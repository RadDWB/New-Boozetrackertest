<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;  /* Dunkleres Rot f√ºr Gemischt */
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 18px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }

    /* Eingabe */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 10px 0 18px;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"‚≠ê"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* Monats√ºbersicht */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    /* Erfolgsquote Ampel */
    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    /* Streak Ampel */
    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Balkendiagramm f√ºr 100 Tage */
    .chart-section{
      margin: 18px 0;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .chart-title{
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 14px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      gap: 16px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chart-bar-label{
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
    }
    .chart-bar-wrapper{
      height: 180px;
      background: #e5e7eb;
      border-radius: 8px;
      position: relative;
      display: flex;
      align-items: flex-end;
      overflow: hidden;
    }
    .chart-bar{
      width: 100%;
      transition: height 0.8s ease;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }
    .chart-bar.negative{ background: linear-gradient(180deg, #ef4444, #dc2626); }
    .chart-bar.positive{ background: linear-gradient(180deg, #10b981, #059669); }

    /* Balkendiagramm f√ºr 100 Tage - KOMPLETT NEU */
    .chart-section{
      margin: 18px 0;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    .chart-title{
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      flex-direction: column;
      gap: 32px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-bar-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chart-bar-label{
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .chart-bar-label small{
      display: block;
      font-size: 12px;
      font-weight: 400;
      color: var(--muted);
      margin-top: 2px;
    }
    .chart-bar-value{
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .chart-bar-number{
      font-size: 32px;
      font-weight: 900;
      color: var(--text);
    }
    .chart-bar-percent{
      font-size: 16px;
      font-weight: 600;
      color: var(--muted);
    }
    .chart-bar-wrapper{
      height: 48px;
      background: #f1f5f9;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .chart-bar{
      height: 100%;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 16px;
      font-weight: 700;
      color: white;
      font-size: 16px;
      position: relative;
    }
    .chart-bar::after{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      border-radius: 12px;
    }
    .chart-bar.negative{ 
      background: linear-gradient(90deg, #ef4444, #f87171);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .chart-bar.positive{ 
      background: linear-gradient(90deg, #10b981, #34d399);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Gesundheitsbewertung */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      color: var(--text);
    }
    .assessment-badge{
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      border-radius: 12px;
      font-size: 24px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
      color: #065f46;
      border: 2px solid #34d399;
    }
    .assessment-badge.balance{ 
      background: linear-gradient(135deg, #fef3c7, #fde68a); 
      color: #92400e;
      border: 2px solid #fbbf24;
    }
    .assessment-badge.weekend{ 
      background: linear-gradient(135deg, #fed7aa, #fdba74); 
      color: #9a3412;
      border: 2px solid #fb923c;
    }
    .assessment-badge.red{ 
      background: linear-gradient(135deg, #fecaca, #fca5a5); 
      color: #7f1d1d;
      border: 2px solid #ef4444;
    }
    .assessment-metrics{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 560px){ 
      .assessment-metrics{ grid-template-columns: 1fr; } 
    }
    .metric-item{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .metric-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .metric-value{
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
    }
    .assessment-description{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
    }
    .assessment-description strong{
      color: var(--primary);
    }
    .assessment-warning{
      margin-top: 12px;
      padding: 10px;
      background: #fff7ed;
      border-left: 4px solid #fb923c;
      border-radius: 6px;
      font-size: 12px;
      color: #9a3412;
    }

    /* Chart-Popup */
    .chart-popup{
      position: fixed; 
      left: 50%; 
      top: 50%; 
      transform: translate(-50%, -50%);
      background: #ffffff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(31,41,55,.2);
      padding: 20px; 
      width: min(680px, 92vw); 
      max-height: 85vh;
      overflow-y: auto;
      display: none; 
      z-index: 1001;
    }
    .chart-popup.active{ display: block; }
    .chart-popup-overlay{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 1000;
    }
    .chart-popup-overlay.active{ display: block; }

    /* Unauff√§lliger Button */
    .btn-stats-toggle{
      background: transparent;
      border: 1px solid #e5e7eb;
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .btn-stats-toggle:hover{
      background: #f9fafb;
      color: var(--text);
      border-color: #cbd5e1;
    }

    .legend{
      display:flex; flex-wrap:wrap; gap:10px 14px; margin: 10px 0 14px; color:var(--muted); font-size: 13px;
    }
    .legend span{ display: flex; align-items: center; gap: 6px; }

    .cal{
      display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom: 10px;
      position: relative;
    }
    .weekday{
      text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0;
      background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6;
    }

    /* Tageszellen */
    .day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center;
      border-radius:10px; border:1px solid #e7eef6; background:#fff; font-weight:700; cursor:pointer;
      transition:.1s ease; position:relative; z-index: 1; user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"‚ùó"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"‚≠ê"; position:absolute; top:4px; right:6px; font-size:12px; }

    /* HEUTE: nur Ring, KEIN Hintergrund-Override! */
    .day.today{
      outline: 3px solid var(--primary);
      outline-offset: -3px;
    }

    /* Spendenbereich */
    .support{
      background:#f8fafc; border:1px solid #e5e7eb; border-radius: 14px; padding: 14px; margin: 12px 0 12px;
      text-align:center; position: relative; z-index: 0;
    }
    .support p{ margin: 0 0 6px; }
    .support-buttons{ margin-top: 0; }

    .support-buttons{
      display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center;
    }
    .support-buttons .btn-holder{ height:48px; display:flex; align-items:center; justify-content:center; }

    #kofi-holder, #kofi-holder iframe{ margin:0 !important; }
    #kofi-holder iframe{ height:48px !important; min-height:48px !important; }
    @media (max-width: 420px){
      #kofi-holder iframe{ height:44px !important; }
    }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin: 10px 0 6px; }
    .month-title{ font-weight: 800; font-size: 20px; }

    .month-top-nav{
      display:flex; gap:10px; justify-content:center; margin: 8px 0 14px;
    }
    .month-top-nav .btn{ width:auto; min-width: 140px; }
    @media (max-width:420px){ .month-top-nav .btn{ min-width: 120px; } }

    /* Edit-Karte ‚Äì unsichtbar bis .active */
    .edit-pop{
      position: fixed; left:50%; top: 18px; transform: translateX(-50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow: var(--shadow);
      padding:14px; width: min(560px, 92vw); display:none; z-index: 1000;
    }
    .edit-pop.active{ display:block; }
    .edit-title{ font-weight:800; font-size:18px; margin: 4px 0 8px; color:#111827; }
    .edit-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .edit-grid{ grid-template-columns: 1fr; } }
    .edit-option{
      width:100%; padding:12px 14px; border-radius:12px; border:2px solid #edf2f7; background:#fff; cursor:pointer; text-align:left;
      transition:.12s ease; font-size:15px;
    }
    .edit-option:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .edit-option.sober{ border-color:#c0f1df; background:#f4fffa; }
    .edit-option.wellness{ border-color:#b3f5cc; background:#f0fdf5; position:relative; }
    .edit-option.wellness::after{ content:"‚ùó"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.moderate{ border-color:#ffe5b5; background:#fff9ec; }
    .edit-option.mixed{ border-color:#fecaca; background:#fef2f2; position:relative; }
    .edit-option.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.alcohol{ border-color:#ffcaca; background:#fff2f2; }
    .edit-option.superday{ border-color:#b7f3d2; background:linear-gradient(135deg,#f6fff9,#f1fff7); position:relative; }
    .edit-option.superday::after{ content:"‚≠ê"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.delete{ border-color:#e2e8f0; background:#f8fafc; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }
    .reset-bar{ margin-top: 16px; display:flex; justify-content:center; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tag-Eingabe Ansicht -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Ralles wunderbarer Booze-Tracker</h1>
      <div class="current-date" id="currentDateDisplay"></div>

      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday">
          <input type="radio" name="dayChoice" value="superday" />
          <span>‚≠ê Supertag ‚Äì Alkoholfrei + Sport gemacht!</span>
        </label>
        <label class="choice-option wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <span>üíö Wellness ‚Äì Alkoholfrei + Sauna/Gesundheit</span>
        </label>
        <label class="choice-option sober">
          <input type="radio" name="dayChoice" value="sober" />
          <span>üü¢ Alkoholfrei ‚Äì Kein Alkohol getrunken</span>
        </label>
        <label class="choice-option moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <span>üü° Moderat ‚Äì Wenig Alkohol getrunken</span>
        </label>
        <label class="choice-option mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <span>‚ù§Ô∏è Schadensbegrenzung ‚Äì Alkohol + Sport</span>
        </label>
        <label class="choice-option alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <span>üî¥ Alkohol ‚Äì Viel Alkohol getrunken</span>
        </label>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn" disabled>Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        üç∑ Gespeicherte Tage: <span id="savedDaysCount">0</span> ¬∑
        <span id="storageStatus">Lade‚Ä¶</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
    </div>

    <!-- Monats-√úbersicht -->
    <div id="monthView" class="view">
      <h1>üìä Booze-√úbersicht</h1>

      <div class="month-head">
        <div class="month-title" id="monthHeader">‚Äî</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">‚Üê Vorheriger</button>
        <button class="btn" onclick="nextMonth()">N√§chster ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Erfolgsquote</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>‚≠ê Supertag</span>
        <span>üíö Wellness</span>
        <span>üü¢ Alkoholfrei</span>
        <span>üü° Moderat</span>
        <span>‚ù§Ô∏è Gemischt</span>
        <span>üî¥ Alkohol</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <!-- Unauff√§lliger Button f√ºr Statistik -->
      <div style="text-align: center; margin-top: 16px;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">üìä 100-Tage-Statistik</button>
      </div>

      <section class="support">
        <p><strong>Findest diese kleine Anwendung n√ºtzlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons">
          <!-- Ko-fi Button -->
          <div id="kofi-holder" class="btn-holder">
            <div id="kofi-widget" aria-label="Ko-fi Unterst√ºtzungsbutton"></div>
          </div>

          <!-- Buy Me a Coffee Button -->
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky"><img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir ¬¥n Kaffee! &emoji=‚òï&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" /></a>
          </div>
        </div>

        <!-- Ko-fi Widget-Script -->
        <script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
        <script type="text/javascript">
          kofiwidget2.init('Spendier mir n¬¥ Kaffee Ko-fi', '#72a4f2', 'R5R319DK8N');
          kofiwidget2.draw();
        </script>
      </section>

      <div class="reset-bar">
        <button class="btn danger" onclick="resetStorage()">üßπ Lokalen Speicher l√∂schen</button>
      </div>
    </div>

    <!-- Edit-Karte -->
    <div id="editPopup" class="edit-pop" aria-hidden="true">
      <div class="edit-title" id="editDate">Datum</div>
      <div class="edit-grid">
        <button class="edit-option superday" onclick="updateDay('superday')">‚≠ê Supertag</button>
        <button class="edit-option wellness" onclick="updateDay('wellness')">üíö Wellness</button>
        <button class="edit-option sober" onclick="updateDay('sober')">üü¢ Alkoholfrei</button>
        <button class="edit-option moderate" onclick="updateDay('moderate')">üü° Moderat</button>
        <button class="edit-option mixed" onclick="updateDay('mixed')">‚ù§Ô∏è Gemischt</button>
        <button class="edit-option alcohol" onclick="updateDay('alcohol')">üî¥ Alkohol</button>
        <button class="edit-option delete" onclick="updateDay('delete')">üóëÔ∏è Tag l√∂schen</button>
        <button class="btn secondary" onclick="closeEditPopup()">Abbrechen</button>
      </div>
    </div>

    <!-- Chart-Popup -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup" aria-hidden="true">
      <div class="chart-section">
        <div class="chart-title">üìä Letzte 100 Tage im √úberblick</div>
        <div class="chart-bars">
          <!-- Negativer Balken -->
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üî¥ Unter 50%
                <small>Alkohol, Gemischt, Moderat</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative" style="width: 0%;"></div>
            </div>
          </div>
          <!-- Positiver Balken -->
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üü¢ √úber 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesundheitsbewertung -->
      <div class="health-assessment">
        <div class="assessment-title">üéØ Deine Gesundheitseinsch√§tzung</div>
        
        <div class="assessment-badge" id="assessmentBadge">
          <!-- Wird dynamisch gef√ºllt -->
        </div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">AF-Quote (alkoholfrei)</div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Gewichtete Gesundheit</div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Binge-N√§he (Hochrisiko)</div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">L√§ngster Cluster</div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription">
          <!-- Wird dynamisch gef√ºllt -->
        </div>

        <div id="assessmentWarning" class="assessment-warning" style="display: none;">
          <!-- Wird bei Bedarf angezeigt -->
        </div>
      </div>

      <button class="btn secondary" style="margin-top: 24px; width: 100%;" onclick="toggleChartPopup()">Schlie√üen</button>
    </div>

    <footer>¬© 2025 by R. Duwenbeck</footer>
  </div>

  <script>
    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let dayData = {};
    let editingDate = null;
    let storageWorking = false;

    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays   = ['Mo','Di','Mi','Do','Fr','Sa','So'];

    const formatDateKey = (date)=> `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
    const formatDisplayDate = (date)=> `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    /* Storage */
    function testStorage(){ try{ localStorage.setItem('__test__','1'); localStorage.removeItem('__test__'); storageWorking = true; }catch{ storageWorking=false; } }
    function updateStorageStatus(message){
      const status = document.getElementById('storageStatus');
      const count  = document.getElementById('savedDaysCount');
      if(status) status.textContent = message ?? '';
      if(count)  count.textContent  = Object.keys(dayData).length;
    }
    function saveData(){
      if(!storageWorking){ updateStorageStatus('‚ùå Speichern nicht m√∂glich'); return false; }
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        updateStorageStatus('‚úÖ Daten gespeichert'); return true;
      }catch{ updateStorageStatus('‚ùå Speicher-Fehler'); return false; }
    }
    function loadData(){
      if(!storageWorking){ updateStorageStatus('‚ö†Ô∏è Kein persistenter Speicher'); return; }
      try{
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        currentInputDate = new Date();
        updateStorageStatus(`‚úÖ ${Object.keys(dayData).length} Tage geladen`);
      }catch{
        dayData = {}; currentInputDate = new Date(); updateStorageStatus('‚ùå Laden fehlgeschlagen');
      }
    }

    /* Erfolgsquote - ANGEPASST */
    function setSuccessCardTint(pct){
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if(pct < 50)      card.classList.add('rate-bad');
      else if(pct < 75) card.classList.add('rate-warn');
      else              card.classList.add('rate-good');
    }
    function calculateSuccessRate(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      let total=0, max=0;
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const st = dayData[formatDateKey(new Date(y,m,d))];
        if(!st) continue;
        max += 1;
        if(st==='superday') total += 1.0;
        else if(st==='wellness') total += 0.9;
        else if(st==='sober') total += 0.75;
        else if(st==='moderate') total += 0.4;
        else if(st==='mixed') total += 0.25;  // ANGEPASST auf 25%
      }
      const pct = max>0 ? Math.round((total/max)*100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      setSuccessCardTint(pct);
    }

    /* Balkendiagramm f√ºr letzte 100 Tage - ANGEPASST f√ºr horizontales Design */
    function calculate100DaysChart(){
      let negative = 0; // unter 50%: alcohol, mixed, moderate
      let positive = 0; // √ºber 50%: sober, wellness, superday
      
      const today = new Date();
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = dayData[formatDateKey(probe)];
        
        if(st === 'alcohol' || st === 'mixed' || st === 'moderate'){
          negative++;
        } else if(st === 'sober' || st === 'wellness' || st === 'superday'){
          positive++;
        }
      }

      // Prozent berechnen (von 100 Tagen)
      const negPct = Math.round((negative / 100) * 100);
      const posPct = Math.round((positive / 100) * 100);

      // Balken aktualisieren mit Animation
      setTimeout(() => {
        // Negative Bar
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        
        // Positive Bar
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 100);
    }

    /* GESUNDHEITSBEWERTUNG - Wissenschaftlich fundiert nach WHO/DGE/RKI/DSM-5 */
    function calculateHealthAssessment(){
      const today = new Date();
      let counts = {
        superday: 0,
        wellness: 0,
        sober: 0,
        moderate: 0,
        mixed: 0,
        alcohol: 0
      };
      
      // Z√§hle Kategorien f√ºr letzte 100 Tage
      const last100Days = [];
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = dayData[formatDateKey(probe)];
        last100Days.push(st || null);
        if(st && counts[st] !== undefined) counts[st]++;
      }

      // 1. AF-Quote (Alkoholfreie Quote) - WHO-Standard
      const afCount = counts.superday + counts.wellness + counts.sober;
      const afQuote = afCount / 100;
      
      // 2. Gewichtete Gesundheitsquote - Differenzierte Bewertung
      const weightedScore = (
        counts.superday * 1.0 +
        counts.wellness * 0.9 +
        counts.sober * 0.75 +
        counts.moderate * 0.4 +
        counts.mixed * 0.25 +
        counts.alcohol * 0.0
      ) / 100;
      
      // 3. Binge-N√§he - RKI-Risikoindikator
      const bingeProximity = counts.alcohol + counts.mixed;
      
      // 4. Cluster-Erkennung - 3+ Hochrisiko-Tage am St√ºck
      let maxCluster = 0;
      let currentCluster = 0;
      for(let i = 0; i < last100Days.length; i++){
        const st = last100Days[i];
        if(st === 'alcohol' || st === 'mixed'){
          currentCluster++;
          if(currentCluster > maxCluster) maxCluster = currentCluster;
        } else {
          currentCluster = 0;
        }
      }

      // 5. Label-Zuweisung nach wissenschaftlichen Schwellenwerten
      let label, badgeClass, description, warning, humorQuote;
      
      if(afQuote >= 0.70 && bingeProximity <= 4){
        // LEBER-SUPERHELD - Gr√ºne Zone (sehr gut)
        label = 'ü¶∏ Leber-Superheld';
        badgeClass = 'zen';
        description = '<strong>Niedriges Gesamtrisiko</strong> ‚Äì Du bist der Batman der Bars ‚Äì unsichtbar f√ºr Alkohol! Deine alkoholfreien Tage (‚â•70%) mit sportlichen/erholsamen Puffern zeigen ein vorbildliches Muster. Binge-Events sind selten (‚â§4/100 Tage ‚âà seltener als monatlich). Deine Leber schickt dir Dankeskarten! üíö';
        humorQuote = 'üí° <em>"Du bist, was du trinkst ‚Äì aber auch, was du an Supertagen tust. Jeder gr√ºne Tag ist wie ein Staubsauger f√ºr Risikokr√ºmel."</em>';
        warning = '‚ö†Ô∏è Trotzdem kein "Freifahrtschein" ‚Äì WHO empfiehlt weiterhin Wachsamkeit.';
        
      } else if(afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12){
        // BALANCE-BUDDHA - Gelb-gr√ºn (ok mit Fragezeichen)
        label = 'üßò Balance-Buddha';
        badgeClass = 'balance';
        description = '<strong>Moderates Risiko</strong> ‚Äì Du meditierst mit einem Glas Wasser ‚Äì zen, aber nicht fanatisch! AF-Quote 40-69% ist solide. Pr√ºfe kritisch: Bleiben "moderate" Tage wirklich moderat (‚â§2 Einheiten/Woche nach DGE)? Binge-Events (‚â§12/100 ‚âà h√∂chstens viertel- bis monatlich) sind √ºberschaubar.';
        humorQuote = 'üí° <em>"Moderate Tage sind wie Parken in der gelben Zone: geht mal gut, aber zur Regel wird\'s besser nicht ‚Äì vor allem nicht t√§glich."</em> (DGE/DHS)';
        warning = 'Tipp: Mehr Supertage/Wellness-Tage einstreuen ‚Äì Sport + Abstinenz = doppelter Gesundheitsboost!';
        
      } else if(afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19)){
        // PARTY-PHILOSOPH - Orange (aufpassen)
        label = 'üé≠ Party-Philosoph';
        badgeClass = 'weekend';
        description = '<strong>Erh√∂htes Risiko</strong> ‚Äì Du philosophierst: "Alkohol ist wie Leben ‚Äì in Ma√üen genie√üen!" Aber Achtung: AF-Quote (<40%) oder Binge-N√§he (13-19/100 ‚âà w√∂chentlich) liegt im WHO-Risikolevel "moderat bis hoch". H√§ufige Rauschsituationen sind Treiber f√ºr Leber-, Krebs- und Herzprobleme. Deine Leber murmelt: "Noch ein Drink, und ich k√ºndige!"';
        humorQuote = 'üí° <em>"Schadensbegrenzung ist wie Z√§hneputzen nach Karamell-Fladen: gut, aber die Karies kam vorher."</em>';
        warning = '‚ö†Ô∏è Empfehlung: AUDIT-Screening durchf√ºhren! Sport neutralisiert Alkoholrisiken NICHT (WHO/DHS). Potenziell mildes AUD bei 2-3 DSM-5-Kriterien.';
        
      } else if(bingeProximity >= 20 && bingeProximity < 40 || (afQuote < 0.30 && afQuote >= 0.20)){
        // RISIKO-ROULETTE - Dunkelorange (hoch)
        label = 'üé≤ Risiko-Roulette';
        badgeClass = 'red';
        description = '<strong>Hohes Risiko</strong> ‚Äì Du spielst Russian Roulette mit Shots ‚Äì Spa√ü, bis es knallt! Binge-N√§he (20-39/100 ‚âà mehrmals w√∂chentlich) oder niedrige AF-Quote (20-29%) zeigen ein kritisches Muster. Hohes Risiko f√ºr Krebs, Leberzirrhose und Unf√§lle. Dein K√∂rper ruft: "Sport vor dem Saufen? Das ist wie Helm beim Bungee-Jumping ‚Äì nett, aber rettet nicht vor dem Fall!"';
        humorQuote = 'üí° <em>"Leider saugt der Staubsauger keinen Rausch weg. Sport ‚â† Gegengift."</em> (WHO)';
        warning = 'üö® Moderate AUD wahrscheinlich (4-5 DSM-5-Kriterien wie Toleranz, soziale Probleme). Medizinisches Gespr√§ch und professionelle Beratung DRINGEND empfohlen!';
        
      } else {
        // SUCHT-ALARM - Rot (sehr hoch / akut)
        label = 'üö® Sucht-Alarm: Rote Lampen gehen an!';
        badgeClass = 'red';
        description = '<strong>Sehr hohes Risiko / Potenzielle Abh√§ngigkeit</strong> ‚Äì Die Sirenen heulen ‚Äì Zeit f√ºr Help! Binge-N√§he (‚â•40/100 ‚âà fast t√§glich) oder fast t√§glicher Konsum (AF-Quote <20%) zeigt extremes Risiko f√ºr Herz, Gehirn, Krebs und Leber. DSM-5-Warnzeichen f√ºr schwere AUD (6+ Kriterien): Entzug, Kontrollverlust, starkes Verlangen (Craving), Weitermachen trotz Sch√§den, Vernachl√§ssigung anderer Aktivit√§ten.';
        humorQuote = 'üí° <em>"Du bist der \'Alkohol-Akrobat\' ‚Äì balancierst auf dem Drahtseil, aber ohne Netz. Deine Leber: \'Ich pack\'s nicht mehr!\'"</em>';
        warning = 'üÜò Professionelle Hilfe SOFORT empfohlen: SAMHSA-Hotline, lokale Suchtberatung, medizinisches Gespr√§ch. Dies ist keine Diagnose, aber ein klares Signal! Ab AUDIT ‚â• 8 Punkten ist professionelle Abkl√§rung essentiell.';
      }

      // Sonder-Warnungen
      let extraWarnings = '';
      if(maxCluster >= 3){
        extraWarnings += '<br>üî• <strong>Cluster-St√ºrmer erkannt:</strong> ' + maxCluster + ' Hochrisiko-Tage am St√ºck bedeuten deutlichen Risiko-Spike!';
      }
      if(counts.mixed >= 15){
        extraWarnings += '<br>üíä <strong>Schadensbegrenzungs-Illusionist:</strong> Sport kaschiert Alkoholrisiken, senkt sie aber NICHT substanziell (WHO). ' + counts.mixed + ' "Gemischt"-Tage zeigen ein problematisches Muster.';
      }

      // UI aktualisieren
      document.getElementById('metricAF').textContent = Math.round(afQuote * 100) + '%';
      document.getElementById('metricHealth').textContent = Math.round(weightedScore * 100) + '%';
      document.getElementById('metricBinge').textContent = bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster > 0 ? maxCluster + ' Tage' : 'Keiner';

      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label;
      badge.className = 'assessment-badge ' + badgeClass;

      document.getElementById('assessmentDescription').innerHTML = description + '<br><br>' + humorQuote;

      const warningEl = document.getElementById('assessmentWarning');
      if(warning || extraWarnings){
        warningEl.innerHTML = (warning || '') + extraWarnings;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }
    }

    /* Streak - ANGEPASST: Geht sofort auf 0 bei nicht-gr√ºnen Tagen */
    function setStreakCardTint(streak){
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      if(streak >= 30)      card.classList.add('streak-great');
      else if(streak >= 21) card.classList.add('streak-good');
      else if(streak >= 11) card.classList.add('streak-warn');
      else if(streak >= 1)  card.classList.add('streak-bad');
      numEl.textContent = String(streak) + (streak>=30 ? ' üéâ' : '');
    }
    function isGreen(state){ return state==='sober' || state==='superday' || state==='wellness'; }
    function calculateStreak(){
      let probe = new Date(); // heute
      let streak = 0;
      
      // Z√§hle r√ºckw√§rts von heute
      while(true){
        const key = formatDateKey(probe);
        const st = dayData[key];
        
        // Wenn gr√ºner Tag: Streak erh√∂hen
        if(isGreen(st)){
          streak++;
          probe.setDate(probe.getDate()-1);
        }
        // Wenn nicht-gr√ºner Tag oder kein Eintrag: Streak beenden
        else {
          break;
        }
        
        // Sicherheit: Max 1000 Tage pr√ºfen
        if(streak > 1000) break;
      }
      
      setStreakCardTint(streak);
    }

    /* Views */
    function updateDayInputView(){
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      updateStorageStatus(`üç∑ ${Object.keys(dayData).length} Tage`);
      const key = formatDateKey(currentInputDate);
      const existing = dayData[key];
      const btn = document.getElementById('submitDay');
      if(existing){
        const radio = document.querySelector(`input[name="dayChoice"][value="${existing}"]`);
        if(radio) radio.checked = true;
        btn.disabled = false;
        btn.textContent = 'Tag aktualisieren';
      }else{
        btn.textContent = 'Tag speichern';
      }
    }

    function showMonthView(){
      currentViewDate = new Date(currentInputDate);
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }
    function showDayInput(){
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      closeEditPopup();
    }

    /* Monatsgrid */
    function updateMonthView(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      const weekdays = ['Mo','Di','Mi','Do','Fr','Sa','So'];
      for(const w of weekdays){
        const h = document.createElement('div');
        h.className = 'weekday';
        h.textContent = w;
        grid.appendChild(h);
      }

      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);
      const startDay = (first.getDay()+6)%7;

      for(let i=0;i<startDay;i++){
        const e = document.createElement('div');
        e.className='day';
        e.style.visibility='hidden';
        grid.appendChild(e);
      }

      const today = new Date();
      for(let d=1; d<=last.getDate(); d++){
        const dt = new Date(y, m, d);
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.textContent = d;
        cell.dataset.y = String(y);
        cell.dataset.m = String(m);
        cell.dataset.d = String(d);

        const st = dayData[formatDateKey(dt)];
        if(st) cell.classList.add(st);
        if(dt.toDateString() === today.toDateString()) cell.classList.add('today');

        grid.appendChild(cell);
      }
    }

    /* Event-Delegation */
    document.addEventListener('click', (e)=>{
      const grid = document.getElementById('monthGrid');
      if(!grid || !grid.contains(e.target)) return;
      const cell = e.target.closest('.day');
      if(!cell) return;
      if(cell.style.visibility === 'hidden') return;

      const y = Number(cell.dataset.y);
      const m = Number(cell.dataset.m);
      const d = Number(cell.dataset.d);
      if(Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return;

      openEditPopup(new Date(y,m,d));
    });

    /* Edit */
    function openEditPopup(date){
      editingDate = date;
      document.getElementById('editDate').textContent = formatDisplayDate(date);
      const pop = document.getElementById('editPopup');
      pop.classList.add('active');
      pop.setAttribute('aria-hidden','false');
    }
    function closeEditPopup(){
      const pop = document.getElementById('editPopup');
      pop.classList.remove('active');
      pop.setAttribute('aria-hidden','true');
      editingDate = null;
    }

    /* Chart Popup */
    function toggleChartPopup(){
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');
      
      if(isActive){
        popup.classList.remove('active');
        overlay.classList.remove('active');
        popup.setAttribute('aria-hidden','true');
      } else {
        calculate100DaysChart();
        calculateHealthAssessment();
        popup.classList.add('active');
        overlay.classList.add('active');
        popup.setAttribute('aria-hidden','false');
      }
    }

    function updateDay(action){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      if(action==='delete') delete dayData[key];
      else dayData[key] = action;

      saveData();
      closeEditPopup();
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }
    function nextMonth(){     currentViewDate.setMonth(currentViewDate.getMonth()+1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }

    /* Save day */
    function saveDay(){
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if(!selected) return;
      const key = formatDateKey(currentInputDate);
      dayData[key] = selected.value;

      const btn = document.getElementById('submitDay');
      const ok = saveData();
      const label = btn.textContent;
      btn.textContent = ok ? '‚úÖ Gespeichert!' : '‚ùå Fehler!';
      setTimeout(()=>btn.textContent = label, 1200);

      calculateStreak();

      currentInputDate.setDate(currentInputDate.getDate()+1);
      updateDayInputView();

      document.querySelectorAll('input[name="dayChoice"]').forEach(r=>r.checked=false);
      btn.disabled = true;
    }

    /* Reset */
    function resetStorage(){
      const ok = confirm('‚ö†Ô∏è Wirklich ALLE lokalen Daten (Tage + Einstellungen) l√∂schen und neu starten?');
      if(!ok) return;
      try{
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerCurrentDate');
      }catch(e){ console.warn('LocalStorage-Bereinigung fehlgeschlagen:', e); }
      location.reload();
    }

    // Expose
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openEditPopup = openEditPopup;
    window.closeEditPopup = closeEditPopup;
    window.updateDay = updateDay;
    window.resetStorage = resetStorage;
    window.toggleChartPopup = toggleChartPopup;

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      testStorage();
      loadData();
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{ document.getElementById('submitDay').disabled = false; });
      });
      document.getElementById('submitDay').addEventListener('click', saveDay);
      updateDayInputView();
    });
  </script>
</body>
</html>
