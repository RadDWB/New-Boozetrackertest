<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;  /* Dunkleres Rot f√ºr Schadensbegrenzung */
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 18px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }

    /* Eingabe */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 10px 0 18px;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"‚≠ê"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* Monats√ºbersicht */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    /* Erfolgsquote Ampel */
    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    /* Streak Ampel */
    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Balkendiagramm f√ºr 100 Tage */
    .chart-section{
      margin: 18px 0;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .chart-title{
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 14px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      gap: 16px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chart-bar-label{
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
    }
    .chart-bar-wrapper{
      height: 180px;
      background: #e5e7eb;
      border-radius: 8px;
      position: relative;
      display: flex;
      align-items: flex-end;
      overflow: hidden;
    }
    .chart-bar{
      width: 100%;
      transition: height 0.8s ease;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }
    .chart-bar.negative{ background: linear-gradient(180deg, #ef4444, #dc2626); }
    .chart-bar.positive{ background: linear-gradient(180deg, #10b981, #059669); }

    /* Balkendiagramm ‚Äì horizontale Variante (neu) */
    .chart-section{
      margin: 18px 0;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    .chart-title{
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      flex-direction: column;
      gap: 32px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-bar-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chart-bar-label{
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .chart-bar-label small{
      display: block;
      font-size: 12px;
      font-weight: 400;
      color: var(--muted);
      margin-top: 2px;
    }
    .chart-bar-value{
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .chart-bar-number{
      font-size: 32px;
      font-weight: 900;
      color: var(--text);
    }
    .chart-bar-percent{
      font-size: 16px;
      font-weight: 600;
      color: var(--muted);
    }
    .chart-bar-wrapper{
      height: 48px;
      background: #f1f5f9;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .chart-bar{
      height: 100%;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 16px;
      font-weight: 700;
      color: white;
      font-size: 16px;
      position: relative;
    }
    .chart-bar::after{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      border-radius: 12px;
    }
    .chart-bar.negative{ 
      background: linear-gradient(90deg, #ef4444, #f87171);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .chart-bar.positive{ 
      background: linear-gradient(90deg, #10b981, #34d399);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Gesundheitsbewertung */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      color: var(--text);
    }
    .assessment-badge{
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      border-radius: 12px;
      font-size: 24px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
      color: #065f46;
      border: 2px solid #34d399;
    }
    .assessment-badge.balance{ 
      background: linear-gradient(135deg, #fef3c7, #fde68a); 
      color: #92400e;
      border: 2px solid #fbbf24;
    }
    .assessment-badge.weekend{ 
      background: linear-gradient(135deg, #fed7aa, #fdba74); 
      color: #9a3412;
      border: 2px solid #fb923c;
    }
    .assessment-badge.red{ 
      background: linear-gradient(135deg, #fecaca, #fca5a5); 
      color: #7f1d1d;
      border: 2px solid #ef4444;
    }
    .assessment-metrics{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 560px){ 
      .assessment-metrics{ grid-template-columns: 1fr; } 
    }
    .metric-item{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      position: relative;
    }
    .metric-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .metric-info{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      cursor: help;
      position: relative;
    }
    .metric-info:hover .metric-tooltip{
      display: block;
    }
    .metric-tooltip{
      display: none;
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      padding: 12px;
      background: #1f2937;
      color: white;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      text-align: left;
      font-weight: 400;
    }
    .metric-tooltip::after{
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
    }
    .metric-tooltip strong{
      color: #60a5fa;
      font-weight: 600;
    }
    @media (max-width: 560px){
      .metric-tooltip{
        width: 220px;
        font-size: 10px;
        padding: 10px;
      }
    }
    .metric-value{
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
    }
    .assessment-description{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
    }
    .assessment-description strong{
      color: var(--primary);
    }
    .assessment-warning{
      margin-top: 12px;
      padding: 10px;
      background: #fff7ed;
      border-left: 4px solid #fb923c;
      border-radius: 6px;
      font-size: 12px;
      color: #9a3412;
    }

    /* Settings f√ºr neutrale Tage */
    .settings-section{
      margin-top: 20px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
    }
    .settings-title{
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-option{
      margin-bottom: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .settings-option:hover{
      border-color: var(--primary);
      background: #eff6ff;
    }
    .settings-option input[type="radio"]{
      margin-right: 8px;
    }
    .settings-option label{
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .settings-option.selected{
      border-color: var(--primary);
      background: #eff6ff;
    }
    .settings-explanation{
      margin-top: 12px;
      padding: 12px;
      background: #f0f9ff;
      border-left: 4px solid var(--primary);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.6;
      color: #1e40af;
    }

    /* AUDIT-C Quiz */
    .audit-quiz{
      margin-top: 20px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
    }
    .audit-question{
      margin-bottom: 16px;
    }
    .audit-question-label{
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
      display: block;
    }
    .audit-options{
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .audit-option{
      padding: 8px 12px;
      background: #f9fafb;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }
    .audit-option:hover{
      border-color: var(--primary);
      background: #eff6ff;
    }
    .audit-option input[type="radio"]{
      margin-right: 8px;
    }
    .audit-option label{
      cursor: pointer;
    }
    .audit-result{
      margin-top: 16px;
      padding: 16px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.6;
    }
    .audit-result.low{
      background: #d1fae5;
      border: 2px solid #34d399;
      color: #065f46;
    }
    .audit-result.medium{
      background: #fef3c7;
      border: 2px solid #fbbf24;
      color: #92400e;
    }
    .audit-result.high{
      background: #fecaca;
      border: 2px solid #ef4444;
      color: #7f1d1d;
    }
    .audit-result strong{
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
    }

    /* Chart-Popup */
    .chart-popup{
      position: fixed; 
      left: 50%; 
      top: 50%; 
      transform: translate(-50%, -50%);
      background: #ffffff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(31,41,55,.2);
      padding: 20px; 
      width: min(680px, 92vw); 
      max-height: 85vh;
      overflow-y: auto;
      display: none; 
      z-index: 1001;
    }
    .chart-popup.active{ display: block; }
    .chart-popup-overlay{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 1000;
    }
    .chart-popup-overlay.active{ display: block; }

    /* Unauff√§lliger Button */
     .btn-stats-toggle{
       appearance: none;
       background: linear-gradient(135deg, #eef2ff, #e0e7ff);
       border: 1.5px solid #c7d2fe;
       color: #1e3a8a;
       padding: 10px 18px;
       border-radius: 999px;
       font-size: 14px;
       font-weight: 700;
       cursor: pointer;
       transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
       box-shadow: 0 6px 14px rgba(79,70,229,.18);
       display: inline-flex;
       align-items: center;
       gap: 8px;
     }
     .btn-stats-toggle:hover{
       background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
       border-color: #a5b4fc;
       transform: translateY(-1px);
       box-shadow: 0 10px 20px rgba(79,70,229,.25);
     }
     .btn-stats-toggle:active{
       transform: translateY(0);
       box-shadow: 0 4px 10px rgba(79,70,229,.2);
     }
     .btn-stats-toggle:focus-visible{
       outline: 3px solid #c7d2fe;
       outline-offset: 2px;
     }

    /* Einstellungs-Button */
    .btn-settings{
      appearance: none;
      background: linear-gradient(135deg, #f0f9ff, #dbeafe);
      border: 1.5px solid #bae6fd;
      color: #0c4a6e;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      box-shadow: 0 6px 14px rgba(2,132,199,.16);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-settings:hover{
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border-color: #93c5fd;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(2,132,199,.22);
    }
    .btn-settings:active{
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(2,132,199,.18);
    }
    .btn-settings:focus-visible{
      outline: 3px solid #93c5fd;
      outline-offset: 2px;
    }

    /* Einstellungs-Popup */
    .settings-popup{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(31,41,55,.25);
      padding: 24px;
      width: min(560px, 92vw);
      max-height: 85vh;
      overflow-y: auto;
      display: none;
      z-index: 1002;
    }
    .settings-popup.active{ display: block; }
    .settings-popup-overlay{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 1001;
    }
    .settings-popup-overlay.active{ display: block; }
    .settings-title{
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--text);
      text-align: center;
    }
    .settings-subtitle{
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 24px;
      text-align: center;
    }
    .settings-section{ margin-bottom: 24px; }
    .settings-section-title{
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text);
    }
    .settings-description{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .settings-options{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .settings-option{
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      transition: all .2s ease;
    }
    .settings-option:hover{
      border-color: var(--primary);
      background: #f8faff;
    }
    .settings-option.selected{
      border-color: var(--primary);
      background: linear-gradient(135deg, #eef2ff, #f8faff);
      box-shadow: 0 4px 12px rgba(79,70,229,0.15);
    }
    .settings-option input[type="radio"]{
      margin-top: 2px;
      transform: scale(1.3);
      accent-color: var(--primary);
    }
    .settings-option input[type="checkbox"]{
      transform: scale(1.2);
      accent-color: var(--primary);
      margin-top: 2px;
    }
    .settings-option-content{ flex: 1; }
    .settings-option-title{
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
    }
    .settings-option-desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .settings-info-box{
      padding: 14px;
      background: #eff6ff;
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      font-size: 12px;
      color: #1e40af;
      line-height: 1.6;
      margin-top: 16px;
    }
    .settings-info-box strong{ color: #1e3a8a; }

    .legend{
      display:flex; flex-wrap:wrap; gap:10px 14px; margin: 10px 0 14px; color:var(--muted); font-size: 13px;
    }
    .legend span{ display: flex; align-items: center; gap: 6px; }

    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom: 10px; position: relative; }
    .weekday{
      text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0;
      background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6;
    }

    /* Tageszellen */
    .day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center;
      border-radius:10px; border:1px solid #e7eef6; background:#fff; font-weight:700; cursor:pointer;
      transition:.1s ease; position:relative; z-index: 1; user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"‚ùó"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"‚≠ê"; position:absolute; top:4px; right:6px; font-size:12px; }

    /* HEUTE: nur Ring, KEIN Hintergrund-Override! */
    .day.today{ outline: 3px solid var(--primary); outline-offset: -3px; }

    /* Kommentar-Tooltip */
    .day-comment-tooltip{
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 200px;
      max-width: 280px;
      padding: 10px 12px;
      background: #1f2937;
      color: white;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      text-align: left;
      font-weight: 400;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .day-comment-tooltip::after{
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
    }
    .day.has-comment{ position: relative; }
    .day.has-comment::before{
      content: 'üí¨';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      opacity: 0.8;
    }
    .day.has-comment:hover .day-comment-tooltip{ display: block; }

    /* Spendenbereich */
    .support{
      background:#f8fafc; border:1px solid #e5e7eb; border-radius: 14px; padding: 14px; margin: 12px 0 12px;
      text-align:center; position: relative; z-index: 0;
    }
    .support p{ margin: 0 0 6px; }
    .support-buttons{ margin-top: 0; }

    .support-buttons{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; }
    .support-buttons .btn-holder{ height:48px; display:flex; align-items:center; justify-content:center; }

    #kofi-holder, #kofi-holder iframe{ margin:0 !important; }
    #kofi-holder iframe{ height:48px !important; min-height:48px !important; }
    @media (max-width: 420px){ #kofi-holder iframe{ height:44px !important; } }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin: 10px 0 6px; }
    .month-title{ font-weight: 800; font-size: 20px; }

    .month-top-nav{ display:flex; gap:10px; justify-content:center; margin: 8px 0 14px; }
    .month-top-nav .btn{ width:auto; min-width: 140px; }
    @media (max-width:420px){ .month-top-nav .btn{ min-width: 120px; } }

    /* Edit-Karte */
    .edit-pop{
      position: fixed; left:50%; top: 18px; transform: translateX(-50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow: var(--shadow);
      padding:14px; width: min(560px, 92vw); display:none; z-index: 1000;
    }
    .edit-pop.active{ display:block; }
    .edit-title{ font-weight:800; font-size:18px; margin: 4px 0 8px; color:#111827; }
    .edit-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .edit-grid{ grid-template-columns: 1fr; } }
    .edit-option{
      width:100%; padding:12px 14px; border-radius:12px; border:2px solid #edf2f7; background:#fff; cursor:pointer; text-align:left;
      transition:.12s ease; font-size:15px;
    }
    .edit-option:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .edit-option.sober{ border-color:#c0f1df; background:#f4fffa; }
    .edit-option.wellness{ border-color:#b3f5cc; background:#f0fdf5; position:relative; }
    .edit-option.wellness::after{ content:"‚ùó"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.moderate{ border-color:#ffe5b5; background:#fff9ec; }
    .edit-option.mixed{ border-color:#fecaca; background:#fef2f2; position:relative; }
    .edit-option.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.alcohol{ border-color:#ffcaca; background:#fff2f2; }
    .edit-option.superday{ border-color:#b7f3d2; background:linear-gradient(135deg,#f6fff9,#f1fff7); position:relative; }
    .edit-option.superday::after{ content:"‚≠ê"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.delete{ border-color:#e2e8f0; background:#f8fafc; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }
    .reset-bar{ margin-top: 16px; display:flex; justify-content:center; }
	
	@media (max-width: 420px){
      .btn-stats-toggle, .btn-settings{
        padding: 9px 14px;
        font-size: 13px;
        gap: 6px;
      }
    }

    /* ---------- GOD-MODUS: neue, stilgleiche Elemente ---------- */
    .godmode-card{
      margin-top:16px;
      padding:16px;
      background:#f8fafc;
      border:1.5px solid #e5e7eb;
      border-radius:12px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.04);
    }
    .gm-title{
      font-size:15px; font-weight:800; margin-bottom:10px; color:#0f172a; display:flex; align-items:center; gap:8px;
    }
    .gm-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .gm-grid{ grid-template-columns: 1fr; } }
    .gm-field{
      display:flex; flex-direction:column; gap:6px;
      background:white; border:1px solid #e5e7eb; border-radius:10px; padding:10px;
    }
    .gm-label{ font-size:12px; color:#475569; font-weight:600; }
    .gm-input, .gm-select{
      padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px; font-family:inherit;
    }
    .gm-inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .gm-pill{
      display:inline-flex; gap:8px; align-items:center;
      background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
    }
    .gm-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btn-mini{
      appearance:none; background:#0ea5e9; color:white; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer;
      box-shadow:0 6px 14px rgba(14,165,233,.22); transition:.15s ease;
    }
    .btn-mini:hover{ background:#0284c7; transform: translateY(-1px); }
    .btn-ghost{
      appearance:none; background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer;
      transition:.15s ease;
    }
    .btn-ghost:hover{ background:#e2e8f0; }
    .gm-note{
      margin-top:8px; font-size:12px; color:#475569;
    }
    .gm-checkbox{ transform: scale(1.2); accent-color: var(--primary); }

    /* Detaillierte Analyse Panel */
    .gm-analysis{
      margin-top:16px; padding:16px; background:#f8fafc; border:1.5px solid #e5e7eb; border-radius:12px;
    }
    .gm-analysis-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:560px){ .gm-analysis-grid{ grid-template-columns:1fr; } }
    .gm-metric{ background:white; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .gm-metric .lbl{ font-size:12px; color:#64748b; }
    .gm-metric .val{ font-size:18px; font-weight:800; }

    .stage-badge{
      margin:10px 0;
      padding:12px;
      border-radius:12px;
      font-weight:800;
      text-align:center;
      border:2px solid #e5e7eb;
      background:linear-gradient(135deg,#eef2ff,#e0e7ff);
      color:#1e3a8a;
    }
    .stage-1{ background:linear-gradient(135deg,#d1fae5,#a7f3d0); color:#065f46; border-color:#34d399; }
    .stage-2{ background:linear-gradient(135deg,#fef3c7,#fde68a); color:#92400e; border-color:#fbbf24; }
    .stage-3{ background:linear-gradient(135deg,#fde68a,#fca5a5); color:#7c2d12; border-color:#fb923c; }
    .stage-4{ background:linear-gradient(135deg,#fecaca,#fca5a5); color:#7f1d1d; border-color:#ef4444; }
    .stage-5{ background:linear-gradient(135deg,#fecaca,#ef4444); color:#7f1d1d; border-color:#b91c1c; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tag-Eingabe Ansicht -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Ralles wunderbarer Booze-Tracker (ChatGPT_V2) 10:46</h1>
      <div class="current-date" id="currentDateDisplay"></div>

      <div style="margin-top: 16px;">
        <label for="dayCommentInput" style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          üí¨ Kommentar (optional):
        </label>
        <textarea 
          id="dayCommentInput" 
          placeholder="Notizen zum Tag (z.B. Anlass, Gef√ºhle, Situation)..."
          style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical;"
        ></textarea>
      </div>

      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday">
          <input type="radio" name="dayChoice" value="superday" />
          <span>‚≠ê Supertag ‚Äì Alkoholfrei + Sport gemacht!</span>
        </label>
        <label class="choice-option wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <span>üíö Wellness ‚Äì Alkoholfrei + Sauna/Gesundheit</span>
        </label>
        <label class="choice-option sober">
          <input type="radio" name="dayChoice" value="sober" />
          <span>üü¢ Alkoholfrei ‚Äì Kein Alkohol getrunken</span>
        </label>
        <label class="choice-option moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <span>üü° Moderat ‚Äì Wenig Alkohol getrunken</span>
        </label>
        <label class="choice-option mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <span>‚ù§Ô∏è Schadensbegrenzung ‚Äì Alkohol + Sport</span>
        </label>
        <label class="choice-option alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <span>üî¥ Alkohol ‚Äì Viel Alkohol getrunken</span>
        </label>
      </div>

      <!-- GOD-MODUS: Detaillierte Eingabe (sichtbar nur wenn aktiviert) -->
      <div id="godModeSection" class="godmode-card" style="display:none" aria-hidden="true">
        <div class="gm-title">üß† God-Modus ‚Äì Detailliertes Tracking</div>

        <div class="gm-grid">
          <!-- Alkoholblock -->
          <div class="gm-field">
            <div class="gm-label">üç∫ Getr√§nketyp & Menge</div>
            <div class="gm-inline">
              <select id="gmDrinkType" class="gm-select" aria-label="Getr√§nketyp">
                <option value="beer|0.05">Bier (5%)</option>
                <option value="radler|0.025">Radler (2.5%)</option>
                <option value="wine|0.10">Wein (10%)</option>
                <option value="liqueur|0.15">Lik√∂r (15%)</option>
                <option value="other20|0.20">Sonstiges 20%</option>
                <option value="other30|0.30">Sonstiges 30%</option>
                <option value="spirit|0.40">Spirituosen (40%)</option>
              </select>
              <input id="gmMlPerPortion" class="gm-input" type="number" min="0" step="10" placeholder="Menge je Portion (ml)" />
              <input id="gmPortions" class="gm-input" type="number" min="0" step="1" placeholder="Anzahl Portionen" />
            </div>
            <div class="gm-inline" style="margin-top:8px;">
              <label class="gm-pill" title="Sport an diesem Tag getrieben?">
                <input id="gmDidSport" type="checkbox" class="gm-checkbox" />
                üèÉ‚Äç‚ôÇÔ∏è Sport getrieben
              </label>
              <span id="gmCalcOut" class="gm-pill" title="Berechneter reiner Alkohol & Drinks">0 g ¬∑ 0.0 Drinks</span>
            </div>
          </div>

          <!-- Cannabisblock -->
          <div class="gm-field">
            <div class="gm-label">üåø Marijuana</div>
            <div class="gm-inline">
              <input id="gmWeedGrams" class="gm-input" type="number" min="0" step="0.1" placeholder="Menge (g)" />
              <select id="gmWeedFreq" class="gm-select" aria-label="H√§ufigkeit">
                <option value="">‚Äì H√§ufigkeit ‚Äì</option>
                <option value="einmalig">einmalig</option>
                <option value="mehrmals">mehrmals am Tag</option>
              </select>
            </div>
            <div class="gm-note">Hinweis: Kombinationskonsum kann das Risiko erh√∂hen. Die Analyse ber√ºcksichtigt dies (+Risiko-Boost ab &gt;1 g/Woche).</div>
          </div>
        </div>

        <div class="gm-actions">
          <button id="gmSuggestBtn" class="btn-mini" type="button">üí° Aus Details Kategorie vorschlagen</button>
          <button id="gmSaveBtn" class="btn-ghost" type="button">üíæ Jetzt speichern</button>
        </div>
        <div class="gm-note">Tipp: Wenn du sp√§ter merkst ‚Äûstatt 2 doch 3 Bier‚Äú, √∂ffne den Tag erneut, passe die Portionen an und speichere.</div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn" disabled>Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        üç∑ Gespeicherte Tage: <span id="savedDaysCount">0</span> ¬∑
        <span id="storageStatus">Lade‚Ä¶</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
    </div>

    <!-- Monats-√úbersicht -->
    <div id="monthView" class="view">
      <h1>üìä Ralles wunderbarer Booze-Tracker</h1>

      <div class="month-head">
        <div class="month-title" id="monthHeader">‚Äî</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">‚Üê Vorheriger</button>
        <button class="btn" onclick="nextMonth()">N√§chster ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Erfolgsquote</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>‚≠ê Supertag</span>
        <span>üíö Wellness</span>
        <span>üü¢ Alkoholfrei</span>
        <span>üü° Moderat</span>
        <span>‚ù§Ô∏è "Schadensbegrenzung"</span>
        <span>üî¥ Alkohol</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <!-- Unauff√§lliger Button f√ºr Statistik -->
      <div style="text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">üìä 100-Tage-Statistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">‚öôÔ∏è Einstellungen</button>
      </div>

      <section class="support">
        <p><strong>Findest diese kleine Anwendung n√ºtzlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons">
          <!-- Ko-fi Button -->
          <div id="kofi-holder" class="btn-holder">
            <div id="kofi-widget" aria-label="Ko-fi Unterst√ºtzungsbutton"></div>
          </div>

          <!-- Buy Me a Coffee Button -->
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky"><img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir ¬¥n Kaffee! &emoji=‚òï&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" /></a>
          </div>
        </div>

        <!-- Ko-fi Widget-Script -->
        <script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
        <script type="text/javascript">
          kofiwidget2.init('Spendier mir n¬¥ Kaffee Ko-fi', '#72a4f2', 'R5R319DK8N');
          kofiwidget2.draw();
        </script>
      </section>

      <div class="reset-bar">
        <button class="btn danger" onclick="resetStorage()">üßπ Lokalen Speicher l√∂schen</button>
      </div>
    </div>

    <!-- Edit-Karte -->
    <div id="editPopup" class="edit-pop" aria-hidden="true">
      <div class="edit-title" id="editDate">Datum</div>
      <div class="edit-grid">
        <button class="edit-option superday" onclick="updateDay('superday')">‚≠ê Supertag</button>
        <button class="edit-option wellness" onclick="updateDay('wellness')">üíö Wellness</button>
        <button class="edit-option sober" onclick="updateDay('sober')">üü¢ Alkoholfrei</button>
        <button class="edit-option moderate" onclick="updateDay('moderate')">üü° Moderat</button>
        <button class="edit-option mixed" onclick="updateDay('mixed')">‚ù§Ô∏è Schadensbegrenzung</button>
        <button class="edit-option alcohol" onclick="updateDay('alcohol')">üî¥ Alkohol</button>
      </div>
      
      <div style="margin-top: 16px;">
        <label for="editCommentInput" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
          üí¨ Kommentar:
        </label>
        <textarea 
          id="editCommentInput" 
          placeholder="Notizen zum Tag..."
          style="width: 100%; min-height: 70px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; font-family: inherit; resize: vertical;"
        ></textarea>
        <button class="btn" style="width: 100%; margin-top: 8px;" onclick="saveEditComment()">üíæ √Ñnderungen speichern</button>
      </div>

      <div class="edit-grid" style="margin-top: 16px;">
        <button class="edit-option delete" onclick="updateDay('delete')">üóëÔ∏è Tag l√∂schen</button>
        <button class="btn secondary" onclick="openInDayEditor()">‚úèÔ∏è Im Tages-Editor (God-Modus) √∂ffnen</button>
        <button class="btn secondary" onclick="closeEditPopup()">Schlie√üen</button>
      </div>
    </div>

    <!-- Chart-Popup -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup" aria-hidden="true">
      <div class="chart-section">
        <div class="chart-title">üìä Letzte 100 Tage im √úberblick</div>
        <div class="chart-bars">
          <!-- Negativer Balken -->
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üî¥ Unter 50%
                <small>Alkohol, "Schadensbegrenzung", Moderat</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative" style="width: 0%;"></div>
            </div>
          </div>
          <!-- Positiver Balken -->
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üü¢ √úber 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesundheitsbewertung (Basis) -->
      <div class="health-assessment">
        <div class="assessment-title">üéØ Deine Gesundheitseinsch√§tzung</div>
        
        <div class="assessment-badge" id="assessmentBadge">
          <!-- Wird dynamisch gef√ºllt -->
        </div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">
              AF-Quote (alkoholfrei)
              <span class="metric-info">
                ‚Ñπ
                <span class="metric-tooltip">
                  Prozentsatz alkoholfreier Tage:<br>
                  <strong>Supertag + Wellness + Alkoholfrei</strong><br><br>
                  WHO-Standard f√ºr gesunde Abstinenz.<br>
                  Je h√∂her, desto besser!
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Gewichtete Gesundheit
              <span class="metric-info">
                ‚Ñπ
                <span class="metric-tooltip">
                  Dein Gesundheits-Score:<br>
                  ‚Ä¢ <strong>Supertag = 100%</strong> (Gold!)<br>
                  ‚Ä¢ Wellness = 90% (Sehr gut)<br>
                  ‚Ä¢ Alkoholfrei = 75% (Gut)<br>
                  ‚Ä¢ Moderat = 40% (Risiko-arm)<br>
                  ‚Ä¢ "Schadensbegrenzung" = 25% (Kompensiert nichts)<br>
                  ‚Ä¢ Viel = 0% (Sch√§dlich)
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Binge-N√§he (Hochrisiko)
              <span class="metric-info">
                ‚Ñπ
                <span class="metric-tooltip">
                  Z√§hlt Hochrisiko-Tage:<br>
                  <strong>"Viel Alkohol" + "Schadensbegrenzung"</strong><br><br>
                  ‚ö†Ô∏è <strong>Ab 13/100</strong> (‚âà w√∂chentlich):<br>
                  Erh√∂htes Risiko (RKI/WHO)<br><br>
                  üö® <strong>Ab 20/100</strong> (‚âà mehrmals w√∂chentlich):<br>
                  Hohes Risiko, Hilfe empfohlen
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              L√§ngster Cluster
              <span class="metric-info">
                ‚Ñπ
                <span class="metric-tooltip">
                  L√§ngste Serie von Hochrisiko-Tagen am St√ºck.<br><br>
                  üî• <strong>Ab 3+ Tagen hintereinander:</strong><br>
                  Deutlicher Risiko-Spike f√ºr Leber & Herz-Kreislauf<br><br>
                  Beispiel: Mo-Di-Mi jeweils "Viel" = 3-Tage-Cluster
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning" style="display: none;"></div>

        <!-- GOD-MODUS: Detaillierte Analyse Toggle -->
        <div id="godAnalysisToggleWrapper" style="text-align:center; margin-top:12px; display:none;">
          <button id="toggleDetailedBtn" class="btn-stats-toggle" type="button">üß† Detaillierte Analyse anzeigen</button>
        </div>
        <div id="godAnalysisPanel" class="gm-analysis" style="display:none;">
          <div class="gm-analysis-grid">
            <div class="gm-metric"><div class="lbl">√ò Drinks/Woche</div><div class="val" id="gmMetricDrinksWeek">‚Äì</div></div>
            <div class="gm-metric"><div class="lbl">Alkohol (g)/Woche</div><div class="val" id="gmMetricGramsWeek">‚Äì</div></div>
            <div class="gm-metric"><div class="lbl">Binge-Tage /100</div><div class="val" id="gmMetricBinge100">‚Äì</div></div>
            <div class="gm-metric"><div class="lbl">L√§ngster Cluster</div><div class="val" id="gmMetricLongestCluster">‚Äì</div></div>
            <div class="gm-metric"><div class="lbl">Marijuana (g/Woche)</div><div class="val" id="gmMetricWeedWeek">‚Äì</div></div>
            <div class="gm-metric"><div class="lbl">Muster</div><div class="val" id="gmMetricPattern">‚Äì</div></div>
          </div>
          <div class="stage-badge" id="gmStageBadge">‚Äì</div>
          <div class="assessment-description" id="gmStageText"></div>
          <div class="assessment-warning" id="gmDetailWarning" style="display:none;"></div>
        </div>
      </div>

      <!-- Einstellungen f√ºr neutrale Tage -->
      <div class="settings-section">
        <div class="settings-title">
          ‚öôÔ∏è Einstellung: Wie sollen nicht-eingetragene Tage gewertet werden?
          <span class="metric-info">
            ‚Ñπ
            <span class="metric-tooltip">
              <strong>Wichtig f√ºr genaue Statistiken!</strong><br><br>
              Neutrale Tage (ohne Eintrag) k√∂nnen die Berechnung verzerren.<br><br>
              W√§hle, wie sie bewertet werden sollen:
            </span>
          </span>
        </div>
        
        <div class="settings-option" onclick="selectNeutralOption('ignore')">
          <label>
            <input type="radio" name="neutralDays" value="ignore" checked>
            <div>
              <strong>Ignorieren</strong> ‚Äì Nur eingetragene Tage z√§hlen<br>
              <small style="color: #6b7280;">Fairste Option: Statistik basiert nur auf bekannten Daten. Bei wenig Eintr√§gen kann Quote aber k√ºnstlich hoch/niedrig sein.</small>
            </div>
          </label>
        </div>

        <div class="settings-option" onclick="selectNeutralOption('neutral')">
          <label>
            <input type="radio" name="neutralDays" value="neutral">
            <div>
              <strong>Eher positiv werten</strong> ‚Äì Wie 50% Gesundheit<br>
              <small style="color: #6b7280;">Neutrale z√§hlen als "neutral", weder gut noch schlecht. Motiviert zum Tracken, ohne zu hart zu bestrafen.</small>
            </div>
          </label>
        </div>

        <div class="settings-option" onclick="selectNeutralOption('negative')">
          <label>
            <input type="radio" name="neutralDays" value="negative">
            <div>
              <strong>Eher negativ werten</strong> ‚Äì Wie 30% Gesundheit<br>
              <small style="color: #6b7280;">Nicht tracken = kleine Strafe (30% Gesundheit, √§hnlich Moderat).<br>
              <strong>Motivation:</strong> Spornt an, jeden Tag zu tracken!</small>
            </div>
          </label>
        </div>

        <div class="settings-option" onclick="selectNeutralOption('very-negative')">
          <label>
            <input type="radio" name="neutralDays" value="very-negative">
            <div>
              <strong>Sehr negativ werten</strong> ‚Äì Wie 15% Gesundheit<br>
              <small style="color: #6b7280;">Maximaler Ansporn: Nicht eingetragen = verd√§chtig. Nur f√ºr sehr disziplinierte Tracker!</small>
            </div>
          </label>
        </div>

        <div class="settings-explanation">
          üí° <strong>Tipp:</strong> Verwende "Ignorieren" f√ºr realistische Statistiken. Die Berechnung zeigt dir dann "Basierend auf X von 100 Tagen", damit du wei√üt, wie vollst√§ndig deine Daten sind.
        </div>
      </div>

      <!-- AUDIT-C Quiz -->
      <div class="audit-quiz">
        <div class="settings-title">üìù AUDIT-C Schnelltest (WHO)</div>
        <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">
          Beantworte 3 kurze Fragen zu deinem Alkoholkonsum im <strong>letzten Jahr</strong>. Dies ist ein validiertes WHO-Screening-Tool ‚Äì keine Diagnose, aber ein guter Indikator.
        </p>

        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Geschlecht (f√ºr Cut-offs):</label>
          <select id="auditGender" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px;">
            <option value="male">M√§nnlich</option>
            <option value="female">Weiblich</option>
          </select>
        </div>

        <div class="audit-question">
          <label class="audit-question-label">1. Wie oft trinken Sie alkoholhaltige Getr√§nke?</label>
          <div class="audit-options">
            <div class="audit-option"><label><input type="radio" name="auditQ1" value="0"> Nie (0 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ1" value="1"> Monatlich oder seltener (1 Punkt)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ1" value="2"> 2-4 Mal im Monat (2 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ1" value="3"> 2-3 Mal pro Woche (3 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ1" value="4"> 4 Mal pro Woche oder √∂fter (4 Punkte)</label></div>
          </div>
        </div>

        <div class="audit-question">
          <label class="audit-question-label">2. Wie viele Einheiten trinken Sie an einem typischen Tag?<br><small>(1 Einheit = 0,25l Bier / 0,1l Wein / 2cl Schnaps)</small></label>
          <div class="audit-options">
            <div class="audit-option"><label><input type="radio" name="auditQ2" value="0"> 1 oder 2 (0 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ2" value="1"> 3 oder 4 (1 Punkt)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ2" value="2"> 5 oder 6 (2 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ2" value="3"> 7, 8 oder 9 (3 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ2" value="4"> 10 oder mehr (4 Punkte)</label></div>
          </div>
        </div>

        <div class="audit-question">
          <label class="audit-question-label">3. Wie oft trinken Sie sechs oder mehr Einheiten an einem Anlass?</label>
          <div class="audit-options">
            <div class="audit-option"><label><input type="radio" name="auditQ3" value="0"> Nie (0 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ3" value="1"> Weniger als monatlich (1 Punkt)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ3" value="2"> Monatlich (2 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ3" value="3"> W√∂chentlich (3 Punkte)</label></div>
            <div class="audit-option"><label><input type="radio" name="auditQ3" value="4"> T√§glich oder fast t√§glich (4 Punkte)</label></div>
          </div>
        </div>

        <button class="btn" style="width: 100%; margin-top: 16px;" onclick="calculateAuditScore()">Ergebnis berechnen</button>

        <div id="auditResult" style="display: none;"></div>
      </div>

      <button class="btn secondary" style="margin-top: 24px; width: 100%;" onclick="toggleChartPopup()">Schlie√üen</button>
    </div>

    <!-- Einstellungs-Popup -->
    <div class="settings-popup-overlay" id="settingsOverlay" onclick="toggleSettingsPopup()"></div>
    <div id="settingsPopup" class="settings-popup" aria-hidden="true">
      <div class="settings-title">‚öôÔ∏è Einstellungen</div>
      <div class="settings-subtitle">Passe die Bewertung an deine Bed√ºrfnisse an</div>

      <div class="settings-section">
        <div class="settings-section-title">üß† God-Modus (detailliertes Tracking)</div>
        <div class="settings-description">
          Aktiviere eine feingranulare Eingabe (Getr√§nketyp, Menge, Portionen, Sport, Marijuana) und eine erweiterte Analyse im Statistik-Popup.
        </div>
        <label class="settings-option" id="gmEnableOption">
          <input type="checkbox" id="gmEnableCheckbox" />
          <div class="settings-option-content">
            <div class="settings-option-title">God-Modus aktivieren</div>
            <div class="settings-option-desc">Zeige im Tages-Editor eine detaillierte Eingabe. Auto-Speichern beim Kategorienwechsel wird im God-Modus deaktiviert, damit du erst ‚ÄûAbsenden‚Äú dr√ºcken kannst.</div>
          </div>
        </label>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üéØ Wie sollen nicht eingetragene Tage bewertet werden?</div>
        <div class="settings-description">
          Tage ohne Eintrag (wei√üe Felder im Kalender) k√∂nnen die Statistik verf√§lschen. 
          W√§hle, wie diese "neutralen" Tage in die Gesundheitsbewertung einflie√üen sollen:
        </div>

        <div class="settings-options">
          <label class="settings-option" id="option-ignore">
            <input type="radio" name="neutralDays" value="ignore" checked>
            <div class="settings-option-content">
              <div class="settings-option-title">üéØ Ignorieren (Empfohlen)</div>
              <div class="settings-option-desc">
                Nur eingetragene Tage z√§hlen. Deine Quote wird realistischer berechnet.<br>
                <strong>Beispiel:</strong> 10 Alkohol + 5 Alkoholfrei von 15 Eintr√§gen = 67% Binge-N√§he ‚Üí Alarm!
              </div>
            </div>
          </label>

          <label class="settings-option" id="option-neutral">
            <input type="radio" name="neutralDays" value="neutral">
            <div class="settings-option-content">
              <div class="settings-option-title">‚öñÔ∏è Als neutral werten</div>
              <div class="settings-option-desc">
                Neutrale Tage werden wie "leicht positiv" (50% Gesundheit) gewertet.<br>
                <strong>Beispiel:</strong> 10 Alkohol + 90 leer = 10% Binge-N√§he (milder)
              </div>
            </div>
          </label>

          <label class="settings-option" id="option-negative">
            <input type="radio" name="neutralDays" value="negative">
            <div class="settings-option-content">
              <div class="settings-option-title">‚ö†Ô∏è Als eher negativ werten</div>
              <div class="settings-option-desc">
                Nicht tracken = kleine Strafe (30% Gesundheit, √§hnlich Moderat).<br>
                <strong>Motivation:</strong> Spornt an, jeden Tag zu tracken!
              </div>
            </div>
          </label>

          <label class="settings-option" id="option-very-negative">
            <input type="radio" name="neutralDays" value="very-negative">
            <div class="settings-option-content">
              <div class="settings-option-title">üö® Als sehr negativ werten</div>
              <div class="settings-option-desc">
                Nicht tracken = deutliche Strafe (15% Gesundheit, fast wie Alkohol).<br>
                <strong>Strikt:</strong> Maximale Motivation f√ºr t√§gliches Tracking!
              </div>
            </div>
          </label>
        </div>

        <div class="settings-info-box">
          üí° <strong>Tipp:</strong> Wenn du erst seit kurzem trackst, w√§hle "Ignorieren". 
          So werden nur deine tats√§chlichen Eintr√§ge bewertet und die Statistik ist realistischer.<br><br>
          üìä Die Anzeige zeigt dir immer: "Basierend auf X von 100 Tagen"
        </div>
      </div>

      <!-- Backup & Wiederherstellung -->
      <div class="settings-section">
        <div class="settings-section-title">üóÑÔ∏è Daten-Backup (lokal)</div>
        <div class="settings-description">
          Export/Import laufen ausschlie√ülich im Browser. Es werden <strong>keine</strong> Daten hochgeladen.
        </div>
        <div class="submit-row" style="margin-top: 8px;">
          <button class="btn secondary" onclick="exportData()">üì§ Daten exportieren</button>
          <button class="btn secondary" onclick="importData()">üì• Daten importieren</button>
        </div>
        <p class="settings-description" style="margin-top:10px;">
          Hinweis: Beim Import werden vorhandene Tage <em>gemerged</em> (gleiche Tage werden √ºberschrieben).
        </p>
      </div>
      <button class="btn" style="width: 100%;" onclick="saveSettings()">Einstellungen speichern</button>
    </div>

    <footer>¬© 2025 by R. Duwenbeck</footer>
  </div>

  <script>
    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let dayData = {};
    let editingDate = null;
    let storageWorking = false;
    let neutralDaysSetting = 'ignore'; // Default: Ignorieren
    let godModeEnabled = false;       // NEW

    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays   = ['Mo','Di','Mi','Do','Fr','Sa','So'];

    const formatDateKey = (date)=> `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;

    // Helper (compat)
    const getDayStatus = (key) => {
      const data = dayData[key];
      if(!data) return null;
      return typeof data === 'string' ? data : data.status;
    };
    const getDayComment = (key) => {
      const data = dayData[key];
      if(!data || typeof data === 'string') return '';
      return data.comment || '';
    };
    const getDayGodExtras = (key) => {
      const data = dayData[key];
      if(!data || typeof data === 'string') return {};
      const { alcohol, marijuana, sport } = data;
      return { alcohol, marijuana, sport };
    };
    const setDayData = (key, status, comment = '', extras = null) => {
      const base = { status, comment };
      if(extras && typeof extras === 'object'){
        if(extras.alcohol) base.alcohol = extras.alcohol;
        if(extras.marijuana) base.marijuana = extras.marijuana;
        if(typeof extras.sport !== 'undefined') base.sport = !!extras.sport;
      }
      dayData[key] = base;
    };
    const formatDisplayDate = (date)=> `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    /* Storage */
    function testStorage(){ try{ localStorage.setItem('__test__','1'); localStorage.removeItem('__test__'); storageWorking = true; }catch{ storageWorking=false; } }
    function updateStorageStatus(message){
      const status = document.getElementById('storageStatus');
      const count  = document.getElementById('savedDaysCount');
      if(status) status.textContent = message ?? '';
      if(count)  count.textContent  = Object.keys(dayData).length;
    }
    function saveData(){
      if(!storageWorking){ updateStorageStatus('‚ùå Speichern nicht m√∂glich'); return false; }
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
          neutralDays: neutralDaysSetting,
          godMode: godModeEnabled
        }));
        updateStorageStatus('‚úÖ Daten gespeichert'); return true;
      }catch{ updateStorageStatus('‚ùå Speicher-Fehler'); return false; }
    }
    function loadData(){
      if(!storageWorking){ updateStorageStatus('‚ö†Ô∏è Kein persistenter Speicher'); return; }
      try{
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        currentInputDate = new Date();

        // Settings laden
        const savedSettings = localStorage.getItem('alcoholTrackerSettings');
        if(savedSettings){
          const s = JSON.parse(savedSettings);
          neutralDaysSetting = s.neutralDays || 'ignore';
          godModeEnabled = !!s.godMode;
        } else {
          // Fallback zu anderem Key, falls vorhanden
          const legacy = localStorage.getItem('boozeTrackerSettings');
          if(legacy){
            const s2 = JSON.parse(legacy);
            neutralDaysSetting = s2.neutralDays || 'ignore';
          }
        }
        // UI anpassen
        const gmCheckbox = document.getElementById('gmEnableCheckbox');
        if(gmCheckbox){ gmCheckbox.checked = godModeEnabled; }
        toggleGodModeUI(godModeEnabled);

        updateStorageStatus(`‚úÖ ${Object.keys(dayData).length} Tage geladen`);
      }catch{
        dayData = {}; currentInputDate = new Date(); updateStorageStatus('‚ùå Laden fehlgeschlagen');
      }
    }

    /* Erfolgsquote */
    function setSuccessCardTint(pct){
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if(pct < 50)      card.classList.add('rate-bad');
      else if(pct < 75) card.classList.add('rate-warn');
      else              card.classList.add('rate-good');
    }
    function calculateSuccessRate(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      let total=0, max=0;
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const key = formatDateKey(new Date(y,m,d));
        const st = getDayStatus(key);
        if(!st) continue;
        max += 1;
        if(st==='superday') total += 1.0;
        else if(st==='wellness') total += 0.9;
        else if(st==='sober') total += 0.75;
        else if(st==='moderate') total += 0.4;
        else if(st==='mixed') total += 0.25;
      }
      const pct = max>0 ? Math.round((total/max)*100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      setSuccessCardTint(pct);
    }

    /* 100 Tage Balken */
    function calculate100DaysChart(){
      let negative = 0; // alcohol, mixed, moderate
      let positive = 0; // sober, wellness, superday
      const today = new Date();
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = getDayStatus(formatDateKey(probe));
        if(st === 'alcohol' || st === 'mixed' || st === 'moderate'){ negative++; }
        else if(st === 'sober' || st === 'wellness' || st === 'superday'){ positive++; }
      }
      const negPct = Math.round((negative / 100) * 100);
      const posPct = Math.round((positive / 100) * 100);
      setTimeout(() => {
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 100);
    }

    /* Gesundheitsbewertung (Basis) */
    function calculateHealthAssessment(){
      const today = new Date();
      let counts = { superday:0, wellness:0, sober:0, moderate:0, mixed:0, alcohol:0, empty:0 };
      const last100Days = [];
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        last100Days.push(st || null);
        if(st && counts[st] !== undefined) counts[st]++; else if(!st) counts.empty++;
      }
      const enteredDays = 100 - counts.empty;

      // Neutral-Tage Verhalten
      let divisor = 100;
      let neutralWeight = 0;
      if(neutralDaysSetting === 'ignore'){ divisor = enteredDays > 0 ? enteredDays : 1; }
      else if(neutralDaysSetting === 'neutral'){ neutralWeight = 0.5; }
      else if(neutralDaysSetting === 'negative'){ neutralWeight = 0.3; }
      else if(neutralDaysSetting === 'very-negative'){ neutralWeight = 0.15; }

      const afCount = counts.superday + counts.wellness + counts.sober;
      const afQuote = afCount / divisor;

      const weightedScore = (
        counts.superday * 1.0 +
        counts.wellness * 0.9 +
        counts.sober * 0.75 +
        counts.moderate * 0.4 +
        counts.mixed * 0.25 +
        counts.alcohol * 0.0 +
        counts.empty * neutralWeight
      ) / 100;

      const bingeProximity = counts.alcohol + counts.mixed;
      const bingeQuote = bingeProximity / divisor;

      // Cluster
      let maxCluster = 0, currentCluster = 0;
      for(let i = 0; i < last100Days.length; i++){
        const st = last100Days[i];
        if(st === 'alcohol' || st === 'mixed'){
          currentCluster++;
          if(currentCluster > maxCluster) maxCluster = currentCluster;
        } else { currentCluster = 0; }
      }

      // Label
      let label, badgeClass, description, warning, humorQuote;
      if(bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10)){
        label = 'üö® Sucht-Alarm: Rote Lampen!'; badgeClass = 'red';
        description = '<strong>Sehr hohes Risiko / Potenzielle Abh√§ngigkeit</strong> ‚Äì Binge-N√§he (‚â•40/100) oder AF-Quote <20% zeigt extremes Risiko.';
        warning = 'üÜò Professionelle Hilfe empfohlen.';
      } else if((bingeProximity >= 20 && bingeProximity < 40) || (afQuote < 0.30 && afQuote >= 0.20) || (bingeQuote >= 0.20 && enteredDays >= 10)){
        label = 'üé≤ Risiko-Roulette'; badgeClass = 'red';
        description = '<strong>Hohes Risiko</strong> ‚Äì Mehrere Hochrisiko-Tage pro Woche.';
        humorQuote = 'üí° Sport ‚â† Gegengift.';
        warning = 'üö® √Ñrztliche Beratung dringend erw√§gen.';
      } else if(afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)){
        label = 'üö® Kipppunkt-Kandidat'; badgeClass = 'weekend';
        description = '<strong>Erh√∂htes Risiko</strong> ‚Äì W√∂chentliche Rauschmuster erkennbar.';
        warning = '‚ö†Ô∏è AUDIT-Screening machen.';
      } else if(afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12){
        label = 'üßò Balance-Buddha'; badgeClass = 'balance';
        description = '<strong>Moderates Risiko</strong> ‚Äì Grunds√§tzliche Balance, Binge eher selten.';
      } else {
        label = 'ü¶∏ Leber-Superheld'; badgeClass = 'zen';
        description = '<strong>Niedriges Gesamtrisiko</strong> ‚Äì Viele alkoholfreie Tage, seltene Ausrutscher.';
      }

      let extraWarnings = '';
      if(maxCluster >= 3){
        extraWarnings += '<br>üî• <strong>Cluster erkannt:</strong> ' + maxCluster + ' Hochrisiko-Tage am St√ºck.';
      }
      if(counts.mixed >= 15){
        extraWarnings += '<br>üíä <strong>"Schadensbegrenzung" ist keine L√∂sung:</strong> ' + counts.mixed + ' Tage.';
      }

      const afDisplay = neutralDaysSetting === 'ignore' ? 
        `${Math.round(afQuote * 100)}% (${afCount}/${enteredDays})` : 
        `${Math.round(afQuote * 100)}%`;
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore * 100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? 
        `${bingeProximity} (${Math.round(bingeQuote * 100)}%)` : 
        bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster > 0 ? maxCluster + ' Tage' : 'Keiner';

      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label;
      badge.className = 'assessment-badge ' + badgeClass;

      const basisInfo = neutralDaysSetting === 'ignore' ? 
        `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">üìä Basierend auf <strong>${enteredDays} von 100 Tagen</strong></div>` :
        `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">üìä Basierend auf <strong>100 Tagen</strong> (${enteredDays} eingetragen, ${counts.empty} neutral gewertet)</div>`;
      document.getElementById('assessmentDescription').innerHTML = basisInfo + description + (humorQuote ? '<br><br>' + humorQuote : '');

      const warningEl = document.getElementById('assessmentWarning');
      if(warning || extraWarnings){
        warningEl.innerHTML = (warning || '') + extraWarnings;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }

      // God-Mode Detail Panel sichtbar schalten (nur wenn aktiviert)
      const toggleWrap = document.getElementById('godAnalysisToggleWrapper');
      if(toggleWrap){ toggleWrap.style.display = godModeEnabled ? 'block' : 'none'; }
      if(godModeEnabled){ computeGodModeDetailedAnalysis(); }
    }

    /* Streak */
    function setStreakCardTint(streak){
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      if(streak >= 30)      card.classList.add('streak-great');
      else if(streak >= 21) card.classList.add('streak-good');
      else if(streak >= 11) card.classList.add('streak-warn');
      else if(streak >= 1)  card.classList.add('streak-bad');
      numEl.textContent = String(streak) + (streak>=30 ? ' üéâ' : '');
    }
    function isGreen(state){ return state==='sober' || state==='superday' || state==='wellness'; }
    function calculateStreak(){
      let probe = new Date(); let streak = 0;
      while(true){
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if(isGreen(st)){ streak++; probe.setDate(probe.getDate()-1); }
        else { break; }
        if(streak > 1000) break;
      }
      setStreakCardTint(streak);
    }

    /* Views */
    function updateDayInputView(){
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      updateStorageStatus(`üç∑ ${Object.keys(dayData).length} Tage`);
      const key = formatDateKey(currentInputDate);
      const existing = getDayStatus(key);
      const existingComment = getDayComment(key);
      const btn = document.getElementById('submitDay');
      document.getElementById('dayCommentInput').value = existingComment || '';

      if(existing){
        const radio = document.querySelector(`input[name="dayChoice"][value="${existing}"]`);
        if(radio) radio.checked = true;
        btn.disabled = false;
        btn.textContent = 'Tag aktualisieren';
      }else{
        document.querySelectorAll('input[name="dayChoice"]').forEach(r=> r.checked=false);
        btn.textContent = 'Tag speichern';
        btn.disabled = true;
      }

      // God-Mode Felder vorf√ºllen
      if(godModeEnabled){ fillGodModeInputsFromData(key); }
    }

    function showMonthView(){
      currentViewDate = new Date(currentInputDate);
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }
    function showDayInput(){
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      closeEditPopup();
    }

    /* Monatsgrid */
    function updateMonthView(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      const wds = ['Mo','Di','Mi','Do','Fr','Sa','So'];
      for(const w of wds){
        const h = document.createElement('div');
        h.className = 'weekday';
        h.textContent = w;
        grid.appendChild(h);
      }

      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);
      const startDay = (first.getDay()+6)%7;

      for(let i=0;i<startDay;i++){
        const e = document.createElement('div');
        e.className='day';
        e.style.visibility='hidden';
        grid.appendChild(e);
      }

      const today = new Date();
      for(let d=1; d<=last.getDate(); d++){
        const dt = new Date(y, m, d);
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.textContent = d;
        cell.dataset.y = String(y);
        cell.dataset.m = String(m);
        cell.dataset.d = String(d);

        const key = formatDateKey(dt);
        const st = getDayStatus(key);
        const comment = getDayComment(key);
        
        if(st) cell.classList.add(st);
        if(dt.toDateString() === today.toDateString()) cell.classList.add('today');
        
        if(comment){
          cell.classList.add('has-comment');
          const tooltip = document.createElement('div');
          tooltip.className = 'day-comment-tooltip';
          tooltip.textContent = comment;
          cell.appendChild(tooltip);
        }

        grid.appendChild(cell);
      }
    }

    /* Event-Delegation f√ºr Kalendertage */
    document.addEventListener('click', (e)=>{
      const grid = document.getElementById('monthGrid');
      if(!grid || !grid.contains(e.target)) return;
      const cell = e.target.closest('.day');
      if(!cell) return;
      if(cell.style.visibility === 'hidden') return;

      const y = Number(cell.dataset.y);
      const m = Number(cell.dataset.m);
      const d = Number(cell.dataset.d);
      if(Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return;

      openEditPopup(new Date(y,m,d));
    });

    /* Edit */
    function openEditPopup(date){
      editingDate = date;
      document.getElementById('editDate').textContent = formatDisplayDate(date);
      const key = formatDateKey(date);
      const comment = getDayComment(key);
      document.getElementById('editCommentInput').value = comment || '';
      const pop = document.getElementById('editPopup');
      pop.classList.add('active');
      pop.setAttribute('aria-hidden','false');
    }
    function closeEditPopup(){
      const pop = document.getElementById('editPopup');
      pop.classList.remove('active');
      pop.setAttribute('aria-hidden','true');
      editingDate = null;
    }
    function openInDayEditor(){
      if(!editingDate) return;
      currentInputDate = new Date(editingDate);
      closeEditPopup();
      showDayInput();
      updateDayInputView();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* Neutral Days Einstellung */
    function selectNeutralOption(option){
      neutralDaysSetting = option;
      const settings = JSON.parse(localStorage.getItem('boozeTrackerSettings') || '{}');
      settings.neutralDays = option;
      localStorage.setItem('boozeTrackerSettings', JSON.stringify(settings));
      document.querySelectorAll('.settings-option').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('input[name="neutralDays"]').forEach(el => {
        el.checked = (el.value === option);
        if(el.checked) el.closest('.settings-option').classList.add('selected');
      });
      calculateHealthAssessment();
    }

    /* AUDIT-C Score */
    function calculateAuditScore(){
      const q1 = parseInt(document.querySelector('input[name="auditQ1"]:checked')?.value);
      const q2 = parseInt(document.querySelector('input[name="auditQ2"]:checked')?.value);
      const q3 = parseInt(document.querySelector('input[name="auditQ3"]:checked')?.value);
      if(isNaN(q1) || isNaN(q2) || isNaN(q3)){ alert('Bitte beantworte alle 3 Fragen!'); return; }
      const score = q1 + q2 + q3;
      const gender = document.getElementById('auditGender').value;
      let risk, riskClass, riskText;
      if(score === 0){ risk='Niedriges Risiko'; riskClass='low'; riskText='Abstinenz oder sehr geringer Konsum.'; }
      else if((gender === 'female' && score < 3) || (gender === 'male' && score < 4)){ risk='Geringes Risiko'; riskClass='low'; riskText='Unterer Bereich. Ma√ühalten beibehalten.'; }
      else if(score < 5){ risk='Riskanter Konsum'; riskClass='medium'; riskText='Potentiell gesundheitssch√§dlich. Reduziere Menge/Frequenz.'; }
      else { risk='Hohes Risiko'; riskClass='high'; riskText='Hohes Risiko f√ºr AUD. Professionelle Beratung empfohlen.'; }

      const resultDiv = document.getElementById('auditResult');
      resultDiv.className = 'audit-result ' + riskClass;
      resultDiv.innerHTML = `
        <strong>AUDIT-C Score: ${score} von 12</strong>
        <strong style="font-size: 14px; margin-top: 8px; display: block;">${risk}</strong>
        ${riskText}
        <br><br>
        <small><strong>Wichtig:</strong> Screening ‚Äì keine Diagnose.</small>
      `;
      resultDiv.style.display = 'block';
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /* Chart Popup */
    function toggleChartPopup(){
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');
      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        calculate100DaysChart();
        calculateHealthAssessment();
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if(radio){ radio.checked = true; radio.closest('.settings-option').classList.add('selected'); }
        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
      }
    }

    /* Settings Popup */
    function toggleSettingsPopup(){
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');
      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if(radio) radio.checked = true;
        document.getElementById('gmEnableCheckbox').checked = godModeEnabled;
        updateSettingsUI();
        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
      }
    }

    function updateSettingsUI(){
      document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
      const selectedOption = document.querySelector(`input[name="neutralDays"]:checked`);
      if(selectedOption){ selectedOption.closest('.settings-option').classList.add('selected'); }
      if(godModeEnabled){ document.getElementById('gmEnableOption').classList.add('selected'); }
    }

    function saveSettings(){
      const selected = document.querySelector('input[name="neutralDays"]:checked');
      if(selected){ neutralDaysSetting = selected.value; }
      godModeEnabled = !!document.getElementById('gmEnableCheckbox').checked;
      saveData();
      toggleSettingsPopup();
      toggleGodModeUI(godModeEnabled);
      alert('‚úÖ Einstellungen gespeichert!');
    }

    /* Update Day via Edit-Popup */
    function updateDay(action){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      if(action === 'delete'){ delete dayData[key]; }
      else {
        const pendingComment = (document.getElementById('editCommentInput').value || '').trim();
        const prev = getDayGodExtras(key);
        setDayData(key, action, pendingComment, prev); // Extras erhalten
      }
      saveData();
      closeEditPopup();
      updateMonthView(); calculateStreak(); calculateSuccessRate();
    }
    function saveEditComment(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const comment = document.getElementById('editCommentInput').value.trim();
      const existingStatus = getDayStatus(key);
      if(existingStatus){
        const prev = getDayGodExtras(key);
        setDayData(key, existingStatus, comment, prev);
        saveData(); updateMonthView();
        const btn = event.target; const originalText = btn.textContent;
        btn.textContent = '‚úÖ Gespeichert!'; setTimeout(() => btn.textContent = originalText, 1200);
      }
      closeEditPopup();
    }

    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }
    function nextMonth(){     currentViewDate.setMonth(currentViewDate.getMonth()+1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }

    /* Save day (uses currentInputDate) */
    function saveDay(){
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if(!selected) return;
      const key = formatDateKey(currentInputDate);
      const comment = (document.getElementById('dayCommentInput').value || '').trim();

      // Extras (God-Mode)
      let extras = null;
      if(godModeEnabled){
        const { grams, drinks, liters, abv, type, mlPerPortion, portions } = computeAlcoholFromInputs();
        const weedGrams = parseFloat(document.getElementById('gmWeedGrams').value || '0') || 0;
        const weedFreq = document.getElementById('gmWeedFreq').value || '';
        const sport = !!document.getElementById('gmDidSport').checked;
        extras = {
          alcohol: grams > 0 ? { grams, drinks, liters, abv, type, mlPerPortion, portions } : undefined,
          marijuana: (weedGrams>0 || weedFreq) ? { grams: weedGrams, frequency: weedFreq } : undefined,
          sport
        };
      }

      setDayData(key, selected.value, comment, extras);
      saveData();

      document.getElementById('submitDay').disabled = true;

      // Zur Monatsansicht
      showMonthView();
    }

    function resetStorage(){
      const ok = confirm('‚ö†Ô∏è Wirklich ALLE lokalen Daten (Tage + Einstellungen) l√∂schen und neu starten?');
      if(!ok) return;
      try{
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerCurrentDate');
        localStorage.removeItem('alcoholTrackerSettings');
      }catch(e){ console.warn('LocalStorage-Bereinigung fehlgeschlagen:', e); }
      location.reload();
    }

    // Expose
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openEditPopup = openEditPopup;
    window.closeEditPopup = closeEditPopup;
    window.updateDay = updateDay;
    window.resetStorage = resetStorage;
    window.toggleChartPopup = toggleChartPopup;
    window.openInDayEditor = openInDayEditor;

    // ---------- GOD-MODUS: Logik ----------
    function toggleGodModeUI(enabled){
      const sec = document.getElementById('godModeSection');
      if(sec){ sec.style.display = enabled ? 'block' : 'none'; sec.setAttribute('aria-hidden', enabled ? 'false' : 'true'); }
      // Auto-Save beim Kategorienwechsel nur im Normalmodus
      bindRadioAutoSave();
      // Toggle im Chart-Popup (Details)
      const tog = document.getElementById('godAnalysisToggleWrapper');
      if(tog){ tog.style.display = enabled ? 'block' : 'none'; }
    }

    function computeAlcoholFromInputs(){
      const [type, abvStr] = (document.getElementById('gmDrinkType').value || 'beer|0.05').split('|');
      const abv = parseFloat(abvStr || '0');
      const mlPerPortion = parseFloat(document.getElementById('gmMlPerPortion').value || '0') || 0;
      const portions = parseFloat(document.getElementById('gmPortions').value || '0') || 0;
      const liters = (mlPerPortion * portions) / 1000; // L
      const grams = +(liters * abv * 0.789 * 1000).toFixed(1); // g Alkohol
      const drinks = +(grams / 10).toFixed(1); // DE-Standarddrink = 10g
      // UI Output
      const out = document.getElementById('gmCalcOut');
      if(out){ out.textContent = `${grams} g ¬∑ ${drinks} Drinks`; }
      return { grams, drinks, liters:+liters.toFixed(3), abv, type, mlPerPortion, portions };
    }

    function fillGodModeInputsFromData(key){
      const { alcohol, marijuana, sport } = getDayGodExtras(key);
      // Defaults
      document.getElementById('gmDrinkType').value = 'beer|0.05';
      document.getElementById('gmMlPerPortion').value = '';
      document.getElementById('gmPortions').value = '';
      document.getElementById('gmWeedGrams').value = '';
      document.getElementById('gmWeedFreq').value = '';
      document.getElementById('gmDidSport').checked = false;

      if(alcohol){
        // try to map back type/abv
        const type = alcohol.type || 'beer';
        const abv = (typeof alcohol.abv === 'number') ? alcohol.abv : 0.05;
        const selectVal = `${type}|${abv}`;
        const sel = document.getElementById('gmDrinkType');
        // if option not exists, keep current
        if([...sel.options].some(o => o.value === selectVal)) sel.value = selectVal;
        document.getElementById('gmMlPerPortion').value = alcohol.mlPerPortion ?? '';
        document.getElementById('gmPortions').value = alcohol.portions ?? '';
      }
      if(marijuana){
        document.getElementById('gmWeedGrams').value = marijuana.grams ?? '';
        document.getElementById('gmWeedFreq').value = marijuana.frequency ?? '';
      }
      if(typeof sport !== 'undefined'){ document.getElementById('gmDidSport').checked = !!sport; }
      computeAlcoholFromInputs();
    }

    function proposeCategoryFromDetails(){
      const { grams } = computeAlcoholFromInputs();
      const didSport = !!document.getElementById('gmDidSport').checked;
      let proposed = null;
      const BINGE_GRAMS = 40;
      const MODERATE_MAX = 20;

      if(grams > 0){
        if(didSport){ proposed = 'mixed'; }
        else if(grams > BINGE_GRAMS){ proposed = 'alcohol'; }
        else if(grams <= MODERATE_MAX){ proposed = 'moderate'; }
        else { proposed = 'alcohol'; }
      } else {
        // keine automatische Zuweisung in die "gr√ºnen" Kategorien ‚Äì User w√§hlt selbst
        proposed = null;
      }

      if(proposed){
        const radio = document.querySelector(`input[name="dayChoice"][value="${proposed}"]`);
        if(radio){ radio.checked = true; document.getElementById('submitDay').disabled = false; }
        toastMini(`‚úÖ Vorgeschlagene Kategorie: ${labelFor(proposed)}`);
      } else {
        toastMini('‚ÑπÔ∏è 0 g Alkohol ‚Äì w√§hle manuell eine passende (gr√ºne) Kategorie.');
      }
    }

    function labelFor(val){
      return ({
        superday:'Supertag', wellness:'Wellness', sober:'Alkoholfrei',
        moderate:'Moderat', mixed:'Schadensbegrenzung', alcohol:'Alkohol'
      })[val] || val;
    }

    function toastMini(text){
      // simpler Mini-Hinweis
      const el = document.createElement('div');
      el.textContent = text;
      el.style.position='fixed'; el.style.bottom='18px'; el.style.left='50%';
      el.style.transform='translateX(-50%)';
      el.style.background='#111827'; el.style.color='#fff'; el.style.padding='10px 14px';
      el.style.fontSize='13px'; el.style.borderRadius='10px'; el.style.boxShadow='0 10px 24px rgba(0,0,0,.25)';
      el.style.zIndex='2000';
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .4s'; }, 1200);
      setTimeout(()=> el.remove(), 1700);
    }

    // Bindings
    function bindGodModeInputs(){
      ['gmDrinkType','gmMlPerPortion','gmPortions'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.addEventListener('input', computeAlcoholFromInputs); el.addEventListener('change', computeAlcoholFromInputs); }
      });
      const sug = document.getElementById('gmSuggestBtn');
      if(sug){ sug.onclick = proposeCategoryFromDetails; }
      const saveBtn = document.getElementById('gmSaveBtn');
      if(saveBtn){ saveBtn.onclick = ()=>{ if(!document.querySelector('input[name="dayChoice"]:checked')) proposeCategoryFromDetails(); saveDay(); }; }
      const toggleBtn = document.getElementById('toggleDetailedBtn');
      if(toggleBtn){
        toggleBtn.onclick = ()=>{
          const panel = document.getElementById('godAnalysisPanel');
          const open = panel.style.display !== 'none';
          panel.style.display = open ? 'none' : 'block';
          toggleBtn.textContent = open ? 'üß† Detaillierte Analyse anzeigen' : 'üß† Detaillierte Analyse ausblenden';
        };
      }
    }

    function bindRadioAutoSave(){
      // Entferne alte Listener: einfacher Ansatz ‚Äì rebind via clone
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        const fresh = radio.cloneNode(true);
        radio.parentNode.replaceChild(fresh, radio);
      });
      // Binde neu:
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        freshRadioHandler(radio);
      });
      function freshRadioHandler(radio){
        radio.addEventListener('change', ()=>{
          // Im God-Mode NICHT auto-speichern (Button nutzen)
          if(!godModeEnabled){
            saveDay();
          } else {
            document.getElementById('submitDay').disabled = false;
          }
        });
      }
    }

    /* ---------- Detaillierte Analyse (God-Mode) ---------- */
    function computeGodModeDetailedAnalysis(){
      const today = new Date();
      const gramsByDay = [];
      const drinksByDay = [];
      const weedByDay = [];
      let detailedCount = 0;

      const fallbackGrams = { superday:0, wellness:0, sober:0, moderate:20, mixed:40, alcohol:50 };

      for(let i=0; i<100; i++){
        const probe = new Date(today); probe.setDate(probe.getDate() - i);
        const key = formatDateKey(probe);
        const data = dayData[key];
        let grams = 0, drinks = 0, weed = 0;
        if(data && typeof data === 'object' && data.alcohol && typeof data.alcohol.grams === 'number'){
          grams = data.alcohol.grams || 0;
          drinks = (typeof data.alcohol.drinks === 'number') ? data.alcohol.drinks : (grams/10);
          detailedCount++;
        } else {
          const st = getDayStatus(key);
          grams = fallbackGrams[st] ?? 0;
          drinks = grams/10;
        }
        if(data && typeof data === 'object' && data.marijuana && typeof data.marijuana.grams === 'number'){
          weed = data.marijuana.grams || 0;
        }
        gramsByDay.push(grams);
        drinksByDay.push(drinks);
        weedByDay.push(weed);
      }

      // W√∂chentlich (Durchschnitt pro Woche in den letzten 100 Tagen)
      const totalGrams = gramsByDay.reduce((a,b)=>a+b,0);
      const totalDrinks = drinksByDay.reduce((a,b)=>a+b,0);
      const totalWeed = weedByDay.reduce((a,b)=>a+b,0);
      const gramsPerWeek = +( (totalGrams/100) * 7 ).toFixed(1);
      const drinksPerWeek = +( (totalDrinks/100) * 7 ).toFixed(1);
      const weedPerWeek = +( (totalWeed/100) * 7 ).toFixed(1);

      // Binge/Cluster
      const BINGE = 40, HIGH = 20;
      const bingeDays = gramsByDay.filter(g=>g>BINGE).length;
      let longestCluster = 0, cur=0;
      gramsByDay.forEach(g=>{
        if(g>HIGH){ cur++; if(cur>longestCluster) longestCluster=cur; } else { cur=0; }
      });

      // Muster
      let friSatGrams=0, friSatCount=0, otherGrams=0, otherCount=0;
      for(let i=0; i<100; i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        const dow = d.getDay(); // 0 So ... 6 Sa
        const g = gramsByDay[i];
        if(dow===5 || dow===6){ friSatGrams += g; friSatCount++; } else { otherGrams += g; otherCount++; }
      }
      const avgWeekend = friSatCount? friSatGrams/friSatCount : 0;
      const avgOther = otherCount? otherGrams/otherCount : 0;
      const weekendBinger = (avgWeekend > 1.5*avgOther) && (bingeDays>0);

      const dailyLowCount = gramsByDay.filter(g=>g>0 && g<=20).length;
      const zeros = gramsByDay.filter(g=>g===0).length;
      const abstinentWithSlips = (zeros>=80 && bingeDays>=1 && bingeDays<=4);
      const dailyLow = (dailyLowCount>=70 && bingeDays<=5);

      let pattern = '‚Äî';
      if(weekendBinger) pattern = 'Weekend-Binger';
      else if(dailyLow) pattern = 'Daily Low';
      else if(abstinentWithSlips) pattern = 'Abstinent mit Slips';

      // Scores (0-100 = gut)
      const qHealth = clamp(100 - (gramsPerWeek/80*100), 0, 100); // 80 g/Woche = schlecht
      const bcRiskPct = clamp((bingeDays/30)*100, 0, 100); // 30/100 = sehr schlecht
      const clusterPenalty = Math.max(0, (longestCluster-2)*5); // ab 3 Tage je +5% Risiko
      const bcHealth = clamp(100 - (bcRiskPct + clusterPenalty), 0, 100);
      let mjPenalty = 0;
      if(weedPerWeek>2) mjPenalty = 20;
      else if(weedPerWeek>1) mjPenalty = 10;
      else if(weedPerWeek>0.5) mjPenalty = 5;
      const mjHealth = clamp(100 - mjPenalty, 0, 100);

      // Kategorie-Score als Fallback
      const catHealth = parseInt((document.getElementById('metricHealth').textContent || '0').replace('%','')) || 0;

      let coverage = detailedCount; // Tage mit echten Detaildaten
      let blend = 1.0;
      if(coverage < 20) blend = 0.5;
      else if(coverage < 50) blend = 0.7;

      const combinedHealth = Math.round(
        blend*(0.5*qHealth + 0.3*bcHealth + 0.2*mjHealth) + (1-blend)*catHealth
      );

      // Stufen (1..5)
      let stage = 3, stageLabel='Kipppunkt-Wanderer', sClass='stage-3', sText='';
      if(gramsPerWeek<10 && bingeDays===0 && longestCluster===0 && weedPerWeek<0.5){
        stage=1; stageLabel='Zen-Meister'; sClass='stage-1';
        sText='Sehr niedrige Mengen, keine Binge-Ereignisse, kaum/kein Marijuana.';
      } else if(gramsPerWeek>=10 && gramsPerWeek<20 && bingeDays<5 && longestCluster<3){
        stage=2; stageLabel='Balance-K√ºnstler'; sClass='stage-2';
        sText='Meist ma√üvoll, seltene Ausrei√üer.';
      } else if((gramsPerWeek>=20 && gramsPerWeek<40) || (bingeDays>=5 && bingeDays<=15) || (longestCluster>=3 && longestCluster<=5) || (weedPerWeek>=0.5 && weedPerWeek<=2)){
        stage=3; stageLabel='Kipppunkt-Wanderer'; sClass='stage-3';
        sText='Mehrere Warnzeichen ‚Äì auf die Bremse treten.';
      } else if((gramsPerWeek>=40 && gramsPerWeek<=80) || (bingeDays>15 && bingeDays<=30) || (longestCluster>5)){
        stage=4; stageLabel='Risiko-Jongleur'; sClass='stage-4';
        sText='Hohe Last; Cluster oder h√§ufige Binges.';
      } else if(gramsPerWeek>80 || bingeDays>30 || longestCluster>7 || weedPerWeek>2){
        stage=5; stageLabel='Alarmstufe Rot'; sClass='stage-5';
        sText='Sehr hohe Belastung; starke Reduktion & Hilfe erw√§gen.';
      }

      // Ausgabe
      document.getElementById('gmMetricDrinksWeek').textContent = `${drinksPerWeek}`;
      document.getElementById('gmMetricGramsWeek').textContent = `${gramsPerWeek} g`;
      document.getElementById('gmMetricBinge100').textContent = `${bingeDays}`;
      document.getElementById('gmMetricLongestCluster').textContent = longestCluster>0 ? `${longestCluster} Tage` : '‚Äî';
      document.getElementById('gmMetricWeedWeek').textContent = `${weedPerWeek} g`;
      document.getElementById('gmMetricPattern').textContent = pattern;

      const badge = document.getElementById('gmStageBadge');
      badge.className = `stage-badge ${sClass}`;
      badge.textContent = `Stufe ${stage}: ${stageLabel} ¬∑ Gesamt-Score (0‚Äì100 gut): ${combinedHealth}`;

      const tips = {
        1:'Weiter so! Erhalte AF-Streaks, plane alkoholfreie Wochenenden.',
        2:'1‚Äì2 zus√§tzliche AF-Tage/Woche bringen dich sicher in Stufe 1.',
        3:'Reduziere Wochenend-Spitzen; setze klare Max-Drinks (‚â§2).',
        4:'Klare Regeln + Hilfe im Umfeld; Meide Trigger-Situationen.',
        5:'Sofortige Reduktionsstrategie & professionelle Hilfe erw√§gen.'
      };
      document.getElementById('gmStageText').innerHTML =
        `<strong>Kurzfazit:</strong> ${sText}<br><br><strong>Tipp:</strong> ${tips[stage]}`;

      const warn = document.getElementById('gmDetailWarning');
      if(coverage < 30){
        warn.style.display='block';
        warn.innerHTML = `‚ö†Ô∏è Nur ${coverage}/100 Tage mit genauen Mengen. <br>Gib √∂fter Details ein ‚Äì dann wird die Analyse pr√§ziser (Fallback: Kategorien = ${coverage===0?'alle':'teilweise'}).`;
      } else { warn.style.display='none'; }
    }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // ---------- Backup & Restore ----------
    function exportData(){
      try{
        const settingsRawA = localStorage.getItem('alcoholTrackerSettings');
        const settingsRawB = localStorage.getItem('boozeTrackerSettings');
        let settings = {};
        try{ if(settingsRawA) settings = JSON.parse(settingsRawA) || {}; }catch{}
        try{ if(settingsRawB) settings = { ...settings, ...(JSON.parse(settingsRawB)||{}) }; }catch{}
        settings.neutralDays = (typeof neutralDaysSetting !== 'undefined' ? neutralDaysSetting : (settings.neutralDays || 'ignore'));
        settings.godMode = godModeEnabled;

        const payload = {
          type: 'booze-tracker-backup',
          version: 2,
          exportedAt: new Date().toISOString(),
          dayData,
          settings
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url;
        a.download = 'booze-tracker-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        alert('‚úÖ Export abgeschlossen. Datei wurde heruntergeladen.');
      }catch(e){
        console.error(e);
        alert('‚ùå Export fehlgeschlagen.');
      }
    }

    function importData(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = e => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const parsed = JSON.parse(ev.target.result);
            let importedDayData;
            let importedSettings;

            if(parsed && parsed.dayData){
              importedDayData = parsed.dayData;
              importedSettings = parsed.settings || {};
            } else {
              importedDayData = parsed;
              importedSettings = {};
            }

            const isDateKey = k => /^\d{4}-\d{1,2}-\d{1,2}$/.test(k);
            const normalizeKey = (k) => {
              const [y, m, d] = k.split('-').map(n => parseInt(n, 10));
              const dt = new Date(y, m - 1, d);
              return formatDateKey(dt);
            };

            const validEntries = {};
            Object.keys(importedDayData || {}).forEach(k => {
              if (isDateKey(k)) {
                const normKey = normalizeKey(k);
                const v = importedDayData[k];
                if (typeof v === 'string') {
                  validEntries[normKey] = { status: v, comment: '' };
                } else if (v && typeof v === 'object' && typeof v.status === 'string') {
                  // Alle bekannten Felder √ºbernehmen
                  const obj = {
                    status: v.status,
                    comment: v.comment || ''
                  };
                  if(v.alcohol) obj.alcohol = v.alcohol;
                  if(v.marijuana) obj.marijuana = v.marijuana;
                  if(typeof v.sport !== 'undefined') obj.sport = !!v.sport;
                  validEntries[normKey] = obj;
                }
              }
            });

            dayData = { ...dayData, ...validEntries };

            // Settings √ºbernehmen
            const newNeutral = importedSettings.neutralDays;
            if(typeof newNeutral !== 'undefined'){ neutralDaysSetting = newNeutral; }
            if(typeof importedSettings.godMode !== 'undefined'){ godModeEnabled = !!importedSettings.godMode; }

            saveData();
            alert('‚úÖ Daten importiert. Die Ansicht wird aktualisiert.');
            location.reload();
          }catch(err){
            console.error(err);
            alert('‚ùå Ung√ºltige Datei oder JSON-Format.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    window.exportData = exportData;
    window.importData = importData;

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      testStorage();
      loadData();
      bindRadioAutoSave();
      bindGodModeInputs();

      updateDayInputView();

      // Submit Button (immer verf√ºgbar)
      document.getElementById('submitDay').addEventListener('click', ()=>{ saveDay(); });

      // Recompute alcohol outputs initially
      computeAlcoholFromInputs();
    });
  </script>
</body>
</html>
