<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }
    .app-version{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 10px;
    }

    /* Eingabe */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 6px 0 18px;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"⭐"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* Monatsübersicht */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Fortschrittsbalken */
    .chart-section{ margin:18px 0; padding:0; background:transparent; border:none; border-radius:0; }
    .chart-title{ font-weight:700; font-size:18px; margin-bottom:24px; text-align:center; color:var(--text); }
    .chart-bars{ display:flex; flex-direction:column; gap:32px; margin-bottom:10px; }
    .chart-bar-container{ display:flex; flex-direction:column; gap:12px; }
    .chart-bar-header{ display:flex; align-items:center; justify-content:space-between; }
    .chart-bar-label{ font-size:14px; font-weight:600; color:var(--text); }
    .chart-bar-label small{ display:block; font-size:12px; font-weight:400; color:var(--muted); margin-top:2px; }
    .chart-bar-value{ display:flex; align-items:baseline; gap:8px; }
    .chart-bar-number{ font-size:32px; font-weight:900; color:var(--text); }
    .chart-bar-percent{ font-size:16px; font-weight:600; color:var(--muted); }
    .chart-bar-wrapper{ height:48px; background:#f1f5f9; border-radius:12px; position:relative; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05); }
    .chart-bar{ height:100%; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); width:0%; border-radius:12px; display:flex; align-items:center; justify-content:flex-end; padding-right:16px; font-weight:700; color:white; font-size:16px; position:relative; }
    .chart-bar::after{ content:''; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0)); border-radius:12px; }
    .chart-bar.negative{ background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .chart-bar.positive{ background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    /* Gesundheitsbewertung */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{ font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--text); }
    .assessment-badge{
      text-align: center; margin-bottom: 24px; padding: 16px; border-radius: 12px; font-size: 24px; font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border: 2px solid #34d399; }
    .assessment-badge.balance{ background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #fbbf24; }
    .assessment-badge.weekend{ background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; border: 2px solid #fb923c; }
    .assessment-badge.red{ background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border: 2px solid #ef4444; }

    .assessment-metrics{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    @media (max-width:560px){ .assessment-metrics{ grid-template-columns:1fr; } }
    .metric-item{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; position:relative; }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; display:flex; align-items:center; gap:6px; }
    .metric-info{
      display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; background:var(--primary);
      color:white; border-radius:50%; font-size:10px; font-weight:700; cursor:help; position:relative;
    }
    .metric-info:hover .metric-tooltip{ display:block; }
    .metric-tooltip{
      display:none; position:absolute; bottom:24px; left:50%; transform: translateX(-50%); width:280px; padding:12px;
      background:#1f2937; color:white; border-radius:8px; font-size:11px; line-height:1.5; z-index:1000; box-shadow:0 8px 20px rgba(0,0,0,0.3); text-align:left; font-weight:400;
    }
    .metric-tooltip::after{
      content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:6px solid transparent; border-top-color:#1f2937;
    }
    .metric-tooltip strong{ color:#60a5fa; font-weight:600; }
    .metric-value{ font-size:20px; font-weight:800; color:var(--text); }
    .assessment-description{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; font-size:13px; line-height:1.6; color:var(--text); }
    .assessment-description strong{ color:var(--primary); }
    .assessment-warning{ margin-top:12px; padding:10px; background:#fff7ed; border-left:4px solid #fb923c; border-radius:6px; font-size:12px; color:#9a3412; }

    /* Settings-Buttons */
    .btn-stats-toggle{
       appearance:none; background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:1.5px solid #c7d2fe; color:#1e3a8a;
       padding:10px 18px; border-radius:999px; font-size:14px; font-weight:700; cursor:pointer;
       transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
       box-shadow:0 6px 14px rgba(79,70,229,.18); display:inline-flex; align-items:center; gap:8px;
     }
     .btn-stats-toggle:hover{ background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border-color:#a5b4fc; transform:translateY(-1px); box-shadow:0 10px 20px rgba(79,70,229,.25); }
     .btn-stats-toggle:active{ transform:translateY(0); box-shadow:0 4px 10px rgba(79,70,229,.2); }
     .btn-stats-toggle:focus-visible{ outline:3px solid #c7d2fe; outline-offset:2px; }

    .btn-settings{
      appearance:none; background:linear-gradient(135deg,#f0f9ff,#dbeafe); border:1.5px solid #bae6fd; color:#0c4a6e;
      padding:10px 18px; border-radius:999px; font-size:14px; font-weight:700; cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      box-shadow:0 6px 14px rgba(2,132,199,.16); display:inline-flex; align-items:center; gap:8px;
    }
    .btn-settings:hover{ background:linear-gradient(135deg,#dbeafe,#bfdbfe); border-color:#93c5fd; transform:translateY(-1px); box-shadow:0 10px 20px rgba(2,132,199,.22); }
    .btn-settings:active{ transform:translateY(0); box-shadow:0 4px 10px rgba(2,132,199,.18); }
    .btn-settings:focus-visible{ outline:3px solid #93c5fd; outline-offset:2px; }

    /* Einstellungs-Popup */
    .settings-popup{
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px; width:min(560px,92vw); max-height:85vh; overflow-y:auto; display:none; z-index:1002;
    }
    .settings-popup.active{ display:block; }
    .settings-popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; z-index:1001; }
    .settings-popup-overlay.active{ display:block; }
    .settings-title{ font-size:22px; font-weight:800; margin-bottom:8px; color:var(--text); text-align:center; }
    .settings-subtitle{ font-size:14px; color:var(--muted); margin-bottom:24px; text-align:center; }
    .settings-section{ margin-bottom:24px; }
    .settings-section-title{ font-size:16px; font-weight:700; margin-bottom:12px; color:var(--text); }
    .settings-description{ font-size:13px; color:var(--muted); margin-bottom:16px; line-height:1.6; }
    .settings-options{ display:flex; flex-direction:column; gap:10px; }
    .settings-option{
      display:flex; align-items:flex-start; gap:12px; padding:14px; border:2px solid #e5e7eb; border-radius:12px; background:#fff; cursor:pointer; transition:all .2s ease;
    }
    .settings-option:hover{ border-color:var(--primary); background:#f8faff; }
    .settings-option.selected{ border-color:var(--primary); background:linear-gradient(135deg,#eef2ff,#f8faff); box-shadow:0 4px 12px rgba(79,70,229,0.15); }
    .settings-option input[type="radio"]{ margin-top:2px; transform:scale(1.3); accent-color:var(--primary); }
    .settings-option-content{ flex:1; }
    .settings-option-title{ font-weight:700; font-size:14px; color:var(--text); margin-bottom:4px; }
    .settings-option-desc{ font-size:12px; color:var(--muted); line-height:1.5; }
    .settings-info-box{ padding:14px; background:#eff6ff; border-left:4px solid var(--primary); border-radius:8px; font-size:12px; color:#1e40af; line-height:1.6; margin-top:16px; }
    .settings-info-box strong{ color:#1e3a8a; }

    .legend{ display:flex; flex-wrap:wrap; gap:10px 14px; margin:10px 0 14px; color:var(--muted); font-size:13px; }
    .legend span{ display:flex; align-items:center; gap:6px; }

    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:10px; position:relative; }
    .weekday{ text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0; background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6; }

    .day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid #e7eef6; background:#fff; font-weight:700; cursor:pointer;
      transition:.1s ease; position:relative; z-index:1; user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"❗"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"❤️"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"⭐"; position:absolute; top:4px; right:6px; font-size:12px; }

    .day.today{ outline: 3px solid var(--primary); outline-offset:-3px; }

    .day-comment-tooltip{
      display:none; position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%);
      min-width:200px; max-width:280px; padding:10px 12px; background:#1f2937; color:white; border-radius:8px; font-size:11px; line-height:1.5;
      z-index:1000; box-shadow:0 8px 20px rgba(0,0,0,0.4); text-align:left; font-weight:400; pointer-events:none; white-space:pre-wrap; word-wrap:break-word;
    }
    .day-comment-tooltip::after{ content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:6px solid transparent; border-top-color:#1f2937; }
    .day.has-comment{ position:relative; }
    .day.has-comment::before{ content:'💬'; position:absolute; top:2px; right:2px; font-size:10px; opacity:.8; }
    .day.has-comment:hover .day-comment-tooltip{ display:block; }

    .support{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:12px 0 12px; text-align:center; position:relative; z-index:0; }
    .support p{ margin:0 0 6px; }
    .support-buttons{ margin-top:0; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; }
    .support-buttons .btn-holder{ height:48px; display:flex; align-items:center; justify-content:center; }
    #kofi-holder, #kofi-holder iframe{ margin:0 !important; }
    #kofi-holder iframe{ height:48px !important; min-height:48px !important; }
    @media (max-width:420px){ #kofi-holder iframe{ height:44px !important; } }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px 0 6px; }
    .month-title{ font-weight:800; font-size:20px; }

    .month-top-nav{ display:flex; gap:10px; justify-content:center; margin:8px 0 14px; }
    .month-top-nav .btn{ width:auto; min-width:140px; }
    @media (max-width:420px){ .month-top-nav .btn{ min-width:120px; } }

    /* Edit-Karte */
    .edit-pop{
      position: fixed; left:50%; top: 18px; transform: translateX(-50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow: var(--shadow);
      padding:14px; width: min(560px, 92vw); display:none; z-index: 1000;
    }
    .edit-pop.active{ display:block; }
    .edit-title{ font-weight:800; font-size:18px; margin: 4px 0 8px; color:#111827; }
    .edit-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .edit-grid{ grid-template-columns: 1fr; } }
    .edit-option{
      width:100%; padding:12px 14px; border-radius:12px; border:2px solid #edf2f7; background:#fff; cursor:pointer; text-align:left;
      transition:.12s ease; font-size:15px;
    }
    .edit-option:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .edit-option.sober{ border-color:#c0f1df; background:#f4fffa; }
    .edit-option.wellness{ border-color:#b3f5cc; background:#f0fdf5; position:relative; }
    .edit-option.wellness::after{ content:"❗"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.moderate{ border-color:#ffe5b5; background:#fff9ec; }
    .edit-option.mixed{ border-color:#fecaca; background:#fef2f2; position:relative; }
    .edit-option.mixed::after{ content:"❤️"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.alcohol{ border-color:#ffcaca; background:#fff2f2; }
    .edit-option.superday{ border-color:#b7f3d2; background:linear-gradient(135deg,#f6fff9,#f1fff7); position:relative; }
    .edit-option.superday::after{ content:"⭐"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.delete{ border-color:#e2e8f0; background:#f8fafc; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }
    .reset-bar{ margin-top: 16px; display:none; } /* verschoben in Einstellungen */

    @media (max-width: 420px){
      .btn-stats-toggle, .btn-settings{
        padding: 9px 14px; font-size: 13px; gap: 6px;
      }
    }

    /* GOD-MODUS: neue, zurückhaltende Sektion */
    .god-section{
      margin-top: 16px; padding:16px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; display:none;
    }
    .god-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .god-grid{ grid-template-columns:1fr; } }
    .god-field{ display:flex; flex-direction:column; gap:6px; }
    .god-label{ font-size:13px; font-weight:600; color:var(--text); }
    .god-input, .god-select{
      padding:10px; border-radius:10px; border:1px solid #d1d5db; font-size:13px; background:white; font-family:inherit;
    }
    .unit-toggle{ display:flex; gap:8px; align-items:center; }
    .unit-pill{
      padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; font-size:12px; cursor:pointer; user-select:none;
    }
    .unit-pill.active{ background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a; font-weight:700; }
    .god-inline{ display:flex; gap:10px; align-items:center; }

    .god-subtle{
      margin-top:10px; font-size:12px; color:var(--muted);
    }
    .god-actions{ display:flex; gap:12px; margin-top:12px; }
    .god-metrics{
      margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .god-metric{
      background:#fff; border:1px solid #e5e7eb; padding:10px; border-radius:10px; font-size:12px;
    }

    /* AUDIT Popup (konditional) */
    .audit-popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:1200; }
    .audit-popup{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 40px rgba(31,41,55,.25); padding:20px; width:min(560px,92vw); max-height:85vh; overflow:auto; display:none; z-index:1201; }

    .analysis-advanced{ margin-top: 14px; }
    .analysis-toggle{
      appearance:none; background:#f1f5f9; border:1px solid #e5e7eb; color:#111827; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    .analysis-box{
      display:none; margin-top:12px; padding:14px; background:#fff; border:1px solid #e5e7eb; border-radius:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tag-Eingabe Ansicht -->
    <div id="dayInputView" class="view active">
      <h1>🍷 Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion"></div>

      <div class="current-date" id="currentDateDisplay"></div>

      <div style="margin-top: 16px;">
        <label for="dayCommentInput" style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          💬 Kommentar (optional):
        </label>
        <textarea 
          id="dayCommentInput" 
          placeholder="Notizen zum Tag (z.B. Anlass, Gefühle, Situation)..."
          class="god-input"
          style="width:100%; min-height:80px; resize:vertical;"
        ></textarea>
      </div>

      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday">
          <input type="radio" name="dayChoice" value="superday" />
          <span>⭐ Supertag – Alkoholfrei + Sport gemacht!</span>
        </label>
        <label class="choice-option wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <span>💚 Wellness – Alkoholfrei + Sauna/Gesundheit</span>
        </label>
        <label class="choice-option sober">
          <input type="radio" name="dayChoice" value="sober" />
          <span>🟢 Alkoholfrei – Kein Alkohol getrunken</span>
        </label>
        <label class="choice-option moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <span>🟡 Moderat – Wenig Alkohol getrunken</span>
        </label>
        <label class="choice-option mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <span>❤️ Schadensbegrenzung – Alkohol + Sport</span>
        </label>
        <label class="choice-option alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <span>🔴 Alkohol – Viel Alkohol getrunken</span>
        </label>
      </div>

      <!-- GOD-MODUS Detail-Eingabe (nur sichtbar wenn aktiviert) -->
      <div id="godSection" class="god-section" aria-hidden="true">
        <div style="font-weight:800; margin-bottom:10px;">🧠 God-Modus: Detaillierte Angaben (optional, verbessert die Auswertung)</div>

        <div class="god-grid">
          <div class="god-field">
            <label class="god-label">Getränketyp (ABV)</label>
            <select id="godDrinkType" class="god-select">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liquor" data-abv="15">Likör (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirit" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>

          <div class="god-field" id="beerSizeField">
            <label class="god-label">Bier-Flaschengröße</label>
            <select id="godBeerSize" class="god-select">
              <option value="0.33">Klein (0,33 l)</option>
              <option value="0.5">Groß (0,5 l)</option>
            </select>
          </div>

          <div class="god-field">
            <label class="god-label">Einheit</label>
            <div class="unit-toggle">
              <span id="unitMl" class="unit-pill active">ml</span>
              <span id="unitL" class="unit-pill">L</span>
            </div>
          </div>

          <div class="god-field">
            <label class="god-label">Menge pro Portion</label>
            <input id="godVolumePerPortion" class="god-input" type="number" min="0" step="1" placeholder="z.B. 330">
          </div>

          <div class="god-field">
            <label class="god-label">Anzahl Portionen</label>
            <input id="godPortions" class="god-input" type="number" min="0" step="1" placeholder="z.B. 2">
          </div>

          <div class="god-field">
            <label class="god-label">🏃‍♂️ Sport heute?</label>
            <div class="god-inline">
              <input id="godDidSport" type="checkbox">
              <span class="god-subtle">Wirkt sich nur auf die Kategorie (Schadensbegrenzung) aus – nicht auf g Alkohol.</span>
            </div>
          </div>

          <div class="god-field">
            <label class="god-label">Marijuana (g)</label>
            <input id="godWeedGrams" class="god-input" type="number" min="0" step="0.1" placeholder="z.B. 0.5">
          </div>

          <div class="god-field">
            <label class="god-label">Häufigkeit</label>
            <select id="godWeedFreq" class="god-select">
              <option value="einmalig">einmalig</option>
              <option value="mehrmals">mehrmals am Tag</option>
            </select>
          </div>
        </div>

        <div class="god-metrics">
          <div class="god-metric"><strong>Alkohol (g):</strong> <span id="godGrams">0</span></div>
          <div class="god-metric"><strong>Drinks (à 10g):</strong> <span id="godDrinks">0</span></div>
        </div>

        <div class="god-actions">
          <button id="godSuggest" class="btn secondary" type="button">💡 Kategorie vorschlagen</button>
          <button id="godSaveDetails" class="btn" type="button">💾 Detaillierte Angaben speichern</button>
        </div>
        <div class="god-subtle">Formel: Volumen(L) × Vol% × 0.789 g/ml · 1000 → g Alkohol · 1 Drink = 10 g (DE)</div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn" disabled>Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        🍷 Gespeicherte Tage: <span id="savedDaysCount">0</span> ·
        <span id="storageStatus">Lade…</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">📊 Monatsübersicht</button>
      </div>
    </div>

    <!-- Monats-Übersicht -->
    <div id="monthView" class="view">
      <h1>📊 Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion2"></div>

      <div class="month-head">
        <div class="month-title" id="monthHeader">—</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">← Vorheriger</button>
        <button class="btn" onclick="nextMonth()">Nächster →</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Erfolgsquote</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>⭐ Supertag</span>
        <span>💚 Wellness</span>
        <span>🟢 Alkoholfrei</span>
        <span>🟡 Moderat</span>
        <span>❤️ "Schadensbegrenzung"</span>
        <span>🔴 Alkohol</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <div style="text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">📊 100-Tage-Statistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">⚙️ Einstellungen</button>
      </div>

      <section class="support">
        <p><strong>Findest diese kleine Anwendung nützlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons">
          <div id="kofi-holder" class="btn-holder">
            <div id="kofi-widget" aria-label="Ko-fi Unterstützungsbutton"></div>
          </div>
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky"><img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir ´n Kaffee! &emoji=☕&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" /></a>
          </div>
        </div>

        <script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
        <script type="text/javascript">
          kofiwidget2.init('Spendier mir n´ Kaffee Ko-fi', '#72a4f2', 'R5R319DK8N');
          kofiwidget2.draw();
        </script>
      </section>
    </div>

    <!-- Edit-Karte -->
    <div id="editPopup" class="edit-pop" aria-hidden="true">
      <div class="edit-title" id="editDate">Datum</div>
      <div class="edit-grid">
        <button class="edit-option superday" onclick="updateDay('superday')">⭐ Supertag</button>
        <button class="edit-option wellness" onclick="updateDay('wellness')">💚 Wellness</button>
        <button class="edit-option sober" onclick="updateDay('sober')">🟢 Alkoholfrei</button>
        <button class="edit-option moderate" onclick="updateDay('moderate')">🟡 Moderat</button>
        <button class="edit-option mixed" onclick="updateDay('mixed')">❤️ Schadensbegrenzung</button>
        <button class="edit-option alcohol" onclick="updateDay('alcohol')">🔴 Alkohol</button>
      </div>

      <!-- God-Details im Editor (optional) -->
      <div id="editGodSection" class="god-section" style="display:none; margin-top:12px;">
        <div style="font-weight:800; margin-bottom:10px;">🧠 God-Details bearbeiten</div>
        <div class="god-grid">
          <div class="god-field">
            <label class="god-label">Getränketyp</label>
            <select id="editDrinkType" class="god-select">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liquor" data-abv="15">Likör (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirit" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>
          <div class="god-field" id="editBeerSizeField">
            <label class="god-label">Bier-Flaschengröße</label>
            <select id="editBeerSize" class="god-select">
              <option value="0.33">Klein (0,33 l)</option>
              <option value="0.5">Groß (0,5 l)</option>
            </select>
          </div>
          <div class="god-field">
            <label class="god-label">Einheit</label>
            <div class="unit-toggle">
              <span id="editUnitMl" class="unit-pill active">ml</span>
              <span id="editUnitL" class="unit-pill">L</span>
            </div>
          </div>
          <div class="god-field">
            <label class="god-label">Menge pro Portion</label>
            <input id="editVolumePerPortion" class="god-input" type="number" min="0" step="1">
          </div>
          <div class="god-field">
            <label class="god-label">Anzahl Portionen</label>
            <input id="editPortions" class="god-input" type="number" min="0" step="1">
          </div>
          <div class="god-field">
            <label class="god-label">🏃‍♂️ Sport?</label>
            <div class="god-inline">
              <input id="editDidSport" type="checkbox">
              <span class="god-subtle">Nur für Kategorie „Schadensbegrenzung“ relevant.</span>
            </div>
          </div>
          <div class="god-field">
            <label class="god-label">Marijuana (g)</label>
            <input id="editWeedGrams" class="god-input" type="number" min="0" step="0.1">
          </div>
          <div class="god-field">
            <label class="god-label">Häufigkeit</label>
            <select id="editWeedFreq" class="god-select">
              <option value="einmalig">einmalig</option>
              <option value="mehrmals">mehrmals am Tag</option>
            </select>
          </div>
        </div>
        <div class="god-metrics">
          <div class="god-metric"><strong>Alkohol (g):</strong> <span id="editGrams">0</span></div>
          <div class="god-metric"><strong>Drinks (à 10g):</strong> <span id="editDrinks">0</span></div>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <label for="editCommentInput" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
          💬 Kommentar:
        </label>
        <textarea 
          id="editCommentInput" 
          placeholder="Notizen zum Tag..."
          style="width: 100%; min-height: 70px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; font-family: inherit; resize: vertical;"
        ></textarea>
        <button class="btn" style="width: 100%; margin-top: 8px;" onclick="saveEditComment()">💾 Änderungen speichern</button>
      </div>

      <div class="edit-grid" style="margin-top: 16px;">
        <button class="edit-option delete" onclick="updateDay('delete')">🗑️ Tag löschen</button>
        <button class="btn secondary" onclick="closeEditPopup()">Schließen</button>
      </div>
    </div>

    <!-- Chart-Popup -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup" aria-hidden="true">
      <div class="chart-section">
        <div class="chart-title">📊 Letzte 100 Tage im Überblick</div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                🔴 Unter 50%
                <small>Alkohol, "Schadensbegrenzung", Moderat</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative" style="width: 0%;"></div>
            </div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                🟢 Über 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesundheitsbewertung (Basis) -->
      <div class="health-assessment">
        <div class="assessment-title">🎯 Deine Gesundheitseinschätzung</div>
        <div class="assessment-badge" id="assessmentBadge"></div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">
              AF-Quote (alkoholfrei)
              <span class="metric-info">ℹ
                <span class="metric-tooltip">
                  Prozentsatz alkoholfreier Tage:<br>
                  <strong>Supertag + Wellness + Alkoholfrei</strong><br><br>
                  Je höher, desto besser.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Gewichtete Gesundheit
              <span class="metric-info">ℹ
                <span class="metric-tooltip">
                  Score (0–100): Supertag 100, Wellness 90, AF 75, Moderat 40, Schadensbegrenzung 25, Viel 0.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Binge-Nähe (Hochrisiko)
              <span class="metric-info">ℹ
                <span class="metric-tooltip">
                  Zählt Hochrisiko-Tage: „Viel“ + „Schadensbegrenzung“.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Längster Cluster
              <span class="metric-info">ℹ
                <span class="metric-tooltip">
                  Längste Serie von Hochrisiko-Tagen am Stück.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning" style="display:none;"></div>

        <!-- Nur bei Risiko sichtbar -->
        <div id="auditSuggestion" style="display:none; text-align:center; margin-top:12px;">
          <button class="btn secondary" type="button" onclick="openAudit()">🧪 AUDIT-Screening machen</button>
          <div style="font-size:12px; color:var(--muted); margin-top:6px;">Dezentes WHO-Screening (3 Fragen) – nur wenn sinnvoll.</div>
        </div>

        <!-- God-Analyse (feine Skala) -->
        <div class="analysis-advanced">
          <button id="analysisToggle" class="analysis-toggle" type="button">🔍 Detaillierte Analyse anzeigen</button>
          <div id="analysisBox" class="analysis-box">
            <div style="font-weight:800; margin-bottom:6px;">Feinere Skala (God-Modus)</div>
            <div id="godMetricsList" style="font-size:13px; line-height:1.6;"></div>
          </div>
        </div>
      </div>

      <button class="btn secondary" style="margin-top: 24px; width: 100%;" onclick="toggleChartPopup()">Schließen</button>
    </div>

    <!-- Einstellungen -->
    <div class="settings-popup-overlay" id="settingsOverlay" onclick="toggleSettingsPopup()"></div>
    <div id="settingsPopup" class="settings-popup" aria-hidden="true">
      <div class="settings-title">⚙️ Einstellungen</div>
      <div class="settings-subtitle">Passe die Bewertung an deine Bedürfnisse an</div>

      <div class="settings-section">
        <div class="settings-section-title">🧠 God-Modus</div>
        <div class="settings-description">Aktiviere den detaillierten Modus (Optionen im Tages-Eingabeformular). Standard-Modus bleibt unverändert.</div>
        <div>
          <label style="display:flex; align-items:center; gap:12px;">
            <input id="toggleGodMode" type="checkbox">
            <span><strong>God-Modus aktivieren</strong> – Detailliertes Tracking (Getränke, Menge, Sport, Marijuana)</span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">🎯 Neutrale Tage</div>
        <div class="settings-description">Wie sollen nicht eingetragene Tage in die Statistik einfließen?</div>
        <div class="settings-options">
          <label class="settings-option" id="option-ignore">
            <input type="radio" name="neutralDays" value="ignore" checked>
            <div class="settings-option-content">
              <div class="settings-option-title">🎯 Ignorieren (Empfohlen)</div>
              <div class="settings-option-desc">Nur eingetragene Tage zählen.</div>
            </div>
          </label>
          <label class="settings-option" id="option-neutral">
            <input type="radio" name="neutralDays" value="neutral">
            <div class="settings-option-content">
              <div class="settings-option-title">⚖️ Als neutral werten</div>
              <div class="settings-option-desc">Neutral ≈ 50% Gesundheit.</div>
            </div>
          </label>
          <label class="settings-option" id="option-negative">
            <input type="radio" name="neutralDays" value="negative">
            <div class="settings-option-content">
              <div class="settings-option-title">⚠️ Eher negativ</div>
              <div class="settings-option-desc">≈ 30% Gesundheit.</div>
            </div>
          </label>
          <label class="settings-option" id="option-very-negative">
            <input type="radio" name="neutralDays" value="very-negative">
            <div class="settings-option-content">
              <div class="settings-option-title">🚨 Sehr negativ</div>
              <div class="settings-option-desc">≈ 15% Gesundheit.</div>
            </div>
          </label>
        </div>
        <div class="settings-info-box">
          💡 Tipp: „Ignorieren“ ist am fairsten, wenn du (noch) nicht täglich trackst.
        </div>
      </div>

      <!-- Backup & Wiederherstellung -->
      <div class="settings-section">
        <div class="settings-section-title">🗄️ Daten-Backup (lokal)</div>
        <div class="settings-description">Export/Import bleibt 100% lokal im Browser.</div>
        <div class="submit-row" style="margin-top:8px;">
          <button class="btn secondary" onclick="exportData()">📤 Daten exportieren</button>
          <button class="btn secondary" onclick="importData()">📥 Daten importieren</button>
        </div>
        <p class="settings-description" style="margin-top:10px;">Hinweis: Import wird gemerged (gleiche Tage werden überschrieben).</p>
      </div>

      <!-- Speicher löschen (verschoben) -->
      <div class="settings-section">
        <div class="settings-section-title">🧹 Speicher</div>
        <div class="settings-description">Setzt alle Tage & Einstellungen zurück.</div>
        <button class="btn danger" onclick="resetStorage()">🧹 Lokalen Speicher löschen</button>
      </div>

      <button class="btn" style="width: 100%;" onclick="saveSettings()">Einstellungen speichern</button>
    </div>

    <!-- AUDIT-C Popup (nur bei Bedarf geöffnet) -->
    <div id="auditOverlay" class="audit-popup-overlay" onclick="closeAudit()"></div>
    <div id="auditPopup" class="audit-popup" aria-hidden="true">
      <div class="settings-title">📝 AUDIT-C Schnelltest (WHO)</div>
      <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">
        3 kurze Fragen zum letzten Jahr. Screening, keine Diagnose.
      </p>

      <div style="margin-bottom: 16px;">
        <label style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Geschlecht (für Cut-offs):</label>
        <select id="auditGender" class="god-select">
          <option value="male">Männlich</option>
          <option value="female">Weiblich</option>
        </select>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">1. Wie oft trinken Sie alkoholhaltige Getränke?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="0"> Nie (0 Punkte)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="1"> Monatlich oder seltener (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="2"> 2–4×/Monat (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="3"> 2–3×/Woche (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="4"> ≥4×/Woche (4)</label></div>
        </div>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">2. Wie viele Einheiten an einem typischen Tag?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="0"> 1–2 (0)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="1"> 3–4 (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="2"> 5–6 (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="3"> 7–9 (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="4"> 10+ (4)</label></div>
        </div>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">3. Wie oft trinken Sie sechs oder mehr Einheiten?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="0"> Nie (0)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="1"> Seltener als monatlich (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="2"> Monatlich (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="3"> Wöchentlich (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="4"> (Fast) täglich (4)</label></div>
        </div>
      </div>

      <button class="btn" style="width: 100%; margin-top: 16px;" onclick="calculateAuditScore()">Ergebnis berechnen</button>
      <div id="auditResult" style="display:none; margin-top:12px;"></div>

      <button class="btn secondary" style="margin-top: 14px; width: 100%;" onclick="closeAudit()">Schließen</button>
    </div>

    <footer>© 2025 by R. Duwenbeck</footer>
  </div>

  <script>
    /* === Version === */
    const APP_VERSION_BASE = 'ChatGPT5_edit_Vers1.3_';
    function pad(n){ return n<10 ? '0'+n : ''+n; }
    function currentHHMM(){
      const d = new Date();
      return pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let dayData = {};
    let editingDate = null;
    let storageWorking = false;
    let neutralDaysSetting = 'ignore';
    let godMode = false;
    let unit = 'ml'; // ml | L

    const monthNames = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays   = ['Mo','Di','Mi','Do','Fr','Sa','So'];

    const formatDateKey = (date)=> `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
    const formatDisplayDate = (date)=> `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    // Helpers: kompatibel mit altem & neuem Format
    const getDayStatus  = (key) => dayData[key] ? (typeof dayData[key]==='string' ? dayData[key] : dayData[key].status) : null;
    const getDayComment = (key) => (dayData[key] && typeof dayData[key]==='object' && dayData[key].comment) ? dayData[key].comment : '';

    const setDayData = (key, status, comment = '', extra = {}) => {
      dayData[key] = { status, comment, ...extra };
    };

    /* Storage */
    function testStorage(){ try{ localStorage.setItem('__test__','1'); localStorage.removeItem('__test__'); storageWorking = true; }catch{ storageWorking=false; } }
    function updateStorageStatus(message){
      const status = document.getElementById('storageStatus');
      const count  = document.getElementById('savedDaysCount');
      if(status) status.textContent = message ?? '';
      if(count)  count.textContent  = Object.keys(dayData).length;
    }
    function saveData(){
      if(!storageWorking){ updateStorageStatus('❌ Speichern nicht möglich'); return false; }
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        updateStorageStatus('✅ Daten gespeichert'); return true;
      }catch{ updateStorageStatus('❌ Speicher-Fehler'); return false; }
    }
    function loadData(){
      if(!storageWorking){ updateStorageStatus('⚠️ Kein persistenter Speicher'); return; }
      try{
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        currentInputDate = new Date();

        // Settings laden
        const savedA = localStorage.getItem('alcoholTrackerSettings');
        const savedB = localStorage.getItem('boozeTrackerSettings'); // Backwards compat
        let settings = {};
        try{ if(savedA) settings = JSON.parse(savedA) || {}; }catch{}
        try{ if(savedB) settings = { ...settings, ...(JSON.parse(savedB)||{}) }; }catch{}
        neutralDaysSetting = settings.neutralDays || 'ignore';
        godMode = !!settings.godMode;

        updateStorageStatus(`✅ ${Object.keys(dayData).length} Tage geladen`);
      }catch{
        dayData = {}; currentInputDate = new Date(); updateStorageStatus('❌ Laden fehlgeschlagen');
      }
    }

    /* Monat / Erfolg / Streak */
    function setSuccessCardTint(pct){
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if(pct < 50)      card.classList.add('rate-bad');
      else if(pct < 75) card.classList.add('rate-warn');
      else              card.classList.add('rate-good');
    }
    function calculateSuccessRate(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      let total=0, max=0;
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const key = formatDateKey(new Date(y,m,d));
        const st = getDayStatus(key);
        if(!st) continue;
        max += 1;
        if(st==='superday') total += 1.0;
        else if(st==='wellness') total += 0.9;
        else if(st==='sober') total += 0.75;
        else if(st==='moderate') total += 0.4;
        else if(st==='mixed') total += 0.25;
      }
      const pct = max>0 ? Math.round((total/max)*100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      setSuccessCardTint(pct);
    }

    function isGreen(state){ return state==='sober' || state==='superday' || state==='wellness'; }
    function setStreakCardTint(streak){
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      if(streak >= 30)      card.classList.add('streak-great');
      else if(streak >= 21) card.classList.add('streak-good');
      else if(streak >= 11) card.classList.add('streak-warn');
      else if(streak >= 1)  card.classList.add('streak-bad');
      numEl.textContent = String(streak) + (streak>=30 ? ' 🎉' : '');
    }
    function calculateStreak(){
      let probe = new Date();
      let streak = 0;
      while(true){
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if(isGreen(st)){ streak++; probe.setDate(probe.getDate()-1); }
        else { break; }
        if(streak > 1000) break;
      }
      setStreakCardTint(streak);
    }

    /* 100 Tage Chart */
    function calculate100DaysChart(){
      let negative = 0;
      let positive = 0;
      const today = new Date();
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = getDayStatus(formatDateKey(probe));
        if(st === 'alcohol' || st === 'mixed' || st === 'moderate'){ negative++; }
        else if(st === 'sober' || st === 'wellness' || st === 'superday'){ positive++; }
      }
      const negPct = Math.round((negative / 100) * 100);
      const posPct = Math.round((positive / 100) * 100);
      setTimeout(() => {
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 100);
    }

    /* Basis-Health + Trigger für AUDIT + God-Analyse */
    function calculateHealthAssessment(){
      const today = new Date();
      let counts = { superday:0, wellness:0, sober:0, moderate:0, mixed:0, alcohol:0, empty:0 };
      const last100Days = [];
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const key = formatDateKey(probe);
        const st  = getDayStatus(key);
        last100Days.push(st || null);
        if(st && counts[st] !== undefined) counts[st]++; else if(!st) counts.empty++;
      }
      const enteredDays = 100 - counts.empty;
      let divisor = 100, neutralWeight = 0;
      if(neutralDaysSetting === 'ignore'){ divisor = enteredDays || 1; }
      else if(neutralDaysSetting === 'neutral'){ neutralWeight = 0.5; }
      else if(neutralDaysSetting === 'negative'){ neutralWeight = 0.3; }
      else if(neutralDaysSetting === 'very-negative'){ neutralWeight = 0.15; }

      const afCount = counts.superday + counts.wellness + counts.sober;
      const afQuote = afCount / divisor;

      const weightedScore = (
        counts.superday * 1.0 +
        counts.wellness * 0.9 +
        counts.sober * 0.75 +
        counts.moderate * 0.4 +
        counts.mixed * 0.25 +
        counts.alcohol * 0.0 +
        counts.empty * neutralWeight
      ) / 100;

      const bingeProximity = counts.alcohol + counts.mixed;
      const bingeQuote = bingeProximity / divisor;

      let maxCluster = 0, currentCluster = 0;
      for(const st of last100Days){
        if(st === 'alcohol' || st === 'mixed'){ currentCluster++; maxCluster = Math.max(maxCluster, currentCluster); }
        else { currentCluster = 0; }
      }

      let label, badgeClass, description, warning, suggestAudit=false;
      if(bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10)){
        label='🚨 Sucht-Alarm: Rote Lampen!'; badgeClass='red';
        description='<strong>Sehr hohes Risiko</strong> – Nähe zu häufigen Rauschlagen.';
        warning='🆘 Bitte professionelle Hilfe erwägen.';
        suggestAudit=true;
      } else if((bingeProximity >= 20 && bingeProximity < 40) || (afQuote < 0.30 && afQuote >= 0.20) || (bingeQuote >= 0.20 && enteredDays >= 10)){
        label='🎲 Risiko-Roulette'; badgeClass='red';
        description='<strong>Hohes Risiko</strong> – Kritische Muster erkennbar.';
        warning='🚨 Gespräch/Screening empfohlen.'; suggestAudit=true;
      } else if(afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)){
        label='🚨 Kipppunkt-Kandidat'; badgeClass='weekend';
        description='Erhöhtes Risiko – Schwelle erreicht.'; suggestAudit=true;
      } else if(afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12){
        label='🧘 Balance-Buddha'; badgeClass='balance'; description='Moderates Risiko.';
      } else {
        label='🦸 Leber-Superheld'; badgeClass='zen'; description='Niedriges Risiko.';
      }

      const extra = (maxCluster>=3 ? `<br>🔥 Cluster: ${maxCluster} Tage am Stück.` : '');
      const afDisplay = neutralDaysSetting === 'ignore' ? `${Math.round(afQuote*100)}% (${afCount}/${enteredDays})` : `${Math.round(afQuote*100)}%`;
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore*100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? `${bingeProximity} (${Math.round(bingeQuote*100)}%)` : bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster>0 ? `${maxCluster} Tage` : 'Keiner';

      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label; badge.className = 'assessment-badge ' + badgeClass;

      const basisInfo = neutralDaysSetting === 'ignore'
        ? `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">📊 Basierend auf <strong>${enteredDays} von 100 Tagen</strong></div>`
        : `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">📊 Basierend auf <strong>100 Tagen</strong></div>`;
      document.getElementById('assessmentDescription').innerHTML = basisInfo + description;

      const warningEl = document.getElementById('assessmentWarning');
      if(warning || extra){ warningEl.innerHTML = (warning||'') + extra; warningEl.style.display='block'; } else { warningEl.style.display='none'; }

      // AUDIT Vorschlag dezent
      document.getElementById('auditSuggestion').style.display = suggestAudit ? 'block' : 'none';

      // God-Analyse (feiner)
      buildGodAdvancedAnalysis();
    }

    /* God-Analyse: quantitative/qualitative + Stufe */
    function buildGodAdvancedAnalysis(){
      // Sammle 100 Tage; fallback g/Kat:
      const today = new Date();
      const fallbackGrams = { superday:0, wellness:0, sober:0, moderate:20, mixed:40, alcohol:50 };
      let gramsTotal = 0, daysCount=0, bingeDays=0, weedWeekGrams=0, usedDays=0;
      let maxCluster=0, curCluster=0;
      const weekdayIdx = d => (d.getDay()+6)%7; // Mo=0 ... So=6
      const friday = 4, saturday = 5;

      let weekendHigh=0, weekendTotal=0, dailyLowCount=0, abstinentMostly=true, peaks=0;

      for(let i=0; i<100; i++){
        const dt = new Date(today); dt.setDate(dt.getDate()-i);
        const key = formatDateKey(dt);
        const entry = dayData[key];
        let grams = 0, weed = 0, status = getDayStatus(key);

        if(entry && typeof entry === 'object' && entry.alcohol && typeof entry.alcohol.grams === 'number'){
          grams = entry.alcohol.grams;
        } else if(status){ grams = fallbackGrams[status] ?? 0; }

        if(entry && entry.marijuana && typeof entry.marijuana.grams === 'number'){ weed = entry.marijuana.grams; }

        gramsTotal += grams; usedDays++;
        if(grams > 0 && grams <= 20) dailyLowCount++;
        if(grams === 0) { /* abstinent candidate */ } else { abstinentMostly = false; }
        if(grams >= 40) bingeDays++;
        if(grams >= 20){ curCluster++; } else { maxCluster = Math.max(maxCluster, curCluster); curCluster=0; }
        weedWeekGrams += weed;

        if(weekdayIdx(dt)===friday || weekdayIdx(dt)===saturday){ weekendTotal++; if(grams>=40) weekendHigh++; }
        if(grams===0){} else if(grams>=60) peaks++;
      }
      maxCluster = Math.max(maxCluster, curCluster);

      // Wochen-Mittel grob (100 Tage ≈ 14.28 Wochen)
      const weeks = 100/7.0;
      const avgDrinksPerWeek = (gramsTotal/10.0)/weeks;
      const weedPerWeek = weedWeekGrams/weeks;

      // Muster
      const weekendBinger = weekendTotal>0 && (weekendHigh/weekendTotal)>=0.4;
      const dailyLow = usedDays>0 && (dailyLowCount/usedDays)>=0.6;
      const abstinentWithSlips = (gramsTotal/usedDays)<5 && peaks>0; // sehr grob

      // Feine Stufe:
      // Mengen-Score (0–100) aus Drinks/Woche (<=1 => 100, 1–2 => 80, 2–4 => 60, 4–8 => 30, >8 => 0)
      let qtyScore=100;
      if(avgDrinksPerWeek<=1) qtyScore=100;
      else if(avgDrinksPerWeek<=2) qtyScore=80;
      else if(avgDrinksPerWeek<=4) qtyScore=60;
      else if(avgDrinksPerWeek<=8) qtyScore=30;
      else qtyScore=0;

      // Binge/Cluster Score
      let patternScore=100;
      if(bingeDays>30 || maxCluster>7) patternScore=0;
      else if(bingeDays>15 || maxCluster>5) patternScore=40;
      else if(bingeDays>5 || maxCluster>3) patternScore=70;
      else patternScore=90;

      // Weed-Score (niedriger ist besser)
      let weedScore=100;
      if(weedPerWeek>2) weedScore=20;
      else if(weedPerWeek>1) weedScore=50;
      else if(weedPerWeek>0.5) weedScore=70;
      else weedScore=90;

      // Gesamtgewichtung (50/30/20)
      const totalScore = 0.5*qtyScore + 0.3*patternScore + 0.2*weedScore;

      // 5-Stufen-Klassifikation
      let fineStage='', tip='';
      if(weedPerWeek<0.5 && avgDrinksPerWeek<1 && bingeDays===0 && maxCluster===0) { fineStage='Stufe 1: Zen-Meister'; }
      else if(avgDrinksPerWeek<=2 && bingeDays<5 && maxCluster<3){ fineStage='Stufe 2: Balance-Künstler'; }
      else if(avgDrinksPerWeek<=4 && bingeDays<=15 && maxCluster<=5){ fineStage='Stufe 3: Kipppunkt-Wanderer'; }
      else if(avgDrinksPerWeek<=8 && (bingeDays<=30 || maxCluster>5)){ fineStage='Stufe 4: Risiko-Jongleur'; }
      else { fineStage='Stufe 5: Alarmstufe Rot'; }

      if(weekendBinger) tip+='• Muster: Weekend-Binger erkannt (Fr/Sa hohe Mengen).<br>';
      if(dailyLow) tip+='• Muster: „Daily Low“ (oft <20 g).<br>';
      if(abstinentWithSlips) tip+='• Muster: Abstinent mit Slips (seltene Peaks).<br>';

      const html = `
        <div><strong>Durchschnittliche Drinks/Woche:</strong> ${avgDrinksPerWeek.toFixed(1)}</div>
        <div><strong>Binge-Tage (≥40g):</strong> ${bingeDays}/100</div>
        <div><strong>Längster Cluster (≥20g):</strong> ${maxCluster} Tage</div>
        <div><strong>Marijuana:</strong> ${weedPerWeek.toFixed(2)} g/Woche</div>
        <div style="margin-top:8px;"><strong>${fineStage}</strong> · Score: ${Math.round(totalScore)}/100</div>
        ${tip?`<div style="margin-top:6px;">${tip}</div>`:''}
        <div style="margin-top:8px; font-size:12px; color:var(--muted);">Hinweis: Wo keine Mengen erfasst wurden, nutzt die Analyse plausible Fallbacks (moderat≈20g, Schadensbegrenzung≈40g, viel≈50g). Exakte Angaben im God-Modus verbessern die Aussagekraft.</div>
      `;
      document.getElementById('godMetricsList').innerHTML = html;
    }

    /* Views */
    function updateDayInputView(){
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      updateStorageStatus(`🍷 ${Object.keys(dayData).length} Tage`);
      const key = formatDateKey(currentInputDate);
      const existing = getDayStatus(key);
      const existingComment = getDayComment(key);
      const btn = document.getElementById('submitDay');
      document.getElementById('dayCommentInput').value = existingComment;

      if(existing){
        const radio = document.querySelector(`input[name="dayChoice"][value="${existing}"]`);
        if(radio) radio.checked = true;
        btn.disabled = false;
        btn.textContent = 'Tag aktualisieren';
      }else{
        btn.textContent = 'Tag speichern';
      }

      // God-Sektion sichtbar?
      document.getElementById('godSection').style.display = godMode ? 'block' : 'none';
    }

    function showMonthView(){
      currentViewDate = new Date(currentInputDate);
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView(); calculateStreak(); calculateSuccessRate();
      document.getElementById('appVersion2').textContent = APP_VERSION_BASE + currentHHMM();
    }
    function showDayInput(){
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      closeEditPopup();
    }

    function updateMonthView(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';
      for(const w of ['Mo','Di','Mi','Do','Fr','Sa','So']){
        const h = document.createElement('div'); h.className='weekday'; h.textContent=w; grid.appendChild(h);
      }

      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);
      const startDay = (first.getDay()+6)%7;

      for(let i=0;i<startDay;i++){
        const e = document.createElement('div'); e.className='day'; e.style.visibility='hidden'; grid.appendChild(e);
      }

      const today = new Date();
      for(let d=1; d<=last.getDate(); d++){
        const dt = new Date(y, m, d);
        const cell = document.createElement('div');
        cell.className = 'day'; cell.textContent = d;
        cell.dataset.y = String(y); cell.dataset.m = String(m); cell.dataset.d = String(d);

        const key = formatDateKey(dt);
        const st = getDayStatus(key);
        const comment = getDayComment(key);

        if(st) cell.classList.add(st);
        if(dt.toDateString() === today.toDateString()) cell.classList.add('today');

        if(comment){
          cell.classList.add('has-comment');
          const tooltip = document.createElement('div');
          tooltip.className = 'day-comment-tooltip';
          tooltip.textContent = comment;
          cell.appendChild(tooltip);
        }
        grid.appendChild(cell);
      }
    }

    document.addEventListener('click', (e)=>{
      const grid = document.getElementById('monthGrid');
      if(!grid || !grid.contains(e.target)) return;
      const cell = e.target.closest('.day');
      if(!cell || cell.style.visibility==='hidden') return;
      const y = Number(cell.dataset.y), m=Number(cell.dataset.m), d=Number(cell.dataset.d);
      openEditPopup(new Date(y,m,d));
    });

    function openEditPopup(date){
      editingDate = date;
      document.getElementById('editDate').textContent = formatDisplayDate(date);
      const key = formatDateKey(date);
      const comment = getDayComment(key);
      document.getElementById('editCommentInput').value = comment;

      // God-Details laden
      const entry = dayData[key];
      const hasGod = entry && typeof entry === 'object' && (entry.alcohol || entry.marijuana || entry.sport!==undefined);
      document.getElementById('editGodSection').style.display = hasGod ? 'block' : (godMode ? 'block' : 'none');

      const drinkSel = document.getElementById('editDrinkType');
      const beerSize = document.getElementById('editBeerSize');
      const volEl = document.getElementById('editVolumePerPortion');
      const portEl= document.getElementById('editPortions');
      const didSport=document.getElementById('editDidSport');
      const weedG=document.getElementById('editWeedGrams');
      const weedF=document.getElementById('editWeedFreq');

      if(hasGod){
        // try to infer fields
        const alc = entry.alcohol || {};
        const typ = alc.type || 'beer';
        const abvMap = {beer:5, radler:2.5, wine:10, liquor:15, other20:20, other30:30, spirit:40};
        drinkSel.value = typ;
        beerSize.value = '0.5';
        const portions = alc.portions || 1;
        const volMl = alc.mlPerPortion || 500;
        document.getElementById('editUnitMl').classList.add('active'); document.getElementById('editUnitL').classList.remove('active');
        volEl.value = Math.round(volMl);
        portEl.value = portions;
        didSport.checked = !!entry.sport;
        weedG.value = entry?.marijuana?.grams ?? 0;
        weedF.value = entry?.marijuana?.frequency || 'einmalig';
        const grams = alc.grams || 0;
        document.getElementById('editGrams').textContent = grams.toFixed(0);
        document.getElementById('editDrinks').textContent = (grams/10).toFixed(1);
      } else {
        drinkSel.value='beer'; beerSize.value='0.5'; volEl.value='500'; portEl.value=''; didSport.checked=false; weedG.value=''; weedF.value='einmalig';
        document.getElementById('editGrams').textContent='0'; document.getElementById('editDrinks').textContent='0';
      }

      const pop = document.getElementById('editPopup');
      pop.classList.add('active');
      pop.setAttribute('aria-hidden','false');
    }
    function closeEditPopup(){
      const pop = document.getElementById('editPopup');
      pop.classList.remove('active');
      pop.setAttribute('aria-hidden','true');
      editingDate = null;
    }

    /* Neutral-Option Auswahl (nur Settings) */
    function selectNeutralOption(option){
      neutralDaysSetting = option;
      const settings = JSON.parse(localStorage.getItem('boozeTrackerSettings') || '{}');
      settings.neutralDays = option;
      localStorage.setItem('boozeTrackerSettings', JSON.stringify(settings));
      document.querySelectorAll('.settings-option').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('input[name="neutralDays"]').forEach(el => {
        el.checked = (el.value === option);
        if(el.checked) el.closest('.settings-option').classList.add('selected');
      });
      calculateHealthAssessment();
    }

    /* AUDIT-C */
    function openAudit(){
      document.getElementById('auditOverlay').style.display='block';
      document.getElementById('auditPopup').style.display='block';
      document.getElementById('auditPopup').setAttribute('aria-hidden','false');
    }
    function closeAudit(){
      document.getElementById('auditOverlay').style.display='none';
      document.getElementById('auditPopup').style.display='none';
      document.getElementById('auditPopup').setAttribute('aria-hidden','true');
    }
    function calculateAuditScore(){
      const q1 = parseInt(document.querySelector('input[name="auditQ1"]:checked')?.value);
      const q2 = parseInt(document.querySelector('input[name="auditQ2"]:checked')?.value);
      const q3 = parseInt(document.querySelector('input[name="auditQ3"]:checked')?.value);
      if(isNaN(q1) || isNaN(q2) || isNaN(q3)){ alert('Bitte beantworte alle 3 Fragen!'); return; }
      const score = q1 + q2 + q3;
      const gender = document.getElementById('auditGender').value;

      let risk, riskClass, riskText;
      if(score === 0){ risk='Niedriges Risiko'; riskClass='low'; riskText='Abstinenz oder sehr geringer Konsum.'; }
      else if((gender==='female' && score < 3) || (gender==='male' && score < 4)){ risk='Geringes Risiko'; riskClass='low'; riskText='Unterer Bereich.'; }
      else if(score < 5){ risk='Riskanter Konsum'; riskClass='medium'; riskText='Reduzierung erwägen.'; }
      else { risk='Hohes Risiko'; riskClass='high'; riskText='Professionelle Beratung empfohlen.'; }

      const resultDiv = document.getElementById('auditResult');
      resultDiv.className = 'audit-result ' + riskClass;
      resultDiv.innerHTML = `<strong>AUDIT-C Score: ${score} von 12</strong><strong style="font-size:14px; margin-top:8px; display:block;">${risk}</strong>${riskText}`;
      resultDiv.style.display = 'block';
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /* Chart Popup */
    function toggleChartPopup(){
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');

      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        calculate100DaysChart();
        calculateHealthAssessment();
        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
      }
    }

    /* Settings Popup */
    function toggleSettingsPopup(){
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');

      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        // Radio-UI refresh
        document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if(radio){ radio.checked = true; radio.closest('.settings-option').classList.add('selected'); }
        document.getElementById('toggleGodMode').checked = !!godMode;

        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
      }
    }

    function saveSettings(){
      const selected = document.querySelector('input[name="neutralDays"]:checked');
      if(selected) neutralDaysSetting = selected.value;
      godMode = document.getElementById('toggleGodMode').checked;

      if(storageWorking){
        try{
          localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
            neutralDays: neutralDaysSetting,
            godMode
          }));
          localStorage.setItem('boozeTrackerSettings', JSON.stringify({
            neutralDays: neutralDaysSetting,
            godMode
          }));
        }catch(e){ console.warn('Settings konnten nicht gespeichert werden:', e); }
      }
      toggleSettingsPopup();
      updateDayInputView();
      alert('✅ Einstellungen gespeichert.');
    }

    /* God-Modus – Eingabe & Kalkulation */
    const DENSITY = 0.789; // g/ml
    function getABV(sel){
      const opt = sel.options[sel.selectedIndex]; return parseFloat(opt.getAttribute('data-abv')) || 0;
    }
    function curUnitFactor(){ return unit==='ml' ? 1 : 1000; } // convert input to ml
    function setUnit(u){
      unit = u;
      document.getElementById('unitMl').classList.toggle('active', unit==='ml');
      document.getElementById('unitL').classList.toggle('active', unit==='L');
      document.getElementById('editUnitMl').classList.toggle('active', unit==='ml');
      document.getElementById('editUnitL').classList.toggle('active', unit==='L');
      // No auto-conversion of existing numbers; we keep user's numbers in their chosen unit
      updateGodCalc('day');
      if(editingDate) updateGodCalc('edit');
    }

    function syncBeerPreset(context){
      const isBeer = (context==='day' ? document.getElementById('godDrinkType').value : document.getElementById('editDrinkType').value);
      const sizeEl  = context==='day' ? document.getElementById('godBeerSize') : document.getElementById('editBeerSize');
      const sizeWrap = context==='day' ? document.getElementById('beerSizeField') : document.getElementById('editBeerSizeField');
      const volEl = context==='day' ? document.getElementById('godVolumePerPortion') : document.getElementById('editVolumePerPortion');
      // Show size only for Bier/Radler
      const show = (isBeer==='beer' || isBeer==='radler');
      sizeWrap.style.display = show ? 'block' : 'none';
      if(show){
        const liters = parseFloat(sizeEl.value);
        const ml = Math.round(liters*1000);
        if(unit==='ml'){ volEl.value = ml; } else { volEl.value = liters; }
      }
      updateGodCalc(context);
    }

    function updateGodCalc(context){
      const isEdit = (context==='edit');
      const drinkSel = isEdit ? document.getElementById('editDrinkType') : document.getElementById('godDrinkType');
      const volEl    = isEdit ? document.getElementById('editVolumePerPortion') : document.getElementById('godVolumePerPortion');
      const portEl   = isEdit ? document.getElementById('editPortions') : document.getElementById('godPortions');
      const gramsEl  = isEdit ? document.getElementById('editGrams') : document.getElementById('godGrams');
      const drinksEl = isEdit ? document.getElementById('editDrinks') : document.getElementById('godDrinks');

      const abv = getABV(drinkSel)/100.0;
      const volInput = parseFloat(volEl.value||'0');
      const portions = parseFloat(portEl.value||'0');
      const totalMl  = (volInput * curUnitFactor()) * portions; // ml
      const grams    = totalMl * abv * DENSITY; // g
      gramsEl.textContent  = Math.round(grams);
      drinksEl.textContent = (grams/10).toFixed(1);
    }

    function godSuggestCategory(grams, didSport){
      if(grams === 0){
        return didSport ? 'superday' : 'sober';
      }
      if(didSport && grams > 0){
        return 'mixed';
      }
      if(grams <= 20) return 'moderate';
      return 'alcohol';
    }

    function collectGodData(context){
      const isEdit = (context==='edit');
      const drinkSel = isEdit ? document.getElementById('editDrinkType') : document.getElementById('godDrinkType');
      const beerSize = isEdit ? document.getElementById('editBeerSize') : document.getElementById('godBeerSize');
      const volEl    = isEdit ? document.getElementById('editVolumePerPortion') : document.getElementById('godVolumePerPortion');
      const portEl   = isEdit ? document.getElementById('editPortions') : document.getElementById('godPortions');
      const weedG    = isEdit ? document.getElementById('editWeedGrams') : document.getElementById('godWeedGrams');
      const weedF    = isEdit ? document.getElementById('editWeedFreq') : document.getElementById('godWeedFreq');
      const didSport = isEdit ? document.getElementById('editDidSport').checked : document.getElementById('godDidSport').checked;

      const abv = getABV(drinkSel);
      const volInput = parseFloat(volEl.value||'0');
      const portions = parseFloat(portEl.value||'0');
      const totalMl  = (volInput * curUnitFactor()) * portions;
      const grams    = totalMl * (abv/100) * DENSITY;

      const alcohol = (totalMl>0) ? {
        type: drinkSel.value,
        abv,
        mlPerPortion: volInput*curUnitFactor(),
        portions,
        grams: Math.round(grams),
        drinks: +(grams/10).toFixed(1)
      } : null;

      const marijuana = (parseFloat(weedG.value||'0')>0) ? {
        grams: parseFloat(weedG.value||'0'),
        frequency: weedF.value
      } : null;

      return { alcohol, marijuana, sport: !!didSport };
    }

    /* Edit & Status Update */
    function updateDay(action){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      if(action === 'delete'){ delete dayData[key]; saveData(); closeEditPopup(); updateMonthView(); calculateStreak(); calculateSuccessRate(); return; }

      const pendingComment = (document.getElementById('editCommentInput').value || '').trim();
      const god = collectGodData('edit');

      dayData[key] = {
        status: action,
        comment: pendingComment,
        ...(god.alcohol ? {alcohol: god.alcohol} : {}),
        ...(god.marijuana ? {marijuana: god.marijuana} : {}),
        ...(god.sport ? {sport: true} : {sport: false})
      };

      saveData(); closeEditPopup(); updateMonthView(); calculateStreak(); calculateSuccessRate();
    }

    function saveEditComment(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const comment = document.getElementById('editCommentInput').value.trim();
      const existingStatus = getDayStatus(key);
      const god = collectGodData('edit');

      if(existingStatus){
        dayData[key] = {
          status: existingStatus,
          comment,
          ...(god.alcohol ? {alcohol: god.alcohol} : {}),
          ...(god.marijuana ? {marijuana: god.marijuana} : {}),
          ...(god.sport ? {sport: true} : {sport: false})
        };
        saveData(); updateMonthView();
        const btn = event.target; const original = btn.textContent; btn.textContent='✅ Gespeichert!'; setTimeout(()=>btn.textContent=original, 1200);
      }
      closeEditPopup();
    }

    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }
    function nextMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()+1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }

    /* Save Day (respektiert God-Modus) */
    function saveDay(){
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if(!selected){ alert('Bitte eine Kategorie wählen.'); return; }

      const key = formatDateKey(new Date());
      const comment = (document.getElementById('dayCommentInput').value || '').trim();

      let extra = {};
      if(godMode){
        const god = collectGodData('day');
        if(god.alcohol) extra.alcohol = god.alcohol;
        if(god.marijuana) extra.marijuana = god.marijuana;
        extra.sport = !!god.sport;

        // Optional: Wenn nichts gewählt wurde, aber Gramm>0 -> Kategorie vorschlagen
        if(selected && god.alcohol){
          const suggested = godSuggestCategory(god.alcohol.grams, extra.sport);
          // nur vorschlagen, nicht überschreiben – der User hat gewählt
          // (wer will: Vorschlag-Button nutzen)
        }
      }

      dayData[key] = { status: selected.value, comment, ...extra };
      saveData();

      document.getElementById('dayCommentInput').value = '';
      document.getElementById('submitDay').disabled = true;

      showMonthView();
    }

    function resetStorage(){
      const ok = confirm('⚠️ Wirklich ALLE lokalen Daten (Tage + Einstellungen) löschen und neu starten?');
      if(!ok) return;
      try{
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerCurrentDate');
        localStorage.removeItem('alcoholTrackerSettings');
        localStorage.removeItem('boozeTrackerSettings');
      }catch(e){ console.warn('LocalStorage-Bereinigung fehlgeschlagen:', e); }
      location.reload();
    }

    // Export/Import (unverändert, nur Settings erweitert)
    function exportData(){
      try{
        const settingsRawA = localStorage.getItem('alcoholTrackerSettings');
        const settingsRawB = localStorage.getItem('boozeTrackerSettings');
        let settings = {};
        try{ if(settingsRawA) settings = JSON.parse(settingsRawA) || {}; }catch{}
        try{ if(settingsRawB) settings = { ...settings, ...(JSON.parse(settingsRawB)||{}) }; }catch{}
        settings.neutralDays = neutralDaysSetting;
        settings.godMode = godMode;

        const payload = {
          type: 'booze-tracker-backup',
          version: 2,
          exportedAt: new Date().toISOString(),
          dayData,
          settings
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url; a.download = 'booze-tracker-backup.json'; a.click();
        URL.revokeObjectURL(url);
        alert('✅ Export abgeschlossen.');
      }catch(e){ console.error(e); alert('❌ Export fehlgeschlagen.'); }
    }

    function importData(){
      const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json';
      input.onchange = e => {
        const file = e.target.files && e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const parsed = JSON.parse(ev.target.result);
            let importedDayData, importedSettings;
            if(parsed && parsed.dayData){ importedDayData = parsed.dayData; importedSettings = parsed.settings || {}; }
            else { importedDayData = parsed; importedSettings = {}; }

            const isDateKey = k => /^\d{4}-\d{1,2}-\d{1,2}$/.test(k);
            const normalizeKey = (k) => { const [y,m,d] = k.split('-').map(n=>parseInt(n,10)); const dt = new Date(y,m-1,d); return formatDateKey(dt); };

            const validEntries = {};
            Object.keys(importedDayData || {}).forEach(k => {
              if(isDateKey(k)){
                const normKey = normalizeKey(k);
                const v = importedDayData[k];
                if(typeof v === 'string'){ validEntries[normKey] = { status:v, comment:'' }; }
                else if(v && typeof v === 'object' && typeof v.status === 'string'){
                  validEntries[normKey] = {
                    status: v.status,
                    comment: v.comment || '',
                    ...(v.alcohol ? {alcohol:v.alcohol} : {}),
                    ...(v.marijuana ? {marijuana:v.marijuana} : {}),
                    ...(v.sport!==undefined ? {sport:!!v.sport} : {})
                  };
                }
              }
            });

            dayData = { ...dayData, ...validEntries };

            if(importedSettings){
              if(importedSettings.neutralDays) neutralDaysSetting = importedSettings.neutralDays;
              if(typeof importedSettings.godMode === 'boolean') godMode = importedSettings.godMode;
              localStorage.setItem('alcoholTrackerSettings', JSON.stringify({ neutralDays: neutralDaysSetting, godMode }));
              localStorage.setItem('boozeTrackerSettings', JSON.stringify({ neutralDays: neutralDaysSetting, godMode }));
            }

            saveData(); alert('✅ Daten importiert.'); location.reload();
          }catch(err){ console.error(err); alert('❌ Ungültige Datei oder JSON-Format.'); }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Expose
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openEditPopup = openEditPopup;
    window.closeEditPopup = closeEditPopup;
    window.updateDay = updateDay;
    window.resetStorage = resetStorage;
    window.toggleChartPopup = toggleChartPopup;
    window.exportData = exportData;
    window.importData = importData;
    window.openAudit = openAudit;
    window.closeAudit = closeAudit;

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('appVersion').textContent = APP_VERSION_BASE + currentHHMM();

      testStorage();
      loadData();

      // Radio-Klicks: Standard = sofort speichern; God-Modus = erst Button
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{
          if(godMode){
            document.getElementById('submitDay').disabled = false;
          } else {
            saveDay();
          }
        });
      });

      document.getElementById('submitDay').addEventListener('click', saveDay);

      // God-Modus UI Events (Day)
      document.getElementById('unitMl').addEventListener('click', ()=>setUnit('ml'));
      document.getElementById('unitL').addEventListener('click', ()=>setUnit('L'));
      ['godDrinkType','godVolumePerPortion','godPortions','godBeerSize'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input', ()=>updateGodCalc('day'));
        el.addEventListener('change', ()=>{ if(id==='godDrinkType' || id==='godBeerSize') syncBeerPreset('day'); updateGodCalc('day'); });
      });
      document.getElementById('godSuggest').addEventListener('click', ()=>{
        const god = collectGodData('day');
        const grams = god.alcohol ? god.alcohol.grams : 0;
        const suggested = godSuggestCategory(grams, god.sport);
        const radio = document.querySelector(`input[name="dayChoice"][value="${suggested}"]`);
        if(radio){ radio.checked = true; document.getElementById('submitDay').disabled = false; }
      });
      document.getElementById('godSaveDetails').addEventListener('click', ()=>{
        const message='✅ Details übernommen. Vergiss nicht „Tag speichern“ zu drücken.';
        alert(message);
      });

      // Edit-God UI Events
      document.getElementById('editUnitMl').addEventListener('click', ()=>setUnit('ml'));
      document.getElementById('editUnitL').addEventListener('click', ()=>setUnit('L'));
      ['editDrinkType','editVolumePerPortion','editPortions','editBeerSize'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input', ()=>updateGodCalc('edit'));
        el.addEventListener('change', ()=>{ if(id==='editDrinkType' || id==='editBeerSize') syncBeerPreset('edit'); updateGodCalc('edit'); });
      });

      updateDayInputView();
    });

  </script>
</body>
</html>
