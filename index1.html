<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker ‚Äî ChatGPT5_edit_Vers2.1_11:00</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;  /* Dunkleres Rot f√ºr Schadensbegrenzung */
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      position: relative;
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 18px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }
    .version-tag{
      display:block;
      text-align:center;
      color:#0c4a6e;
      font-size:12px;
      margin-top:-6px;
    }

    /* Eingabe */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 10px 0 18px;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"‚≠ê"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* Monats√ºbersicht */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    /* Erfolgsquote Ampel */
    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    /* Streak Ampel */
    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* 100 Tage Balken (Horizontal) */
    .chart-section{
      margin: 18px 0;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    .chart-title{
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      flex-direction: column;
      gap: 32px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-bar-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chart-bar-label{
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .chart-bar-label small{
      display: block;
      font-size: 12px;
      font-weight: 400;
      color: var(--muted);
      margin-top: 2px;
    }
    .chart-bar-value{
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .chart-bar-number{
      font-size: 32px;
      font-weight: 900;
      color: var(--text);
    }
    .chart-bar-percent{
      font-size: 16px;
      font-weight: 600;
      color: var(--muted);
    }
    .chart-bar-wrapper{
      height: 48px;
      background: #f1f5f9;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .chart-bar{
      height: 100%;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 16px;
      font-weight: 700;
      color: white;
      font-size: 16px;
      position: relative;
    }
    .chart-bar::after{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      border-radius: 12px;
    }
    .chart-bar.negative{ 
      background: linear-gradient(90deg, #ef4444, #f87171);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .chart-bar.positive{ 
      background: linear-gradient(90deg, #10b981, #34d399);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Gesundheitsbewertung */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      color: var(--text);
    }
    .assessment-badge{
      text-align: center;
      margin-bottom: 16px;
      padding: 14px;
      border-radius: 12px;
      font-size: 22px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
      color: #065f46;
      border: 2px solid #34d399;
    }
    .assessment-badge.balance{ 
      background: linear-gradient(135deg, #fef3c7, #fde68a); 
      color: #92400e;
      border: 2px solid #fbbf24;
    }
    .assessment-badge.weekend{ 
      background: linear-gradient(135deg, #fed7aa, #fdba74); 
      color: #9a3412;
      border: 2px solid #fb923c;
    }
    .assessment-badge.red{ 
      background: linear-gradient(135deg, #fecaca, #fca5a5); 
      color: #7f1d1d;
      border: 2px solid #ef4444;
    }
    .assessment-metrics{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 10px;
    }
    @media (max-width: 560px){ 
      .assessment-metrics{ grid-template-columns: 1fr; } 
    }
    .metric-item{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      position: relative;
    }
    .metric-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .metric-info{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      cursor: help;
      position: relative;
    }
    .metric-info:hover .metric-tooltip{ display: block; }
    .metric-tooltip{
      display: none;
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      padding: 12px;
      background: #1f2937;
      color: white;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      text-align: left;
      font-weight: 400;
    }
    .metric-tooltip::after{
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
    }
    .metric-tooltip strong{ color: #60a5fa; font-weight: 600; }
    .metric-value{ font-size: 20px; font-weight: 800; color: var(--text); }
    .assessment-description{
      padding: 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
    }
    .assessment-description strong{ color: var(--primary); }
    .assessment-warning{
      margin-top: 10px;
      padding: 10px;
      background: #fff7ed;
      border-left: 4px solid #fb923c;
      border-radius: 6px;
      font-size: 12px;
      color: #9a3412;
      display:none;
    }

    /* Buttons Top */
    .btn-stats-toggle, .btn-settings{
       appearance: none;
       border: 1.5px solid #c7d2fe;
       padding: 10px 18px;
       border-radius: 999px; 
       font-size: 14px; font-weight: 700; cursor: pointer;
       transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
       display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-stats-toggle{
      background: linear-gradient(135deg, #eef2ff, #e0e7ff);
      color: #1e3a8a; box-shadow: 0 6px 14px rgba(79,70,229,.18);
    }
    .btn-stats-toggle:hover{
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      border-color: #a5b4fc; transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(79,70,229,.25);
    }
    .btn-settings{
      background: linear-gradient(135deg, #f0f9ff, #dbeafe);
      color: #0c4a6e; box-shadow: 0 6px 14px rgba(2,132,199,.16);
      border-color:#bae6fd;
    }
    .btn-settings:hover{
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border-color: #93c5fd;
      transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,132,199,.22);
    }

    /* Popups */
    .chart-popup, .settings-popup, .edit-pop{
      border-radius:16px; border:1px solid #e5e7eb; background:#fff; box-shadow: 0 20px 40px rgba(31,41,55,.25);
    }
    .chart-popup{
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      padding: 20px; width: min(680px, 92vw); max-height: 85vh; overflow-y: auto;
      display: none; z-index: 1001;
    }
    .chart-popup.active{ display:block; }
    .chart-popup-overlay, .settings-popup-overlay{
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); display:none; z-index:1000;
    }
    .chart-popup-overlay.active, .settings-popup-overlay.active{ display:block; }

    .settings-popup{
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      padding: 24px; width: min(560px, 92vw); max-height: 85vh; overflow-y: auto;
      display:none; z-index:1002;
    }
    .settings-popup.active{ display:block; }
    .settings-title{ font-size:22px; font-weight:800; margin:0 0 6px; text-align:center; }
    .settings-subtitle{ font-size:14px; color:var(--muted); margin-bottom: 18px; text-align:center; }
    .settings-section{ margin-bottom: 20px; background:#fff; border:2px solid #e5e7eb; border-radius:12px; padding:14px; }
    .settings-section-title{ font-size:16px; font-weight:700; margin-bottom:10px; }
    .settings-description{ font-size:13px; color:var(--muted); margin-bottom:10px; line-height:1.6; }
    .settings-options{ display:flex; flex-direction:column; gap:10px; }
    .settings-option{
      display:flex; gap:12px; padding:12px; border:2px solid #e5e7eb; border-radius:12px; background:#fff; cursor:pointer; transition:.2s;
    }
    .settings-option:hover{ border-color: var(--primary); background:#f8faff; }
    .settings-option.selected{ border-color: var(--primary); background: linear-gradient(135deg,#eef2ff,#f8faff); box-shadow: 0 4px 12px rgba(79,70,229,.15); }
    .settings-option input[type="radio"], .settings-option input[type="checkbox"]{ transform: scale(1.2); accent-color: var(--primary); }

    /* Edit-Karte */
    .edit-pop{
      position: fixed; left:50%; top: 18px; transform: translateX(-50%);
      padding:14px; width: min(620px, 92vw); display:none; z-index: 1003;
    }
    .edit-pop.active{ display:block; }
    .edit-title{ font-weight:800; font-size:18px; margin: 4px 0 8px; color:#111827; }
    .edit-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .edit-grid{ grid-template-columns: 1fr; } }
    .edit-option{
      width:100%; padding:12px 14px; border-radius:12px; border:2px solid #edf2f7; background:#fff; cursor:pointer; text-align:left;
      transition:.12s ease; font-size:15px;
    }
    .edit-option:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .edit-option.sober{ border-color:#c0f1df; background:#f4fffa; }
    .edit-option.wellness{ border-color:#b3f5cc; background:#f0fdf5; position:relative; }
    .edit-option.wellness::after{ content:"‚ùó"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.moderate{ border-color:#ffe5b5; background:#fff9ec; }
    .edit-option.mixed{ border-color:#fecaca; background:#fef2f2; position:relative; }
    .edit-option.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.alcohol{ border-color:#ffcaca; background:#fff2f2; }
    .edit-option.superday{ border-color:#b7f3d2; background:linear-gradient(135deg,#f6fff9,#f1fff7); position:relative; }
    .edit-option.superday::after{ content:"‚≠ê"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.delete{ border-color:#e2e8f0; background:#f8fafc; }

    /* God-Mode: Detailbereich */
    .god-section{
      margin-top:16px; padding:14px; border:2px solid #e5e7eb; border-radius:12px; background:#f9fafb;
    }
    .god-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .god-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; flex-direction:column; gap:6px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px;
    }
    .field label{ font-size:12px; color:var(--muted); }
    .field input[type="number"], .field select, .field input[type="text"]{
      padding:8px; border-radius:8px; border:1px solid #d1d5db; font-size:13px; font-family:inherit;
    }
    .inline{ display:flex; gap:10px; align-items:center; }
    .pill{ padding:6px 10px; background:#eef2ff; color:#1e3a8a; border:1px solid #c7d2fe; border-radius:999px; font-weight:700; font-size:12px; }
    .calc-box{ padding:10px; border:2px dashed #cbd5e1; border-radius:10px; background:#fff; font-size:13px; }
    .calc-box strong{ color:#0b5; }
    .hint{ font-size:12px; color:var(--muted); }

    /* Godmode-Badge */
    .god-badge{
      position: fixed; right: 14px; bottom: 14px;
      background: linear-gradient(135deg,#fff7ed,#ffedd5);
      border: 2px solid #fdba74; color:#9a3412;
      padding:8px 12px; border-radius:999px; font-size:12px; font-weight:800;
      box-shadow: 0 10px 20px rgba(251,146,60,.25);
      display:none; z-index:1100;
    }
    .god-badge.active{ display:block; }

    /* Danger box */
    .danger-box{
      background:#fef2f2; border:2px solid #fecaca; color:#7f1d1d;
      border-radius:12px; padding:12px; font-size:13px;
    }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }

    @media (max-width: 420px){
      .btn-stats-toggle, .btn-settings{
        padding: 9px 14px; font-size: 13px; gap: 6px;
      }
      .god-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tag-Eingabe Ansicht -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Ralles wunderbarer Booze-Tracker</h1>
      <div class="version-tag">ChatGPT5_edit_Vers2.1_11:00</div>
      <div class="current-date" id="currentDateDisplay"></div>

      <div style="margin-top: 16px;">
        <label for="dayCommentInput" style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          üí¨ Kommentar (optional):
        </label>
        <textarea 
          id="dayCommentInput" 
          placeholder="Notizen zum Tag (z.B. Anlass, Gef√ºhle, Situation)..."
          style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical;"
        ></textarea>
      </div>

      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday">
          <input type="radio" name="dayChoice" value="superday" />
          <span>‚≠ê Supertag ‚Äì Alkoholfrei + Sport gemacht!</span>
        </label>
        <label class="choice-option wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <span>üíö Wellness ‚Äì Alkoholfrei + Sauna/Gesundheit</span>
        </label>
        <label class="choice-option sober">
          <input type="radio" name="dayChoice" value="sober" />
          <span>üü¢ Alkoholfrei ‚Äì Kein Alkohol getrunken</span>
        </label>
        <label class="choice-option moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <span>üü° Moderat ‚Äì Wenig Alkohol getrunken</span>
        </label>
        <label class="choice-option mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <span>‚ù§Ô∏è Schadensbegrenzung ‚Äì Alkohol + Sport</span>
        </label>
        <label class="choice-option alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <span>üî¥ Alkohol ‚Äì Viel Alkohol getrunken</span>
        </label>
      </div>

      <!-- GOD MODE DETAIL-EINGABE (nur sichtbar, wenn aktiviert) -->
      <div id="godInputSection" class="god-section" style="display:none;">
        <div class="god-row" style="justify-content:space-between;">
          <div class="pill">üß™ God-Modus ‚Äì Detaillierte Angaben</div>
          <label class="inline" style="gap:8px;">
            <input type="checkbox" id="godSport" />
            <span style="font-size:13px;">üèÉ‚Äç‚ôÇÔ∏è Sport gemacht</span>
          </label>
        </div>

        <!-- Schnellwahl Bier -->
        <div class="god-grid" style="margin-top:12px;">
          <div class="field">
            <label>üç∫ Schnellwahl: Bier 0,33 l (5 % vol)</label>
            <div class="inline">
              <select id="beer033Count">
                <option value="0">0</option>
                ${Array.from({length:20},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
              </select>
              <span class="hint">Anzahl Flaschen</span>
            </div>
          </div>
          <div class="field">
            <label>üç∫ Schnellwahl: Bier 0,5 l (5 % vol)</label>
            <div class="inline">
              <select id="beer05Count">
                <option value="0">0</option>
                ${Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
              </select>
              <span class="hint">Anzahl Flaschen</span>
            </div>
          </div>
        </div>

        <!-- Manuelle Eingabe -->
        <div class="god-grid" style="margin-top:12px;">
          <div class="field">
            <label>ü•É Getr√§nketyp</label>
            <select id="alcType">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liqueur" data-abv="15">Lik√∂r (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirits" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>
          <div class="field">
            <label>üî¢ Anzahl Portionen</label>
            <input id="alcPortions" type="number" min="0" step="1" value="0" />
          </div>
          <div class="field">
            <label>üìè Menge pro Portion</label>
            <div class="inline">
              <input id="alcAmount" type="number" min="0" step="10" value="0" style="width:120px;">
              <select id="unitToggle" style="width:90px;">
                <option value="ml">ml</option>
                <option value="l">l</option>
              </select>
            </div>
            <div class="hint">Bei Wein reichen ml; Einheit frei w√§hlbar.</div>
          </div>
          <div class="field">
            <label>üåø Marijuana (optional)</label>
            <div class="inline">
              <input id="mjGrams" type="number" min="0" step="0.1" value="0" style="width:110px;" placeholder="Gramm">
              <select id="mjFreq">
                <option value="">H√§ufigkeit w√§hlen</option>
                <option value="einmalig">einmalig</option>
                <option value="mehrmals">mehrmals am Tag</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Ergebnis -->
        <div class="calc-box" style="margin-top:12px;">
          <div>üìê <strong id="calcGrams">0</strong> g reiner Alkohol ‚Ä¢ ü•§ <strong id="calcDrinks">0</strong> Standarddrinks (10 g)</div>
          <div style="margin-top:6px;">üß† Kategorie-Vorschlag: <strong id="suggestedCategory">‚Äî</strong></div>
          <div id="suggestionNote" class="hint" style="margin-top:6px; display:none;">Vorschlag √ºbernommen: Die Tageskategorie wurde oben vorgew√§hlt. Speichere, um den Tag zu √ºbernehmen.</div>
        </div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn" disabled>Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        üç∑ Gespeicherte Tage: <span id="savedDaysCount">0</span> ¬∑
        <span id="storageStatus">Lade‚Ä¶</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
    </div>

    <!-- Monats-√úbersicht -->
    <div id="monthView" class="view">
      <h1>üìä Ralles wunderbarer Booze-Tracker</h1>
      <div class="version-tag">ChatGPT5_edit_Vers2.1_11:00</div>

      <div class="month-head">
        <div class="month-title" id="monthHeader">‚Äî</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">‚Üê Vorheriger</button>
        <button class="btn" onclick="nextMonth()">N√§chster ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Erfolgsquote</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>‚≠ê Supertag</span>
        <span>üíö Wellness</span>
        <span>üü¢ Alkoholfrei</span>
        <span>üü° Moderat</span>
        <span>‚ù§Ô∏è "Schadensbegrenzung"</span>
        <span>üî¥ Alkohol</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <!-- Buttons -->
      <div style="text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">üìä 100-Tage-Statistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">‚öôÔ∏è Einstellungen</button>
      </div>

      <section class="support" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius: 14px; padding: 14px; margin: 12px 0 12px; text-align:center;">
        <p><strong>Findest diese kleine Anwendung n√ºtzlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center;">
          <div id="kofi-holder" class="btn-holder">
            <div id="kofi-widget" aria-label="Ko-fi Unterst√ºtzungsbutton"></div>
          </div>
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky"><img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir ¬¥n Kaffee! &emoji=‚òï&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" /></a>
          </div>
        </div>
        <script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
        <script type="text/javascript"> try{ kofiwidget2.init('Spendier mir n¬¥ Kaffee Ko-fi', '#72a4f2', 'R5R319DK8N'); kofiwidget2.draw(); }catch(e){} </script>
      </section>
    </div>

    <!-- Edit-Karte -->
    <div id="editPopup" class="edit-pop" aria-hidden="true">
      <div class="edit-title" id="editDate">Datum</div>
      <div class="edit-grid">
        <button class="edit-option superday" onclick="updateDay('superday')">‚≠ê Supertag</button>
        <button class="edit-option wellness" onclick="updateDay('wellness')">üíö Wellness</button>
        <button class="edit-option sober" onclick="updateDay('sober')">üü¢ Alkoholfrei</button>
        <button class="edit-option moderate" onclick="updateDay('moderate')">üü° Moderat</button>
        <button class="edit-option mixed" onclick="updateDay('mixed')">‚ù§Ô∏è Schadensbegrenzung</button>
        <button class="edit-option alcohol" onclick="updateDay('alcohol')">üî¥ Alkohol</button>
      </div>
      
      <div style="margin-top: 12px;">
        <label for="editCommentInput" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
          üí¨ Kommentar:
        </label>
        <textarea 
          id="editCommentInput" 
          placeholder="Notizen zum Tag..."
          style="width: 100%; min-height: 70px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; font-family: inherit; resize: vertical;"
        ></textarea>
        <button class="btn" style="width: 100%; margin-top: 8px;" onclick="saveEditComment()">üíæ √Ñnderungen speichern</button>
      </div>

      <!-- Godmode: Detail bearbeiten -->
      <div id="godEditContainer" class="god-section" style="display:none; margin-top:12px;">
        <div class="pill">üß™ God-Modus: Detaillierte Mengen bearbeiten</div>
        <div class="god-grid" style="margin-top:10px;">
          <div class="field">
            <label>üç∫ Bier 0,33 l</label>
            <input id="editBeer033" type="number" min="0" step="1" value="0">
          </div>
          <div class="field">
            <label>üç∫ Bier 0,5 l</label>
            <input id="editBeer05" type="number" min="0" step="1" value="0">
          </div>
          <div class="field">
            <label>ü•É Typ</label>
            <select id="editType">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liqueur" data-abv="15">Lik√∂r (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirits" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>
          <div class="field">
            <label>üî¢ Portionen</label>
            <input id="editPortions" type="number" min="0" step="1" value="0">
          </div>
          <div class="field">
            <label>üìè Menge/Portion</label>
            <div class="inline">
              <input id="editAmount" type="number" min="0" step="10" value="0" style="width:120px;">
              <select id="editUnit">
                <option value="ml">ml</option>
                <option value="l">l</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>üèÉ‚Äç‚ôÇÔ∏è Sport</label>
            <input id="editSport" type="checkbox">
          </div>
          <div class="field">
            <label>üåø Marijuana</label>
            <div class="inline">
              <input id="editMjGrams" type="number" min="0" step="0.1" value="0" style="width:110px;">
              <select id="editMjFreq">
                <option value="">‚Äî</option>
                <option value="einmalig">einmalig</option>
                <option value="mehrmals">mehrmals am Tag</option>
              </select>
            </div>
          </div>
        </div>
        <div class="calc-box" style="margin-top:8px;">
          <div>üìê <strong id="editCalcGrams">0</strong> g ‚Ä¢ ü•§ <strong id="editCalcDrinks">0</strong> Drinks</div>
        </div>
        <button class="btn" style="width:100%; margin-top:8px;" onclick="saveGodEdit()">üíæ Detaileingaben speichern</button>
      </div>

      <div class="edit-grid" style="margin-top: 12px;">
        <button id="btnOpenGodEdit" class="edit-option" style="border-color:#c7d2fe; background:#eef2ff; display:none;" onclick="toggleGodEdit()">üß™ Detaillierte Mengen bearbeiten (God-Modus)</button>
        <button class="edit-option delete" onclick="updateDay('delete')">üóëÔ∏è Tag l√∂schen</button>
        <button class="btn secondary" onclick="closeEditPopup()">Schlie√üen</button>
      </div>
    </div>

    <!-- Chart-Popup -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup" aria-hidden="true">
      <div class="chart-section">
        <div class="chart-title">üìä Letzte 100 Tage im √úberblick</div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üî¥ Unter 50%
                <small>Alkohol, "Schadensbegrenzung", Moderat</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative" style="width: 0%;"></div>
            </div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üü¢ √úber 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesundheitsbewertung -->
      <div class="health-assessment">
        <div class="assessment-title">üéØ Deine Gesundheitseinsch√§tzung</div>
        <div class="assessment-badge" id="assessmentBadge"></div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">
              AF-Quote (alkoholfrei)
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">
                  Prozentsatz alkoholfreier Tage:<br>
                  <strong>Supertag + Wellness + Alkoholfrei</strong><br><br>
                  Je h√∂her, desto besser.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Gewichtete Gesundheit
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">
                  Score gewichtet nach Kategorien (Supertag=100 ‚Ä¶ Alkohol=0).
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Binge-N√§he
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">
                  Hochrisiko-Tage (Alkohol + Schadensbegrenzung).
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              L√§ngster Cluster
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">
                  L√§ngste Serie von Hochrisiko-Tagen am St√ºck.
                </span>
              </span>
            </div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning"></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnShowDetailAnalysis" class="btn secondary" style="flex:1 1 220px;" onclick="toggleDetailAnalysis()">üß† Detaillierte Analyse anzeigen</button>
          <button id="btnOpenAudit" class="btn" style="display:none; flex:1 1 220px;" onclick="openAudit()">üß™ AUDIT-C Screening √∂ffnen</button>
        </div>

        <!-- Detaillierte Analyse-Panel -->
        <div id="detailAnalysisPanel" class="god-section" style="display:none; margin-top:12px;">
          <div class="god-grid">
            <div class="field">
              <label>√ò Drinks/Woche (28 Tage)</label>
              <div id="daDrinksWeek" style="font-weight:800;">‚Äî</div>
            </div>
            <div class="field">
              <label>Binge-Tage / 100</label>
              <div id="daBinge100" style="font-weight:800;">‚Äî</div>
            </div>
            <div class="field">
              <label>L√§ngster Hochrisiko-Cluster</label>
              <div id="daCluster" style="font-weight:800;">‚Äî</div>
            </div>
            <div class="field">
              <label>Marijuana (g/Woche)</label>
              <div id="daMjWeek" style="font-weight:800;">‚Äî</div>
            </div>
          </div>
          <div class="calc-box" style="margin-top:10px;" id="patternNotes"></div>
        </div>

        <!-- AUDIT-C (versteckt, nur via Button) -->
        <div id="auditWrap" class="god-section" style="display:none; margin-top:12px;">
          <div class="settings-title" style="margin:0 0 8px;">üìù AUDIT-C Schnelltest (WHO)</div>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">
            3 Fragen zum Konsum im letzten Jahr. Screening-Tool ‚Äì keine Diagnose.
          </p>
          <div style="margin-bottom: 10px;">
            <label style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Geschlecht (Cut-offs):</label>
            <select id="auditGender" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px;">
              <option value="male">M√§nnlich</option>
              <option value="female">Weiblich</option>
            </select>
          </div>

          <div class="audit-question">
            <label class="audit-question-label">1. Wie oft trinken Sie alkoholhaltige Getr√§nke?</label>
            <div class="audit-options" style="display:flex; flex-direction:column; gap:6px;">
              <label class="audit-option"><input type="radio" name="auditQ1" value="0"> Nie (0)</label>
              <label class="audit-option"><input type="radio" name="auditQ1" value="1"> Monatlich oder seltener (1)</label>
              <label class="audit-option"><input type="radio" name="auditQ1" value="2"> 2‚Äì4√ó/Monat (2)</label>
              <label class="audit-option"><input type="radio" name="auditQ1" value="3"> 2‚Äì3√ó/Woche (3)</label>
              <label class="audit-option"><input type="radio" name="auditQ1" value="4"> 4√ó/Woche oder √∂fter (4)</label>
            </div>
          </div>

          <div class="audit-question">
            <label class="audit-question-label">2. Wie viele Einheiten an einem typischen Tag? <small>(1 Einheit ‚âà 10 g)</small></label>
            <div class="audit-options" style="display:flex; flex-direction:column; gap:6px;">
              <label class="audit-option"><input type="radio" name="auditQ2" value="0"> 1‚Äì2 (0)</label>
              <label class="audit-option"><input type="radio" name="auditQ2" value="1"> 3‚Äì4 (1)</label>
              <label class="audit-option"><input type="radio" name="auditQ2" value="2"> 5‚Äì6 (2)</label>
              <label class="audit-option"><input type="radio" name="auditQ2" value="3"> 7‚Äì9 (3)</label>
              <label class="audit-option"><input type="radio" name="auditQ2" value="4"> 10+ (4)</label>
            </div>
          </div>

          <div class="audit-question">
            <label class="audit-question-label">3. Wie oft sechs oder mehr Einheiten?</label>
            <div class="audit-options" style="display:flex; flex-direction:column; gap:6px;">
              <label class="audit-option"><input type="radio" name="auditQ3" value="0"> Nie (0)</label>
              <label class="audit-option"><input type="radio" name="auditQ3" value="1"> < monatlich (1)</label>
              <label class="audit-option"><input type="radio" name="auditQ3" value="2"> monatlich (2)</label>
              <label class="audit-option"><input type="radio" name="auditQ3" value="3"> w√∂chentlich (3)</label>
              <label class="audit-option"><input type="radio" name="auditQ3" value="4"> (fast) t√§glich (4)</label>
            </div>
          </div>

          <button class="btn" style="width: 100%; margin-top: 8px;" onclick="calculateAuditScore()">Ergebnis berechnen</button>
          <div id="auditResult" style="display:none; margin-top:10px;"></div>
        </div>
      </div>

      <button class="btn secondary" style="margin-top: 16px; width: 100%;" onclick="toggleChartPopup()">Schlie√üen</button>
    </div>

    <!-- Einstellungs-Popup -->
    <div class="settings-popup-overlay" id="settingsOverlay" onclick="toggleSettingsPopup()"></div>
    <div id="settingsPopup" class="settings-popup" aria-hidden="true">
      <div class="settings-title">‚öôÔ∏è Einstellungen</div>
      <div class="settings-subtitle">Passe die Bewertung an deine Bed√ºrfnisse an</div>

      <div class="settings-section">
        <div class="settings-section-title">üß™ God-Modus</div>
        <div class="settings-description">Wenn aktiviert, kannst du detaillierte Mengen erfassen, automatische Kategorie-Vorschl√§ge nutzen und erweiterte Analysen einsehen.</div>
        <label class="settings-option">
          <input type="checkbox" id="toggleGodMode">
          <div>
            <div class="settings-option-title">God-Modus aktivieren</div>
            <div class="settings-option-desc">Zeige die detaillierte Tages-Eingabe und erweitere die Auswertung (intern feinere Risikostufen).</div>
          </div>
        </label>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üéØ Neutrale Tage werten</div>
        <div class="settings-description">
          Wie sollen Tage ohne Eintrag gewertet werden (f√ºr die 100-Tage-Bewertung)?
        </div>
        <div class="settings-options">
          <label class="settings-option" id="option-ignore">
            <input type="radio" name="neutralDays" value="ignore" checked>
            <div>
              <div class="settings-option-title">Ignorieren (Empfohlen)</div>
              <div class="settings-option-desc">Nur eingetragene Tage z√§hlen.</div>
            </div>
          </label>
          <label class="settings-option" id="option-neutral">
            <input type="radio" name="neutralDays" value="neutral">
            <div>
              <div class="settings-option-title">Als neutral werten (50%)</div>
              <div class="settings-option-desc">Leicht positiv.</div>
            </div>
          </label>
          <label class="settings-option" id="option-negative">
            <input type="radio" name="neutralDays" value="negative">
            <div>
              <div class="settings-option-title">Eher negativ (30%)</div>
              <div class="settings-option-desc">Strenger, motiviert zum Tracken.</div>
            </div>
          </label>
          <label class="settings-option" id="option-very-negative">
            <input type="radio" name="neutralDays" value="very-negative">
            <div>
              <div class="settings-option-title">Sehr negativ (15%)</div>
              <div class="settings-option-desc">Maximale Disziplin.</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Backup & Wiederherstellung -->
      <div class="settings-section">
        <div class="settings-section-title">üóÑÔ∏è Daten-Backup (lokal)</div>
        <div class="settings-description">Export/Import laufen ausschlie√ülich im Browser. Es werden <strong>keine</strong> Daten hochgeladen.</div>
        <div class="submit-row" style="margin-top: 8px;">
          <button class="btn secondary" onclick="exportData()">üì§ Daten exportieren</button>
          <button class="btn secondary" onclick="importData()">üì• Daten importieren</button>
        </div>
        <p class="settings-description" style="margin-top:10px;">Beim Import werden vorhandene Tage gemerged (gleiche Tage werden √ºberschrieben).</p>
      </div>

      <button class="btn" style="width: 100%; margin-bottom:14px;" onclick="saveSettings()">Einstellungen speichern</button>

      <!-- Danger Zone -->
      <div class="settings-section danger-box">
        <div class="settings-section-title">üß® Gefahrbereich</div>
        <div class="settings-description"><strong>Alle lokalen Daten endg√ºltig entfernen.</strong> Dies kann nicht r√ºckg√§ngig gemacht werden.</div>
        <button class="btn danger" style="width:100%;" onclick="resetStorage()">üóëÔ∏è ALLE Datenbankeintr√§ge unwiderruflich l√∂schen</button>
      </div>
    </div>

    <footer>¬© 2025 by R. Duwenbeck</footer>
  </div>

  <!-- Godmode Badge -->
  <div id="godBadge" class="god-badge">üß™ God-Modus aktiviert</div>

  <script>
    const APP_VERSION = 'ChatGPT5_edit_Vers2.1_11:00';
    const ETHANOL_DENSITY_G_PER_ML = 0.789; // g/ml
    const ABV_DEFAULTS = { beer:5, radler:2.5, wine:10, liqueur:15, other20:20, other30:30, spirits:40 };

    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let dayData = {};
    let editingDate = null;
    let storageWorking = false;
    let neutralDaysSetting = 'ignore';
    let godMode = false;

    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays   = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    const formatDateKey = (date)=> `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
    const formatDisplayDate = (date)=> `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    const getDayStatus = (key) => {
      const data = dayData[key];
      if(!data) return null;
      return typeof data === 'string' ? data : data.status;
    };
    const getDayComment = (key) => {
      const data = dayData[key];
      if(!data || typeof data === 'string') return '';
      return data.comment || '';
    };

    function testStorage(){ try{ localStorage.setItem('__test__','1'); localStorage.removeItem('__test__'); storageWorking = true; }catch{ storageWorking=false; } }
    function updateStorageStatus(message){
      const status = document.getElementById('storageStatus');
      const count  = document.getElementById('savedDaysCount');
      if(status) status.textContent = message ?? '';
      if(count)  count.textContent  = Object.keys(dayData).length;
    }
    function saveData(){
      if(!storageWorking){ updateStorageStatus('‚ùå Speichern nicht m√∂glich'); return false; }
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        localStorage.setItem('alcoholTrackerSettings', JSON.stringify({ neutralDays: neutralDaysSetting, godMode }));
        updateStorageStatus('‚úÖ Daten gespeichert'); return true;
      }catch{ updateStorageStatus('‚ùå Speicher-Fehler'); return false; }
    }
    function loadData(){
      if(!storageWorking){ updateStorageStatus('‚ö†Ô∏è Kein persistenter Speicher'); return; }
      try{
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        currentInputDate = new Date();

        const savedSettings = localStorage.getItem('alcoholTrackerSettings');
        if(savedSettings){
          const settings = JSON.parse(savedSettings);
          neutralDaysSetting = settings.neutralDays || 'ignore';
          godMode = !!settings.godMode;
        }
        updateStorageStatus(`‚úÖ ${Object.keys(dayData).length} Tage geladen`);
      }catch{
        dayData = {}; currentInputDate = new Date(); updateStorageStatus('‚ùå Laden fehlgeschlagen');
      }
    }

    /* UI Helpers */
    function setSuccessCardTint(pct){
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if(pct < 50)      card.classList.add('rate-bad');
      else if(pct < 75) card.classList.add('rate-warn');
      else              card.classList.add('rate-good');
    }
    function calculateSuccessRate(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      let total=0, max=0;
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const key = formatDateKey(new Date(y,m,d));
        const st = getDayStatus(key);
        if(!st) continue;
        max += 1;
        if(st==='superday') total += 1.0;
        else if(st==='wellness') total += 0.9;
        else if(st==='sober') total += 0.75;
        else if(st==='moderate') total += 0.4;
        else if(st==='mixed') total += 0.25;
      }
      const pct = max>0 ? Math.round((total/max)*100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      setSuccessCardTint(pct);
    }

    function calculate100DaysChart(){
      let negative = 0; // alcohol, mixed, moderate
      let positive = 0; // sober, wellness, superday
      const today = new Date();
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = getDayStatus(formatDateKey(probe));
        if(st === 'alcohol' || st === 'mixed' || st === 'moderate') negative++;
        else if(st === 'sober' || st === 'wellness' || st === 'superday') positive++;
      }
      const negPct = Math.round((negative / 100) * 100);
      const posPct = Math.round((positive / 100) * 100);
      setTimeout(() => {
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 50);
    }

    /* God-Mode: Gramm/Drinks Berechnung aus Eingaben (Day-Input) */
    function litersFrom(value, unit){ const v = parseFloat(value||0); return (unit==='l') ? v : (v/1000); }
    function gramsFromLiters(liters, abvPercent){
      const abv = (parseFloat(abvPercent||0)/100);
      return Math.max(0, liters * abv * (ETHANOL_DENSITY_G_PER_ML*1000)); // 789 g/L
    }
    function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }

    function readGodInputs(){
      const beer033 = parseInt(document.getElementById('beer033Count')?.value||'0',10);
      const beer05  = parseInt(document.getElementById('beer05Count')?.value||'0',10);
      const alcTypeEl = document.getElementById('alcType');
      const abv = parseFloat(alcTypeEl?.selectedOptions?.[0]?.dataset?.abv || ABV_DEFAULTS.beer);
      const portions = parseInt(document.getElementById('alcPortions')?.value||'0',10);
      const amount = parseFloat(document.getElementById('alcAmount')?.value||'0');
      const unit = document.getElementById('unitToggle')?.value || 'ml';
      const sport = !!document.getElementById('godSport')?.checked;
      const mjGrams = parseFloat(document.getElementById('mjGrams')?.value||'0');
      const mjFreq = document.getElementById('mjFreq')?.value||'';

      return { beer033, beer05, type: alcTypeEl?.value||'beer', abv, portions, amount, unit, sport, mjGrams, mjFreq };
    }

    function computeGodTotals(inputs){
      const l_beer033 = inputs.beer033 * 0.33;
      const l_beer05  = inputs.beer05  * 0.5;

      const gramsBeer033 = gramsFromLiters(l_beer033, 5);
      const gramsBeer05  = gramsFromLiters(l_beer05, 5);

      const litersManual = litersFrom(inputs.amount, inputs.unit) * clamp(inputs.portions,0,9999);
      const gramsManual  = gramsFromLiters(litersManual, inputs.abv);

      const totalGrams = gramsBeer033 + gramsBeer05 + gramsManual;
      const drinks = totalGrams / 10;

      return {
        grams: Math.round(totalGrams),
        drinks: Math.round(drinks*10)/10,
        breakdown: {
          beer033: { liters:l_beer033, grams:Math.round(gramsBeer033), count:inputs.beer033 },
          beer05:  { liters:l_beer05,  grams:Math.round(gramsBeer05),  count:inputs.beer05  },
          manual:  { liters:Math.round(litersManual*1000)/1000, grams:Math.round(gramsManual), type:inputs.type, abv:inputs.abv, portions:inputs.portions, amount:inputs.amount, unit:inputs.unit }
        },
        sport: inputs.sport,
        marijuana: { grams: Math.round((inputs.mjGrams||0)*10)/10, frequency: inputs.mjFreq||'' }
      };
    }

    function suggestCategory(grams, sport){
      if(grams<=0){
        return sport ? 'superday' : 'sober';
      }
      if(sport){
        return grams > 60 ? 'alcohol' : 'mixed';
      }else{
        return grams > 40 ? 'alcohol' : 'moderate';
      }
    }

    function applySuggestionToRadios(suggested){
      const radio = document.querySelector(`input[name="dayChoice"][value="${suggested}"]`);
      if(radio){
        radio.checked = true;
        document.getElementById('submitDay').disabled = false;
        const note = document.getElementById('suggestionNote');
        if(note){ note.style.display = 'block'; setTimeout(()=> note.style.display='none', 2000); }
      }
    }

    function updateGodCalculationUI(){
      if(!godMode) return;
      const inputs = readGodInputs();
      const totals = computeGodTotals(inputs);
      document.getElementById('calcGrams').textContent = String(totals.grams);
      document.getElementById('calcDrinks').textContent = String(totals.drinks);
      const cat = suggestCategory(totals.grams, totals.sport);
      document.getElementById('suggestedCategory').textContent = cat.toUpperCase();
      applySuggestionToRadios(cat);
    }

    /* HEALTH ASSESSMENT */
    function calculateHealthAssessment(){
      const today = new Date();
      const last100 = [];
      let counted = { superday:0, wellness:0, sober:0, moderate:0, mixed:0, alcohol:0, empty:0 };

      for(let i=0;i<100;i++){
        const probe = new Date(today); probe.setDate(probe.getDate()-i);
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if(st){ last100.push({key, st}); counted[st]++; } else { last100.push({key, st:null}); counted.empty++; }
      }
      const enteredDays = 100 - counted.empty;

      // weights for category health
      const catWeight = { superday:1.0, wellness:0.9, sober:0.75, moderate:0.4, mixed:0.25, alcohol:0.0 };
      let divisor = 100;
      let neutralWeight = 0;
      if(neutralDaysSetting === 'ignore'){ divisor = enteredDays>0?enteredDays:1; }
      else if(neutralDaysSetting === 'neutral'){ neutralWeight = 0.5; }
      else if(neutralDaysSetting === 'negative'){ neutralWeight = 0.3; }
      else if(neutralDaysSetting === 'very-negative'){ neutralWeight = 0.15; }

      const afCount = counted.superday + counted.wellness + counted.sober;
      const afQuote = afCount / (neutralDaysSetting==='ignore' ? (enteredDays||1) : 100);
      const weightedScore = (
        counted.superday*1.0 + counted.wellness*0.9 + counted.sober*0.75 + counted.moderate*0.4 + counted.mixed*0.25 + counted.alcohol*0.0 + counted.empty*neutralWeight
      ) / 100;

      // Binge = alcohol + mixed
      const bingeProximity = counted.alcohol + counted.mixed;
      const bingeQuote = bingeProximity / (neutralDaysSetting==='ignore' ? (enteredDays||1) : 100);

      // Cluster
      let maxCluster = 0, cur = 0;
      for(const d of last100){
        if(d.st==='alcohol' || d.st==='mixed'){ cur++; maxCluster = Math.max(maxCluster, cur); }
        else cur = 0;
      }

      // Label
      let label, badgeClass, description='', warning='';
      if(bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10)){
        label='üö® Sucht-Alarm: Rote Lampen!'; badgeClass='red';
        description='Sehr hohes Risiko / potenzielle Abh√§ngigkeit. Binge-N√§he sehr hoch oder kaum alkoholfreie Tage.';
        warning='üÜò Bitte professionelle Hilfe erw√§gen. AUDIT-C verf√ºgbar.';
      } else if((bingeProximity >= 20) || (afQuote < 0.30) || (bingeQuote >= 0.20 && enteredDays >= 10)){
        label='üé≤ Risiko-Roulette'; badgeClass='red';
        description='Hohes Risiko ‚Äì h√§ufige Hochrisiko-Tage oder geringe AF-Quote.';
        warning='üö® Reduktion dringend empfohlen. AUDIT-C verf√ºgbar.';
      } else if(afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)){
        label='üö® Kipppunkt-Kandidat'; badgeClass='weekend';
        description='Erh√∂htes Risiko ‚Äì kritische Schwelle erreicht.';
        warning='‚ö†Ô∏è Beobachten & reduzieren. AUDIT-C verf√ºgbar.';
      } else if(afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12){
        label='üßò Balance-Buddha'; badgeClass='balance';
        description='Moderates Risiko. Mehr gr√ºne Tage erh√∂hen die Sicherheit.';
      } else {
        label='ü¶∏ Leber-Superheld'; badgeClass='zen';
        description='Niedriges Gesamtrisiko ‚Äì viele alkoholfreie Tage.';
      }

      const afDisplay = neutralDaysSetting === 'ignore' ? `${Math.round(afQuote*100)}% (${afCount}/${enteredDays||0})` : `${Math.round(afQuote*100)}%`;
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore*100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? `${bingeProximity} (${Math.round(bingeQuote*100)}%)` : bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster>0 ? (maxCluster + ' Tage') : 'Keiner';

      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label; badge.className = 'assessment-badge ' + badgeClass;

      const basisInfo = neutralDaysSetting === 'ignore'
        ? `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:8px;">üìä Basierend auf <strong>${enteredDays} von 100 Tagen</strong></div>`
        : `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:8px;">üìä Basierend auf <strong>100 Tagen</strong> (${enteredDays} eingetragen, ${counted.empty} neutral gewertet)</div>`;

      document.getElementById('assessmentDescription').innerHTML = basisInfo + description;
      const warningEl = document.getElementById('assessmentWarning');
      if(warning){ warningEl.textContent = warning; warningEl.style.display='block'; } else { warningEl.style.display='none'; }

      // Show AUDIT CTA only when risky
      const showAudit = /Alarm|Risiko|Kipppunkt/.test(label);
      document.getElementById('btnOpenAudit').style.display = showAudit ? 'inline-flex' : 'none';

      // Detail analysis numbers
      computeDetailAnalysis(); // fills detail panel values
    }

    /* Detail Analysis (God) */
    function getGramsForDay(key, fallback=true){
      const rec = dayData[key];
      if(!rec) return 0;
      if(typeof rec === 'object' && rec.alcohol && typeof rec.alcohol.grams === 'number') return rec.alcohol.grams;
      if(!fallback) return 0;
      const st = typeof rec==='string'?rec:rec.status;
      const map = { superday:0, wellness:0, sober:0, moderate:20, mixed:40, alcohol:80 };
      return map[st] ?? 0;
    }
    function getMJForDay(key){
      const rec = dayData[key];
      if(!rec || typeof rec!=='object' || !rec.marijuana) return 0;
      return rec.marijuana.grams ? Number(rec.marijuana.grams) : 0;
    }

    function computeDetailAnalysis(){
      const today = new Date();
      let grams28=0, daysConsidered=0, mj28=0;
      let binge100=0, cluster=0, cur=0;
      let friSatHigh=0, friSatTotal=0, daily10plus=0, days>?

      for(let i=0;i<100;i++){
        const probe = new Date(today); probe.setDate(probe.getDate()-i);
        const key = formatDateKey(probe);
        const grams = getGramsForDay(key,true);
        if(i<28){
          grams28 += grams; daysConsidered++;
          mj28 += getMJForDay(key);
        }
        if(grams>40) binge100++;
        if(grams>40){ cur++; cluster = Math.max(cluster,cur); } else { cur=0; }

        // Weekend warrior check
        const dow = probe.getDay(); // 0=So..6=Sa
        if(dow===5 || dow===6){ friSatTotal++; if(grams>40) friSatHigh++; }

        // Daily low pattern
        if(grams>10) daily10plus++;
      }

      const drinksWeek = (grams28/10) / Math.max(1,(daysConsidered/7)); // avg per week over last 28d
      const mjPerWeek = mj28 / Math.max(1,(daysConsidered/7));

      document.getElementById('daDrinksWeek').textContent = (Math.round(drinksWeek*10)/10)+'';
      document.getElementById('daBinge100').textContent  = String(binge100);
      document.getElementById('daCluster').textContent   = cluster>0 ? (cluster+' Tage') : '‚Äî';
      document.getElementById('daMjWeek').textContent    = (Math.round(mjPerWeek*10)/10)+' g';

      let notes = [];
      if(friSatTotal>0 && friSatHigh/friSatTotal > 0.6) notes.push('üçª <strong>Weekend Warrior</strong>: >60% Hochrisiko an Fr/Sa.');
      if(daily10plus > 70) notes.push('üìÜ <strong>Daily Drinker</strong>: >70 Tage mit >10 g in 100 Tagen.');
      if(binge100>=3 && (100 - binge100) > 60) notes.push('üé¢ <strong>Slip & Slide</strong>: meist sauber, aber 3+ Binge-Peaks.');
      if(mjPerWeek>1) notes.push('üåø <strong>Poly-Use</strong>: Marijuana >1 g/Woche ‚Äì Risiko-Boost.');
      if(notes.length===0) notes.push('‚úÖ Kein auff√§lliges Muster erkannt.');
      document.getElementById('patternNotes').innerHTML = notes.join('<br>');
    }

    /* Streak & Month view */
    function isGreen(state){ return state==='sober' || state==='superday' || state==='wellness'; }
    function setStreakCardTint(streak){
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      if(streak >= 30)      card.classList.add('streak-great');
      else if(streak >= 21) card.classList.add('streak-good');
      else if(streak >= 11) card.classList.add('streak-warn');
      else if(streak >= 1)  card.classList.add('streak-bad');
      numEl.textContent = String(streak) + (streak>=30 ? ' üéâ' : '');
    }
    function calculateStreak(){
      let probe = new Date();
      let streak = 0;
      while(true){
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if(isGreen(st)){ streak++; probe.setDate(probe.getDate()-1); }
        else break;
        if(streak > 1000) break;
      }
      setStreakCardTint(streak);
    }

    function updateMonthView(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      const weekdays = ['Mo','Di','Mi','Do','Fr','Sa','So'];
      for(const w of weekdays){
        const h = document.createElement('div');
        h.className = 'weekday';
        h.textContent = w;
        grid.appendChild(h);
      }

      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);
      const startDay = (first.getDay()+6)%7;
      for(let i=0;i<startDay;i++){
        const e = document.createElement('div');
        e.className='day'; e.style.visibility='hidden'; grid.appendChild(e);
      }

      const today = new Date();
      for(let d=1; d<=last.getDate(); d++){
        const dt = new Date(y, m, d);
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.textContent = d;
        cell.dataset.y = String(y);
        cell.dataset.m = String(m);
        cell.dataset.d = String(d);

        const key = formatDateKey(dt);
        const st = getDayStatus(key);
        const comment = getDayComment(key);
        
        if(st) cell.classList.add(st);
        if(dt.toDateString() === today.toDateString()) cell.classList.add('today');
        if(comment){
          cell.classList.add('has-comment');
          const tooltip = document.createElement('div');
          tooltip.className = 'day-comment-tooltip';
          tooltip.textContent = comment;
          cell.appendChild(tooltip);
        }
        grid.appendChild(cell);
      }
    }

    document.addEventListener('click', (e)=>{
      const grid = document.getElementById('monthGrid');
      if(!grid || !grid.contains(e.target)) return;
      const cell = e.target.closest('.day');
      if(!cell) return;
      if(cell.style.visibility === 'hidden') return;

      const y = Number(cell.dataset.y);
      const m = Number(cell.dataset.m);
      const d = Number(cell.dataset.d);
      if(Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return;

      openEditPopup(new Date(y,m,d));
    });

    function openEditPopup(date){
      editingDate = date;
      document.getElementById('editDate').textContent = formatDisplayDate(date);
      const key = formatDateKey(date);
      document.getElementById('editCommentInput').value = getDayComment(key);
      const pop = document.getElementById('editPopup');
      pop.classList.add('active'); pop.setAttribute('aria-hidden','false');

      // God edit availability
      const godBtn = document.getElementById('btnOpenGodEdit');
      if(godMode){ godBtn.style.display='block'; preloadGodEdit(key); } else { godBtn.style.display='none'; document.getElementById('godEditContainer').style.display='none'; }
    }
    function closeEditPopup(){
      const pop = document.getElementById('editPopup');
      pop.classList.remove('active'); pop.setAttribute('aria-hidden','true'); editingDate = null;
    }

    function preloadGodEdit(key){
      const rec = dayData[key] || {};
      const alc = rec.alcohol || {};
      const br = alc.breakdown || {};
      document.getElementById('editBeer033').value = br.beer033?.count ?? 0;
      document.getElementById('editBeer05').value  = br.beer05?.count  ?? 0;
      document.getElementById('editType').value    = br.manual?.type ?? 'beer';
      document.getElementById('editPortions').value= br.manual?.portions ?? 0;
      document.getElementById('editAmount').value  = br.manual?.amount ?? 0;
      document.getElementById('editUnit').value    = br.manual?.unit ?? 'ml';
      document.getElementById('editSport').checked = !!alc.sport;
      document.getElementById('editMjGrams').value = (rec.marijuana?.grams ?? alc.marijuana?.grams ?? 0);
      document.getElementById('editMjFreq').value  = (rec.marijuana?.frequency ?? alc.marijuana?.frequency ?? '');
      updateGodEditCalc();
    }
    function toggleGodEdit(){
      const box = document.getElementById('godEditContainer');
      box.style.display = (box.style.display==='none'||!box.style.display) ? 'block' : 'none';
    }
    function updateGodEditCalc(){
      const beer033 = parseInt(document.getElementById('editBeer033').value||'0',10);
      const beer05  = parseInt(document.getElementById('editBeer05').value||'0',10);
      const typeEl  = document.getElementById('editType');
      const abv     = parseFloat(typeEl.selectedOptions[0].dataset.abv||'5');
      const portions= parseInt(document.getElementById('editPortions').value||'0',10);
      const amount  = parseFloat(document.getElementById('editAmount').value||'0');
      const unit    = document.getElementById('editUnit').value;

      const l033 = beer033*0.33, l05 = beer05*0.5;
      const g033 = gramsFromLiters(l033,5);
      const g05  = gramsFromLiters(l05,5);
      const lMan = litersFrom(amount, unit)*portions;
      const gMan = gramsFromLiters(lMan,abv);
      const grams = Math.round(g033+g05+gMan);
      const drinks= Math.round((grams/10)*10)/10;
      document.getElementById('editCalcGrams').textContent = String(grams);
      document.getElementById('editCalcDrinks').textContent = String(drinks);
    }
    ['editBeer033','editBeer05','editType','editPortions','editAmount','editUnit'].forEach(id=>{
      document.addEventListener('input', (e)=>{ if(e.target && e.target.id===id) updateGodEditCalc(); });
      document.addEventListener('change', (e)=>{ if(e.target && e.target.id===id) updateGodEditCalc(); });
    });

    function saveGodEdit(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const exist = dayData[key]||{};
      const status = getDayStatus(key) || 'moderate';
      const comment = getDayComment(key) || '';

      const beer033 = parseInt(document.getElementById('editBeer033').value||'0',10);
      const beer05  = parseInt(document.getElementById('editBeer05').value||'0',10);
      const typeEl  = document.getElementById('editType');
      const abv     = parseFloat(typeEl.selectedOptions[0].dataset.abv||'5');
      const type    = typeEl.value;
      const portions= parseInt(document.getElementById('editPortions').value||'0',10);
      const amount  = parseFloat(document.getElementById('editAmount').value||'0');
      const unit    = document.getElementById('editUnit').value;
      const sport   = !!document.getElementById('editSport').checked;
      const mjG     = parseFloat(document.getElementById('editMjGrams').value||'0');
      const mjF     = document.getElementById('editMjFreq').value||'';

      const totals = computeGodTotals({
        beer033, beer05, type, abv, portions, amount, unit, sport,
        mjGrams:mjG, mjFreq:mjF
      });

      dayData[key] = {
        status,
        comment,
        alcohol: { grams: totals.grams, drinks: totals.drinks, sport, breakdown: totals.breakdown },
        marijuana: totals.marijuana
      };
      saveData(); updateMonthView(); calculateStreak(); calculateSuccessRate();
      alert('‚úÖ Detaileingaben gespeichert.');
    }

    function updateSettingsUI(){
      // selected classes
      document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
      const selected = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
      if(selected){ selected.checked = true; selected.closest('.settings-option').classList.add('selected'); }
      document.getElementById('toggleGodMode').checked = godMode;
      document.getElementById('godBadge').classList.toggle('active', godMode);
      document.getElementById('godInputSection').style.display = godMode ? 'block' : 'none';
      document.getElementById('btnOpenGodEdit').style.display = godMode ? 'block' : 'none';
    }

    function toggleChartPopup(){
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');
      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        calculate100DaysChart(); calculateHealthAssessment();
        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
        // ensure detail section hidden by default
        document.getElementById('detailAnalysisPanel').style.display='none';
        document.getElementById('btnShowDetailAnalysis').textContent='üß† Detaillierte Analyse anzeigen';
      }
    }

    function toggleSettingsPopup(){
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');
      if(isActive){
        popup.classList.remove('active'); overlay.classList.remove('active'); popup.setAttribute('aria-hidden','true');
      } else {
        updateSettingsUI();
        popup.classList.add('active'); overlay.classList.add('active'); popup.setAttribute('aria-hidden','false');
      }
    }

    function toggleDetailAnalysis(){
      const panel = document.getElementById('detailAnalysisPanel');
      const btn = document.getElementById('btnShowDetailAnalysis');
      if(panel.style.display==='none' || !panel.style.display){ panel.style.display='block'; btn.textContent='üß† Detaillierte Analyse verbergen'; }
      else { panel.style.display='none'; btn.textContent='üß† Detaillierte Analyse anzeigen'; }
    }
    function openAudit(){
      const wrap = document.getElementById('auditWrap');
      wrap.style.display = (wrap.style.display==='none'||!wrap.style.display)?'block':'none';
    }

    function selectNeutralOption(option){
      neutralDaysSetting = option;
      const settings = JSON.parse(localStorage.getItem('alcoholTrackerSettings') || '{}');
      settings.neutralDays = option; localStorage.setItem('alcoholTrackerSettings', JSON.stringify(settings));
      document.querySelectorAll('input[name="neutralDays"]').forEach(el => {
        el.checked = (el.value === option);
        if(el.checked) el.closest('.settings-option').classList.add('selected');
      });
      calculateHealthAssessment();
    }

    function saveSettings(){
      neutralDaysSetting = document.querySelector('input[name="neutralDays"]:checked')?.value || 'ignore';
      godMode = !!document.getElementById('toggleGodMode').checked;
      saveData();
      updateSettingsUI();
      toggleSettingsPopup();
      alert('‚úÖ Einstellungen gespeichert.');
    }

    function updateDay(action){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      if(action === 'delete'){
        delete dayData[key];
      } else {
        const pendingComment = (document.getElementById('editCommentInput').value || '').trim();
        const existing = dayData[key] || {};
        // preserve existing extended data
        dayData[key] = {
          status: action,
          comment: pendingComment,
          alcohol: existing.alcohol || undefined,
          marijuana: existing.marijuana || undefined
        };
      }
      saveData();
      closeEditPopup();
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    function saveEditComment(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const comment = document.getElementById('editCommentInput').value.trim();
      const existingStatus = getDayStatus(key) || 'sober';
      const existing = dayData[key] || {};
      dayData[key] = { status: existingStatus, comment, alcohol: existing.alcohol, marijuana: existing.marijuana };
      saveData();
      updateMonthView();
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ Gespeichert!';
      setTimeout(() => btn.textContent = originalText, 1200);
      closeEditPopup();
    }

    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }
    function nextMonth(){     currentViewDate.setMonth(currentViewDate.getMonth()+1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }

    function saveDay(){
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if(!selected) return;
      const key = formatDateKey(new Date());
      const comment = (document.getElementById('dayCommentInput').value || '').trim();
      const base = { status: selected.value, comment };

      if(godMode){
        const inputs = readGodInputs();
        const totals = computeGodTotals(inputs);
        base.alcohol = { grams: totals.grams, drinks: totals.drinks, sport: totals.sport, breakdown: totals.breakdown };
        base.marijuana = totals.marijuana;
      }

      dayData[key] = base;
      saveData();

      document.getElementById('submitDay').disabled = true;
      showMonthView();
    }

    function updateDayInputView(){
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      updateStorageStatus(`üç∑ ${Object.keys(dayData).length} Tage`);
      const key = formatDateKey(currentInputDate);
      const existing = getDayStatus(key);
      const existingComment = getDayComment(key);
      const btn = document.getElementById('submitDay');
      document.getElementById('dayCommentInput').value = existingComment;
      if(existing){
        const radio = document.querySelector(`input[name="dayChoice"][value="${existing}"]`);
        if(radio) radio.checked = true;
        btn.disabled = false; btn.textContent = 'Tag aktualisieren';
      }else{
        btn.textContent = 'Tag speichern'; btn.disabled = true;
      }

      // Prefill god inputs if present
      if(godMode){
        const rec = dayData[key] || {};
        const alc = rec.alcohol || {};
        const br = alc.breakdown || {};
        if(document.getElementById('beer033Count')) document.getElementById('beer033Count').value = br.beer033?.count ?? 0;
        if(document.getElementById('beer05Count'))  document.getElementById('beer05Count').value  = br.beer05?.count  ?? 0;
        if(document.getElementById('alcType'))      document.getElementById('alcType').value      = br.manual?.type ?? 'beer';
        if(document.getElementById('alcPortions'))  document.getElementById('alcPortions').value  = br.manual?.portions ?? 0;
        if(document.getElementById('alcAmount'))    document.getElementById('alcAmount').value    = br.manual?.amount ?? 0;
        if(document.getElementById('unitToggle'))   document.getElementById('unitToggle').value   = br.manual?.unit ?? 'ml';
        if(document.getElementById('godSport'))     document.getElementById('godSport').checked   = !!alc.sport;
        if(document.getElementById('mjGrams'))      document.getElementById('mjGrams').value      = (rec.marijuana?.grams ?? alc.marijuana?.grams ?? 0);
        if(document.getElementById('mjFreq'))       document.getElementById('mjFreq').value       = (rec.marijuana?.frequency ?? alc.marijuana?.frequency ?? '');
        updateGodCalculationUI();
      }
    }

    function showMonthView(){
      currentViewDate = new Date(currentInputDate);
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }
    function showDayInput(){
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      closeEditPopup();
    }

    function resetStorage(){
      const ok = confirm('‚ö†Ô∏è Wirklich ALLE lokalen Daten (Tage + Einstellungen) l√∂schen und neu starten?');
      if(!ok) return;
      try{
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerCurrentDate');
        localStorage.removeItem('alcoholTrackerSettings');
      }catch(e){ console.warn('LocalStorage-Bereinigung fehlgeschlagen:', e); }
      location.reload();
    }

    // Export / Import
    function exportData(){
      try{
        const settings = { neutralDays: neutralDaysSetting, godMode };
        const payload = { type:'booze-tracker-backup', version:2, exportedAt:new Date().toISOString(), dayData, settings };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a'); a.href = url; a.download = 'booze-tracker-backup.json'; a.click(); URL.revokeObjectURL(url);
        alert('‚úÖ Export abgeschlossen. Datei wurde heruntergeladen.');
      }catch(e){ console.error(e); alert('‚ùå Export fehlgeschlagen.'); }
    }
    function importData(){
      const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json';
      input.onchange = e => {
        const file = e.target.files && e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const parsed = JSON.parse(ev.target.result);
            let importedDayData = parsed.dayData || parsed || {};
            let importedSettings = parsed.settings || {};
            const isDateKey = k => /^\d{4}-\d{1,2}-\d{1,2}$/.test(k);
            const normalizeKey = (k) => { const [y,m,d]=k.split('-').map(n=>parseInt(n,10)); const dt=new Date(y,m-1,d); return formatDateKey(dt); };
            const validEntries = {};
            Object.keys(importedDayData||{}).forEach(k=>{
              if(isDateKey(k)){
                const normKey = normalizeKey(k);
                const v = importedDayData[k];
                if(typeof v === 'string') validEntries[normKey] = { status: v, comment: '' };
                else if(v && typeof v === 'object' && typeof v.status === 'string'){
                  validEntries[normKey] = {
                    status: v.status,
                    comment: v.comment || '',
                    alcohol: v.alcohol || undefined,
                    marijuana: v.marijuana || undefined
                  };
                }
              }
            });
            dayData = { ...dayData, ...validEntries };
            if(importedSettings.neutralDays) neutralDaysSetting = importedSettings.neutralDays;
            if(typeof importedSettings.godMode === 'boolean') godMode = importedSettings.godMode;
            saveData();
            alert('‚úÖ Daten importiert. Die Ansicht wird aktualisiert.');
            location.reload();
          }catch(err){ console.error(err); alert('‚ùå Ung√ºltige Datei oder JSON-Format.'); }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Wire globals
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openEditPopup = openEditPopup;
    window.closeEditPopup = closeEditPopup;
    window.updateDay = updateDay;
    window.resetStorage = resetStorage;
    window.toggleChartPopup = toggleChartPopup;
    window.toggleSettingsPopup = toggleSettingsPopup;
    window.exportData = exportData;
    window.importData = importData;
    window.saveEditComment = saveEditComment;
    window.saveGodEdit = saveGodEdit;
    window.toggleGodEdit = toggleGodEdit;
    window.calculateAuditScore = calculateAuditScore;
    window.selectNeutralOption = selectNeutralOption;
    window.toggleDetailAnalysis = toggleDetailAnalysis;
    window.openAudit = openAudit;

    // INIT
    document.addEventListener('DOMContentLoaded', ()=>{
      testStorage();
      loadData();

      // Version tags
      document.querySelectorAll('.version-tag').forEach(el=> el.textContent = APP_VERSION);

      // Remove any old autosave-on-radio logic; now enable save button instead
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{ document.getElementById('submitDay').disabled = false; });
      });

      // God inputs live reactions
      ['beer033Count','beer05Count','alcType','alcPortions','alcAmount','unitToggle','godSport','mjGrams','mjFreq']
      .forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('input', updateGodCalculationUI);
          el.addEventListener('change', updateGodCalculationUI);
        }
      });

      // Save button
      document.getElementById('submitDay').addEventListener('click', saveDay);

      updateDayInputView();
      updateSettingsUI();
    });

    /* AUDIT-C Score */
    function calculateAuditScore(){
      const q1 = parseInt(document.querySelector('input[name="auditQ1"]:checked')?.value);
      const q2 = parseInt(document.querySelector('input[name="auditQ2"]:checked')?.value);
      const q3 = parseInt(document.querySelector('input[name="auditQ3"]:checked')?.value);
      if(isNaN(q1) || isNaN(q2) || isNaN(q3)){ alert('Bitte alle 3 Fragen beantworten.'); return; }
      const score = q1 + q2 + q3;
      const gender = document.getElementById('auditGender').value;
      let risk, riskClass, riskText;
      if(score === 0){ risk='Niedriges Risiko'; riskClass='low'; riskText='Abstinenz oder sehr geringer Konsum.'; }
      else if((gender==='female' && score < 3) || (gender==='male' && score < 4)){ risk='Geringes Risiko'; riskClass='low'; riskText='Unterer Bereich; Ma√ühalten beibehalten.'; }
      else if(score < 5){ risk='Riskanter Konsum'; riskClass='medium'; riskText='Potentiell sch√§dlich; Reduktion erw√§gen.'; }
      else { risk='Hohes Risiko'; riskClass='high'; riskText='Hohe Wahrscheinlichkeit f√ºr AUD ‚Äì Beratung empfohlen.'; }
      const resultDiv = document.getElementById('auditResult');
      resultDiv.className = 'audit-result '+riskClass;
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
        <strong>AUDIT-C Score: ${score} von 12</strong>
        <strong style="font-size:14px; display:block; margin-top:6px;">${risk}</strong>
        ${riskText}
      `;
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  </script>
</body>
</html>
