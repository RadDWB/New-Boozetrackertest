<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booze-Tracker â€” v2.1 (Multi-Drinks & Clean Flow)</title>
  <style>
    :root{
      --bg1:#6ea8ff; --bg2:#8ee5ff; --ink:#111827; --muted:#6b7280;
      --card:#fff; --border:#e5e7eb; --shadow:0 16px 40px rgba(0,0,0,.12);
      --primary:#16a34a; --primary-2:#15803d; --danger:#ef4444; --warn:#f59e0b;
      --good:#10b981; --ok:#22c55e; --mid:#f59e0b; --bad:#ef4444;
      --pill:#f1f5f9;
      --r:14px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;}
    .container{max-width:1000px;margin:28px auto;padding:clamp(14px,2.5vw,22px);background:var(--card);
      border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);}
    h1{margin:0 0 6px;text-align:center;font-size:clamp(26px,4.5vw,34px);}
    .sub{color:var(--muted);text-align:center;font-size:12px;margin-bottom:8px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{height:44px;padding:0 16px;border-radius:12px;border:0;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;transition:.15s ease;box-shadow:0 10px 24px rgba(22,163,74,.25);}
    .btn:hover{background:var(--primary-2);transform:translateY(-1px);}
    .btn.secondary{background:#64748b;box-shadow:0 10px 24px rgba(100,116,139,.2);}
    .btn.secondary:hover{background:#475569;}
    .btn.ghost{background:#e5e7eb;color:#111827;box-shadow:none;}
    .btn.danger{background:var(--danger);}
    .pill{background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .grid-3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:10px;}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;}
    @media(max-width:760px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700;}
    select,input[type="number"],input[type="text"],textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:14px;font-family:inherit;background:#fff;}
    textarea{min-height:76px;resize:vertical;}
    .hidden{display:none !important;}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px;}
    .weekday{background:#f1f5f9;border:1px solid var(--border);padding:6px 0;border-radius:8px;text-align:center;font-size:12px;font-weight:700;color:#475569;}
    .day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:800;position:relative;cursor:pointer;user-select:none;transition:.1s ease;}
    .day:hover{transform:scale(1.03);box-shadow:0 10px 20px rgba(0,0,0,.08);}
    .day.sober{background:#10b981;color:#fff;} .day.wellness{background:#22c55e;color:#fff;} .day.superday{background:#059669;color:#fff;}
    .day.moderate{background:#f59e0b;color:#fff;} .day.mixed{background:#dc2626;color:#fff;} .day.alcohol{background:#ef4444;color:#fff;}
    .day.today{outline:3px solid var(--primary);outline-offset:-3px;}
    .day.has-comment::before{content:'ğŸ’¬';position:absolute;top:2px;right:2px;font-size:10px;opacity:.9;}
    .day.has-flags::after{content:'âš‘';position:absolute;left:3px;bottom:2px;font-size:11px;opacity:.9;}
    .tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
      min-width:200px;max-width:280px;padding:10px 12px;background:#111827;color:#fff;border-radius:8px;font-size:11px;line-height:1.5;z-index:30;box-shadow:0 10px 24px rgba(0,0,0,.35);white-space:pre-wrap;}
    .tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#111827;}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:12px 0 6px;font-weight:800;}
    .section-title .hint{font-size:12px;color:var(--muted);}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;}
    .badge.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;}
    .badge.ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;}
    .warn-text{color:#b45309;font-weight:700;}
    .radio-rows{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    @media(max-width:680px){.radio-rows{grid-template-columns:1fr;}}
    .radio-opt{display:flex;gap:10px;align-items:flex-start;border:2px solid #edf2f7;border-radius:12px;background:#fff;padding:10px;cursor:pointer;}
    .radio-opt:hover{box-shadow:0 8px 18px rgba(0,0,0,.08);transform:translateY(-1px);}
    .radio-opt input{transform:scale(1.2);margin-top:2px;accent-color:var(--primary);}
    .desc{font-size:12px;color:#4b5563;margin-top:2px;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:40;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 48px rgba(0,0,0,.25);padding:16px;width:min(760px,92vw);max-height:85vh;overflow:auto;display:none;z-index:45;}
    .analysis{background:linear-gradient(135deg,#f8fafc,#f1f5f9);border:2px solid var(--border);border-radius:14px;padding:14px;margin-top:10px;}
    .assessment-badge{padding:12px;border-radius:12px;text-align:center;font-weight:800;}
    .assessment-badge.red{background:linear-gradient(135deg,#fecaca,#fca5a5);border:2px solid #ef4444;color:#7f1d1d;}
    .assessment-badge.weekend{background:linear-gradient(135deg,#fed7aa,#fdba74);border:2px solid #fb923c;color:#9a3412;}
    .assessment-badge.balance{background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #fbbf24;color:#92400e;}
    .assessment-badge.zen{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:2px solid #34d399;color:#065f46;}
    .metric-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media(max-width:760px){.metric-grid{grid-template-columns:1fr 1fr;}}
    .metric{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;}
    .metric .l{font-size:12px;color:var(--muted);} .metric .v{font-weight:900;font-size:20px;}
    details.settings{border:1px solid var(--border);border-radius:12px;padding:10px;margin:10px 0;background:#fff;}
    details.settings summary{cursor:pointer;font-weight:800;list-style:none;}
    details.settings summary::-webkit-details-marker{display:none;}
    .kicker{font-size:12px;color:#475569;margin-left:6px;font-weight:500;}
    .god-badge{position:fixed;right:16px;top:16px;background:#0f172a;color:#e5e7eb;padding:8px 12px;border-radius:999px;font-weight:800;font-size:12px;display:none;z-index:60;}
    .god-badge.active{display:block;}
  </style>
</head>
<body>
  <div id="godBadge" class="god-badge">ğŸ§  Godâ€‘Modus aktiv</div>
  <div class="container">
    <h1>ğŸ· Boozeâ€‘Tracker</h1>
    <div class="sub">v2.1 Â· Klicke im Kalender einen Tag an, um EintrÃ¤ge zu bearbeiten oder hinzuzufÃ¼gen.</div>

    <!-- Monats-Ansicht als primÃ¤rer Einstieg -->
    <div id="monthHead" class="section-title">
      <div><span id="monthTitle">â€”</span> <span class="hint" id="monthHint"></span></div>
      <div class="row">
        <button class="btn secondary" id="btnPrev">â† Vorheriger</button>
        <button class="btn" id="btnNext">NÃ¤chster â†’</button>
        <button class="btn ghost" id="btnToday">Heute</button>
        <button class="btn secondary" id="btnChart">ğŸ“Š 100â€‘Tage</button>
        <button class="btn secondary" id="btnSettings">âš™ï¸ Einstellungen</button>
      </div>
    </div>

    <div class="cal" id="monthGrid"></div>

    <div class="row" style="justify-content:center;margin-top:12px;">
      <span class="pill">â­ Supertag</span>
      <span class="pill">ğŸ’š Wellness</span>
      <span class="pill">ğŸŸ¢ AF</span>
      <span class="pill">ğŸŸ¡ Moderat</span>
      <span class="pill">â¤ï¸ Schadensbegrenzung</span>
      <span class="pill">ğŸ”´ Viel</span>
    </div>
  </div>

  <!-- Editieren / Eingabe -->
  <div id="editOverlay" class="overlay"></div>
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="section-title"><div id="editTitle">Datum</div><button class="btn ghost" onclick="closeEdit()">SchlieÃŸen âœ•</button></div>

    <!-- Kategorie mit ErklÃ¤rungen + Flags -->
    <div class="card">
      <div class="label">Kategorie (manuell mÃ¶glich â€“ Abgleich mit Vorschlag)</div>
      <div class="radio-rows" id="categoryGroup">
        <label class="radio-opt"><input type="radio" name="cat" value="superday"><div><div><strong>â­ Supertag</strong></div><div class="desc">noAlk + Sport</div></div></label>
        <label class="radio-opt"><input type="radio" name="cat" value="wellness"><div><div><strong>ğŸ’š Wellness</strong></div><div class="desc">noAlk + GesundheitsaktivitÃ¤t (Sauna, Yoga, etc.)</div></div></label>
        <label class="radio-opt"><input type="radio" name="cat" value="sober"><div><div><strong>ğŸŸ¢ Alkoholfrei</strong></div><div class="desc">kein Alkohol</div></div></label>
        <label class="radio-opt"><input type="radio" name="cat" value="moderate"><div><div><strong>ğŸŸ¡ Moderat</strong></div><div class="desc">â‰ˆ â‰¤ 20 g Alkohol</div></div></label>
        <label class="radio-opt"><input type="radio" name="cat" value="mixed"><div><div><strong>â¤ï¸ Schadensbegrenzung</strong></div><div class="desc">â€Selbstbetrugâ€œ: Sport + feiern (â‰¤ 40 g)</div></div></label>
        <label class="radio-opt"><input type="radio" name="cat" value="alcohol"><div><div><strong>ğŸ”´ Viel</strong></div><div class="desc">> 40 g Alkohol</div></div></label>
      </div>
      <div id="catSuggestionBox" class="badge warn hidden">âš ï¸ Passt nicht zu Daten. Vorschlag: <span id="catSuggestLabel"></span></div>

      <div class="row" style="margin-top:8px;">
        <label class="pill"><input id="flagSport" type="checkbox"> Sport</label>
        <label class="pill"><input id="flagDopeEnable" type="checkbox"> Dope (anzeigen)</label>
        <label class="pill"><input id="flagHangover" type="checkbox"> Katertag</label>
        <label class="pill"><input id="flagTotalCrash" type="checkbox"> Totalabsturz</label>
      </div>
      <div id="dopeRow" class="grid-3 hidden" style="margin-top:8px;">
        <div><div class="label">Marijuana (g)</div><input id="weedGrams" type="number" min="0" step="0.1" value="0"></div>
        <div><div class="label">HÃ¤ufigkeit</div><select id="weedFreq"><option value="einmalig">einmalig</option><option value="mehrmals">mehrmals</option></select></div>
      </div>
    </div>

    <!-- Multi-GetrÃ¤nke -->
    <div class="card" style="margin-top:10px;">
      <div class="section-title">
        <div>GetrÃ¤nke erfassen</div>
        <button class="btn ghost" onclick="addDrinkItem()">+ GetrÃ¤nk</button>
      </div>

      <div id="drinksList" class="grid-4">
        <!-- dynamische Zeilen -->
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div class="card"><div class="label">Alkohol (g, Summe)</div><div id="sumGrams" style="font-weight:900;font-size:20px;">0</div></div>
        <div class="card"><div class="label">Drinks (Ã  10 g)</div><div id="sumDrinks" style="font-weight:900;font-size:20px;">0</div></div>
      </div>
      <div id="autoInfo" class="badge ok hidden" style="margin-top:8px;">â„¹ Kategorie automatisch auf <strong id="autoCatLabel"></strong> gesetzt</div>
    </div>

    <!-- Kommentar -->
    <div class="card" style="margin-top:10px;">
      <div class="label">ğŸ’¬ Kommentar</div>
      <textarea id="editComment" placeholder="Anlass, Trigger, Schlaf, etc. (optional)"></textarea>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end;">
      <button class="btn secondary" onclick="suggestCategory()">Kategorie vorschlagen</button>
      <button class="btn" onclick="saveEntry()">ğŸ’¾ Speichern</button>
      <button class="btn danger" onclick="deleteEntry()">ğŸ—‘ï¸ LÃ¶schen</button>
    </div>
  </div>

  <!-- Charts / Settings -->
  <div id="chartOverlay" class="overlay"></div>
  <div id="chartModal" class="modal">
    <div class="section-title"><div>ğŸ“Š Letzte 100 Tage</div><button class="btn ghost" onclick="toggleChart()">SchlieÃŸen âœ•</button></div>
    <div class="analysis">
      <div id="assessmentBadge" class="assessment-badge">â€”</div>
      <div class="metric-grid" style="margin-top:8px;">
        <div class="metric"><div class="l">AFâ€‘Quote</div><div class="v" id="metAF">0%</div></div>
        <div class="metric"><div class="l">Gewichteter Score</div><div class="v" id="metHealth">0%</div></div>
        <div class="metric"><div class="l">Bingeâ€‘NÃ¤he</div><div class="v" id="metBinge">0</div></div>
        <div class="metric"><div class="l">LÃ¤ngster Cluster</div><div class="v" id="metCluster">0</div></div>
      </div>
      <div class="card" style="margin-top:10px;">
        <div style="font-weight:800;margin-bottom:6px;">Feinere Skala & Prognosen</div>
        <div id="godMetricsList" style="font-size:13px;line-height:1.6;"></div>
      </div>
    </div>
  </div>

  <div id="settingsOverlay" class="overlay"></div>
  <div id="settingsModal" class="modal">
    <div class="section-title"><div>âš™ï¸ Einstellungen</div><button class="btn ghost" onclick="toggleSettings()">SchlieÃŸen âœ•</button></div>

    <details class="settings" open>
      <summary>ğŸ§  Godâ€‘Modus <span class="kicker">erweiterte Analyse & Prognosen</span></summary>
      <div class="row" style="margin-top:8px;">
        <label class="pill"><input id="setGod" type="checkbox"> Godâ€‘Modus aktivieren</label>
        <label class="pill"><input id="setAutoReclass" type="checkbox"> Autoâ€‘Reklassifizieren</label>
        <label class="pill"><input id="setNudges" type="checkbox"> Nudges & Warnungen</label>
        <label class="pill"><input id="setLiveEdit" type="checkbox" checked> Liveâ€‘Speichern im Edit</label>
      </div>
    </details>

    <details class="settings">
      <summary>ğŸ“Š Statistikâ€‘Basis <span class="kicker">Kalendertage vs. EintrÃ¤ge</span></summary>
      <div class="row" style="margin-top:8px;">
        <label class="pill"><input type="radio" name="denom" value="entered" checked> Eingetragene Tage</label>
        <label class="pill"><input type="radio" name="denom" value="calendar"> Kalendertage</label>
      </div>
      <div class="row" style="margin-top:8px;">
        <span class="pill">Neutrale Tage zÃ¤hlen: 
          <select id="neutralDays">
            <option value="ignore">Ignorieren</option>
            <option value="neutral">Neutral</option>
            <option value="negative">Negativ</option>
            <option value="very-negative">Sehr negativ</option>
          </select>
        </span>
      </div>
    </details>

    <details class="settings">
      <summary>ğŸ—„ï¸ Daten <span class="kicker">Export/Import</span></summary>
      <div class="row" style="margin-top:8px;">
        <button class="btn secondary" onclick="exportData()">ğŸ“¤ Export</button>
        <button class="btn secondary" onclick="importData()">ğŸ“¥ Import</button>
      </div>
    </details>

    <details class="settings">
      <summary>âš ï¸ Gefahrenbereich <span class="kicker">Alles lÃ¶schen</span></summary>
      <div class="card">
        <div class="row">
          <label class="pill"><input id="confirm1" type="checkbox"> Ich habe verstanden</label>
          <label class="pill"><input id="confirm2" type="checkbox"> Ich habe exportiert</label>
          <button id="btnReset" class="btn danger" disabled onclick="resetAll()">ğŸ§¹ LÃ¶schen</button>
        </div>
      </div>
    </details>

    <div class="row" style="justify-content:flex-end;margin-top:8px;">
      <button class="btn" onclick="saveSettings()">Einstellungen speichern</button>
    </div>
  </div>

  <script>
    /* ===== Core State ===== */
    const monthNames = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    const cats = ['superday','wellness','sober','moderate','mixed','alcohol'];
    const catLabel = {superday:'Supertag', wellness:'Wellness', sober:'Alkoholfrei', moderate:'Moderat', mixed:'Schadensbegrenzung', alcohol:'Viel'};
    const pad2 = n => (n<10 ? '0'+n : ''+n);
    const keyOf = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    let dayData = {}; // key â†’ { status, comment, flags:{sport,hangover,totalCrash}, alcoholItems:[{type,abv,volMl,units}], marijuana:{grams,freq} }
    let settings = { god:false, autoRe:false, nudges:false, live:true, denom:'entered', neutral:'ignore' };
    let viewDate = new Date();
    let editingDate = null;

    /* ===== Storage ===== */
    function loadAll(){
      try{
        dayData = JSON.parse(localStorage.getItem('alcoholTrackerData')||'{}')||{};
      }catch{ dayData = {}; }
      migrateToItemsIfNeeded();
      try{
        const s = JSON.parse(localStorage.getItem('alcoholTrackerSettings')||'{}')||{};
        settings.god=!!s.godMode; settings.autoRe=!!s.autoReclass; settings.nudges=!!s.nudgesEnabled; settings.live=(s.liveEditSave!==false);
        settings.denom=s.denomSetting||'entered'; settings.neutral=s.neutralDays||'ignore';
      }catch{}
      document.getElementById('godBadge').classList.toggle('active', !!settings.god);
    }
    function saveAll(){
      localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
      localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
        godMode:settings.god, autoReclass:settings.autoRe, nudgesEnabled:settings.nudges, liveEditSave:settings.live,
        denomSetting:settings.denom, neutralDays:settings.neutral
      }));
    }

    /* ===== Migration: single alcohol â†’ items ===== */
    function migrateToItemsIfNeeded(){
      let changed=false;
      for(const k of Object.keys(dayData)){
        const v = dayData[k];
        if(!v) continue;
        // Normalize wrapper
        if(typeof v==='string'){ dayData[k] = {status:v, comment:''}; changed=true; continue; }
        if(!v.alcoholItems){
          const items=[];
          const alc=v.alcohol;
          if(alc){
            const abv = Number(alc.abv||0);
            // beer033/beer05 collapse into items
            const b33 = Number(alc.beer033||0);
            const b05 = Number(alc.beer05||0);
            if(b33>0) items.push({type:'beer',abv:5,volMl:330,units:b33});
            if(b05>0) items.push({type:'beer',abv:5,volMl:500,units:b05});
            const vol=Number(alc.volume||0), portions=Number(alc.portions||0);
            if(vol>0 && portions>0) items.push({type:alc.type||'other',abv:abv>0?abv:10,volMl:vol,units:portions});
          }
          v.alcoholItems = items;
          changed=true;
        }
      }
      if(changed) localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
    }

    /* ===== Calendar ===== */
    function buildCalendar(){
      const grid = document.getElementById('monthGrid'); grid.innerHTML='';
      const y=viewDate.getFullYear(), m=viewDate.getMonth();
      document.getElementById('monthTitle').textContent = `${monthNames[m]} ${y}`;
      document.getElementById('monthHint').textContent = 'Klicke einen Tag zum Bearbeiten';
      weekdays.forEach(w=>{ const el=document.createElement('div'); el.className='weekday'; el.textContent=w; grid.appendChild(el); });
      const first = new Date(y,m,1); let lead = (first.getDay()+6)%7;
      for(let i=0;i<lead;i++){ const s=document.createElement('div'); s.style.visibility='hidden'; grid.appendChild(s); }
      const last = new Date(y,m+1,0).getDate();
      for(let d=1; d<=last; d++){
        const key = `${y}-${pad2(m+1)}-${pad2(d)}`;
        const cell=document.createElement('div'); cell.className='day'; cell.textContent=String(d);
        const v=dayData[key];
        if(v && v.status){ cell.classList.add(v.status); }
        const today=new Date(); if(d===today.getDate() && m===today.getMonth() && y===today.getFullYear()) cell.classList.add('today');
        const comment = v && v.comment; const hasFlags = v && v.flags && (v.flags.hangover || v.flags.totalCrash);
        if(comment){ cell.classList.add('has-comment'); }
        if(hasFlags){ cell.classList.add('has-flags'); }
        // tooltip content
        const tip=document.createElement('div'); tip.className='tooltip';
        tip.textContent = (comment?('ğŸ’¬ '+comment+'\n'):'') + (hasFlags?('âš‘ '+(v.flags.hangover?'Katertag ':'')+(v.flags.totalCrash?'Totalabsturz':'')) : '');
        if(tip.textContent.trim().length>0){ cell.appendChild(tip); }
        // hover show
        cell.addEventListener('mouseenter', ()=>{ if(tip.textContent.trim().length>0) tip.style.display='block'; });
        cell.addEventListener('mouseleave', ()=>{ tip.style.display='none'; });
        // long-press for touch
        let tmr=null;
        cell.addEventListener('touchstart', ()=>{ if(tip.textContent.trim().length>0){ tmr=setTimeout(()=> tip.style.display='block', 450);} }, {passive:true});
        ['touchend','touchcancel','touchmove'].forEach(ev=> cell.addEventListener(ev, ()=>{ if(tmr){clearTimeout(tmr);tmr=null;} tip.style.display='none'; }, {passive:true}));
        // open editor
        cell.addEventListener('click', ()=> openEdit(new Date(y,m,d)));
        grid.appendChild(cell);
      }
    }

    /* ===== Edit Modal ===== */
    function openEdit(date){
      editingDate=date;
      document.getElementById('editTitle').textContent = date.toLocaleDateString('de-DE',{weekday:'long', day:'2-digit', month:'long', year:'numeric'});
      const key=keyOf(date);
      const v = dayData[key] || {status:null, comment:'', alcoholItems:[], flags:{}, marijuana:{}};
      // set category
      document.querySelectorAll('input[name="cat"]').forEach(r=> r.checked = (r.value === v.status));
      // flags
      document.getElementById('flagSport').checked = !!(v.flags && v.flags.sport);
      document.getElementById('flagHangover').checked = !!(v.flags && v.flags.hangover);
      document.getElementById('flagTotalCrash').checked = !!(v.flags && v.flags.totalCrash);
      // dope
      const enableDope = v.marijuana && (v.marijuana.grams>0 || v.marijuana.freq);
      document.getElementById('flagDopeEnable').checked = !!enableDope;
      document.getElementById('dopeRow').classList.toggle('hidden', !enableDope);
      document.getElementById('weedGrams').value = (v.marijuana && v.marijuana.grams) ? v.marijuana.grams : 0;
      document.getElementById('weedFreq').value  = (v.marijuana && v.marijuana.freq) ? v.marijuana.freq : 'einmalig';
      // comment
      document.getElementById('editComment').value = v.comment || '';
      // drinks
      renderDrinksList(v.alcoholItems||[]);
      // compute sums and suggestion
      recomputeSumsAndMaybeSuggest();
      // show
      document.getElementById('editOverlay').style.display='block';
      document.getElementById('editModal').style.display='block';
    }
    function closeEdit(){
      document.getElementById('editOverlay').style.display='none';
      document.getElementById('editModal').style.display='none';
      editingDate=null;
    }

    /* ===== Drink Rows ===== */
    const DRINK_PRESETS = {
      beer:  {abv:5,  volumes:[{ml:330,label:'0,33 l'},{ml:500,label:'0,5 l'}]},
      radler:{abv:2.5,volumes:[{ml:330,label:'0,33 l'},{ml:500,label:'0,5 l'}]},
      wine:  {abv:10, volumes:[{ml:100,label:'100 ml'},{ml:200,label:'200 ml'},{ml:250,label:'250 ml'}]},
      liquor:{abv:15, volumes:[{ml:100,label:'100 ml'},{ml:200,label:'200 ml'}]},
      spirit:{abv:40, volumes:[{ml:20,label:'20 ml'},{ml:40,label:'40 ml'},{ml:60,label:'60 ml'}]},
      other20:{abv:20, volumes:[{ml:100,label:'100 ml'},{ml:200,label:'200 ml'},{ml:500,label:'500 ml'}]},
      other30:{abv:30, volumes:[{ml:20,label:'20 ml'},{ml:100,label:'100 ml'},{ml:200,label:'200 ml'}]}
    };
    const DRINK_LABEL = {beer:'Bier', radler:'Radler', wine:'Wein', liquor:'LikÃ¶r', spirit:'Spirituosen', other20:'Sonstiges (20%)', other30:'Sonstiges (30%)'};

    function newDrinkItem(obj){
      return {
        type: obj?.type || 'beer',
        abv:  obj?.abv ?? (DRINK_PRESETS['beer'].abv),
        volMl: obj?.volMl || 500,
        units: obj?.units || 1
      };
    }

    function renderDrinksList(items){
      const list=document.getElementById('drinksList'); list.innerHTML='';
      if(!items || !items.length) items=[newDrinkItem({type:'beer', volMl:500, units:1, abv:5})];
      items.forEach((it,i)=> list.appendChild(drinkRow(it,i)));
      list.dataset.count = items.length;
    }

    function drinkRow(item, idx){
      const wrap=document.createElement('div'); wrap.className='card'; wrap.style.display='grid'; wrap.style.gridTemplateColumns='1.2fr 1fr 1fr auto'; wrap.style.gap='8px'; wrap.style.alignItems='center';
      // Type
      const selType=document.createElement('select'); selType.innerHTML = Object.keys(DRINK_PRESETS).map(k=>`<option value="${k}">${DRINK_LABEL[k]}</option>`).join('');
      selType.value=item.type;
      // Volume
      const selVol=document.createElement('select'); updateVolumeOptions(selVol, selType.value, item.volMl);
      // Units
      const selUnits=document.createElement('select'); for(let n=1;n<=20;n++){ const o=document.createElement('option'); o.value=String(n); o.textContent=String(n); selUnits.appendChild(o); }
      selUnits.value=String(item.units||1);
      // Remove
      const rem=document.createElement('button'); rem.className='btn ghost'; rem.textContent='Entfernen'; rem.addEventListener('click', ()=>{ wrap.remove(); recomputeSumsAndMaybeSuggest(); });
      // Change handlers
      selType.addEventListener('change', ()=>{ updateVolumeOptions(selVol, selType.value, null); recomputeSumsAndMaybeSuggest(); });
      selVol.addEventListener('change', ()=> recomputeSumsAndMaybeSuggest());
      selUnits.addEventListener('change', ()=> recomputeSumsAndMaybeSuggest());
      // Mount
      wrap.appendChild(selType); wrap.appendChild(selVol); wrap.appendChild(selUnits); wrap.appendChild(rem);
      return wrap;
    }

    function updateVolumeOptions(selectEl, type, selectedMl){
      const preset = DRINK_PRESETS[type] || DRINK_PRESETS['beer'];
      const abv = preset.abv;
      selectEl.innerHTML='';
      preset.volumes.forEach(v=>{
        const o=document.createElement('option');
        o.value=String(v.ml); o.textContent=v.label; selectEl.appendChild(o);
      });
      // custom
      const oC=document.createElement('option'); oC.value='custom'; oC.textContent='Benutzerdefiniertâ€¦'; selectEl.appendChild(oC);
      if(selectedMl && preset.volumes.some(v=>v.ml===selectedMl)){ selectEl.value=String(selectedMl); }
      else if(selectedMl){ selectEl.value='custom'; }
      // When custom â†’ prompt
      selectEl.addEventListener('change', function onChange(){
        if(selectEl.value==='custom'){
          const ml = prompt('Eigene Menge (ml):', selectedMl && selectEl.dataset.lastCustom ? selectEl.dataset.lastCustom : '150');
          if(ml && !isNaN(parseFloat(ml))){
            selectEl.dataset.lastCustom = String(Math.max(0, parseFloat(ml)));
          } else {
            // fallback
            selectEl.value = String((preset.volumes[0]||{ml:100}).ml);
          }
        }
      }, {once:true});
    }

    function addDrinkItem(){
      const list=document.getElementById('drinksList');
      list.appendChild(drinkRow(newDrinkItem({type:'wine', volMl:200, units:1, abv:10}), parseInt(list.dataset.count||'0',10)));
      recomputeSumsAndMaybeSuggest();
    }

    /* ===== Math ===== */
    function gramsOf(abvPct, volMl, units){
      const volL = volMl/1000;
      return Math.max(0, Math.round(volL * (abvPct/100) * 0.789 * 1000 * (units||1)));
    }
    function collectCurrentDrinks(){
      const list=document.getElementById('drinksList');
      const items=[];
      list.querySelectorAll('.card').forEach(row=>{
        const [selType, selVol, selUnits] = row.querySelectorAll('select');
        const type = selType.value;
        const preset = DRINK_PRESETS[type] || DRINK_PRESETS['beer'];
        let volMl = 0;
        if(selVol.value==='custom'){
          volMl = Number(selVol.dataset.lastCustom||0);
          if(!volMl){ volMl = Number(prompt('Eigene Menge (ml):','150')||0); selVol.dataset.lastCustom=String(volMl||0); }
        }else{
          volMl = Number(selVol.value||0);
        }
        const units = Number(selUnits.value||1);
        items.push({type, abv:preset.abv, volMl, units});
      });
      return items;
    }
    function totalGramsFromItems(items){
      return items.reduce((sum,it)=> sum + gramsOf(it.abv, it.volMl, it.units), 0);
    }
    function suggestedCategoryFrom(grams, sport){
      if(grams===0) return sport?'superday':'sober';
      if(sport && grams<=40) return 'mixed';
      if(grams<=20) return 'moderate';
      return 'alcohol';
    }

    function recomputeSumsAndMaybeSuggest(){
      const items = collectCurrentDrinks();
      const grams = totalGramsFromItems(items);
      document.getElementById('sumGrams').textContent = String(grams);
      document.getElementById('sumDrinks').textContent = String(Math.round(grams/10));
      const sport = document.getElementById('flagSport').checked;
      const suggestion = suggestedCategoryFrom(grams, sport);
      // auto classify?
      if(settings.autoRe){
        setManualCategory(suggestion);
        showAutoInfo(suggestion, true);
        hideCatMismatch();
      }else{
        // check mismatch vs selected manual
        const manual = getManualCategory();
        if(manual && manual!==suggestion){
          showCatMismatch(suggestion);
        }else{
          hideCatMismatch();
        }
      }
    }
    function showAutoInfo(cat, show){
      const box=document.getElementById('autoInfo'); const lab=document.getElementById('autoCatLabel');
      lab.textContent = catLabel[cat]||'â€”'; box.classList.toggle('hidden', !show);
    }
    function showCatMismatch(suggest){
      const box=document.getElementById('catSuggestionBox'); const lab=document.getElementById('catSuggestLabel');
      lab.textContent = catLabel[suggest]||'â€”'; box.classList.remove('hidden');
    }
    function hideCatMismatch(){ document.getElementById('catSuggestionBox').classList.add('hidden'); document.getElementById('autoInfo').classList.add('hidden'); }

    function getManualCategory(){
      const r=document.querySelector('input[name="cat"]:checked'); return r ? r.value : null;
    }
    function setManualCategory(v){
      const r=document.querySelector(`input[name="cat"][value="${v}"]`);
      if(r) r.checked=true;
    }
    function suggestCategory(){
      const sport = document.getElementById('flagSport').checked;
      const grams = Number(document.getElementById('sumGrams').textContent||'0');
      const s = suggestedCategoryFrom(grams, sport);
      setManualCategory(s);
      showCatMismatch(s); // zeigen als â€Vorschlagâ€œ
    }

    /* ===== Save/Delete ===== */
    function saveEntry(){
      if(!editingDate) return;
      const key = keyOf(editingDate);
      const items = collectCurrentDrinks();
      const grams = totalGramsFromItems(items);
      const status = getManualCategory() || suggestedCategoryFrom(grams, document.getElementById('flagSport').checked);
      const entry = {
        status,
        comment: (document.getElementById('editComment').value||'').trim(),
        alcoholItems: items,
        flags: {
          sport: !!document.getElementById('flagSport').checked,
          hangover: !!document.getElementById('flagHangover').checked,
          totalCrash: !!document.getElementById('flagTotalCrash').checked
        },
        marijuana: (document.getElementById('flagDopeEnable').checked ? {
          grams: Number(document.getElementById('weedGrams').value||0),
          freq: (document.getElementById('weedFreq').value||'einmalig')
        } : undefined)
      };
      dayData[key]=entry; saveAll(); buildCalendar(); closeEdit();
    }
    function deleteEntry(){
      if(!editingDate) return;
      const key=keyOf(editingDate);
      delete dayData[key]; saveAll(); buildCalendar(); closeEdit();
    }

    /* ===== Charts & Assessment (kept, using items/grams) ===== */
    function gramsOfKey(key){
      const v=dayData[key]; if(!v) return 0;
      const items=v.alcoholItems||[]; if(items.length>0) return totalGramsFromItems(items);
      // fallback legacy
      if(v.alcohol && typeof v.alcohol.grams==='number') return v.alcohol.grams;
      // rough from status
      if(v.status==='moderate') return 20;
      if(v.status==='mixed') return 40;
      if(v.status==='alcohol') return 50;
      return 0;
    }
    const wdi = d => (d.getDay()+6)%7;
    function seriesLastNDays(n){
      const arr=[]; const today=new Date();
      for(let i=0;i<n;i++){ const d=new Date(today); d.setDate(d.getDate()-i); const k=keyOf(d); arr.push({key:k,date:d,grams:gramsOfKey(k)}); }
      return arr.reverse();
    }
    function slope(arr){
      const n=arr.length; if(n<3) return 0;
      let sx=0,sy=0,sxy=0,sxx=0;
      for(let i=0;i<n;i++){ const x=i, y=arr[i].grams; sx+=x; sy+=y; sxy+=x*y; sxx+=x*x; }
      return (n*sxy - sx*sy)/Math.max((n*sxx - sx*sx),1e-6);
    }
    function std(arr){
      const n=arr.length; if(n===0) return 0;
      const mean=arr.reduce((a,b)=>a+b,0)/n;
      const v=arr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n;
      return Math.sqrt(v);
    }
    const COMMENT_FLAGS=[
      {re:/feier|party|geburtstag|abschluss|oktoberfest/i, weight:+0.10, tag:'Feier'},
      {re:/stress|Ã¤rger|streit|deadline|druck/i,           weight:+0.08, tag:'Stress'},
      {re:/schlaf\s*(\d+)\s*h/i,                          weight:(m)=> (parseInt(m[1],10)<6?+0.06:0), tag:'Schlaf<6h'}
    ];
    function commentRisk(key){
      const v=dayData[key]; if(!v || !v.comment) return {delta:0,tags:[]};
      let delta=0,tags=[];
      for(const f of COMMENT_FLAGS){ const m=v.comment.match(f.re); if(m){ const w=(typeof f.weight==='function')?f.weight(m):f.weight; delta+=w; tags.push(f.tag); } }
      return {delta:Math.min(delta,0.2),tags};
    }
    function computeFeatures(){
      const s7=seriesLastNDays(7), s14=seriesLastNDays(14), s30=seriesLastNDays(30), s100=seriesLastNDays(100);
      const avg7=s7.reduce((a,b)=>a+b.grams,0)/Math.max(s7.length,1);
      const avg30=s30.reduce((a,b)=>a+b.grams,0)/Math.max(s30.length,1);
      const vol14=std(s14.map(x=>x.grams));
      const trend30=slope(s30);
      let binge=0,cluster=0,cur=0,weekendHigh=0,weekendTot=0,hangovers=0,crash=0;
      for(const x of s100){
        if(x.grams>=40) binge++;
        if(x.grams>=20){ cur++; cluster=Math.max(cluster,cur); } else cur=0;
        const v=dayData[x.key];
        if(v && v.flags && v.flags.hangover) hangovers++;
        if(v && v.flags && v.flags.totalCrash) crash++;
        const dow=wdi(x.date);
        if(dow===4||dow===5){ const st=(v||{}).status; if(st || x.grams>0){ weekendTot++; if(x.grams>=40) weekendHigh++; } }
      }
      const weekendBias=weekendTot? weekendHigh/weekendTot:0;
      let dualUse=0; const windowA=s30.filter(x=>x.grams>0);
      for(const x of windowA){ const v=dayData[x.key]; if(v && v.marijuana && v.marijuana.grams>0) dualUse++; }
      const used=s100.filter(x=>x.grams>0).map(x=>x.grams);
      const median = arr=>{ const t=[...arr].sort((a,b)=>a-b); const m=Math.floor(t.length/2); return t.length? (t.length%2?t[m]:(t[m-1]+t[m])/2):0; };
      let tolStrong=false, tolSoft=false;
      if(used.length>=20){ const first=used.slice(0,Math.floor(used.length/2)); const last=used.slice(Math.ceil(used.length/2));
        if(first.length>=10 && last.length>=10){ const delta=median(first)-median(last); tolStrong=(delta<-5); tolSoft=(!tolStrong && delta<-3); } }
      return {avg7,avg30,vol14,trend30,binge,cluster,weekendBias,dualUse,tolStrong,tolSoft,hangovers,crash};
    }
    function riskAssessment(){
      const f=computeFeatures();
      let qty=100; const drinksPerWeek=(f.avg7/10)*7;
      if(drinksPerWeek<=1) qty=100; else if(drinksPerWeek<=2) qty=80; else if(drinksPerWeek<=4) qty=60; else if(drinksPerWeek<=8) qty=30; else qty=0;
      qty += (f.trend30<0?+8:(f.trend30>0?-8:0));
      let pattern=90;
      if(f.binge>30 || f.cluster>7) pattern=0;
      else if(f.binge>15 || f.cluster>5) pattern=40;
      else if(f.binge>5  || f.cluster>3) pattern=70;
      if(f.weekendBias>=0.4) pattern -= 8;
      const volThresh=Math.max(20, 0.5*f.avg30); if(f.vol14>=volThresh) pattern -= 6;
      let ctx=90; if(f.dualUse>=3) ctx-=10; if(f.tolStrong) ctx-=10; else if(f.tolSoft) ctx-=5;
      if(f.hangovers>=5) ctx -= 5; if(f.crash>=2) ctx -= 10;
      const total=Math.round(0.5*qty + 0.35*pattern + 0.15*ctx);
      let stage='Stufe 2: Balance-KÃ¼nstler';
      if(total>=90) stage='Stufe 1: Zen-Meister';
      else if(total>=65) stage='Stufe 2: Balance-KÃ¼nstler';
      else if(total>=45) stage='Stufe 3: Kipppunkt-Wanderer';
      else if(total>=25) stage='Stufe 4: Risiko-Jongleur';
      else stage='Stufe 5: Alarmstufe Rot';
      const subtypes=[];
      if(f.weekendBias>=0.4) subtypes.push('Weekend-Binger');
      if(f.binge>=1 && f.avg30<5) subtypes.push('Abstinenz mit Slips');
      if(f.cluster>=3) subtypes.push('Cluster-Rider');
      if(f.dualUse>=3) subtypes.push('Coupling (Alkohol+THC)');
      if(f.tolStrong) subtypes.push('Tolerance-Creep (stark)'); else if(f.tolSoft) subtypes.push('Tolerance-Creep (leicht)');
      const s100=seriesLastNDays(100); if((f.avg7<=20) && s100.filter(x=>x.grams>0).length>=50) subtypes.push('Daily-Low');
      if(f.hangovers>=5) subtypes.push('HÃ¤ufige Katertage');
      if(f.crash>=1) subtypes.push('TotalabstÃ¼rze verzeichnet');
      return { total, stage, subtypes, features:f };
    }
    function predict7Days(){
      const idx=Object.fromEntries(cats.map((c,i)=>[c,i]));
      const M=Array.from({length:cats.length},()=>Array(cats.length).fill(1e-3));
      const today=new Date(); let prev=null;
      for(let i=180;i>=1;i--){
        const d=new Date(today); d.setDate(d.getDate()-i);
        const k=keyOf(d); const st=(dayData[k]||{}).status; if(!st) continue;
        const w=(i<=30)?2:1; if(prev!=null){ M[idx[prev]][idx[st]] += w; } prev=st;
      }
      for(let r=0;r<M.length;r++){ const s=M[r].reduce((a,b)=>a+b,0); for(let c=0;c<M[r].length;c++) M[r][c]/=s; }
      let start=(dayData[keyOf(today)]||{}).status || prev || 'sober';
      const out=[]; let state=start; const cR=commentRisk(keyOf(today)).delta;
      for(let h=1;h<=7;h++){
        const d=new Date(today); d.setDate(d.getDate()+h);
        const dow=wdi(d); const row=M[idx[state]];
        let pHigh=row[idx['moderate']]+row[idx['mixed']]+row[idx['alcohol']];
        if(dow===4||dow===5) pHigh+=0.10; else if(dow===0) pHigh-=0.10;
        if(h<=2) pHigh += Math.min(0.2, cR*0.5);
        pHigh=Math.max(0,Math.min(1,pHigh));
        out.push({date:d, risk:Math.round(pHigh*100), explain:`${state} â†’ ${Math.round(pHigh*100)}% (Wochentag ${dow===4||dow===5?'+10%':dow===0?'-10%':'Â±0'})`});
        const next=row.indexOf(Math.max(...row)); state=cats[next];
      }
      return out;
    }
    function renderAdvancedAnalysisHTML(){
      const ra=riskAssessment(); const fx=predict7Days(); const todayKey=keyOf(new Date()); const cR=commentRisk(todayKey);
      const tags=cR.tags.length?` Â· Signale: ${cR.tags.join(', ')}`:'';
      return `<div style="margin:8px 0;"><strong>${ra.stage}</strong> Â· Score ${ra.total}/100<br>${ra.subtypes.length?'ğŸ§© '+ra.subtypes.join(', '):''}${tags}</div>`+
        `<div style="margin-top:10px;"><strong>7â€‘Tageâ€‘Risikoâ€‘Prognose</strong><br>`+
        fx.map(x=>`${x.date.toLocaleDateString('de-DE',{weekday:'short'})}: ${x.risk}% <span class="pill">${x.explain}</span>`).join('<br>')+`</div>`;
    }

    function toggleChart(){
      const ov=document.getElementById('chartOverlay'); const md=document.getElementById('chartModal');
      const opening = md.style.display!=='block';
      ov.style.display = opening?'block':'none'; md.style.display = opening?'block':'none';
      if(opening){
        // simple assessment numbers (reuse prior logic)
        document.getElementById('godMetricsList').innerHTML = renderAdvancedAnalysisHTML();
        // Summaries (AF quote etc.)
        const today=new Date();
        const counts={superday:0,wellness:0,sober:0,moderate:0,mixed:0,alcohol:0,empty:0};
        for(let i=0;i<100;i++){
          const d=new Date(today); d.setDate(d.getDate()-i); const v=dayData[keyOf(d)]; const st=v && v.status;
          if(st) counts[st]++; else counts.empty++;
        }
        const entered=100-counts.empty;
        let divisor=100, neutralWeight=0;
        if(settings.neutral==='ignore'){ divisor=entered||1; }
        else if(settings.neutral==='neutral'){ neutralWeight=0.5; }
        else if(settings.neutral==='negative'){ neutralWeight=0.3; }
        else if(settings.neutral==='very-negative'){ neutralWeight=0.15; }
        const afCount=counts.superday+counts.wellness+counts.sober;
        const afQuote = afCount/divisor;
        const weightedScore = (
          counts.superday*1.0 + counts.wellness*0.9 + counts.sober*0.75 +
          counts.moderate*0.4 + counts.mixed*0.25 + counts.alcohol*0.0 +
          counts.empty*neutralWeight
        )/100;
        // cluster and binge-proximity
        let maxCluster=0,cur=0,bingeProx=0;
        for(let i=0;i<100;i++){
          const d=new Date(today); d.setDate(d.getDate()-i); const st=(dayData[keyOf(d)]||{}).status;
          const neg = (st==='alcohol'||st==='mixed');
          if(neg){ bingeProx++; cur++; maxCluster=Math.max(maxCluster,cur); } else { cur=0; }
        }
        // badge
        const badge=document.getElementById('assessmentBadge');
        const bingePct = Math.round((bingeProx/(settings.denom==='entered'?(entered||1):100))*100);
        let label='â€”', cls='zen';
        if(bingeProx>=40 || afQuote<0.20 || (bingePct>=40 && entered>=10)){ label='ğŸš¨ Suchtâ€‘Alarm: Rote Lampen!'; cls='red'; }
        else if((bingeProx>=20 && bingeProx<40) || (afQuote<0.30 && afQuote>=0.20) || (bingePct>=20 && entered>=10)){ label='ğŸ² Risikoâ€‘Roulette'; cls='red'; }
        else if(afQuote<=0.39 || (bingeProx>=13 && bingeProx<=19) || (bingePct>=13 && entered>=10)){ label='âš ï¸ Kipppunktâ€‘Kandidat'; cls='weekend'; }
        else if(afQuote>=0.40 && afQuote<0.70 && bingeProx<=12){ label='ğŸ§˜ Balanceâ€‘Buddha'; cls='balance'; }
        else { label='ğŸ¦¸ Leberâ€‘Superheld'; cls='zen'; }
        badge.className='assessment-badge '+cls; badge.textContent=label;
        document.getElementById('metAF').textContent = (settings.neutral==='ignore' ? `${Math.round(afQuote*100)}% (${afCount}/${entered})` : `${Math.round(afQuote*100)}%`);
        document.getElementById('metHealth').textContent = Math.round(weightedScore*100)+'%';
        document.getElementById('metBinge').textContent = (settings.neutral==='ignore' ? `${bingeProx} (${bingePct}%)` : String(bingeProx));
        document.getElementById('metCluster').textContent = maxCluster>0 ? `${maxCluster} Tage` : 'Keiner';
      }
    }

    /* ===== Settings ===== */
    function toggleSettings(){
      const ov=document.getElementById('settingsOverlay'); const md=document.getElementById('settingsModal');
      const opening = md.style.display!=='block';
      ov.style.display = opening?'block':'none'; md.style.display = opening?'block':'none';
      if(opening){
        document.getElementById('setGod').checked = !!settings.god;
        document.getElementById('setAutoReclass').checked = !!settings.autoRe;
        document.getElementById('setNudges').checked = !!settings.nudges;
        document.getElementById('setLiveEdit').checked = !!settings.live;
        document.querySelectorAll('input[name="denom"]').forEach(r=> r.checked=(r.value===settings.denom));
        document.getElementById('neutralDays').value = settings.neutral;
        // reset section guard
        document.getElementById('confirm1').checked=false; document.getElementById('confirm2').checked=false;
        document.getElementById('btnReset').disabled=true;
      }
    }
    function saveSettings(){
      settings.god = !!document.getElementById('setGod').checked;
      settings.autoRe = !!document.getElementById('setAutoReclass').checked;
      settings.nudges = !!document.getElementById('setNudges').checked;
      settings.live   = !!document.getElementById('setLiveEdit').checked;
      const r=document.querySelector('input[name="denom"]:checked'); settings.denom = r ? r.value : 'entered';
      settings.neutral = document.getElementById('neutralDays').value||'ignore';
      saveAll();
      document.getElementById('godBadge').classList.toggle('active', !!settings.god);
      toggleSettings();
    }
    document.getElementById('confirm1').addEventListener('change', checkResetReady);
    document.getElementById('confirm2').addEventListener('change', checkResetReady);
    function checkResetReady(){
      document.getElementById('btnReset').disabled = !(document.getElementById('confirm1').checked && document.getElementById('confirm2').checked);
    }
    function resetAll(){
      if(!confirm('Wirklich ALLES lÃ¶schen?')) return;
      localStorage.removeItem('alcoholTrackerData');
      localStorage.removeItem('alcoholTrackerSettings');
      dayData={}; saveAll(); buildCalendar(); toggleSettings();
    }

    /* ===== Events ===== */
    document.getElementById('btnPrev').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()-1); buildCalendar(); });
    document.getElementById('btnNext').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()+1); buildCalendar(); });
    document.getElementById('btnToday').addEventListener('click', ()=>{ viewDate=new Date(); buildCalendar(); });
    document.getElementById('btnChart').addEventListener('click', toggleChart);
    document.getElementById('btnSettings').addEventListener('click', toggleSettings);
    document.getElementById('flagDopeEnable').addEventListener('change', (e)=>{
      document.getElementById('dopeRow').classList.toggle('hidden', !e.target.checked);
    });
    document.getElementById('flagSport').addEventListener('change', ()=> recomputeSumsAndMaybeSuggest());
    document.querySelectorAll('input[name="cat"]').forEach(r=> r.addEventListener('change', ()=> recomputeSumsAndMaybeSuggest()));
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        ['editModal','chartModal','settingsModal'].forEach(id=>{
          const md=document.getElementById(id);
          if(md.style.display==='block'){
            if(id==='editModal') closeEdit();
            if(id==='chartModal') toggleChart();
            if(id==='settingsModal') toggleSettings();
          }
        });
      }
      if(e.key==='ArrowLeft') { viewDate.setMonth(viewDate.getMonth()-1); buildCalendar(); }
      if(e.key==='ArrowRight'){ viewDate.setMonth(viewDate.getMonth()+1); buildCalendar(); }
    });

    /* ===== Import/Export ===== */
    function exportData(){
      const blob=new Blob([JSON.stringify(dayData,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='booze-tracker-backup.json'; a.click(); URL.revokeObjectURL(a.href);
    }
    function importData(){
      const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange=(e)=>{
        const f=e.target.files && e.target.files[0]; if(!f) return;
        const rd=new FileReader(); rd.onload=()=>{
          try{
            const obj=JSON.parse(String(rd.result||'{}'))||{}; let merged=0,skipped=0;
            for(const k of Object.keys(obj)){
              const v=obj[k];
              if(!v || typeof v!=='object'){ skipped++; continue; }
              // minimal validation
              if(v.alcoholItems && !Array.isArray(v.alcoholItems)){ skipped++; continue; }
              dayData[k]=v; merged++;
            }
            saveAll(); buildCalendar(); alert(`Import ok: ${merged} Ã¼bernommen, ${skipped} verworfen`);
          }catch{ alert('Import fehlgeschlagen'); }
        }; rd.readAsText(f);
      }; inp.click();
    }

    /* ===== Boot ===== */
    window.addEventListener('load', ()=>{
      loadAll(); buildCalendar();
    });
  </script>
</body>
</html>
