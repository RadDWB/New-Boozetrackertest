<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 860px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      position: relative;
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }
    .app-version{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 10px;
    }

    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 6px 0 18px;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"‚≠ê"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }
    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }
    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    .chart-section{ margin:18px 0; padding:0; background:transparent; border:none; border-radius:0; }
    .chart-title{ font-weight:700; font-size:18px; margin-bottom:24px; text-align:center; color:var(--text); }
    .chart-bars{ display:flex; flex-direction:column; gap:32px; margin-bottom:10px; }
    .chart-bar-container{ display:flex; flex-direction:column; gap:12px; }
    .chart-bar-header{ display:flex; align-items:center; justify-content:space-between; }
    .chart-bar-label{ font-size:14px; font-weight:600; color:var(--text); }
    .chart-bar-label small{ display:block; font-size:12px; font-weight:400; color:var(--muted); margin-top:2px; }
    .chart-bar-value{ display:flex; align-items:baseline; gap:8px; }
    .chart-bar-number{ font-size:32px; font-weight:900; color:var(--text); }
    .chart-bar-percent{ font-size:16px; font-weight:600; color:var(--muted); }
    .chart-bar-wrapper{ height:48px; background:#f1f5f9; border-radius:12px; position:relative; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05); }
    .chart-bar{ height:100%; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); width:0%; border-radius:12px; display:flex; align-items:center; justify-content:flex-end; padding-right:16px; font-weight:700; color:white; font-size:16px; position:relative; }
    .chart-bar::after{ content:''; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0)); border-radius:12px; }
    .chart-bar.negative{ background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .chart-bar.positive{ background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{ font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--text); }
    .assessment-badge{
      text-align: center; margin-bottom: 24px; padding: 16px; border-radius: 12px; font-size: 24px; font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border: 2px solid #34d399; }
    .assessment-badge.balance{ background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #fbbf24; }
    .assessment-badge.weekend{ background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; border: 2px solid #fb923c; }
    .assessment-badge.red{ background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border: 2px solid #ef4444; }

    .assessment-metrics{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    @media (max-width:560px){ .assessment-metrics{ grid-template-columns:1fr; } }
    .metric-item{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; position:relative; }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; display:flex; align-items:center; gap:6px; }
    .metric-info{ display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; background:var(--primary); color:white; border-radius:50%; font-size:10px; font-weight:700; cursor:help; position:relative; }
    .metric-info:hover .metric-tooltip{ display:block; }
    .metric-tooltip{
      display:none; position:absolute; bottom:24px; left:50%; transform: translateX(-50%); width:280px; padding:12px;
      background:#1f2937; color:white; border-radius:8px; font-size:11px; line-height:1.5; z-index:1000; box-shadow:0 8px 20px rgba(0,0,0,0.3); text-align:left; font-weight:400;
    }
    .metric-tooltip::after{ content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:6px solid transparent; border-top-color:#1f2937; }
    .metric-tooltip strong{ color:#60a5fa; font-weight:600; }
    .metric-value{ font-size:20px; font-weight:800; color:var(--text); }
    .assessment-description{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; font-size:13px; line-height:1.6; color:var(--text); }
    .assessment-description strong{ color:var(--primary); }
    .assessment-warning{ margin-top:12px; padding:10px; background:#fff7ed; border-left:4px solid #fb923c; border-radius:6px; font-size:12px; color:#9a3412; }

    .btn-stats-toggle{
       appearance:none; background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:1.5px solid #c7d2fe; color:#1e3a8a;
       padding:10px 18px; border-radius:999px; font-size:14px; font-weight:700; cursor:pointer;
       transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
       box-shadow:0 6px 14px rgba(79,70,229,.18); display:inline-flex; align-items:center; gap:8px;
     }
     .btn-stats-toggle:hover{ background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border-color:#a5b4fc; transform:translateY(-1px); box-shadow:0 10px 20px rgba(79,70,229,.25); }
     .btn-stats-toggle:active{ transform:translateY(0); box-shadow:0 4px 10px rgba(79,70,229,.2); }
     .btn-stats-toggle:focus-visible{ outline:3px solid #c7d2fe; outline-offset:2px; }

    .btn-settings{
      appearance:none; background:linear-gradient(135deg,#f0f9ff,#dbeafe); border:1.5px solid #bae6fd; color:#0c4a6e;
      padding:10px 18px; border-radius:999px; font-size:14px; font-weight:700; cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      box-shadow:0 6px 14px rgba(2,132,199,.16); display:inline-flex; align-items:center; gap:8px;
    }
    .btn-settings:hover{ background:linear-gradient(135deg,#dbeafe,#bfdbfe); border-color:#93c5fd; transform:translateY(-1px); box-shadow:0 10px 20px rgba(2,132,199,.22); }
    .btn-settings:active{ transform:translateY(0); box-shadow:0 4px 10px rgba(2,132,199,.18); }
    .btn-settings:focus-visible{ outline:3px solid #93c5fd; outline-offset:2px; }

    .settings-popup{
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px; width:min(560px,92vw); max-height:85vh; overflow-y:auto; display:none; z-index:1002;
    }
    .settings-popup.active{ display:block; }
    .settings-popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; z-index:1001; }
    .settings-popup-overlay.active{ display:block; }
    .settings-title{ font-size:22px; font-weight:800; margin-bottom:8px; color:var(--text); text-align:center; }
    .settings-subtitle{ font-size:14px; color:var(--muted); margin-bottom:24px; text-align:center; }
    .settings-section{ margin-bottom:24px; }
    .settings-section-title{ font-size:16px; font-weight:700; margin-bottom:12px; color:var(--text); }
    .settings-description{ font-size:13px; color:var(--muted); margin-bottom:16px; line-height:1.6; }
    .settings-options{ display:flex; flex-direction:column; gap:10px; }
    .settings-option{ display:flex; align-items:flex-start; gap:12px; padding:14px; border:2px solid #e5e7eb; border-radius:12px; background:#fff; cursor:pointer; transition:all .2s ease; }
    .settings-option:hover{ border-color:var(--primary); background:#f8faff; }
    .settings-option.selected{ border-color:var(--primary); background:linear-gradient(135deg,#eef2ff,#f8faff); box-shadow:0 4px 12px rgba(79,70,229,0.15); }
    .settings-option input[type="radio"]{ margin-top:2px; transform:scale(1.3); accent-color:var(--primary); }
    .settings-option-content{ flex:1; }
    .settings-option-title{ font-weight:700; font-size:14px; color:var(--text); margin-bottom:4px; }
    .settings-option-desc{ font-size:12px; color:var(--muted); line-height:1.5; }
    .settings-info-box{ padding:14px; background:#eff6ff; border-left:4px solid var(--primary); border-radius:8px; font-size:12px; color:#1e40af; line-height:1.6; margin-top:16px; }
    .settings-info-box strong{ color:#1e3a8a; }

    .legend{ display:flex; flex-wrap:wrap; gap:10px 14px; margin:10px 0 14px; color:var(--muted); font-size:13px; }
    .legend span{ display:flex; align-items:center; gap:6px; }

    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:10px; position:relative; }
    .weekday{ text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0; background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6; }

    .day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid #e7eef6; background:#fff; font-weight:700; cursor:pointer;
      transition:.1s ease; position:relative; z-index:1; user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"‚ùó"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; top:4px; right:6px; font-size:12px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"‚≠ê"; position:absolute; top:4px; right:6px; font-size:12px; }

    .day.today{ outline: 3px solid var(--primary); outline-offset:-3px; }

    .day-comment-tooltip{
      display:none; position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%);
      min-width:200px; max-width:280px; padding:10px 12px; background:#1f2937; color:white; border-radius:8px; font-size:11px; line-height:1.5;
      z-index:1000; box-shadow:0 8px 20px rgba(0,0,0,0.4); text-align:left; font-weight:400; pointer-events:none; white-space:pre-wrap; word-wrap:break-word;
    }
    .day-comment-tooltip::after{ content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:6px solid transparent; border-top-color:#1f2937; }
    .day.has-comment{ position:relative; }
    .day.has-comment::before{ content:'üí¨'; position:absolute; top:2px; right:2px; font-size:10px; opacity:.8; }
    .day.has-comment:hover .day-comment-tooltip{ display:block; }

    .support{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:12px 0 12px; text-align:center; position:relative; z-index:0; }
    .support p{ margin:0 0 6px; }
    .support-buttons{ margin-top:0; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; }
    #kofi-holder, #kofi-holder iframe{ margin:0 !important; }
    #kofi-holder iframe{ height:48px !important; min-height:48px !important; }
    @media (max-width:420px){ #kofi-holder iframe{ height:44px !important; } }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px 0 6px; }
    .month-title{ font-weight:800; font-size:20px; }
    .month-top-nav{ display:flex; gap:10px; justify-content:center; margin:8px 0 14px; }
    .month-top-nav .btn{ width:auto; min-width:140px; }
    @media (max-width:420px){ .month-top-nav .btn{ min-width:120px; } }

    .edit-pop{
      position: fixed; left:50%; top: 18px; transform: translateX(-50%);
      background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; box-shadow: var(--shadow);
      padding:14px; width: min(560px, 92vw); display:none; z-index: 1004;
    }
    .edit-pop.active{ display:block; }
    .edit-title{ font-weight:800; font-size:18px; margin: 4px 0 8px; color:#111827; }
    .edit-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .edit-grid{ grid-template-columns: 1fr; } }
    .edit-option{
      width:100%; padding:12px 14px; border-radius:12px; border:2px solid #edf2f7; background:#fff; cursor:pointer; text-align:left;
      transition:.12s ease; font-size:15px;
    }
    .edit-option:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .edit-option.sober{ border-color:#c0f1df; background:#f4fffa; }
    .edit-option.wellness{ border-color:#b3f5cc; background:#f0fdf5; position:relative; }
    .edit-option.wellness::after{ content:"‚ùó"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.moderate{ border-color:#ffe5b5; background:#fff9ec; }
    .edit-option.mixed{ border-color:#fecaca; background:#fef2f2; position:relative; }
    .edit-option.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.alcohol{ border-color:#ffcaca; background:#fff2f2; }
    .edit-option.superday{ border-color:#b7f3d2; background:linear-gradient(135deg,#f6fff9,#f1fff7); position:relative; }
    .edit-option.superday::after{ content:"‚≠ê"; position:absolute; right:14px; top:50%; transform:translateY(-50%); }
    .edit-option.delete{ border-color:#e2e8f0; background:#f8fafc; }

    .chart-popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:1001; }
    .chart-popup{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 40px rgba(31,41,55,.25); padding:20px; width:min(720px,92vw); max-height:85vh; overflow:auto; display:none; z-index:1002; }

    .audit-popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:1001; }
    .audit-popup{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 40px rgba(31,41,55,.25); padding:20px; width:min(560px,92vw); max-height:85vh; overflow:auto; display:none; z-index:1002; }

    /* GOD-MODUS */
    .god-section{ margin-top: 16px; padding:16px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; display:none; }
    .god-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .god-grid{ grid-template-columns:1fr; } }
    .god-field{ display:flex; flex-direction:column; gap:6px; }
    .god-label{ font-size:13px; font-weight:600; color:var(--text); }
    .god-input, .god-select{ padding:10px; border-radius:10px; border:1px solid #d1d5db; font-size:13px; background:white; font-family:inherit; }
    .unit-toggle{ display:flex; gap:8px; align-items:center; }
    .unit-pill{ padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; font-size:12px; cursor:pointer; user-select:none; }
    .unit-pill.active{ background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a; font-weight:700; }
    .god-inline{ display:flex; gap:10px; align-items:center; }
    .god-subtle{ margin-top:6px; font-size:12px; color:var(--muted); }
    .god-actions{ display:flex; gap:12px; margin-top:12px; }
    .god-metrics{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .god-metric{ background:#fff; border:1px solid #e5e7eb; padding:10px; border-radius:10px; font-size:12px; }

    /* GOD BADGE */
    .god-badge{
      position: fixed; right: 16px; top: 16px; z-index: 1100;
      display:none; align-items:center; gap:8px;
      background: #0f172a; color:#e5e7eb; padding:8px 12px; border-radius:999px; font-weight:800; font-size:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .god-badge.active{ display:flex; }
    .mini-badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#e5e7eb; font-size:10px; font-weight:700; }

    /* Gefahrenbereich */
    .danger-zone{ border:2px dashed #fecaca; background:#fff1f2; padding:14px; border-radius:12px; }
    .danger-zone h4{ margin:0 0 8px; color:#7f1d1d; }
    .danger-zone p{ margin:0 0 8px; color:#9f1239; font-size:12px; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }
  
/* Ensure chart popup hidden by default */
.chart-popup{ display:none; }
.chart-popup.active{ display:block; }
.chart-popup-overlay{ display:none; }
.chart-popup-overlay.active{ display:block; }

</style>
<style>
.app-version{ display:inline-block; margin-left:12px; font-size:12px; color:#64748b; vertical-align:middle; }
#godBadge.active{ outline:2px dashed #f59e0b; outline-offset:4px; }
</style></head>
<body>
  <div id="godBadge" class="god-badge">üß† <span>God‚ÄëModus aktiviert</span></div>

  <div class="container">
    <!-- Tag-Eingabe Ansicht -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion"></div>
      <div class="current-date" id="currentDateDisplay"></div>

      <div>
        <label for="dayCommentInput" style="display:block; font-size:14px; font-weight:600; margin-bottom:8px; color:var(--text);">üí¨ Kommentar (optional):</label>
        <textarea id="dayCommentInput" placeholder="Notizen zum Tag (z.B. Anlass, Gef√ºhle, Situation)..." class="god-input" style="width:100%; min-height:80px; resize:vertical;"></textarea>
      </div>

      <div class="choice-container" role="group" aria-label="Tagesauswahl" id="choiceGroup">
        <label class="choice-option superday"><input type="radio" name="dayChoice" value="superday" /><span>‚≠ê Supertag ‚Äì Alkoholfrei + Sport gemacht!</span></label>
        <label class="choice-option wellness"><input type="radio" name="dayChoice" value="wellness" /><span>üíö Wellness ‚Äì Alkoholfrei + Sauna/Gesundheit</span></label>
        <label class="choice-option sober"><input type="radio" name="dayChoice" value="sober" /><span>üü¢ Alkoholfrei ‚Äì Kein Alkohol getrunken</span></label>
        <label class="choice-option moderate"><input type="radio" name="dayChoice" value="moderate" /><span>üü° Moderat ‚Äì Wenig Alkohol getrunken</span></label>
        <label class="choice-option mixed"><input type="radio" name="dayChoice" value="mixed" /><span>‚ù§Ô∏è Schadensbegrenzung ‚Äì Alkohol + Sport</span></label>
        <label class="choice-option alcohol"><input type="radio" name="dayChoice" value="alcohol" /><span>üî¥ Alkohol ‚Äì Viel Alkohol getrunken</span></label>
      </div>
      <div id="autoClassInfo" style="display:none; font-size:12px; color:#6b7280; margin-top:4px;"></div>

      <!-- GOD-MODUS Detail-Eingabe (nur sichtbar wenn aktiviert) -->
      <div id="godSection" class="god-section" aria-hidden="true">
        <div style="font-weight:800; margin-bottom:10px;">üß† God‚ÄëModus: Detaillierte Angaben (optional, verbessert die Auswertung)</div>

        <div class="god-grid">
          <div class="god-field">
            <label class="god-label">Getr√§nketyp (ABV)</label>
            <select id="godDrinkType" class="god-select">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liquor" data-abv="15">Lik√∂r (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirit" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>

          <div class="god-field" id="beerSizeField">
            <label class="god-label">Bier‚ÄëFlaschengr√∂√üe</label>
            <select id="godBeerSize" class="god-select">
              <option value="0.33">Klein (0,33‚ÄØl)</option>
              <option value="0.5">Gro√ü (0,5‚ÄØl)</option>
            </select>
          </div>

          <div class="god-field">
            <label class="god-label">Einheit</label>
            <div class="unit-toggle">
              <span id="unitMl" class="unit-pill active">ml</span>
              <span id="unitL" class="unit-pill">L</span>
            </div>
          </div>

          <div class="god-field">
            <label class="god-label">Menge pro Portion</label>
            <input id="godVolumePerPortion" class="god-input" type="number" min="0" step="1" placeholder="z.B. 330">
          </div>

          <div class="god-field">
            <label class="god-label">Anzahl Portionen</label>
            <input id="godPortions" class="god-input" type="number" min="0" step="1" placeholder="z.B. 2">
          </div>

          <div class="god-field">
            <label class="god-label">üèÉ‚Äç‚ôÇÔ∏è Sport heute?</label>
            <div class="god-inline">
              <input id="godDidSport" type="checkbox">
              <span class="god-subtle">Wirkt sich nur auf die Kategorie (Schadensbegrenzung) aus ‚Äì nicht auf g Alkohol.</span>
            </div>
          </div>

          <div class="god-field">
            <label class="god-label">Marijuana (g)</label>
            <input id="godWeedGrams" class="god-input" type="number" min="0" step="0.1" placeholder="z.B. 0.5">
          </div>

          <div class="god-field">
            <label class="god-label">H√§ufigkeit</label>
            <select id="godWeedFreq" class="god-select">
              <option value="einmalig">einmalig</option>
              <option value="mehrmals">mehrmals am Tag</option>
            </select>
          </div>
        
        <div class="god-field">
          <div class="god-inline">
            <label class="god-label" style="margin-right:8px;">Tages-Flags</label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="flagTotalCrash" type="checkbox"> <span>Totalabsturz</span></label>
            <label style="display:flex;align-items:center;gap:6px;"><input id="flagHangover" type="checkbox"> <span>Katertag</span></label>
          </div>
        </div>

        <!-- Quick‚ÄëSelect f√ºr Bier -->
        
        <div class="god-grid">
          <div class="god-field">
            <label class="god-label">Schnellwahl: Bier 0,33‚ÄØl (Anzahl 1‚Äì20)</label>
            <select id="qsBeer033" class="god-select">
              <option value="0">‚Äì</option>
            </select>
          </div>
          <div class="god-field">
            <label class="god-label">Schnellwahl: Bier 0,5‚ÄØl (Anzahl 1‚Äì10)</label>
            <select id="qsBeer05" class="god-select">
              <option value="0">‚Äì</option>
            </select>
          </div>
        </div>

        
        <div class="god-field">
          <label class="god-label">Getr√§nke (detailliert)</label>
          <div id="drinksRepeater"></div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnAddDrink" class="btn secondary" type="button" style="width:auto;">+ Weiteres Getr√§nk</button>
            <button id="btnClearDrinks" class="btn danger" type="button" style="width:auto;">√ó Leeren</button>
          </div>
          <div class="god-subtle">Flow: Getr√§nk w√§hlen ‚Üí Menge pro Portion ‚Üí Anzahl. Eigene Menge via ‚ÄûCustom (ml)‚Äú m√∂glich.</div>
        </div>
        <div class="god-metrics">
        
          <div class="god-metric"><strong>Alkohol (g):</strong> <span id="godGrams">0</span></div>
          <div class="god-metric"><strong>Drinks (√† 10‚ÄØg):</strong> <span id="godDrinks">0</span></div>
        </div>

        <div class="god-actions">
          <button id="godSuggest" class="btn secondary" type="button">üí° Kategorie vorschlagen</button>
          <button id="godSaveDetails" class="btn" type="button">üíæ Detaillierte Angaben speichern</button>
        </div>
        <div class="god-subtle">Formel: Volumen(L) √ó Vol% √ó 0.789‚ÄØg/ml √ó 1000 ‚Üí g Alkohol ¬∑ 1 Drink = 10‚ÄØg (DE)</div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn" disabled>Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        üç∑ Gespeicherte Tage: <span id="savedDaysCount">0</span> ¬∑ <span id="storageStatus">Lade‚Ä¶</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
    </div>

    <!-- Monats-√úbersicht -->
    <div id="monthView" class="view">
      <h1>üìä Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion2"></div>

      <div class="month-head"><div class="month-title" id="monthHeader">‚Äî</div></div>
      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">‚Üê Vorheriger</button>
        <button class="btn" onclick="nextMonth()">N√§chster ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Erfolgsquote</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>‚≠ê Supertag</span><span>üíö Wellness</span><span>üü¢ Alkoholfrei</span>
        <span>üü° Moderat</span><span>‚ù§Ô∏è "Schadensbegrenzung"</span><span>üî¥ Alkohol</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <div style="text-align:center; margin-top:16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">üìä 100‚ÄëTage‚ÄëStatistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">‚öôÔ∏è Einstellungen</button>
      </div>

      <section class="support">
        <p><strong>N√ºtzlich?</strong> Spendier mir einen Kaffee:</p>
        <div class="support-buttons">
          <div id="kofi-holder" class="btn-holder"></div>
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky">
              <img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir ¬¥n Kaffee! &emoji=‚òï&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" />
            </a>
          </div>
        </div>
      </section>
    </div>

    <!-- Edit-Karte -->
    <div id="editPopup" class="edit-pop" aria-hidden="true">
      <div class="edit-title" id="editDate">Datum</div>
      <div class="edit-grid">
        <button class="edit-option superday" onclick="updateDay('superday')">‚≠ê Supertag</button>
        <button class="edit-option wellness" onclick="updateDay('wellness')">üíö Wellness</button>
        <button class="edit-option sober" onclick="updateDay('sober')">üü¢ Alkoholfrei</button>
        <button class="edit-option moderate" onclick="updateDay('moderate')">üü° Moderat</button>
        <button class="edit-option mixed" onclick="updateDay('mixed')">‚ù§Ô∏è Schadensbegrenzung</button>
        <button class="edit-option alcohol" onclick="updateDay('alcohol')">üî¥ Alkohol</button>
      </div>

      <div id="editGodSection" class="god-section" style="display:none; margin-top:12px;">
        <div style="font-weight:800; margin-bottom:10px;">üß† God‚ÄëDetails bearbeiten</div>
        <div class="god-grid">
          <div class="god-field"><label class="god-label">Getr√§nketyp</label>
            <select id="editDrinkType" class="god-select">
              <option value="beer" data-abv="5">Bier (5%)</option>
              <option value="radler" data-abv="2.5">Radler (2.5%)</option>
              <option value="wine" data-abv="10">Wein (10%)</option>
              <option value="liquor" data-abv="15">Lik√∂r (15%)</option>
              <option value="other20" data-abv="20">Sonstiges (20%)</option>
              <option value="other30" data-abv="30">Sonstiges (30%)</option>
              <option value="spirit" data-abv="40">Spirituosen (40%)</option>
            </select>
          </div>
          <div class="god-field" id="editBeerSizeField">
            <label class="god-label">Bier‚ÄëFlaschengr√∂√üe</label>
            <select id="editBeerSize" class="god-select">
              <option value="0.33">Klein (0,33‚ÄØl)</option>
              <option value="0.5">Gro√ü (0,5‚ÄØl)</option>
            </select>
          </div>
          <div class="god-field">
            <label class="god-label">Einheit</label>
            <div class="unit-toggle">
              <span id="editUnitMl" class="unit-pill active">ml</span>
              <span id="editUnitL" class="unit-pill">L</span>
            </div>
          </div>
          <div class="god-field">
            <label class="god-label">Menge pro Portion</label>
            <input id="editVolumePerPortion" class="god-input" type="number" min="0" step="1">
          </div>
          <div class="god-field">
            <label class="god-label">Anzahl Portionen</label>
            <input id="editPortions" class="god-input" type="number" min="0" step="1">
          </div>
          <div class="god-field">
            <label class="god-label">üèÉ‚Äç‚ôÇÔ∏è Sport?</label>
            <div class="god-inline"><input id="editDidSport" type="checkbox"><span class="god-subtle">Nur f√ºr ‚ÄûSchadensbegrenzung‚Äú relevant.</span></div>
          </div>
          <div class="god-field">
            <label class="god-label">Marijuana (g)</label>
            <input id="editWeedGrams" class="god-input" type="number" min="0" step="0.1">
          </div>
          <div class="god-field">
            <label class="god-label">H√§ufigkeit</label>
            <select id="editWeedFreq" class="god-select">
              <option value="einmalig">einmalig</option>
              <option value="mehrmals">mehrmals am Tag</option>
            </select>
          </div>
        </div>
        <div class="god-metrics">
          <div class="god-metric"><strong>Alkohol (g):</strong> <span id="editGrams">0</span></div>
          <div class="god-metric"><strong>Drinks (√† 10‚ÄØg):</strong> <span id="editDrinks">0</span></div>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <label for="editCommentInput" style="display:block; font-size:13px; font-weight:600; margin-bottom:6px; color:var(--text);">üí¨ Kommentar:</label>
        <textarea id="editCommentInput" placeholder="Notizen zum Tag..." style="width:100%; min-height:70px; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:12px; font-family:inherit; resize:vertical;"></textarea>
        <button class="btn" style="width:100%; margin-top:8px;" onclick="saveEditComment()">üíæ √Ñnderungen speichern</button>
      </div>

      <div class="edit-grid" style="margin-top: 16px;">
        <button class="edit-option delete" onclick="updateDay('delete')">üóëÔ∏è Tag l√∂schen</button>
        <button class="btn secondary" onclick="closeEditPopup()">Schlie√üen</button>
      </div>
    </div>

    <!-- Chart-Popup -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup" aria-hidden="true">
      <div class="chart-section">
        <div class="chart-title">üìä Letzte 100 Tage im √úberblick</div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">üî¥ Unter 50% <small>Alkohol, ‚ÄûSchadensbegrenzung‚Äú, Moderat</small></div>
              <div class="chart-bar-value"><span class="chart-bar-number" id="chartNegativeNum">0</span><span class="chart-bar-percent" id="chartNegativePct">0%</span></div>
            </div>
            <div class="chart-bar-wrapper"><div class="chart-bar negative" id="chartNegative" style="width:0%;"></div></div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">üü¢ √úber 50% <small>Supertag, Wellness, Alkoholfrei</small></div>
              <div class="chart-bar-value"><span class="chart-bar-number" id="chartPositiveNum">0</span><span class="chart-bar-percent" id="chartPositivePct">0%</span></div>
            </div>
            <div class="chart-bar-wrapper"><div class="chart-bar positive" id="chartPositive" style="width:0%;"></div></div>
          </div>
        </div>
      </div>

      <div class="health-assessment">
        <div class="assessment-title">üéØ Deine Gesundheitseinsch√§tzung</div>
        <div class="assessment-badge" id="assessmentBadge"></div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">AF‚ÄëQuote (alkoholfrei)
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">Prozentsatz alkoholfreier Tage:<br><strong>Supertag + Wellness + Alkoholfrei</strong><br><br>Je h√∂her, desto besser.</span>
              </span>
            </div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Gewichtete Gesundheit
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">Score (0‚Äì100): Supertag 100, Wellness 90, AF 75, Moderat 40, Schadensbegrenzung 25, Viel 0.</span>
              </span>
            </div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Binge‚ÄëN√§he (Hochrisiko)
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">Z√§hlt Hochrisiko‚ÄëTage: ‚ÄûViel‚Äú + ‚ÄûSchadensbegrenzung‚Äú.</span>
              </span>
            </div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">L√§ngster Cluster
              <span class="metric-info">‚Ñπ
                <span class="metric-tooltip">L√§ngste Serie von Hochrisiko‚ÄëTagen am St√ºck.</span>
              </span>
            </div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning" style="display:none;"></div>

        <div id="auditSuggestion" style="display:none; text-align:center; margin-top:12px;">
          <button class="btn secondary" type="button" onclick="openAudit()">üß™ AUDIT‚ÄëScreening machen</button>
          <div style="font-size:12px; color:var(--muted); margin-top:6px;">Dezentes WHO‚ÄëScreening (3 Fragen) ‚Äì nur wenn sinnvoll.</div>
        </div>

        <div class="analysis-advanced" style="margin-top:14px;">
          <button id="analysisToggle" class="btn secondary" type="button">üîç Detaillierte Analyse anzeigen</button>
          <div id="analysisBox" class="analysis-box" style="display:none; margin-top:12px; padding:14px; background:#fff; border:1px solid #e5e7eb; border-radius:12px;">
            <div style="font-weight:800; margin-bottom:6px;">Feinere Skala & Prognosen</div>
            <div id="godMetricsList" style="font-size:13px; line-height:1.6;"></div>
          </div>
        </div>
      </div>

      <button class="btn secondary" style="margin-top: 24px; width: 100%;" onclick="toggleChartPopup()">Schlie√üen</button>
    </div>

    <!-- Einstellungen -->
    <div class="settings-popup-overlay" id="settingsOverlay" onclick="toggleSettingsPopup()"></div>
    <div id="settingsPopup" class="settings-popup" aria-hidden="true">
      <div class="settings-title">‚öôÔ∏è Einstellungen</div>
      <div class="settings-subtitle">Passe die Bewertung an deine Bed√ºrfnisse an</div>

      <div class="settings-section">
        <div class="settings-section-title">üß† God‚ÄëModus</div>
        <div class="settings-description">Detailliertes Tracking (Getr√§nke, Menge, Sport, Marijuana). Standard‚ÄëModus bleibt unver√§ndert.</div>
        <div><label style="display:flex; align-items:center; gap:12px;"><input id="toggleGodMode" type="checkbox"><span><strong>God‚ÄëModus aktivieren</strong></span></label></div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üéõÔ∏è Automatik</div>
        <div class="settings-description">Optionen, die dir Arbeit abnehmen.</div>
        <div class="settings-options">
          <label class="settings-option"><input id="toggleAutoReclass" type="checkbox"><div class="settings-option-content"><div class="settings-option-title">Auto‚ÄëReklassifizieren</div><div class="settings-option-desc">Kategorie automatisch setzen, wenn die eingegebene Menge eine andere Stufe erzwingt.</div></div></label>
          <label class="settings-option"><input id="toggleNudges" type="checkbox"><div class="settings-option-content"><div class="settings-option-title">Nudges & Warnungen</div><div class="settings-option-desc">Vorab‚ÄëNudge (17‚ÄØUhr), Relapse‚ÄëFirewall, Streak‚ÄëReminder am Freitag.</div></div></label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üéØ Neutrale Tage</div>
        <div class="settings-description">Wie sollen nicht eingetragene Tage in die Statistik einflie√üen?</div>
        <div class="settings-options">
          <label class="settings-option" id="option-ignore"><input type="radio" name="neutralDays" value="ignore" checked><div class="settings-option-content"><div class="settings-option-title">üéØ Ignorieren (Empfohlen)</div><div class="settings-option-desc">Nur eingetragene Tage z√§hlen.</div></div></label>
          <label class="settings-option" id="option-neutral"><input type="radio" name="neutralDays" value="neutral"><div class="settings-option-content"><div class="settings-option-title">‚öñÔ∏è Als neutral werten</div><div class="settings-option-desc">Neutral ‚âà 50% Gesundheit.</div></div></label>
          <label class="settings-option" id="option-negative"><input type="radio" name="neutralDays" value="negative"><div class="settings-option-content"><div class="settings-option-title">‚ö†Ô∏è Eher negativ</div><div class="settings-option-desc">‚âà 30% Gesundheit.</div></div></label>
          <label class="settings-option" id="option-very-negative"><input type="radio" name="neutralDays" value="very-negative"><div class="settings-option-content"><div class="settings-option-title">üö® Sehr negativ</div><div class="settings-option-desc">‚âà 15% Gesundheit.</div></div></label>
        </div>
        <div class="settings-info-box">üí° ‚ÄûIgnorieren‚Äú ist am fairsten, wenn du (noch) nicht t√§glich trackst.</div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üóÑÔ∏è Daten‚ÄëBackup (lokal)</div>
        <div class="settings-description">Export/Import bleibt 100% lokal im Browser.</div>
        <div class="submit-row" style="margin-top:8px;">
          <button class="btn secondary" onclick="exportData()">üì§ Daten exportieren</button>
          <button class="btn secondary" onclick="importData()">üì• Daten importieren</button>
        </div>
        <p class="settings-description" style="margin-top:10px;">Import wird gemerged (gleiche Tage werden √ºberschrieben).</p>
      </div>

      <!-- Gefahr ganz unten -->
      <div class="settings-section">
        <div class="danger-zone">
          <h4>‚ö†Ô∏è Gefahrenbereich</h4>
          <p>Alle Eintr√§ge und Einstellungen unwiderruflich l√∂schen.</p>
          <button class="btn danger" onclick="resetStorage()">üßπ Lokalen Speicher l√∂schen</button>
        </div>
      </div>

      <button class="btn" style="width: 100%;" onclick="saveSettings()">Einstellungen speichern</button>
    </div>

    <!-- AUDIT-C Popup -->
    <div id="auditOverlay" class="audit-popup-overlay" onclick="closeAudit()"></div>
    <div id="auditPopup" class="audit-popup" aria-hidden="true">
      <div class="settings-title">üìù AUDIT‚ÄëC Schnelltest (WHO)</div>
      <p style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">3 kurze Fragen zum letzten Jahr. Screening, keine Diagnose.</p>

      <div style="margin-bottom: 16px;">
        <label style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Geschlecht (f√ºr Cut‚Äëoffs):</label>
        <select id="auditGender" class="god-select">
          <option value="male">M√§nnlich</option>
          <option value="female">Weiblich</option>
        </select>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">1. Wie oft trinken Sie alkoholhaltige Getr√§nke?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="0"> Nie (0 Punkte)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="1"> Monatlich oder seltener (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="2"> 2‚Äì4√ó/Monat (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="3"> 2‚Äì3√ó/Woche (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ1" value="4"> ‚â•4√ó/Woche (4)</label></div>
        </div>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">2. Wie viele Einheiten an einem typischen Tag?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="0"> 1‚Äì2 (0)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="1"> 3‚Äì4 (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="2"> 5‚Äì6 (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="3"> 7‚Äì9 (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ2" value="4"> 10+ (4)</label></div>
        </div>
      </div>

      <div class="audit-question">
        <label class="audit-question-label">3. Wie oft trinken Sie sechs oder mehr Einheiten?</label>
        <div class="audit-options">
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="0"> Nie (0)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="1"> Seltener als monatlich (1)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="2"> Monatlich (2)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="3"> W√∂chentlich (3)</label></div>
          <div class="audit-option"><label><input type="radio" name="auditQ3" value="4"> (Fast) t√§glich (4)</label></div>
        </div>
      </div>

      <button class="btn" style="width: 100%; margin-top: 16px;" onclick="calculateAuditScore()">Ergebnis berechnen</button>
      <div id="auditResult" style="display:none; margin-top:12px;"></div>
      <button class="btn secondary" style="margin-top: 14px; width: 100%;" onclick="closeAudit()">Schlie√üen</button>
    </div>

    <footer>¬© 2025 by R. Duwenbeck</footer>
  </div>

  <script>

// === Debounce + Storage Warnung ===
function __bt_debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms); }; }
window.buildMonthGrid = (function(orig){
  if(typeof orig!=='function') return orig;
  const deb = __bt_debounce(orig, 120);
  return function(){ return deb.apply(this, arguments); }
})(window.buildMonthGrid);

function btStorageInfo(){
  try{
    const s = JSON.stringify(window.dayData || JSON.parse(localStorage.getItem('alcoholTrackerData')||'{}'));
    const kb = (s.length/1024).toFixed(0);
    const info = document.querySelector('.storage-info');
    if(info) info.textContent = 'Lokaler Speicher: ~'+kb+' KB';
    if((s.length/1024/1024)>4){ console.warn('Speicher n√§hert sich der Grenze'); }
  }catch(e){} }
document.addEventListener('DOMContentLoaded', btStorageInfo);


// === Danger-Zone: Double Confirm + Countdown ===
document.addEventListener('DOMContentLoaded', ()=>{
  const btn=document.getElementById('btnDeleteAll');
  if(!btn) return;
  let armed=false, timer=null, left=5;
  const orig=btn.textContent;
  btn.addEventListener('click',(e)=>{
    if(!armed){
      e.preventDefault();
      btn.disabled=true; left=5; btn.textContent='L√∂schen aktiv in '+left+'s';
      timer=setInterval(()=>{
        left--; btn.textContent='L√∂schen aktiv in '+left+'s';
        if(left<=0){ clearInterval(timer); btn.disabled=false; btn.textContent='WIRKLICH ALLES l√∂schen'; armed=true; }
      },1000);
      alert('‚ö†Ô∏è Ernsthaft? Exportiere vorher deine Daten (Einstellungen ‚Üí Export).');
      return;
    } else {
      if(typeof deleteAllData==='function'){ deleteAllData(); }
      armed=false; btn.textContent=orig;
    }
  });
});


// === Tooltip Tap + Heute-Button + ESC schlie√üt Popups ===
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.day.has-comment').forEach(el=>{
    el.addEventListener('click',(e)=>{
      const tip=el.querySelector('.day-comment-tooltip');
      if(!tip) return;
      const vis = tip.style.display==='block';
      tip.style.display = vis?'none':'block';
      e.stopPropagation();
    });
  });
  document.body.addEventListener('click',()=>{
    document.querySelectorAll('.day-comment-tooltip').forEach(t=>t.style.display='none');
  });

  const nav=document.querySelector('.month-top-nav');
  if(nav && !document.getElementById('btnToday')){
    const b=document.createElement('button'); b.id='btnToday'; b.className='btn secondary'; b.textContent='Heute';
    b.style.width='auto'; b.addEventListener('click',()=>{ try{ if(typeof goToToday==='function') goToToday(); }catch(e){} });
    nav.appendChild(b);
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      ['chartPopup','settingsPopup','auditPopup','editPopup'].forEach(id=>{
        const el=document.getElementById(id);
        const ol=document.getElementById(id+'Overlay') || document.querySelector('.'+id+'-overlay');
        if(el && el.classList?.contains('active')){ el.classList.remove('active'); if(ol) ol.classList.remove('active'); }
        else if(el && el.style && el.style.display==='block'){ el.style.display='none'; if(ol) ol.style.display='none'; }
      });
    }
  });
});


// === Risiko/Features + Forecast ===
function getDayStatus(key){
  try{ const v=window.dayData?.[key]; return (typeof v==='string')? v : (v?.status||''); }catch(e){ return ''; }
}
function gramsForDate(key){
  try{
    const v=window.dayData?.[key];
    if(v && typeof v==='object' && v.alcohol && typeof v.alcohol.grams==='number') return v.alcohol.grams;
    const st=getDayStatus(key);
    if(st==='moderate') return 20;
    if(st==='mixed')    return 40;
    if(st==='alcohol')  return 50;
    return 0;
  }catch(e){ return 0; }
}
function wdi(d){ return (d.getDay()+6)%7; }
function seriesLastNDays(n){
  const today=new Date(); const arr=[];
  for(let i=0;i<n;i++){ const d=new Date(today); d.setDate(d.getDate()-i);
    const k = d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2)+'-'+('0'+d.getDate()).slice(-2);
    arr.push({key:k,date:d,grams:gramsForDate(k)});
  } return arr.reverse();
}
function std(vals){ const n=vals.length; if(!n) return 0; const m=vals.reduce((a,b)=>a+b,0)/n; const v=vals.reduce((a,b)=>a+(b-m)*(b-m),0)/n; return Math.sqrt(v); }
function slope(arr){ const n=arr.length; if(n<3) return 0; let sx=0,sy=0,sxy=0,sxx=0; for(let i=0;i<n;i++){ const x=i,y=arr[i].grams; sx+=x; sy+=y; sxy+=x*y; sxx+=x*x; } const m=(n*sxy - sx*sy)/Math.max((n*sxx - sx*sx),1e-6); return m; }

const COMMENT_FLAGS=[
  {re:/feier|party|geburtstag|abschluss|oktoberfest/i, weight:+0.1, tag:'Feier'},
  {re:/stress|√§rger|streit|deadline|druck/i,         weight:+0.08, tag:'Stress'},
  {re:/schlaf\s*(\d+)\s*h/i,                      weight:(m)=> (parseInt(m[1],10)<6?+0.06:0), tag:'Schlaf<6h'}
];
function commentRisk(key){
  const v=window.dayData?.[key]; if(!v||!v.comment) return {delta:0,tags:[]};
  let delta=0,tags=[];
  for(const f of COMMENT_FLAGS){ const m = v.comment.match(f.re); if(m){ const w=(typeof f.weight==='function')? f.weight(m): f.weight; delta+=w; tags.push(f.tag);} }
  return {delta:Math.min(delta,0.2),tags};
}
function computeFeatures(){
  const s7=seriesLastNDays(7), s14=seriesLastNDays(14), s30=seriesLastNDays(30), s100=seriesLastNDays(100);
  const avg7 = s7.reduce((a,b)=>a+b.grams,0)/Math.max(s7.length,1);
  const avg30= s30.reduce((a,b)=>a+b.grams,0)/Math.max(s30.length,1);
  const vol14= std(s14.map(x=>x.grams));
  const trend30=slope(s30);
  let binge=0, cluster=0, cur=0, weekendHigh=0, weekendTot=0;
  for(const x of s100){
    if(x.grams>=40) binge++;
    if(x.grams>=20){ cur++; cluster=Math.max(cluster,cur);} else cur=0;
    const dow=wdi(x.date);
    if((dow===4||dow===5) && (x.grams>0 || getDayStatus(x.key))){
      weekendTot++; if(x.grams>=40) weekendHigh++;
    }
  }
  const weekendBias = weekendTot ? weekendHigh/weekendTot : 0;
  const used = s100.filter(x=>x.grams>0).map(x=>x.grams);
  const median = a=>{ const t=[...a].sort((x,y)=>x-y); const m=Math.floor(t.length/2); return t.length?(t.length%2?t[m]:(t[m-1]+t[m])/2):0; };
  let tol=false, tolSoft=false;
  if(used.length>=20){
    const d = median(used.slice(0,10)) - median(used.slice(-10));
    tol = (d < -5);
    tolSoft = (!tol && d < -3);
  }
  return {avg7,avg30,vol14,trend30,binge,cluster,weekendBias,toleranceCreep:tol,toleranceSoft:tolSoft};
}
function riskAssessment(){
  const f=computeFeatures();
  let qty=100;
  const drinksPerWeek=(f.avg7/10)*7;
  if(drinksPerWeek<=1) qty=100;
  else if(drinksPerWeek<=2) qty=80;
  else if(drinksPerWeek<=4) qty=60;
  else if(drinksPerWeek<=8) qty=30;
  else qty=0;
  qty += (f.trend30<0?-8: (f.trend30>0? -8:0));
  qty = Math.max(0, Math.min(100, qty));

  let pattern=90;
  if(f.binge>30 || f.cluster>7) pattern=0;
  else if(f.binge>15 || f.cluster>5) pattern=40;
  else if(f.binge>5  || f.cluster>3) pattern=70;

  if(f.weekendBias>=0.4) pattern -= 8;

  const volThresh = Math.max(20, 0.5*f.avg30);
  if(f.vol14>=volThresh) pattern -= 6;
  pattern = Math.max(0, Math.min(100, pattern));

  let ctx=90;
  if(f.toleranceCreep) ctx -= 10;
  else if(f.toleranceSoft) ctx -= 4;
  ctx = Math.max(0, Math.min(100, ctx));

  const total = Math.round(0.5*qty + 0.35*pattern + 0.15*ctx);
  let stage='Stufe 2: Balance-K√ºnstler';
  if(total>=90) stage='Stufe 1: Zen-Meister';
  else if(total>=65) stage='Stufe 2: Balance-K√ºnstler';
  else if(total>=45) stage='Stufe 3: Kipppunkt-Wanderer';
  else if(total>=25) stage='Stufe 4: Risiko-Jongleur';
  else stage='Stufe 5: Alarmstufe Rot';

  const subtypes=[];
  if(f.weekendBias>=0.4) subtypes.push('Weekend-Binger');
  if(f.binge>=1 && f.avg30<5) subtypes.push('Abstinenz mit Slips');
  if(f.cluster>=3) subtypes.push('Cluster-Rider');
  if(f.toleranceCreep) subtypes.push('Tolerance-Creep');
  if(f.toleranceSoft) subtypes.push('Tolerance-Creep (soft)');
  return { total, stage, subtypes, features:f };
}
function predict7Days(){
  const cats=['superday','wellness','sober','moderate','mixed','alcohol'];
  const idx=Object.fromEntries(cats.map((c,i)=>[c,i]));
  const M=Array.from({length:cats.length},()=>Array(cats.length).fill(1e-3));
  const today=new Date(); let prev=null;
  for(let i=180;i>=1;i--){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const k=d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2)+'-'+('0'+d.getDate()).slice(-2);
    const st=getDayStatus(k); if(!st) continue;
    const w=(i<=30)?2:1;
    if(prev!=null){ M[idx[prev]][idx[st]] += w; }
    prev=st;
  }
  for(let r=0;r<M.length;r++){ const s=M[r].reduce((a,b)=>a+b,0); for(let c=0;c<M[r].length;c++) M[r][c]/=s; }
  let start = getDayStatus(today.getFullYear()+'-'+('0'+(today.getMonth()+1)).slice(-2)+'-'+('0'+today.getDate()).slice(-2)) || prev || 'sober';
  const todayKey = today.getFullYear()+'-'+('0'+(today.getMonth()+1)).slice(-2)+'-'+('0'+today.getDate()).slice(-2);
  const cr = commentRisk(todayKey).delta;
  const out=[]; let state=start;
  for(let h=1;h<=7;h++){
    const d=new Date(today); d.setDate(d.getDate()+h);
    const dow=wdi(d);
    const row=M[idx[state]];
    let pHigh=row[idx['moderate']]+row[idx['mixed']]+row[idx['alcohol']];
    if(dow===4||dow===5) pHigh+=0.10; else if(dow===0) pHigh-=0.10;
    if(h<=3) pHigh += Math.min(0.2, cr);
    pHigh=Math.max(0, Math.min(1, pHigh));
    out.push({date:d, risk:Math.round(pHigh*100), explain:`${state} ‚ûú ${Math.round(pHigh*100)}% (Wochentag ${dow===4||dow===5?'+10%':dow===0?'-10%':'¬±0'})`});
    const nextIdx = row.indexOf(Math.max(...row)); state=cats[nextIdx];
  }
  return out;
}
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const ra=riskAssessment();
    const fx=predict7Days();
    const anchor=document.querySelector('.health-assessment');
    if(anchor){
      const box=document.createElement('div');
      box.style.marginTop='12px';
      box.innerHTML=`<div style="font-weight:700;margin-bottom:6px;">${ra.stage} ¬∑ Score ${ra.total}/100</div>`+
        (ra.subtypes.length?`<div style="font-size:12px;color:#6b7280;margin-bottom:8px;">üß© ${ra.subtypes.join(', ')}</div>`:'')+
        `<div><strong>7‚ÄëTage‚ÄëRisiko‚ÄëPrognose</strong><br>`+fx.map(x=>`${x.date.toLocaleDateString('de-DE',{weekday:'short'})}: ${x.risk}% <span style="color:#6b7280;">(${x.explain})</span>`).join('<br>')+`</div>`;
      anchor.appendChild(box);
    }
  }catch(e){}
});


// === Schema-Version + Migration ===
function btZeroPad(n){ return String(n).padStart(2,'0'); }
function btKey(d){ return d.getFullYear()+'-'+btZeroPad(d.getMonth()+1)+'-'+btZeroPad(d.getDate()); }
function migrateKeysIfNeeded(){
  try{
    const sv = localStorage.getItem('alcoholTrackerSchemaVersion')||'0';
    let data = JSON.parse(localStorage.getItem('alcoholTrackerData')||'{}');
    let changed=false;
    for(const k of Object.keys(data)){
      if(typeof data[k]==='string'){ data[k] = { status:data[k], comment:'' }; changed=true; }
    }
    const map={};
    for(const k of Object.keys(data)){
      const m = String(k).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if(m){
        const nk = m[1]+'-'+btZeroPad(m[2])+'-'+btZeroPad(m[3]);
        if(nk!==k){ changed=true; }
        map[nk] = data[k];
      }else{
        map[k]=data[k];
      }
    }
    if(changed || sv!=='1'){
      localStorage.setItem('alcoholTrackerData', JSON.stringify(map));
      localStorage.setItem('alcoholTrackerSchemaVersion','1');
      window.dayData = map;
    }
  }catch(e){ console.warn('Migration issue', e); }
}
document.addEventListener('DOMContentLoaded', migrateKeysIfNeeded);

function validateImported(obj){
  if(!obj || typeof obj!=='object') return null;
  const out={dayData:{}, settings:{}};
  if(obj.dayData && typeof obj.dayData==='object'){
    for(const [k,v] of Object.entries(obj.dayData)){
      const m = String(k).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if(!m) continue;
      const nk = m[1]+'-'+btZeroPad(m[2])+'-'+btZeroPad(m[3]);
      if(typeof v==='string'){ out.dayData[nk]={status:v, comment:''}; }
      else if(typeof v==='object'){
        const vv={};
        vv.status = (v.status||'').toString();
        vv.comment= (v.comment||'').toString();
        if(v.alcohol && typeof v.alcohol==='object'){
          const a={};
          a.grams = Math.max(0, parseFloat(v.alcohol.grams)||0);
          a.drinks= Math.max(0, parseFloat(v.alcohol.drinks)||0);
          vv.alcohol=a;
        }
        if(v.sport) vv.sport = !!v.sport;
        if(v.marijuana && typeof v.marijuana==='object'){
          vv.marijuana = { grams: Math.max(0, parseFloat(v.marijuana.grams)||0), freq: v.marijuana.freq||'einmalig' };
        }
        out.dayData[nk]=vv;
      }
    }
  }
  if(obj.settings && typeof obj.settings==='object'){
    const s={};
    s.god = !!obj.settings.god;
    s.neutralDays = Array.isArray(obj.settings.neutralDays)? obj.settings.neutralDays : ['sober','wellness','superday'];
    out.settings=s;
  }
  return out;
}


// === Auto-Reklassifikation (reihenfolge korrigiert) + Warnhinweis ===
function calcSuggestedCategory(){
  const grams = (typeof __bt_live_grams==='number') ? __bt_live_grams : 0;
  const didSport = !!document.getElementById('godDidSport')?.checked;
  let target = 'sober';
  if(grams===0){ target = didSport ? 'superday' : 'sober'; }
  else if(didSport && grams<=40){ target = 'mixed'; }
  else if(grams<=20){ target = 'moderate'; }
  else { target = 'alcohol'; }
  return target;
}
function autoSuggestCategory(){
  const el = document.getElementById('autoClassInfo');
  if(!el) return;
  const sug = calcSuggestedCategory();
  el.style.display='block';
  el.textContent = 'Vorschlag: '+(
    sug==='superday'?'Supertag (0g + Sport)':
    sug==='sober'?'Alkoholfrei':
    sug==='mixed'?'Schadensbegrenzung (Alkohol+Sport, ‚â§40g)':
    sug==='moderate'?'Moderat (‚â§20g)':
    'Alkohol (viel)'
  );
  const chosen = (document.querySelector('input[name="dayChoice"]:checked')||{}).value;
  const warn = document.getElementById('categoryWarn') || (function(){ const w=document.createElement('div'); w.id='categoryWarn'; w.style.cssText='margin-top:6px;font-size:12px;color:#9a3412;background:#fff7ed;border-left:4px solid #fb923c;padding:8px;border-radius:6px;display:none;'; el.after(w); return w; })();
  if(chosen && chosen!==sug){ warn.textContent='‚ö†Ô∏è Deine Auswahl passt nicht zum Vorschlag ('+sug+').'; warn.style.display='block'; }
  else { warn.style.display='none'; }
}
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('choiceGroup')?.addEventListener('change', autoSuggestCategory);
});


// === Multi-Drink Repeater ===
const DRINK_PRESETS = {
  "beer": {label:"Bier (5%)", abv:5,  volumes:[330,500]},
  "radler": {label:"Radler (2.5%)", abv:2.5, volumes:[330,500]},
  "wine": {label:"Wein (10%)", abv:10, volumes:[100,200,250]},
  "liquor":{label:"Lik√∂r (15%)", abv:15, volumes:[20,40]},
  "spirit":{label:"Spirituosen (40%)", abv:40, volumes:[20,40]},
  "other20":{label:"Sonstiges (20%)", abv:20, volumes:[100,200]},
  "other30":{label:"Sonstiges (30%)", abv:30, volumes:[20,40,100]}
};
function makeDrinkRow(idx){
  const wrap = document.createElement('div');
  wrap.className = 'god-grid';
  wrap.dataset.row = idx;
  wrap.innerHTML = `
    <div class="god-field">
      <label class="god-label">Getr√§nk</label>
      <select class="god-select drink-type">
        ${Object.entries(DRINK_PRESETS).map(([k,v])=>`<option value="${k}" data-abv="${v.abv}">${v.label}</option>`).join('')}
      </select>
    </div>
    <div class="god-field">
      <label class="god-label">Menge pro Portion</label>
      <select class="god-select drink-volume"></select>
      <div class="god-inline" style="margin-top:6px;">
        <span style="font-size:12px;color:#64748b;">Custom (ml):</span>
        <input type="number" class="god-input drink-volume-custom" min="0" step="10" style="max-width:120px">
      </div>
    </div>
    <div class="god-field">
      <label class="god-label">Anzahl</label>
      <select class="god-select drink-count">
        ${Array.from({length:20},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
      </select>
    </div>
    <div class="god-field">
      <label class="god-label">ABV (%)</label>
      <input class="god-input drink-abv" type="number" min="0" max="80" step="0.1" value="5">
    </div>
    <div class="god-field">
      <label class="god-label">&nbsp;</label>
      <button class="btn danger drink-remove" type="button" style="width:auto;">Entfernen</button>
    </div>
  `;
  return wrap;
}
function drinksInit(){
  const holder = document.getElementById('drinksRepeater');
  if(!holder) return;
  function syncVolumes(row){
    const typeSel = row.querySelector('.drink-type');
    const volSel  = row.querySelector('.drink-volume');
    const abvIn   = row.querySelector('.drink-abv');
    const preset  = DRINK_PRESETS[typeSel.value];
    volSel.innerHTML = preset.volumes.map(v=>`<option value="${v}">${v} ml</option>`).join('') + `<option value="custom">Custom</option>`;
    abvIn.value = preset.abv;
  }
  function rowCompute(row){
    const typeSel = row.querySelector('.drink-type');
    const volSel  = row.querySelector('.drink-volume');
    const volCus  = row.querySelector('.drink-volume-custom');
    const cntSel  = row.querySelector('.drink-count');
    const abvIn   = row.querySelector('.drink-abv');
    const abv = Math.max(0, Math.min(80, parseFloat(abvIn.value)||0));
    let vol = volSel.value==='custom' ? (parseFloat(volCus.value)||0) : (parseFloat(volSel.value)||0);
    const cnt = parseInt(cntSel.value||'0',10);
    const grams = vol * (abv/100) * 0.789 * cnt;
    return {grams, drinks: grams/10};
  }
  function recomputeAll(){
    let g=0,d=0;
    holder.querySelectorAll('[data-row]').forEach(row=>{
      const r = rowCompute(row); g+=r.grams; d+=r.drinks;
    });
    const gEl=document.getElementById('godGrams'); if(gEl) gEl.textContent = Math.round(g);
    const dEl=document.getElementById('godDrinks'); if(dEl) dEl.textContent = (d).toFixed(1);
    window.__bt_live_grams = g;
    autoSuggestCategory();
  }
  function attach(row){
    row.addEventListener('change', recomputeAll);
    row.querySelector('.drink-volume-custom').addEventListener('input', recomputeAll);
    row.querySelector('.drink-type').addEventListener('change', ()=>{ syncVolumes(row); recomputeAll(); });
    row.querySelector('.drink-remove').addEventListener('click', ()=>{ row.remove(); recomputeAll(); });
    syncVolumes(row);
  }
  function add(){ const row = makeDrinkRow(Date.now()); holder.appendChild(row); attach(row); recomputeAll(); }
  document.getElementById('btnAddDrink')?.addEventListener('click', add);
  document.getElementById('btnClearDrinks')?.addEventListener('click', ()=>{ holder.innerHTML=''; recomputeAll(); });
  if(holder.childElementCount===0) add();
}
document.addEventListener('DOMContentLoaded', drinksInit);


// === God-Gates: Mengen nur im God-Mode ===
function __bt_updateGodGates(){
  try{
    let s = (window.settings && (settings.god===true || settings.god==='true')) || (typeof godMode!=='undefined' && !!godMode);
    const main = document.getElementById('godSection'); if(main) main.style.display = s ? 'block' : 'none';
    const edit = document.getElementById('editGodSection'); if(edit) edit.style.display = s ? 'block' : 'none';
    const badge= document.getElementById('godBadge'); if(badge) badge.classList.toggle('active', !!s);
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', __bt_updateGodGates);


// === Start wie zuletzt + First-Run Eingabe ===
function btGetLastView(){ try{return localStorage.getItem('bt_lastView')||'edit';}catch(e){return 'edit';} }
function btSetLastView(v){ try{localStorage.setItem('bt_lastView', v);}catch(e){} }
function btMaybeStart(){
  const seen = localStorage.getItem('bt_firstRunSeen');
  if(!seen){
    localStorage.setItem('bt_firstRunSeen','1');
    if (typeof openEditPopup === 'function') openEditPopup(new Date());
    return;
  }
  const last = btGetLastView();
  if(last==='edit'){ if (typeof openEditPopup === 'function') openEditPopup(new Date()); }
  else if (typeof showMonthView === 'function') showMonthView();
}
(function(){
  const _o = window.openEditPopup;
  if(typeof _o === 'function'){
    window.openEditPopup = function(dt){ btSetLastView('edit'); return _o.apply(this, arguments); };
  }
  const _m = window.showMonthView;
  if(typeof _m === 'function'){
    window.showMonthView = function(){ btSetLastView('month'); return _m.apply(this, arguments); };
  }
})();


// === Version Stempel ===
function __bt_hhmm(){const d=new Date();return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');}
document.addEventListener('DOMContentLoaded',()=>{ try{ const el=document.getElementById('appVersion'); if(el) el.textContent='ChatGPT_edit_Ver3.0_'+__bt_hhmm(); }catch(e){} });

    /* === Version === */
    const APP_VERSION_BASE = 'ChatGPT5_edit_Vers1.4_';
    function pad(n){ return n<10 ? '0'+n : ''+n; }
    function currentHHMM(){
      const d = new Date();
      return pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    /* === State === */
    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let dayData = {};
    let editingDate = null;
    let storageWorking = false;
    let neutralDaysSetting = 'ignore';
    let godMode = false;
    let autoReclass = false;
    let nudgesEnabled = false;
    let unit = 'ml'; // ml | L

    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    const weekdays   = ['Mo','Di','Mi','Do','Fr','Sa','So'];

    const formatDateKey = (date)=> `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
    const formatDisplayDate = (date)=> `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    // Helpers: kompatibel mit altem & neuem Format
    const getDayStatus  = (key) => dayData[key] ? (typeof dayData[key]==='string' ? dayData[key] : dayData[key].status) : null;
    const getDayComment = (key) => (dayData[key] && typeof dayData[key]==='object' && dayData[key].comment) ? dayData[key].comment : '';
    const getDayExtra   = (key) => (dayData[key] && typeof dayData[key]==='object') ? dayData[key] : null;

    const setDayData = (key, status, comment = '', extra = {}) => {
      dayData[key] = { status, comment, ...extra };
    };

    /* === Storage === */
    function testStorage(){ try{ localStorage.setItem('__test__','1'); localStorage.removeItem('__test__'); storageWorking = true; }catch{ storageWorking=false; } }
    function updateStorageStatus(message){
      const status = document.getElementById('storageStatus');
      const count  = document.getElementById('savedDaysCount');
      if(status) status.textContent = message ?? '';
      if(count)  count.textContent  = Object.keys(dayData).length;
    }
    function saveData(){
      if(!storageWorking){ updateStorageStatus('‚ùå Speichern nicht m√∂glich'); return false; }
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        updateStorageStatus('‚úÖ Daten gespeichert'); return true;
      }catch{ updateStorageStatus('‚ùå Speicher‚ÄëFehler'); return false; }
    }
    function loadData(){
      if(!storageWorking){ updateStorageStatus('‚ö†Ô∏è Kein persistenter Speicher'); return; }
      try{
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        currentInputDate = new Date();
        // Settings laden
        const savedA = localStorage.getItem('alcoholTrackerSettings');
        const savedB = localStorage.getItem('boozeTrackerSettings'); // Backwards compat
        let settings = {};
        try{ if(savedA) settings = JSON.parse(savedA) || {}; }catch{}
        try{ if(savedB) settings = { ...settings, ...(JSON.parse(savedB)||{}) }; }catch{}
        neutralDaysSetting = settings.neutralDays || 'ignore';
        godMode = !!settings.godMode;
        autoReclass = !!settings.autoReclass;
        nudgesEnabled = !!settings.nudgesEnabled;
        updateStorageStatus(`‚úÖ ${Object.keys(dayData).length} Tage geladen`);
      }catch{
        dayData = {}; currentInputDate = new Date(); updateStorageStatus('‚ùå Laden fehlgeschlagen');
      }
    }

    /* === Init UI === */
    function initApp(){
      document.getElementById('appVersion').textContent = APP_VERSION_BASE + currentHHMM();
      document.getElementById('appVersion2').textContent = APP_VERSION_BASE + currentHHMM();
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      const godSection = document.getElementById('godSection');
      const godBadge = document.getElementById('godBadge');
      godSection.style.display = godMode ? 'block':'none';
      godSection.setAttribute('aria-hidden', godMode ? 'false' : 'true');
      if(godMode){ godBadge.classList.add('active'); } else { godBadge.classList.remove('active'); }
      // Quick‚ÄëSelect Optionen auff√ºllen
      const qs033 = document.getElementById('qsBeer033');
      const qs05  = document.getElementById('qsBeer05');
      for(let i=1;i<=20;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); qs033.appendChild(o); }
      for(let i=1;i<=10;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); qs05.appendChild(o); }
      // Radio‚ÄëEnable
      document.querySelectorAll('input[name="dayChoice"]').forEach(r=>{
        r.addEventListener('change', ()=> document.getElementById('submitDay').disabled = false);
      });
      // Einheit Toggle
      document.getElementById('unitMl').addEventListener('click', ()=>setUnit('ml'));
      document.getElementById('unitL').addEventListener('click', ()=>setUnit('L'));
      document.getElementById('editUnitMl').addEventListener('click', ()=>setEditUnit('ml'));
      document.getElementById('editUnitL').addEventListener('click', ()=>setEditUnit('L'));
      // God‚ÄëListeners
      ['godDrinkType','godBeerSize','godVolumePerPortion','godPortions','godWeedGrams','godWeedFreq','godDidSport'].forEach(id=>{
        const el=document.getElementById(id); if(el){ el.addEventListener('input', recalcGod); el.addEventListener('change', recalcGod); }
      });
      document.getElementById('qsBeer033').addEventListener('change', onQuickSelect033);
      document.getElementById('qsBeer05').addEventListener('change', onQuickSelect05);
      document.getElementById('godSuggest').addEventListener('click', applySuggestedCategory);
      document.getElementById('godSaveDetails').addEventListener('click', saveGodDetailsOnly);
      // Submit
      document.getElementById('submitDay').addEventListener('click', submitDay);
      // Analysis toggle
      document.getElementById('analysisToggle').addEventListener('click', ()=>{
        const box = document.getElementById('analysisBox');
        box.style.display = box.style.display==='none'?'block':'none';
        if(box.style.display==='block'){ renderAdvancedAnalysis(); }
      });
      // Calendar initial
      buildMonthGrid();
      calculateSuccessRate();
      calculateStreak();
      // Nudges
      scheduleNudgesIfEnabled();
    }

    function setUnit(u){
      unit = u;
      document.getElementById('unitMl').classList.toggle('active', u==='ml');
      document.getElementById('unitL').classList.toggle('active', u==='L');
      recalcGod();
    }
    function setEditUnit(u){
      document.getElementById('editUnitMl').classList.toggle('active', u==='ml');
      document.getElementById('editUnitL').classList.toggle('active', u==='L');
      recalcEditGod();
    }

    /* === Quick‚ÄëSelects === */
    function onQuickSelect033(e){
      const n = parseInt(e.target.value||'0',10); if(!n){return;}
      document.getElementById('godDrinkType').value = 'beer';
      document.getElementById('godBeerSize').value = '0.33';
      setUnit('ml');
      document.getElementById('godVolumePerPortion').value = 330;
      document.getElementById('godPortions').value = n;
      recalcGod(true);
    }
    function onQuickSelect05(e){
      const n = parseInt(e.target.value||'0',10); if(!n){return;}
      document.getElementById('godDrinkType').value = 'beer';
      document.getElementById('godBeerSize').value = '0.5';
      setUnit('ml');
      document.getElementById('godVolumePerPortion').value = 500;
      document.getElementById('godPortions').value = n;
      recalcGod(true);
    }

    /* === Rechenlogik Alkohol === */
    function computeGrams(volumeInput, portions, typeEl, beerSizeEl, volumeUnit){
      const portionsNum = Math.max(0, Number(portions)||0);
      let volMl = Math.max(0, Number(volumeInput)||0);
      if(volumeUnit==='L'){ volMl *= 1000; }
      const typeElAbv = typeEl ? (parseFloat(typeEl.selectedOptions[0].dataset.abv)||0) : 0;
      // Wenn "Bier" ausgew√§hlt: Volumen pro Portion = Flaschengr√∂√üe
      if(typeEl && typeEl.value==='beer' && beerSizeEl){
        const bottle = parseFloat(beerSizeEl.value||'0.5');
        volMl = bottle*1000;
      }
      const volL = volMl/1000;
      const grams = volL * (typeElAbv/100) * 0.789 * 1000 * portionsNum;
      return Math.max(0, Math.round(grams));
    }

    function recalcGod(fromQuick){
      const grams = computeGrams(
        document.getElementById('godVolumePerPortion').value,
        document.getElementById('godPortions').value,
        document.getElementById('godDrinkType'),
        document.getElementById('godBeerSize'),
        unit
      );
      document.getElementById('godGrams').textContent = grams;
      document.getElementById('godDrinks').textContent = Math.round(grams/10);
      if(autoReclass){ autoClassifyByGrams(grams); }
      if(fromQuick && autoReclass){ showAutoClassInfo('Schnellwahl √ºbernommen & Kategorie angepasst.'); }
    }

    function showAutoClassInfo(msg){
      const el = document.getElementById('autoClassInfo');
      el.textContent = '‚Ñπ ' + msg;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 3000);
    }

    function applySuggestedCategory(){
      const grams = parseInt(document.getElementById('godGrams').textContent||'0',10);
      autoClassifyByGrams(grams, true);
    }

    function autoClassifyByGrams(grams, forceInfo){
      // Mapping: 0 ‚Üí sober/supertag (mit Sport), <=20 ‚Üí moderate, >20 && Sport ‚Üí mixed, >40 ‚Üí alcohol
      let target = null;
      const sport = document.getElementById('godDidSport').checked;
      if(grams===0){ target = sport ? 'superday' : 'sober'; }
      else if(grams<=20){ target = 'moderate'; }
      else if(grams>0 && sport && grams<=40){ target = 'mixed'; }
      else if(grams>40){ target = 'alcohol'; }
      if(target){
        const radio = document.querySelector(`input[name="dayChoice"][value="${target}"]`);
        if(radio){ radio.checked = true; document.getElementById('submitDay').disabled = false; }
        if(forceInfo){ showAutoClassInfo(`Kategorie automatisch auf ‚Äû${labelFor(target)}‚Äú gesetzt.`); }
      }
    }
    function labelFor(v){
      return v==='superday'?'Supertag':v==='wellness'?'Wellness':v==='sober'?'Alkoholfrei':v==='moderate'?'Moderat':v==='mixed'?'Schadensbegrenzung':'Alkohol';
    }

    function saveGodDetailsOnly(){
      const key = formatDateKey(currentInputDate);
      const comment = (document.getElementById('dayCommentInput').value||'').trim();
      const extra = collectGodExtraFromInputs();
      const status = getSelectedStatus() || getDayStatus(key) || 'sober';
      setDayData(key, status, comment, extra);
      saveData();
      showAutoClassInfo('Detaillierte Angaben gespeichert.');
    }

    function collectGodExtraFromInputs(){
      const type = document.getElementById('godDrinkType').value;
      const abv  = parseFloat(document.getElementById('godDrinkType').selectedOptions[0].dataset.abv||'0');
      const size = document.getElementById('godBeerSize').value;
      const volume = Number(document.getElementById('godVolumePerPortion').value||0);
      const portions = Number(document.getElementById('godPortions').value||0);
      const sport = !!document.getElementById('godDidSport').checked;
      const weed = Number(document.getElementById('godWeedGrams').value||0);
      const weedF = document.getElementById('godWeedFreq').value;
      const grams = parseInt(document.getElementById('godGrams').textContent||'0',10);
      return { alcohol:{ type, abv, volume, portions, size, grams }, sport, marijuana:{ grams:weed, freq:weedF } };
    }

    function getSelectedStatus(){
      const r = document.querySelector('input[name="dayChoice"]:checked');
      return r ? r.value : null;
    }

    /* === Submit Day === */
    function submitDay(){
      const key = formatDateKey(currentInputDate);
      const status = getSelectedStatus();
      const comment = (document.getElementById('dayCommentInput').value||'').trim();
      if(!status){
        updateStorageStatus('‚ö†Ô∏è Bitte eine Kategorie w√§hlen.');
        return;
      }
      let extra = {};
      if(godMode){
        extra = collectGodExtraFromInputs();
      }
      setDayData(key, status, comment, extra);
      saveData();
      // Reset
      document.querySelectorAll('input[name="dayChoice"]').forEach(r=> r.checked=false);
      document.getElementById('submitDay').disabled = true;
      // Info
      updateStorageStatus('‚úÖ Tag gespeichert');
    }

    /* === Monat / Erfolg / Streak === */
    function setSuccessCardTint(pct){
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if(pct < 50)      card.classList.add('rate-bad');
      else if(pct < 75) card.classList.add('rate-warn');
      else              card.classList.add('rate-good');
    }
    function calculateSuccessRate(){
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      let total=0, max=0;
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const key = formatDateKey(new Date(y,m,d));
        const st = getDayStatus(key);
        if(!st) continue;
        max += 1;
        if(st==='superday') total += 1.0;
        else if(st==='wellness') total += 0.9;
        else if(st==='sober') total += 0.75;
        else if(st==='moderate') total += 0.4;
        else if(st==='mixed') total += 0.25;
      }
      const pct = max>0 ? Math.round((total/max)*100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      setSuccessCardTint(pct);
    }

    function isGreen(state){ return state==='sober' || state==='superday' || state==='wellness'; }
    function setStreakCardTint(streak){
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      if(streak >= 30)      card.classList.add('streak-great');
      else if(streak >= 21) card.classList.add('streak-good');
      else if(streak >= 11) card.classList.add('streak-warn');
      else if(streak >= 1)  card.classList.add('streak-bad');
      numEl.textContent = String(streak) + (streak>=30 ? ' üéâ' : '');
    }
    function calculateStreak(){
      let probe = new Date();
      let streak = 0;
      while(true){
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if(isGreen(st)){ streak++; probe.setDate(probe.getDate()-1); }
        else { break; }
        if(streak > 1000) break;
      }
      setStreakCardTint(streak);
    }

    /* === Kalender === */
    function buildMonthGrid(){
      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';
      const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;
      weekdays.forEach(w => { const el = document.createElement('div'); el.className='weekday'; el.textContent = w; grid.appendChild(el); });
      const firstDay = new Date(y, m, 1);
      let start = (firstDay.getDay()+6)%7; // Mo=0
      for(let i=0;i<start;i++){ const d=document.createElement('div'); d.style.visibility='hidden'; grid.appendChild(d); }
      const last = new Date(y, m+1, 0).getDate();
      for(let d=1; d<=last; d++){
        const key = formatDateKey(new Date(y,m,d));
        const st = getDayStatus(key);
        const cell = document.createElement('div');
        cell.className = 'day ' + (st||'');
        cell.textContent = String(d);
        if(!st){ cell.style.opacity = 0.75; }
        // Tooltip Kommentar
        const comment = getDayComment(key);
        if(comment){
          cell.classList.add('has-comment');
          const tip = document.createElement('div'); tip.className='day-comment-tooltip'; tip.textContent = comment; cell.appendChild(tip);
        }
        // Heute markieren
        const today = new Date();
        if(d===today.getDate() && m===today.getMonth() && y===today.getFullYear()){ cell.classList.add('today'); }
        cell.addEventListener('click', ()=> openEditPopup(new Date(y,m,d)));
        grid.appendChild(cell);
      }
    }
    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); buildMonthGrid(); calculateSuccessRate(); }
    function nextMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()+1); buildMonthGrid(); calculateSuccessRate(); }

    /* === Edit Popup === */
    function openEditPopup(date){
      editingDate = date;
      document.getElementById('editDate').textContent = formatDisplayDate(editingDate);
      // Kommentar vorf√ºllen
      const key = formatDateKey(editingDate);
      document.getElementById('editCommentInput').value = getDayComment(key);
      // God‚ÄëDetails sichtbar?
      const sec = document.getElementById('editGodSection');
      sec.style.display = godMode ? 'block' : 'none';
      // Details f√ºllen
      if(godMode){
        fillEditGodFromData(key);
        recalcEditGod();
      }
      document.getElementById('editPopup').classList.add('active');
    }
    function closeEditPopup(){ document.getElementById('editPopup').classList.remove('active'); editingDate=null; }
    function saveEditComment(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const v = dayData[key];
      const c = (document.getElementById('editCommentInput').value||'').trim();
      if(v && typeof v==='object'){ v.comment = c; } else if(typeof v==='string'){ dayData[key]={status:v, comment:c}; } else { dayData[key]={status:'sober', comment:c}; }
      saveData();
      buildMonthGrid();
      updateStorageStatus('‚úçÔ∏è Kommentar gespeichert');
    }

    function fillEditGodFromData(key){
      const v = getDayExtra(key) || {};
      const alc = (v.alcohol||{});
      (document.getElementById('editDrinkType')).value = alc.type || 'beer';
      (document.getElementById('editBeerSize')).value  = alc.size || '0.5';
      (document.getElementById('editVolumePerPortion')).value = alc.volume || 500;
      (document.getElementById('editPortions')).value = alc.portions || 0;
      (document.getElementById('editDidSport')).checked = !!v.sport;
      (document.getElementById('editWeedGrams')).value = (v.marijuana && v.marijuana.grams) ? v.marijuana.grams : 0;
      (document.getElementById('editWeedFreq')).value  = (v.marijuana && v.marijuana.freq) ? v.marijuana.freq : 'einmalig';
    }

    function recalcEditGod(){
      if(!editingDate) return;
      const grams = computeGrams(
        document.getElementById('editVolumePerPortion').value,
        document.getElementById('editPortions').value,
        document.getElementById('editDrinkType'),
        document.getElementById('editBeerSize'),
        document.getElementById('editUnitMl').classList.contains('active')?'ml':'L'
      );
      document.getElementById('editGrams').textContent = grams;
      document.getElementById('editDrinks').textContent = Math.round(grams/10);
      // Persistiere Live (nur God‚ÄëModus)
      const key = formatDateKey(editingDate);
      const base = getDayExtra(key) || {};
      const status = getDayStatus(key) || 'sober';
      const extra = {
        alcohol:{
          type: document.getElementById('editDrinkType').value,
          abv: parseFloat(document.getElementById('editDrinkType').selectedOptions[0].dataset.abv||'0'),
          size: document.getElementById('editBeerSize').value,
          volume: Number(document.getElementById('editVolumePerPortion').value||0),
          portions: Number(document.getElementById('editPortions').value||0),
          grams: grams
        },
        sport: !!document.getElementById('editDidSport').checked,
        marijuana: { grams: Number(document.getElementById('editWeedGrams').value||0), freq: document.getElementById('editWeedFreq').value }
      };
      const comment = base.comment||'';
      setDayData(key, status, comment, extra);
      saveData();
      buildMonthGrid();
    }

    function updateDay(newStatus){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      if(newStatus==='delete'){
        delete dayData[key];
        saveData();
        buildMonthGrid();
        closeEditPopup();
        return;
      }
      // Kategorie + Kommentar + (evtl. God‚ÄëDetails) zusammen speichern, ohne Popup auto zu schlie√üen
      const v = getDayExtra(key)||{};
      const comment = document.getElementById('editCommentInput').value||'';
      setDayData(key, newStatus, comment, v);
      saveData();
      buildMonthGrid();
      updateStorageStatus('‚úÖ Tag aktualisiert');
    }

    function showMonthView(){
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      buildMonthGrid(); calculateSuccessRate(); calculateStreak();
    }

    /* === Export/Import/Reset === */
    function exportData(){
      const blob = new Blob([JSON.stringify(dayData, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'booze-tracker-backup.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importData(){
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const obj = JSON.parse(String(reader.result||'{}'));
            // Merge
            for(const k of Object.keys(obj||{})){ dayData[k] = obj[k]; }
            saveData(); buildMonthGrid(); calculateSuccessRate(); calculateStreak();
            updateStorageStatus('‚úÖ Import erfolgreich');
          }catch{ updateStorageStatus('‚ùå Import fehlgeschlagen'); }
        };
        reader.readAsText(file);
      };
      inp.click();
    }
    function resetStorage(){
      if(!confirm('Wirklich ALLES l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.')) return;
      localStorage.removeItem('alcoholTrackerData');
      localStorage.removeItem('alcoholTrackerSettings');
      localStorage.removeItem('boozeTrackerSettings');
      dayData = {}; saveData(); buildMonthGrid(); calculateSuccessRate(); calculateStreak();
      updateStorageStatus('üßπ Zur√ºckgesetzt');
    }

    /* === Settings === */
    function toggleSettingsPopup(){
      const ov = document.getElementById('settingsOverlay');
      const po = document.getElementById('settingsPopup');
      const isOpen = po.classList.toggle('active');
      ov.classList.toggle('active', isOpen);
      if(isOpen){
        // F√ºllen
        document.getElementById('toggleGodMode').checked = godMode;
        document.getElementById('toggleAutoReclass').checked = autoReclass;
        document.getElementById('toggleNudges').checked = nudgesEnabled;
        document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`).checked = true;
      }
    }
    function saveSettings(){
      godMode = !!document.getElementById('toggleGodMode').checked;
      autoReclass = !!document.getElementById('toggleAutoReclass').checked;
      nudgesEnabled = !!document.getElementById('toggleNudges').checked;
      const nd = document.querySelector('input[name="neutralDays"]:checked');
      neutralDaysSetting = nd ? nd.value : 'ignore';
      const settings = { godMode, neutralDays:neutralDaysSetting, autoReclass, nudgesEnabled };
      localStorage.setItem('alcoholTrackerSettings', JSON.stringify(settings));
      // UI
      const godSection = document.getElementById('godSection');
      const godBadge = document.getElementById('godBadge');
      godSection.style.display = godMode ? 'block':'none';
      godSection.setAttribute('aria-hidden', godMode ? 'false' : 'true');
      if(godMode){ godBadge.classList.add('active'); } else { godBadge.classList.remove('active'); }
      toggleSettingsPopup();
      updateStorageStatus('‚úÖ Einstellungen gespeichert');
      scheduleNudgesIfEnabled();
    }

    /* === Chart / Assessment === */
    function calculate100DaysChart(){
      let negative = 0;
      let positive = 0;
      const today = new Date();
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = getDayStatus(formatDateKey(probe));
        if(st === 'alcohol' || st === 'mixed' || st === 'moderate'){ negative++; }
        else if(st === 'sober' || st === 'wellness' || st === 'superday'){ positive++; }
      }
      const negPct = Math.round((negative / 100) * 100);
      const posPct = Math.round((positive / 100) * 100);
      setTimeout(() => {
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 50);
    }

    function calculateHealthAssessment(){
      const today = new Date();
      let counts = { superday:0, wellness:0, sober:0, moderate:0, mixed:0, alcohol:0, empty:0 };
      const last100Days = [];
      for(let i=0; i<100; i++){
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const key = formatDateKey(probe);
        const st  = getDayStatus(key);
        last100Days.push(st || null);
        if(st && counts[st] !== undefined) counts[st]++; else if(!st) counts.empty++;
      }
      const enteredDays = 100 - counts.empty;
      let divisor = 100, neutralWeight = 0;
      if(neutralDaysSetting === 'ignore'){ divisor = enteredDays || 1; }
      else if(neutralDaysSetting === 'neutral'){ neutralWeight = 0.5; }
      else if(neutralDaysSetting === 'negative'){ neutralWeight = 0.3; }
      else if(neutralDaysSetting === 'very-negative'){ neutralWeight = 0.15; }

      const afCount = counts.superday + counts.wellness + counts.sober;
      const afQuote = afCount / divisor;

      const weightedScore = (
        counts.superday * 1.0 +
        counts.wellness * 0.9 +
        counts.sober * 0.75 +
        counts.moderate * 0.4 +
        counts.mixed * 0.25 +
        counts.alcohol * 0.0 +
        counts.empty * neutralWeight
      ) / 100;

      const bingeProximity = counts.alcohol + counts.mixed;
      const bingeQuote = bingeProximity / divisor;

      let maxCluster = 0, currentCluster = 0;
      for(const st of last100Days){
        if(st === 'alcohol' || st === 'mixed'){ currentCluster++; maxCluster = Math.max(maxCluster, currentCluster); }
        else { currentCluster = 0; }
      }

      let label, badgeClass, description, warning, suggestAudit=false;
      if(bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10)){
        label='üö® Sucht‚ÄëAlarm: Rote Lampen!'; badgeClass='red'; description='<strong>Sehr hohes Risiko</strong> ‚Äì N√§he zu h√§ufigen Rauschlagen.'; warning='üÜò Bitte professionelle Hilfe erw√§gen.'; suggestAudit=true;
      } else if((bingeProximity >= 20 && bingeProximity < 40) || (afQuote < 0.30 && afQuote >= 0.20) || (bingeQuote >= 0.20 && enteredDays >= 10)){
        label='üé≤ Risiko‚ÄëRoulette'; badgeClass='red'; description='<strong>Hohes Risiko</strong> ‚Äì Kritische Muster erkennbar.'; warning='üö® Gespr√§ch/Screening empfohlen.'; suggestAudit=true;
      } else if(afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)){
        label='üö® Kipppunkt‚ÄëKandidat'; badgeClass='weekend'; description='Erh√∂htes Risiko ‚Äì Schwelle erreicht.'; suggestAudit=true;
      } else if(afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12){
        label='üßò Balance‚ÄëBuddha'; badgeClass='balance'; description='Moderates Risiko.';
      } else { label='ü¶∏ Leber‚ÄëSuperheld'; badgeClass='zen'; description='Niedriges Risiko.'; }

      const afDisplay = neutralDaysSetting === 'ignore' ? `${Math.round(afQuote*100)}% (${afCount}/${enteredDays})` : `${Math.round(afQuote*100)}%`;
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore*100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? `${bingeProximity} (${Math.round(bingeQuote*100)}%)` : bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster>0 ? `${maxCluster} Tage` : 'Keiner';

      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label; badge.className = 'assessment-badge ' + badgeClass;
      document.getElementById('assessmentDescription').innerHTML = description;
      const warnEl = document.getElementById('assessmentWarning');
      if(suggestAudit){ warnEl.style.display='block'; warnEl.textContent = warning; document.getElementById('auditSuggestion').style.display='block'; }
      else{ warnEl.style.display='none'; document.getElementById('auditSuggestion').style.display='none'; }
    }

    /* === Risiko-Features, Scores & Vorhersage === */
    function gramsForDate(key){
      const v = dayData[key];
      if(v && typeof v==='object' && v.alcohol && typeof v.alcohol.grams==='number') return v.alcohol.grams;
      const st = getDayStatus(key);
      if(st==='moderate') return 20;
      if(st==='mixed')    return 40;
      if(st==='alcohol')  return 50;
      return 0;
    }
    function seriesLastNDays(n){
      const today = new Date();
      const arr = [];
      for(let i=0;i<n;i++){
        const d = new Date(today); d.setDate(d.getDate()-i);
        arr.push({ key: `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`, date: d, grams: gramsForDate(`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`) });
      }
      return arr.reverse();
    }
    function slope(arr){
      const n = arr.length;
      if(n<3) return 0;
      let sx=0, sy=0, sxy=0, sxx=0;
      for(let i=0;i<n;i++){ const x=i, y=arr[i].grams; sx+=x; sy+=y; sxy+=x*y; sxx+=x*x; }
      const m = (n*sxy - sx*sy) / Math.max((n*sxx - sx*sx), 1e-6);
      return m;
    }
    function std(arr){
      const n=arr.length; if(n===0) return 0;
      const mean = arr.reduce((a,b)=>a+b,0)/n;
      const v = arr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n;
      return Math.sqrt(v);
    }
    const wdi = d => (d.getDay()+6)%7;

    const COMMENT_FLAGS = [
      {re:/feier|party|geburtstag|abschluss|oktoberfest/i, weight:+0.10, tag:'Feier'},
      {re:/stress|√§rger|streit|deadline|druck/i,         weight:+0.08, tag:'Stress'},
      {re:/schlaf\s*(\d+)\s*h/i,                        weight:(m)=> (parseInt(m[1],10)<6?+0.06:0), tag:'Schlaf<6h'}
    ];
    function commentRisk(key){
      const v = dayData[key];
      if(!v || typeof v!=='object' || !v.comment) return {delta:0,tags:[]};
      let delta=0, tags=[];
      for(const f of COMMENT_FLAGS){
        const m = v.comment.match(f.re);
        if(m){ const w = (typeof f.weight==='function')? f.weight(m): f.weight; delta+=w; tags.push(f.tag); }
      }
      return {delta: Math.min(delta, 0.2), tags};
    }

    function computeFeatures(){
      const s7 = seriesLastNDays(7),  s14 = seriesLastNDays(14), s30 = seriesLastNDays(30), s100 = seriesLastNDays(100);
      const avg7   = s7.reduce((a,b)=>a+b.grams,0)/Math.max(s7.length,1);
      const avg30  = s30.reduce((a,b)=>a+b.grams,0)/Math.max(s30.length,1);
      const vol14  = std(s14.map(x=>x.grams));
      const trend30 = slope(s30);
      let binge=0, cluster=0, cur=0, weekendHigh=0, weekendTot=0;
      for(const x of s100){
        if(x.grams>=40) binge++;
        if(x.grams>=20){ cur++; cluster = Math.max(cluster, cur); } else cur=0;
        const dow = wdi(x.date);
        if(dow===4 || dow===5){ weekendTot++; if(x.grams>=40) weekendHigh++; }
      }
      const weekendBias = weekendTot? weekendHigh/weekendTot : 0;
      let dualUse=0;
      const windowA = s30.filter(x=>x.grams>0);
      for(const x of windowA){
        const v = dayData[x.key];
        if(v && v.marijuana && v.marijuana.grams>0) dualUse++;
      }
      const used = s100.filter(x=>x.grams>0).map(x=>x.grams);
      const median = arr => { const t=[...arr].sort((a,b)=>a-b); const m=Math.floor(t.length/2); return t.length? (t.length%2?t[m]:(t[m-1]+t[m])/2):0; };
      const tol = (used.length>=20) ? (median(used.slice(0,10)) - median(used.slice(-10))) : 0;
      return { avg7, avg30, vol14, trend30, binge, cluster, weekendBias, dualUse, toleranceCreep: (tol< -5) };
    }

    function riskAssessment(){
      const f = computeFeatures();
      let qty=100;
      const drinksPerWeek = (f.avg7/10)*7;
      if(drinksPerWeek<=1) qty=100;
      else if(drinksPerWeek<=2) qty=80;
      else if(drinksPerWeek<=4) qty=60;
      else if(drinksPerWeek<=8) qty=30;
      else qty=0;
      qty += (f.trend30<0?+8: (f.trend30>0? -8:0));
      qty = Math.max(0, Math.min(100, qty));

      let pattern=90;
      if(f.binge>30 || f.cluster>7) pattern=0;
      else if(f.binge>15 || f.cluster>5) pattern=40;
      else if(f.binge>5  || f.cluster>3) pattern=70;
      if(f.weekendBias>=0.4) pattern -= 8;
      if(f.vol14>=25) pattern -= 6;
      pattern = Math.max(0, Math.min(100, pattern));

      let ctx=90;
      if(f.dualUse>=3) ctx -= 10;
      if(f.toleranceCreep) ctx -= 10;
      ctx = Math.max(0, Math.min(100, ctx));

      const total = Math.round(0.5*qty + 0.35*pattern + 0.15*ctx);

      let stage = 'Stufe 2: Balance‚ÄëK√ºnstler';
      if(total>=90) stage='Stufe 1: Zen‚ÄëMeister';
      else if(total>=65) stage='Stufe 2: Balance‚ÄëK√ºnstler';
      else if(total>=45) stage='Stufe 3: Kipppunkt‚ÄëWanderer';
      else if(total>=25) stage='Stufe 4: Risiko‚ÄëJongleur';
      else stage='Stufe 5: Alarmstufe Rot';

      const subtypes=[];
      if(f.weekendBias>=0.4) subtypes.push('Weekend‚ÄëBinger');
      if(f.binge>=1 && f.avg30<5) subtypes.push('Abstinenz mit Slips');
      if(f.cluster>=3) subtypes.push('Cluster‚ÄëRider');
      if(f.dualUse>=3) subtypes.push('Coupling (Alkohol+THC)');
      if(f.toleranceCreep) subtypes.push('Tolerance‚ÄëCreep');
      const s100 = seriesLastNDays(100);
      if((f.avg7<=20) && s100.filter(x=>x.grams>0).length>=50) subtypes.push('Daily‚ÄëLow');

      return { total, stage, subtypes, features:f };
    }

    function predict7Days(){
      const cats = ['superday','wellness','sober','moderate','mixed','alcohol'];
      const idx  = Object.fromEntries(cats.map((c,i)=>[c,i]));
      const M = Array.from({length:cats.length},()=>Array(cats.length).fill(1e-3));
      const today = new Date();
      let prev = null;
      for(let i=180;i>=1;i--){
        const d  = new Date(today); d.setDate(d.getDate()-i);
        const k  = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        const st = getDayStatus(k);
        if(!st) continue;
        if(prev!=null){ M[idx[prev]][idx[st]] += 1; }
        prev = st;
      }
      for(let r=0;r<M.length;r++){
        const s = M[r].reduce((a,b)=>a+b,0); for(let c=0;c<M[r].length;c++) M[r][c] /= s;
      }
      let start = getDayStatus(`${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`) || prev || 'sober';
      const out=[];
      let state = start;
      for(let h=1; h<=7; h++){
        const d  = new Date(today); d.setDate(d.getDate()+h);
        const dow = wdi(d);
        const row = M[idx[state]];
        let pHigh = row[idx['moderate']] + row[idx['mixed']] + row[idx['alcohol']];
        if(dow===4 || dow===5) pHigh += 0.10; else if(dow===0) pHigh -= 0.10;
        pHigh = Math.max(0, Math.min(1, pHigh));
        out.push({date:d, risk: Math.round(pHigh*100), explain:`${state} ‚ûú ${Math.round(pHigh*100)}% (Wochentag‚ÄëFaktor ${dow===4||dow===5?'+10%':dow===0?'-10%':'¬±0'})`});
        const nextIdx = row.indexOf(Math.max(...row));
        state = cats[nextIdx];
      }
      return out;
    }

    function renderAdvancedAnalysis(){
      const ra = riskAssessment();
      const fx = predict7Days();
      const list = document.getElementById('godMetricsList');
      list.innerHTML = `<div style="margin:8px 0;"><strong>${ra.stage}</strong> ¬∑ Score ${ra.total}/100<br>${ra.subtypes.length?'üß© '+ra.subtypes.join(', '):''}</div>` +
        `<div style="margin-top:10px;"><strong>7‚ÄëTage‚ÄëRisiko‚ÄëPrognose</strong><br>`+
        fx.map(x=>`${x.date.toLocaleDateString('de-DE',{weekday:'short'})}: ${x.risk}% <span class="mini-badge">${x.explain}</span>`).join('<br>')+
        `</div>`;
    }

    /* === Chart Popup Toggle === */
    function toggleChartPopup(){
      const ov = document.getElementById('chartOverlay');
      const po = document.getElementById('chartPopup');
      const isOpen = po.style.display !== 'block';
      po.style.display = isOpen ? 'block' : 'none';
      ov.style.display = isOpen ? 'block' : 'none';
      if(isOpen){ calculate100DaysChart(); calculateHealthAssessment(); renderAdvancedAnalysis(); }
    }

    /* === AUDIT === */
    function openAudit(){ document.getElementById('auditOverlay').style.display='block'; document.getElementById('auditPopup').style.display='block'; }
    function closeAudit(){ document.getElementById('auditOverlay').style.display='none'; document.getElementById('auditPopup').style.display='none'; }
    function calculateAuditScore(){
      const q1 = Number((document.querySelector('input[name="auditQ1"]:checked')||{}).value||0);
      const q2 = Number((document.querySelector('input[name="auditQ2"]:checked')||{}).value||0);
      const q3 = Number((document.querySelector('input[name="auditQ3"]:checked')||{}).value||0);
      const total = q1+q2+q3;
      const gender = (document.getElementById('auditGender').value)||'male';
      const cutoff = (gender==='female') ? 3 : 4;
      const res = document.getElementById('auditResult');
      res.style.display='block';
      res.innerHTML = `AUDIT‚ÄëC: <strong>${total}</strong> Punkte. ${ total>=cutoff ? '‚ö†Ô∏è Auff√§llig ‚Äì vertiefendes Gespr√§ch/Screening empfohlen.' : '‚úÖ Unauff√§llig.' }`;
    }

    /* === Nudges === */
    function scheduleNudgesIfEnabled(){
      if(!nudgesEnabled){ return; }
      // Einfaches Scheduling: In 1 Minute testen & dann t√§glich gegen 17:00
      setTimeout(checkForecastNudge, 60*1000);
      scheduleDailyAt17(checkForecastNudge);
      scheduleRelapseFirewall();
      scheduleFridayStreakReminder();
    }
    function scheduleDailyAt17(fn){
      const now = new Date();
      const next = new Date();
      next.setHours(17,0,0,0);
      if(next.getTime() <= now.getTime()){ next.setDate(next.getDate()+1); }
      const delay = next.getTime() - now.getTime();
      setTimeout(()=>{ fn(); scheduleDailyAt17(fn); }, delay);
    }
    function checkForecastNudge(){
      const fx = predict7Days();
      if(!fx || !fx.length) return;
      const tmr = fx[0];
      if(tmr.risk>35){ miniPopup(`üîÆ Morgen erh√∂htes Risiko (${tmr.risk}%). Wenn‚Äëdann‚ÄëPlan setzen?`); }
    }
    function scheduleRelapseFirewall(){
      // Checke alle 6h
      setInterval(()=>{
        let bad=0;
        for(let i=0;i<2;i++){
          const d = new Date(); d.setDate(d.getDate()-i);
          const st = getDayStatus(formatDateKey(d));
          if(st==='alcohol' || st==='mixed'){ bad++; }
        }
        if(bad>=2){ miniPopup('üõ°Ô∏è Zwei schwere Tage in Folge. Dritten Tag vermeiden: Ziel setzen (AF‚ÄëTag, Spaziergang, 0,0‚ÄØ% kaltstellen).'); }
      }, 6*60*60*1000);
    }
    function scheduleFridayStreakReminder(){
      setInterval(()=>{
        const d=new Date(); const dow=(d.getDay()+6)%7;
        if(dow===4){ // Freitag
          const st = getDayStatus(formatDateKey(new Date()));
          if(isGreen(st)){ miniPopup('üîî Streak sichern: Plan f√ºr Freitagabend? AF‚ÄëGetr√§nk bereitstellen.'); }
        }
      }, 3*60*60*1000);
    }
    function miniPopup(text){
      const pop = document.createElement('div');
      pop.style.position='fixed'; pop.style.right='16px'; pop.style.bottom='16px';
      pop.style.background='#111827'; pop.style.color='#e5e7eb'; pop.style.padding='12px 14px';
      pop.style.borderRadius='12px'; pop.style.boxShadow='0 10px 24px rgba(0,0,0,.35)'; pop.style.zIndex='1200';
      pop.style.maxWidth='320px'; pop.style.fontSize='13px'; pop.textContent = text;
      document.body.appendChild(pop);
      setTimeout(()=>{ pop.remove(); }, 7000);
    }

    /* === Month/Edit plumbing in view switch === */
    function showDayInput(){
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
    }

    /* === Bootstrap === */
    window.addEventListener('load', ()=>{
      testStorage(); loadData(); initApp();
    });
  </script>
<script>
// === Robust Export/Import Override (nicht-invasiv) ===
(function(){
  function exportDataSafe(){
    try{
      const payload = { dayData: (window.dayData||{}), settings: JSON.parse(localStorage.getItem('alcoholTrackerSettings')||'{}') };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'booze-tracker-backup.json'; a.click();
      URL.revokeObjectURL(url);
      alert('‚úÖ Export abgeschlossen.');
    }catch(e){ console.error(e); alert('‚ùå Export fehlgeschlagen.'); }
  }
  function importDataSafe(){
    const input = document.createElement('input');
    input.type='file'; input.accept='.json,application/json';
    input.onchange = (e)=>{
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const parsed = JSON.parse(ev.target.result);
          const clean = (typeof validateImported==='function') ? validateImported(parsed) : parsed;
          if(!clean || !clean.dayData) throw new Error('Kein dayData gefunden');
          window.dayData = Object.assign({}, window.dayData||{}, clean.dayData);
          try{ localStorage.setItem('alcoholTrackerData', JSON.stringify(window.dayData)); }catch{}
          if(clean.settings){
            try{ localStorage.setItem('alcoholTrackerSettings', JSON.stringify(clean.settings)); }catch{}
          }
          alert('‚úÖ Import erfolgreich. Lade neu ‚Ä¶');
          location.reload();
        }catch(err){ console.error(err); alert('‚ùå Ung√ºltige Datei.'); }
      };
      reader.readAsText(file);
    };
    input.click();
  }
  window.exportData = exportDataSafe;
  window.importData = importDataSafe;
})();
</script><script>
// === Weed-UI: nur sichtbar, wenn Checkbox aktiv ===
document.addEventListener('DOMContentLoaded', ()=>{
  function installWeedToggle(prefix){
    const grams = document.getElementById(prefix+'WeedGrams');
    const freq  = document.getElementById(prefix+'WeedFreq');
    if(!grams || !freq) return;
    const wrapper = document.createElement('div');
    wrapper.className = 'weed-wrap';
    grams.parentElement.insertAdjacentElement('beforebegin', wrapper);
    wrapper.appendChild(grams.parentElement);
    wrapper.appendChild(freq.parentElement);
    const cb = document.createElement('label');
    cb.style.display='flex'; cb.style.alignItems='center'; cb.style.gap='6px'; cb.style.margin='6px 0';
    const input = document.createElement('input'); input.type='checkbox'; input.id=prefix+'WeedOn';
    const span = document.createElement('span'); span.textContent='Cannabis eintragen';
    cb.appendChild(input); cb.appendChild(span);
    wrapper.parentElement.insertBefore(cb, wrapper);
    function sync(){
      const on = input.checked;
      wrapper.style.display = on ? 'block':'none';
    }
    input.addEventListener('change', sync);
    // auto-on if there are non-zero values/freq set
    const hasData = (parseFloat(grams.value||'0')>0) || (freq.value && freq.value!=='nie');
    input.checked = hasData;
    sync();
  }
  installWeedToggle('god');
  installWeedToggle('edit');
});
</script><script>
// === Settings: Sections collapsible ===
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.settings-section-title').forEach(h=>{
    h.style.cursor='pointer';
    const caret = document.createElement('span');
    caret.textContent='‚ñæ';
    caret.style.marginLeft='6px'; caret.style.fontSize='12px'; caret.className='caret';
    h.appendChild(caret);
    let body = h.nextElementSibling;
    if(!body) return;
    body.style.display='none';
    h.addEventListener('click', ()=>{
      const open = (body.style.display!=='none');
      body.style.display = open ? 'none' : 'block';
      caret.textContent = open ? '‚ñæ' : '‚ñ¥';
    });
  });
});
</script></body>
</html>
