<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }
    .app-version{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 10px;
    }

    /* === EINGABE === */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 6px 0 18px;
    }

    /* Kategorie-Auswahl */
    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 15px;
      position:relative;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }
    .choice-option.selected{ border-color: var(--primary); background: #f0f4ff; }
    
    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
    }
    .choice-option.hangover{ border-color: #d4d4d8; background: #fafafa; }
    
    .choice-label{ flex:1; }
    .choice-desc{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .choice-warning{
      display:none;
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:4px;
      padding:6px 8px;
      background:#fff7ed;
      border:1px solid #fb923c;
      border-radius:8px;
      font-size:11px;
      color:#9a3412;
      z-index:10;
    }
    .choice-option.warning-active .choice-warning{ display:block; }

    /* God-Modus Detail-Eingabe */
    .god-section{
      margin-top: 16px;
      padding:16px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      display:none;
    }
    .god-section.active{ display:block; }
    
    .god-header{
      font-weight:800;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    /* Getr√§nke-Liste */
    .drinks-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:12px;
    }
    
    .drink-item{
      background:white;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
      position:relative;
    }
    
    .drink-remove{
      position:absolute;
      top:8px;
      right:8px;
      background:#fee;
      border:1px solid #fcc;
      border-radius:50%;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:14px;
      color:#dc2626;
    }
    .drink-remove:hover{ background:#fcc; }
    
    .drink-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    @media (max-width:560px){ .drink-row{ grid-template-columns: 1fr; } }
    
    .drink-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    
    .drink-label{
      font-size:12px;
      font-weight:600;
      color:var(--text);
    }
    
    .drink-select, .drink-input{
      padding:8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
      background:white;
      font-family:inherit;
    }
    
    .drink-summary{
      font-size:12px;
      color:var(--muted);
      padding-top:8px;
      border-top:1px solid #e5e7eb;
    }
    
    .btn-add-drink{
      width:100%;
      padding:10px;
      background:#f0f4ff;
      border:1px dashed var(--primary);
      border-radius:8px;
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
      font-size:14px;
    }
    .btn-add-drink:hover{ background:#e0e7ff; }
    
    /* Checkboxen-Grid */
    .checkboxes-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin:12px 0;
    }
    @media (max-width:560px){ .checkboxes-grid{ grid-template-columns:1fr; } }
    
    .checkbox-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      background:white;
      border:1px solid #e5e7eb;
      border-radius:8px;
    }
    .checkbox-item input[type="checkbox"]{
      transform:scale(1.2);
      accent-color:var(--primary);
    }
    .checkbox-item label{
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    
    /* Live-Berechnung */
    .live-calc{
      margin-top:12px;
      padding:12px;
      background:white;
      border:1px solid #e5e7eb;
      border-radius:10px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      text-align:center;
    }
    .live-calc-item{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .live-calc-value{
      font-size:24px;
      font-weight:800;
      color:var(--text);
    }
    .live-calc-label{
      font-size:11px;
      color:var(--muted);
    }
    .live-calc-suggest{
      grid-column:1/-1;
      padding:8px;
      background:#f0f9ff;
      border-radius:6px;
      font-size:12px;
      color:#0c4a6e;
    }
    
    /* Buttons */
    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* === MONATS√úBERSICHT === */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Kalender */
    .legend{ display:flex; flex-wrap:wrap; gap:10px 14px; margin:10px 0 14px; color:var(--muted); font-size:13px; }
    .legend span{ display:flex; align-items:center; gap:6px; }

    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:10px; position:relative; }
    .weekday{ text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0; background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6; }

    .day{
      aspect-ratio:1;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      border:1px solid #e7eef6;
      background:#fff;
      font-weight:700;
      cursor:pointer;
      transition:.1s ease;
      position:relative;
      z-index:1;
      user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"üíö"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"‚ù§Ô∏è"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"‚≠ê"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.hangover{ background:#71717a; color:#fff; }
    .day.hangover::after{ content:"üòµ"; position:absolute; top:2px; right:4px; font-size:10px; }

    .day.today{ outline: 3px solid var(--primary); outline-offset:-3px; }

    /* Kommentar-Tooltip */
    .day-comment-tooltip{
      display:none;
      position:absolute;
      bottom:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      min-width:200px;
      max-width:280px;
      padding:10px 12px;
      background:#1f2937;
      color:white;
      border-radius:8px;
      font-size:11px;
      line-height:1.5;
      z-index:1000;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      text-align:left;
      font-weight:400;
      pointer-events:none;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .day-comment-tooltip::after{
      content:'';
      position:absolute;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      border:6px solid transparent;
      border-top-color:#1f2937;
    }
    .day.has-comment{ position:relative; }
    .day.has-comment::before{ content:'üí¨'; position:absolute; top:2px; left:2px; font-size:10px; opacity:.8; }
    .day.has-comment:hover .day-comment-tooltip{ display:block; }
    
    /* Mobile: Tap um Tooltip zu zeigen */
    @media (max-width:640px){
      .day.has-comment.tooltip-active .day-comment-tooltip{ display:block; }
    }

    /* Chart-Popup */
    .chart-popup-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      z-index:1001;
    }
    .chart-popup-overlay.active{ display:block; }
    
    .chart-popup{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px;
      width:min(720px,92vw);
      max-height:85vh;
      overflow-y:auto;
      display:none;
      z-index:1002;
    }
    .chart-popup.active{ display:block; }

    .chart-section{ margin:18px 0; }
    .chart-title{ font-weight:700; font-size:18px; margin-bottom:24px; text-align:center; color:var(--text); }
    .chart-bars{ display:flex; flex-direction:column; gap:32px; margin-bottom:10px; }
    .chart-bar-container{ display:flex; flex-direction:column; gap:12px; }
    .chart-bar-header{ display:flex; align-items:center; justify-content:space-between; }
    .chart-bar-label{ font-size:14px; font-weight:600; color:var(--text); }
    .chart-bar-label small{ display:block; font-size:12px; font-weight:400; color:var(--muted); margin-top:2px; }
    .chart-bar-value{ display:flex; align-items:baseline; gap:8px; }
    .chart-bar-number{ font-size:32px; font-weight:900; color:var(--text); }
    .chart-bar-percent{ font-size:16px; font-weight:600; color:var(--muted); }
    .chart-bar-wrapper{ height:48px; background:#f1f5f9; border-radius:12px; position:relative; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05); }
    .chart-bar{ height:100%; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); width:0%; border-radius:12px; display:flex; align-items:center; justify-content:flex-end; padding-right:16px; font-weight:700; color:white; font-size:16px; position:relative; }
    .chart-bar::after{ content:''; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0)); border-radius:12px; }
    .chart-bar.negative{ background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .chart-bar.positive{ background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    /* Health Assessment */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{ font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--text); }
    .assessment-badge{
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      border-radius: 12px;
      font-size: 22px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .assessment-badge.zen{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border: 2px solid #34d399; }
    .assessment-badge.balance{ background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #fbbf24; }
    .assessment-badge.weekend{ background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; border: 2px solid #fb923c; }
    .assessment-badge.red{ background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border: 2px solid #ef4444; }

    .assessment-metrics{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    @media (max-width:560px){ .assessment-metrics{ grid-template-columns:1fr; } }
    .metric-item{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .metric-value{ font-size:20px; font-weight:800; color:var(--text); }
    .assessment-description{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; font-size:13px; line-height:1.6; color:var(--text); }
    .assessment-warning{ margin-top:12px; padding:10px; background:#fff7ed; border-left:4px solid #fb923c; border-radius:6px; font-size:12px; color:#9a3412; }

    /* Detailanalyse Toggle */
    .analysis-advanced{ margin-top: 14px; }
    .analysis-toggle{
      appearance:none;
      background:#f1f5f9;
      border:1px solid #e5e7eb;
      color:#111827;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      width:100%;
    }
    .analysis-toggle:hover{ background:#e2e8f0; }
    .analysis-box{
      display:none;
      margin-top:12px;
      padding:14px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
    }
    .analysis-box.active{ display:block; }

    /* Settings */
    .settings-popup-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:none;
      z-index:1001;
    }
    .settings-popup-overlay.active{ display:block; }
    
    .settings-popup{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px;
      width:min(560px,92vw);
      max-height:85vh;
      overflow-y:auto;
      display:none;
      z-index:1002;
    }
    .settings-popup.active{ display:block; }
    
    .settings-title{ font-size:22px; font-weight:800; margin-bottom:8px; color:var(--text); text-align:center; }
    .settings-subtitle{ font-size:14px; color:var(--muted); margin-bottom:24px; text-align:center; }
    
    .settings-section{
      margin-bottom:20px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:hidden;
    }
    .settings-section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      background:#f9fafb;
      cursor:pointer;
      user-select:none;
    }
    .settings-section-header:hover{ background:#f3f4f6; }
    .settings-section-title{ font-size:16px; font-weight:700; color:var(--text); }
    .settings-section-toggle{
      font-size:18px;
      color:var(--muted);
      transition:transform .2s ease;
    }
    .settings-section.collapsed .settings-section-toggle{ transform:rotate(-90deg); }
    .settings-section-content{
      padding:16px;
      background:white;
      display:block;
    }
    .settings-section.collapsed .settings-section-content{ display:none; }
    
    .settings-description{ font-size:13px; color:var(--muted); margin-bottom:12px; line-height:1.6; }
    .settings-options{ display:flex; flex-direction:column; gap:10px; }
    .settings-option{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:12px;
      border:2px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      transition:all .2s ease;
    }
    .settings-option:hover{ border-color:var(--primary); background:#f8faff; }
    .settings-option.selected{ border-color:var(--primary); background:linear-gradient(135deg,#eef2ff,#f8faff); box-shadow:0 4px 12px rgba(79,70,229,0.15); }
    .settings-option input[type="radio"]{ margin-top:2px; transform:scale(1.3); accent-color:var(--primary); }
    .settings-option-content{ flex:1; }
    .settings-option-title{ font-weight:700; font-size:14px; color:var(--text); margin-bottom:4px; }
    .settings-option-desc{ font-size:12px; color:var(--muted); line-height:1.5; }

    /* Buttons f√ºr Settings/Stats */
    .btn-stats-toggle, .btn-settings{
      appearance:none;
      background:linear-gradient(135deg,#eef2ff,#e0e7ff);
      border:1.5px solid #c7d2fe;
      color:#1e3a8a;
      padding:10px 18px;
      border-radius:999px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease;
      box-shadow:0 6px 14px rgba(79,70,229,.18);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-stats-toggle:hover, .btn-settings:hover{
      background:linear-gradient(135deg,#e0e7ff,#c7d2fe);
      border-color:#a5b4fc;
      transform:translateY(-1px);
      box-shadow:0 10px 20px rgba(79,70,229,.25);
    }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px 0 6px; }
    .month-title{ font-weight:800; font-size:20px; }
    .month-top-nav{ display:flex; gap:10px; justify-content:center; margin:8px 0 14px; }
    .month-top-nav .btn{ width:auto; min-width:140px; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }

    /* Support */
    .support{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      text-align:center;
    }
    .support p{ margin:0 0 6px; }
    .support-buttons{ margin-top:0; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <!-- === TAG-EINGABE VIEW === -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion"></div>

      <div class="current-date" id="currentDateDisplay"></div>

      <!-- Kategorie-Auswahl mit Beschreibungen -->
      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday" data-value="superday">
          <input type="radio" name="dayChoice" value="superday" />
          <div class="choice-label">
            <div>‚≠ê Supertag</div>
            <div class="choice-desc">Kein Alkohol + Sport</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option wellness" data-value="wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <div class="choice-label">
            <div>üíö Wellness</div>
            <div class="choice-desc">Kein Alkohol + Gesundheit (Sauna, Yoga)</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option sober" data-value="sober">
          <input type="radio" name="dayChoice" value="sober" />
          <div class="choice-label">
            <div>üü¢ Alkoholfrei</div>
            <div class="choice-desc">Kein Alkohol getrunken</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option moderate" data-value="moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <div class="choice-label">
            <div>üü° Moderat</div>
            <div class="choice-desc">Wenig Alkohol (‚â§20g) - auch mit Sport ok üëü</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option mixed" data-value="mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <div class="choice-label">
            <div>‚ù§Ô∏è Schadensbegrenzung</div>
            <div class="choice-desc">Selbstbetrug = Sport + feiern (21-60g)</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option alcohol" data-value="alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <div class="choice-label">
            <div>üî¥ Alkohol</div>
            <div class="choice-desc">Viel Alkohol getrunken (>20g)</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option hangover" data-value="hangover">
          <input type="radio" name="dayChoice" value="hangover" />
          <div class="choice-label">
            <div>üòµ Katertag</div>
            <div class="choice-desc">Totalabsturz / Hangover (mit/ohne Weiter-Alkohol)</div>
          </div>
          <div class="choice-warning">‚ö†Ô∏è Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
      </div>

      <!-- Kommentar -->
      <div style="margin-top: 16px;">
        <label for="dayCommentInput" style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          üí¨ Kommentar (optional):
        </label>
        <textarea 
          id="dayCommentInput" 
          placeholder="Notizen zum Tag (z.B. Anlass, Gef√ºhle, Situation)..."
          style="width:100%; min-height:80px; resize:vertical; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:13px; font-family:inherit;"
        ></textarea>
      </div>

      <!-- God-Modus Bereich -->
      <div id="godSection" class="god-section">
        <div class="god-header">
          <span>üß† Detaillierte Eingabe</span>
          <button id="godToggleBtn" class="btn secondary" style="width:auto; height:32px; padding:0 12px; font-size:12px;">Ausblenden</button>
        </div>

        <!-- Getr√§nke-Liste -->
        <div class="drinks-list" id="drinksList">
          <!-- Wird dynamisch bef√ºllt -->
        </div>

        <button class="btn-add-drink" id="addDrinkBtn">+ Weiteres Getr√§nk hinzuf√ºgen</button>

        <!-- Checkboxen -->
        <div class="checkboxes-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="checkSport">
            <label for="checkSport">üèÉ‚Äç‚ôÇÔ∏è Sport gemacht</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkDope">
            <label for="checkDope">üåø Marijuana konsumiert</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkCrash">
            <label for="checkCrash">üí• Totalabsturz</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkHangover">
            <label for="checkHangover">üòµ Katertag</label>
          </div>
        </div>

        <!-- Dope Details (nur wenn aktiviert) -->
        <div id="dopeDetails" style="display:none; margin-top:12px; padding:12px; background:white; border:1px solid #e5e7eb; border-radius:8px;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="drink-field">
              <label class="drink-label">Menge (g)</label>
              <input type="number" id="dopeGrams" class="drink-input" min="0" step="0.1" placeholder="z.B. 0.5">
            </div>
            <div class="drink-field">
              <label class="drink-label">H√§ufigkeit</label>
              <select id="dopeFreq" class="drink-select">
                <option value="einmalig">einmalig</option>
                <option value="mehrmals">mehrmals am Tag</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Live-Berechnung -->
        <div class="live-calc">
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveGrams">0</div>
            <div class="live-calc-label">Gramm Alkohol</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveDrinks">0.0</div>
            <div class="live-calc-label">Drinks (√† 10g)</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveBAC">0.0‚Ä∞</div>
            <div class="live-calc-label">√ò Promille (gesch√§tzt)</div>
          </div>
          <div class="live-calc-suggest" id="liveSuggest">
            üí° Vorschlag: <strong id="suggestedCat">‚Äî</strong>
          </div>
        </div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn">Tag speichern</button>
      </div>

      <div class="storage-info" id="storageInfo">
        üç∑ Gespeicherte Tage: <span id="savedDaysCount">0</span> ¬∑
        <span id="storageStatus">Lade‚Ä¶</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
    </div>

    <!-- === MONATS√úBERSICHT VIEW === -->
    <div id="monthView" class="view">
      <h1>üìä Ralles wunderbarer Booze-Tracker</h1>
      <div class="app-version" id="appVersion2"></div>

      <div class="month-head">
        <div class="month-title" id="monthHeader">‚Äî</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">‚Üê Vorheriger</button>
        <button class="btn" onclick="currentMonth()">üìÖ Heute</button>
        <button class="btn" onclick="nextMonth()">N√§chster ‚Üí</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">√ò Gesundheitsscore</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>‚≠ê Supertag</span>
        <span>üíö Wellness</span>
        <span>üü¢ Alkoholfrei</span>
        <span>üü° Moderat (üëü = mit Sport)</span>
        <span>‚ù§Ô∏è Schadensbegrenzung</span>
        <span>üî¥ Alkohol</span>
        <span>üòµ Katertag (‚ö†Ô∏è = mit Weiter-Alkohol)</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <div style="text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">üìä 100-Tage-Statistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">‚öôÔ∏è Einstellungen</button>
      </div>

      <section class="support">
        <p><strong>Findest du diese App n√ºtzlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons">
          <a href="https://www.buymeacoffee.com/rduwenbecky">
            <img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir 'n Kaffee!&emoji=‚òï&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" style="height:48px;" />
          </a>
        </div>
      </section>
    </div>

    <!-- === CHART POPUP === -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup">
      <div class="chart-section">
        <div class="chart-title">üìä Letzte 100 Tage im √úberblick</div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üî¥ Unter 50%
                <small>Alkohol, Schadensbegrenzung, Moderat, Katertag</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative"></div>
            </div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                üü¢ √úber 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Health Assessment -->
      <div class="health-assessment">
        <div class="assessment-title">üéØ Deine Gesundheitseinsch√§tzung</div>
        <div class="assessment-badge" id="assessmentBadge"></div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">AF-Quote (alkoholfrei)</div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Gewichtete Gesundheit</div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Binge-N√§he (Hochrisiko)</div>
            <div class="metric-value" id="metricBinge">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">L√§ngster Cluster</div>
            <div class="metric-value" id="metricCluster">0</div>
          </div>
        </div>

        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning" style="display:none;"></div>

        <!-- Detailanalyse -->
        <div class="analysis-advanced">
          <button id="analysisToggle" class="analysis-toggle">üîç Detaillierte Analyse anzeigen</button>
          <div id="analysisBox" class="analysis-box">
            <div style="font-weight:800; margin-bottom:8px;">Feinere Analyse</div>
            <div id="godMetricsList" style="font-size:13px; line-height:1.7;"></div>
          </div>
        </div>
      </div>

      <button class="btn secondary" style="margin-top: 24px; width: 100%;" onclick="toggleChartPopup()">Schlie√üen</button>
    </div>

    <!-- === SETTINGS POPUP === -->
    <div class="settings-popup-overlay" id="settingsOverlay" onclick="toggleSettingsPopup()"></div>
    <div id="settingsPopup" class="settings-popup">
      <div class="settings-title">‚öôÔ∏è Einstellungen</div>
      <div class="settings-subtitle">Passe die Bewertung an deine Bed√ºrfnisse an</div>

      <!-- God-Modus Section -->
      <div class="settings-section" id="settingsGodMode">
        <div class="settings-section-header" onclick="toggleSettingsSection('settingsGodMode')">
          <div class="settings-section-title">üß† God-Modus</div>
          <div class="settings-section-toggle">‚ñº</div>
        </div>
        <div class="settings-section-content">
          <div class="settings-description">
            Aktiviere detaillierte Eingaben (Getr√§nke, Mengen, Sport, Checkboxen).
          </div>
          <label style="display:flex; align-items:center; gap:12px;">
            <input id="toggleGodMode" type="checkbox">
            <span><strong>God-Modus aktivieren</strong></span>
          </label>
        </div>
      </div>

      <!-- Neutrale Tage Section -->
      <div class="settings-section" id="settingsNeutralDays">
        <div class="settings-section-header" onclick="toggleSettingsSection('settingsNeutralDays')">
          <div class="settings-section-title">üéØ Neutrale Tage</div>
          <div class="settings-section-toggle">‚ñº</div>
        </div>
        <div class="settings-section-content">
          <div class="settings-description">
            Wie sollen nicht eingetragene Tage in die Statistik einflie√üen?
          </div>
          <div class="settings-options">
            <label class="settings-option" id="option-ignore">
              <input type="radio" name="neutralDays" value="ignore" checked>
              <div class="settings-option-content">
                <div class="settings-option-title">üéØ Ignorieren (Empfohlen)</div>
                <div class="settings-option-desc">Nur eingetragene Tage z√§hlen.</div>
              </div>
            </label>
            <label class="settings-option" id="option-neutral">
              <input type="radio" name="neutralDays" value="neutral">
              <div class="settings-option-content">
                <div class="settings-option-title">‚öñÔ∏è Als neutral werten</div>
                <div class="settings-option-desc">Neutral ‚âà 50% Gesundheit.</div>
              </div>
            </label>
            <label class="settings-option" id="option-negative">
              <input type="radio" name="neutralDays" value="negative">
              <div class="settings-option-content">
                <div class="settings-option-title">‚ö†Ô∏è Eher negativ</div>
                <div class="settings-option-desc">‚âà 30% Gesundheit.</div>
              </div>
            </label>
            <label class="settings-option" id="option-very-negative">
              <input type="radio" name="neutralDays" value="very-negative">
              <div class="settings-option-content">
                <div class="settings-option-title">üö® Sehr negativ</div>
                <div class="settings-option-desc">‚âà 15% Gesundheit.</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Backup Section -->
      <div class="settings-section collapsed" id="settingsBackup">
        <div class="settings-section-header" onclick="toggleSettingsSection('settingsBackup')">
          <div class="settings-section-title">üóÑÔ∏è Daten-Backup</div>
          <div class="settings-section-toggle">‚ñº</div>
        </div>
        <div class="settings-section-content">
          <div class="settings-description">
            Export/Import bleibt 100% lokal im Browser.
          </div>
          <div class="submit-row">
            <button class="btn secondary" onclick="exportData()">üì§ Exportieren</button>
            <button class="btn secondary" onclick="importData()">üì• Importieren</button>
          </div>
        </div>
      </div>

      <!-- Speicher l√∂schen Section -->
      <div class="settings-section collapsed" id="settingsReset">
        <div class="settings-section-header" onclick="toggleSettingsSection('settingsReset')">
          <div class="settings-section-title">üßπ Speicher l√∂schen</div>
          <div class="settings-section-toggle">‚ñº</div>
        </div>
        <div class="settings-section-content">
          <div class="settings-description">
            Setzt alle Tage & Einstellungen zur√ºck. Erst exportieren!
          </div>
          <button class="btn danger" onclick="resetStorage()">üßπ Lokalen Speicher l√∂schen</button>
        </div>
      </div>

      <button class="btn" style="width: 100%; margin-top:16px;" onclick="saveSettings()">Einstellungen speichern</button>
    </div>

    <footer>¬© 2025 by R. Duwenbeck</footer>
  </div>

  <script>
    /* ========================================
       GLOBALE VARIABLEN & KONFIGURATION
    ======================================== */
    const APP_VERSION = 'Optimized_v2.0';
    
    let dayData = {};
    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let storageWorking = false;
    let neutralDaysSetting = 'ignore';
    let godMode = false;
    
    const DENSITY = 0.789; // g/ml f√ºr Ethanol
    const DRINK_UNIT = 10; // 1 Drink = 10g Alkohol (DE Standard)
    
    // Getr√§nke-Datenbank mit typischen Mengen
    const DRINKS_DB = {
      beer: {
        name: 'Bier',
        abv: 5,
        portions: [
          {label: 'Flasche klein (0,33l)', ml: 330},
          {label: 'Flasche gro√ü (0,5l)', ml: 500},
          {label: 'Ma√ü (1l)', ml: 1000},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      radler: {
        name: 'Radler / Biermischgetr√§nk',
        abv: 2.5,
        portions: [
          {label: 'Flasche (0,33l)', ml: 330},
          {label: 'Flasche (0,5l)', ml: 500},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      wine: {
        name: 'Wein',
        abv: 12,
        portions: [
          {label: 'Glas klein (100ml)', ml: 100},
          {label: 'Glas standard (150ml)', ml: 150},
          {label: 'Glas gro√ü (200ml)', ml: 200},
          {label: 'Flasche (750ml)', ml: 750},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      champagne: {
        name: 'Sekt / Champagner',
        abv: 11,
        portions: [
          {label: 'Glas (100ml)', ml: 100},
          {label: 'Flasche (750ml)', ml: 750},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      liquor: {
        name: 'Lik√∂r',
        abv: 15,
        portions: [
          {label: 'Shot (20ml)', ml: 20},
          {label: 'Glas (50ml)', ml: 50},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      spirit: {
        name: 'Spirituosen (Vodka, Whisky, etc.)',
        abv: 40,
        portions: [
          {label: 'Shot (20ml)', ml: 20},
          {label: 'Doppel-Shot (40ml)', ml: 40},
          {label: 'Glas (50ml)', ml: 50},
          {label: 'Eigene Menge', ml: 0}
        ]
      },
      cocktail: {
        name: 'Cocktail',
        abv: 15,
        portions: [
          {label: 'Standard (200ml)', ml: 200},
          {label: 'Long Drink (300ml)', ml: 300},
          {label: 'Eigene Menge', ml: 0}
        ]
      }
    };

    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    
    /* ========================================
       HELPER FUNCTIONS
    ======================================== */
    const pad = (n) => n < 10 ? '0' + n : '' + n;
    const formatDateKey = (date) => `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
    const formatDisplayDate = (date) => `${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
    
    const getDayStatus = (key) => {
      const entry = dayData[key];
      if (!entry) return null;
      return typeof entry === 'string' ? entry : entry.status;
    };
    
    const getDayComment = (key) => {
      const entry = dayData[key];
      return (entry && typeof entry === 'object' && entry.comment) ? entry.comment : '';
    };

    /* ========================================
       STORAGE & MIGRATION
    ======================================== */
    function testStorage() {
      try {
        localStorage.setItem('__test__', '1');
        localStorage.removeItem('__test__');
        storageWorking = true;
      } catch {
        storageWorking = false;
      }
    }

    function updateStorageStatus(message) {
      const status = document.getElementById('storageStatus');
      const count = document.getElementById('savedDaysCount');
      if (status) status.textContent = message ?? '';
      if (count) count.textContent = Object.keys(dayData).length;
    }

    function migrateData() {
      // Migration 1: Date-Keys normieren
      const schemaVersion = localStorage.getItem('alcoholTrackerSchemaVersion') || '0';
      if (schemaVersion === '0') {
        const newData = {};
        for (const key of Object.keys(dayData)) {
          const parts = key.split('-').map(n => parseInt(n, 10));
          if (parts.length !== 3) {
            newData[key] = dayData[key];
            continue;
          }
          const [y, m, d] = parts;
          const normalizedKey = `${y}-${pad(m)}-${pad(d)}`;
          newData[normalizedKey] = dayData[key];
        }
        dayData = newData;
        localStorage.setItem('alcoholTrackerSchemaVersion', '1');
      }

      // Migration 2: String-Eintr√§ge zu Objekten
      for (const key of Object.keys(dayData)) {
        if (typeof dayData[key] === 'string') {
          dayData[key] = {
            status: dayData[key],
            comment: ''
          };
        }
      }
    }

    function saveData() {
      if (!storageWorking) {
        updateStorageStatus('‚ùå Speichern nicht m√∂glich');
        return false;
      }
      try {
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        updateStorageStatus('‚úÖ Daten gespeichert');
        return true;
      } catch {
        updateStorageStatus('‚ùå Speicher-Fehler');
        return false;
      }
    }

    function loadData() {
      if (!storageWorking) {
        updateStorageStatus('‚ö†Ô∏è Kein persistenter Speicher');
        return;
      }
      try {
        const savedData = localStorage.getItem('alcoholTrackerData');
        dayData = savedData && savedData !== 'null' ? JSON.parse(savedData) : {};
        
        // Settings laden
        const settings = JSON.parse(localStorage.getItem('alcoholTrackerSettings') || '{}');
        neutralDaysSetting = settings.neutralDays || 'ignore';
        godMode = !!settings.godMode;

        migrateData();
        updateStorageStatus(`‚úÖ ${Object.keys(dayData).length} Tage geladen`);
      } catch {
        dayData = {};
        updateStorageStatus('‚ùå Laden fehlgeschlagen');
      }
    }

    function exportData() {
      try {
        const settings = {
          neutralDays: neutralDaysSetting,
          godMode
        };
        const payload = {
          type: 'booze-tracker-backup',
          version: 2,
          exportedAt: new Date().toISOString(),
          dayData,
          settings
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `booze-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert('‚úÖ Export abgeschlossen.');
      } catch (e) {
        console.error(e);
        alert('‚ùå Export fehlgeschlagen.');
      }
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const parsed = JSON.parse(ev.target.result);
            let importedDayData = parsed.dayData || parsed;
            let importedSettings = parsed.settings || {};

            // Validierung & Merge
            const isDateKey = k => /^\d{4}-\d{1,2}-\d{1,2}$/.test(k);
            const validEntries = {};
            
            Object.keys(importedDayData).forEach(k => {
              if (isDateKey(k)) {
                const v = importedDayData[k];
                if (typeof v === 'string') {
                  validEntries[k] = {status: v, comment: ''};
                } else if (v && typeof v === 'object' && v.status) {
                  validEntries[k] = {...v};
                }
              }
            });

            dayData = {...dayData, ...validEntries};
            
            if (importedSettings.neutralDays) neutralDaysSetting = importedSettings.neutralDays;
            if (typeof importedSettings.godMode === 'boolean') godMode = importedSettings.godMode;

            saveData();
            alert('‚úÖ Daten importiert.');
            location.reload();
          } catch (err) {
            console.error(err);
            alert('‚ùå Ung√ºltige Datei.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function resetStorage() {
      if (!confirm('‚ö†Ô∏è Wirklich ALLE lokalen Daten l√∂schen? Vorher exportieren!')) return;
      try {
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerSettings');
        localStorage.removeItem('alcoholTrackerSchemaVersion');
      } catch (e) {
        console.warn('Bereinigung fehlgeschlagen:', e);
      }
      location.reload();
    }

    /* ========================================
       GOD-MODUS: GETR√ÑNKE-VERWALTUNG
    ======================================== */
    let drinksCounter = 0;
    let activeDrinks = [];

    function addDrink(data = null) {
      drinksCounter++;
      const drinkId = `drink-${drinksCounter}`;
      
      const drink = {
        id: drinkId,
        type: data?.type || 'beer',
        portionIndex: data?.portionIndex || 0,
        customMl: data?.customMl || 0,
        units: data?.units || 1
      };
      
      activeDrinks.push(drink);
      renderDrinkItem(drink);
      updateLiveCalc();
    }

    function renderDrinkItem(drink) {
      const container = document.getElementById('drinksList');
      const drinkData = DRINKS_DB[drink.type];
      
      const div = document.createElement('div');
      div.className = 'drink-item';
      div.id = drink.id;
      
      // Portion-Options generieren
      let portionOptions = '';
      drinkData.portions.forEach((p, idx) => {
        portionOptions += `<option value="${idx}" ${idx === drink.portionIndex ? 'selected' : ''}>${p.label}</option>`;
      });
      
      // Units-Options (1-20)
      let unitOptions = '';
      for (let i = 1; i <= 20; i++) {
        unitOptions += `<option value="${i}" ${i === drink.units ? 'selected' : ''}>${i}x</option>`;
      }
      
      const selectedPortion = drinkData.portions[drink.portionIndex];
      const showCustom = selectedPortion.ml === 0;
      
      div.innerHTML = `
        <div class="drink-remove" onclick="removeDrink('${drink.id}')">√ó</div>
        <div class="drink-row">
          <div class="drink-field">
            <label class="drink-label">Getr√§nk</label>
            <select class="drink-select" data-drink="${drink.id}" data-field="type">
              ${Object.keys(DRINKS_DB).map(key => 
                `<option value="${key}" ${key === drink.type ? 'selected' : ''}>${DRINKS_DB[key].name}</option>`
              ).join('')}
            </select>
          </div>
          <div class="drink-field">
            <label class="drink-label">Menge</label>
            <select class="drink-select" data-drink="${drink.id}" data-field="portion">
              ${portionOptions}
            </select>
          </div>
          <div class="drink-field">
            <label class="drink-label">Anzahl</label>
            <select class="drink-select" data-drink="${drink.id}" data-field="units">
              ${unitOptions}
            </select>
          </div>
        </div>
        <div class="drink-field" style="display:${showCustom ? 'block' : 'none'};" data-custom="${drink.id}">
          <label class="drink-label">Eigene Menge (ml)</label>
          <input type="number" class="drink-input" data-drink="${drink.id}" data-field="custom" 
                 min="0" step="10" value="${drink.customMl}" placeholder="z.B. 330">
        </div>
        <div class="drink-summary">
          <strong>${drinkData.name}</strong> ¬∑ ${drinkData.abv}% Vol ¬∑ 
          <span data-summary="${drink.id}">‚Äî</span>
        </div>
      `;
      
      container.appendChild(div);
      updateDrinkSummary(drink);
    }

    function updateDrinkSummary(drink) {
      const drinkData = DRINKS_DB[drink.type];
      const portion = drinkData.portions[drink.portionIndex];
      const ml = portion.ml === 0 ? drink.customMl : portion.ml;
      const totalMl = ml * drink.units;
      const grams = totalMl * (drinkData.abv / 100) * DENSITY;
      
      const summary = document.querySelector(`[data-summary="${drink.id}"]`);
      if (summary) {
        summary.textContent = `${totalMl}ml gesamt ‚Üí ${Math.round(grams)}g Alkohol`;
      }
    }

    function removeDrink(drinkId) {
      activeDrinks = activeDrinks.filter(d => d.id !== drinkId);
      const elem = document.getElementById(drinkId);
      if (elem) elem.remove();
      updateLiveCalc();
    }

    function updateDrinkFromInput(drinkId, field, value) {
      const drink = activeDrinks.find(d => d.id === drinkId);
      if (!drink) return;
      
      if (field === 'type') {
        drink.type = value;
        drink.portionIndex = 0;
        drink.customMl = 0;
        // Re-render
        const elem = document.getElementById(drinkId);
        elem.remove();
        renderDrinkItem(drink);
      } else if (field === 'portion') {
        drink.portionIndex = parseInt(value);
        const drinkData = DRINKS_DB[drink.type];
        const showCustom = drinkData.portions[drink.portionIndex].ml === 0;
        const customField = document.querySelector(`[data-custom="${drinkId}"]`);
        if (customField) customField.style.display = showCustom ? 'block' : 'none';
        updateDrinkSummary(drink);
      } else if (field === 'units') {
        drink.units = parseInt(value);
        updateDrinkSummary(drink);
      } else if (field === 'custom') {
        drink.customMl = parseFloat(value) || 0;
        updateDrinkSummary(drink);
      }
      
      updateLiveCalc();
    }

    /* ========================================
       LIVE-BERECHNUNG & AUTO-KATEGORIE
    ======================================== */
    function calculateTotalAlcohol() {
      let totalGrams = 0;
      activeDrinks.forEach(drink => {
        const drinkData = DRINKS_DB[drink.type];
        const portion = drinkData.portions[drink.portionIndex];
        const ml = portion.ml === 0 ? drink.customMl : portion.ml;
        const grams = ml * drink.units * (drinkData.abv / 100) * DENSITY;
        totalGrams += grams;
      });
      return Math.round(totalGrams);
    }

    function estimateBAC(grams) {
      // Sehr grobe Sch√§tzung f√ºr 75kg Person, Widmark-Formel
      // BAC = (Alkohol in g) / (K√∂rpergewicht in kg √ó r)
      // r ‚âà 0.68 f√ºr M√§nner, 0.55 f√ºr Frauen
      const weight = 75; // Annahme
      const r = 0.68;
      const bac = grams / (weight * r);
      return Math.max(0, bac).toFixed(1);
    }

    function suggestCategory(grams, sport, crash, hangover) {
      // Korrigierte Auto-Reklassifikation
      if (crash) return 'hangover'; // Totalabsturz = immer Katertag
      if (hangover && grams > 0) return 'hangover'; // Katertag MIT Alkohol = sehr problematisch
      if (hangover && grams === 0) return 'hangover'; // Katertag OHNE Alkohol = normal
      
      if (grams === 0) {
        return sport ? 'superday' : 'sober';
      }
      
      // FIX: Schadensbegrenzung erst ab 21g + Sport
      if (sport && grams >= 21 && grams <= 60) {
        return 'mixed'; // Schadensbegrenzung = Selbstbetrug
      }
      
      if (grams <= 20) {
        return 'moderate'; // Moderat - auch mit Sport!
      }
      
      if (grams > 60) {
        return 'hangover'; // Extreme Menge = wahrscheinlich Totalabsturz
      }
      
      return 'alcohol';
    }

    function updateLiveCalc() {
      const grams = calculateTotalAlcohol();
      const drinks = (grams / DRINK_UNIT).toFixed(1);
      const bac = estimateBAC(grams);
      
      const sport = document.getElementById('checkSport').checked;
      const crash = document.getElementById('checkCrash').checked;
      const hangover = document.getElementById('checkHangover').checked;
      
      const suggested = suggestCategory(grams, sport, crash, hangover);
      
      document.getElementById('liveGrams').textContent = grams;
      document.getElementById('liveDrinks').textContent = drinks;
      document.getElementById('liveBAC').textContent = bac + '‚Ä∞';
      
      const suggestedEl = document.getElementById('suggestedCat');
      const catNames = {
        superday: '‚≠ê Supertag',
        wellness: 'üíö Wellness',
        sober: 'üü¢ Alkoholfrei',
        moderate: 'üü° Moderat',
        mixed: '‚ù§Ô∏è Schadensbegrenzung',
        alcohol: 'üî¥ Alkohol',
        hangover: 'üòµ Katertag'
      };
      suggestedEl.textContent = catNames[suggested] || '‚Äî';
      
      // FIX: Auto-Select des vorgeschlagenen Radio-Buttons
      const suggestedRadio = document.querySelector(`input[name="dayChoice"][value="${suggested}"]`);
      if (suggestedRadio && !suggestedRadio.checked) {
        suggestedRadio.dataset.autoSelected = 'true'; // Markiere als Auto-Select
        suggestedRadio.checked = true;
      }
      
      // Warnungen bei manueller Diskrepanz
      updateCategoryWarnings(suggested);
    }

    function updateCategoryWarnings(suggested) {
      // Nur warnen wenn MANUELL abgewichen
      const selectedRadio = document.querySelector('input[name="dayChoice"]:checked');
      const selected = selectedRadio ? selectedRadio.value : null;
      
      // Wenn suggested nicht √ºbergeben wurde, von aktueller Eingabe ableiten
      if (!suggested && godMode) {
        const grams = calculateTotalAlcohol();
        const sport = document.getElementById('checkSport').checked;
        const crash = document.getElementById('checkCrash').checked;
        const hangover = document.getElementById('checkHangover').checked;
        suggested = suggestCategory(grams, sport, crash, hangover);
      }
      
      document.querySelectorAll('.choice-option').forEach(opt => {
        opt.classList.remove('warning-active');
      });
      
      // Nur warnen wenn Auto-Select vorhanden ist und manuell abgewichen wurde
      if (selected && suggested && selected !== suggested && !selectedRadio.dataset.autoSelected) {
        const opt = document.querySelector(`.choice-option[data-value="${selected}"]`);
        if (opt) opt.classList.add('warning-active');
      }
    }

    /* ========================================
       TAG-EINGABE VIEW
    ======================================== */
    function updateDayInputView() {
      document.getElementById('currentDateDisplay').textContent = formatDisplayDate(currentInputDate);
      updateStorageStatus(`üç∑ ${Object.keys(dayData).length} Tage`);
      
      const key = formatDateKey(currentInputDate);
      const entry = dayData[key];
      
      // Kommentar laden
      document.getElementById('dayCommentInput').value = getDayComment(key);
      
      // God-Modus Sichtbarkeit
      const godSection = document.getElementById('godSection');
      godSection.style.display = godMode ? 'block' : 'none';
      
      const godBtn = document.getElementById('godToggleBtn');
      godBtn.textContent = godMode ? 'Ausblenden' : 'Einblenden';
      
      if (godMode) {
        // Reset Drinks Liste
        activeDrinks = [];
        document.getElementById('drinksList').innerHTML = '';
        
        if (entry && entry.drinks && Array.isArray(entry.drinks)) {
          // Getr√§nke laden
          entry.drinks.forEach(d => addDrink(d));
        } else {
          // FIX: Initial ein leeres Getr√§nk hinzuf√ºgen
          addDrink();
        }
        
        // Checkboxen
        document.getElementById('checkSport').checked = !!entry?.sport;
        document.getElementById('checkDope').checked = !!(entry?.marijuana && entry.marijuana.grams > 0);
        document.getElementById('checkCrash').checked = !!entry?.crash;
        document.getElementById('checkHangover').checked = entry?.status === 'hangover';
        
        // Dope Details
        if (entry?.marijuana) {
          document.getElementById('dopeGrams').value = entry.marijuana.grams || '';
          document.getElementById('dopeFreq').value = entry.marijuana.frequency || 'einmalig';
          document.getElementById('dopeDetails').style.display = 'block';
        } else {
          document.getElementById('dopeDetails').style.display = 'none';
        }
        
        updateLiveCalc();
      }
      
      // Kategorie ausw√§hlen
      const status = getDayStatus(key);
      if (status) {
        const radio = document.querySelector(`input[name="dayChoice"][value="${status}"]`);
        if (radio) {
          radio.checked = true;
          radio.dataset.autoSelected = 'true'; // Markiere als geladen, nicht manuell
        }
      }
    }

    function saveDay() {
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if (!selected) {
        alert('Bitte eine Kategorie w√§hlen.');
        return;
      }
      
      const key = formatDateKey(currentInputDate);
      const comment = document.getElementById('dayCommentInput').value.trim();
      
      const entry = {
        status: selected.value,
        comment
      };
      
      if (godMode) {
        // Getr√§nke speichern
        if (activeDrinks.length > 0) {
          entry.drinks = activeDrinks.map(d => ({
            type: d.type,
            portionIndex: d.portionIndex,
            customMl: d.customMl,
            units: d.units
          }));
          entry.totalAlcohol = calculateTotalAlcohol();
        }
        
        // Checkboxen
        entry.sport = document.getElementById('checkSport').checked;
        entry.crash = document.getElementById('checkCrash').checked;
        
        // Marijuana
        const dopeChecked = document.getElementById('checkDope').checked;
        if (dopeChecked) {
          const grams = parseFloat(document.getElementById('dopeGrams').value) || 0;
          if (grams > 0) {
            entry.marijuana = {
              grams,
              frequency: document.getElementById('dopeFreq').value
            };
          }
        }
      }
      
      dayData[key] = entry;
      saveData();
      
      // Zur√ºcksetzen
      document.getElementById('dayCommentInput').value = '';
      activeDrinks = [];
      document.getElementById('drinksList').innerHTML = '';
      document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
      document.getElementById('dopeDetails').style.display = 'none';
      
      showMonthView();
    }

    /* ========================================
       MONATS√úBERSICHT
    ======================================== */
    function showMonthView() {
      currentViewDate = new Date(currentInputDate);
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
      document.getElementById('appVersion2').textContent = APP_VERSION;
    }

    function showDayInput() {
      document.getElementById('monthView').classList.remove('active');
      document.getElementById('dayInputView').classList.add('active');
      document.getElementById('appVersion').textContent = APP_VERSION;
    }

    function updateMonthView() {
      const y = currentViewDate.getFullYear();
      const m = currentViewDate.getMonth();
      document.getElementById('monthHeader').textContent = `${monthNames[m]} ${y}`;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';
      
      // Weekday headers
      ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(w => {
        const h = document.createElement('div');
        h.className = 'weekday';
        h.textContent = w;
        grid.appendChild(h);
      });

      const first = new Date(y, m, 1);
      const last = new Date(y, m + 1, 0);
      const startDay = (first.getDay() + 6) % 7;

      // Empty cells
      for (let i = 0; i < startDay; i++) {
        const e = document.createElement('div');
        e.className = 'day';
        e.style.visibility = 'hidden';
        grid.appendChild(e);
      }

      const today = new Date();
      for (let d = 1; d <= last.getDate(); d++) {
        const dt = new Date(y, m, d);
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.textContent = d;
        cell.dataset.y = String(y);
        cell.dataset.m = String(m);
        cell.dataset.d = String(d);

        const key = formatDateKey(dt);
        const st = getDayStatus(key);
        const comment = getDayComment(key);
        const entry = dayData[key];

        if (st) cell.classList.add(st);
        if (dt.toDateString() === today.toDateString()) cell.classList.add('today');

        // Sport-Marker bei moderaten Tagen
        if (st === 'moderate' && entry && entry.sport) {
          const sportIcon = document.createElement('span');
          sportIcon.textContent = 'üëü';
          sportIcon.style.cssText = 'position:absolute; bottom:2px; right:2px; font-size:10px;';
          cell.appendChild(sportIcon);
        }
        
        // Katertag-Differenzierung
        if (st === 'hangover' && entry) {
          const hasAlcohol = entry.totalAlcohol && entry.totalAlcohol > 0;
          if (hasAlcohol) {
            // Katertag MIT Alkohol = extrem problematisch
            cell.style.background = '#991b1b'; // Dunkleres Rot
            const warning = document.createElement('span');
            warning.textContent = '‚ö†Ô∏è';
            warning.style.cssText = 'position:absolute; top:2px; left:2px; font-size:10px;';
            cell.appendChild(warning);
          }
          // Ohne Alkohol: normales Grau bleibt
        }

        if (comment) {
          cell.classList.add('has-comment');
          const tooltip = document.createElement('div');
          tooltip.className = 'day-comment-tooltip';
          tooltip.textContent = comment;
          cell.appendChild(tooltip);
        }

        grid.appendChild(cell);
      }
    }

    function previousMonth() {
      currentViewDate.setMonth(currentViewDate.getMonth() - 1);
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    function nextMonth() {
      currentViewDate.setMonth(currentViewDate.getMonth() + 1);
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    function currentMonth() {
      currentViewDate = new Date();
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    /* ========================================
       KALENDER-KLICK (TAG EDITIEREN)
    ======================================== */
    document.addEventListener('click', (e) => {
      const grid = document.getElementById('monthGrid');
      if (!grid || !grid.contains(e.target)) return;
      
      const cell = e.target.closest('.day');
      if (!cell || cell.style.visibility === 'hidden') return;
      
      // Mobile: Toggle Tooltip
      if (window.innerWidth <= 640 && cell.classList.contains('has-comment')) {
        cell.classList.toggle('tooltip-active');
        return;
      }
      
      // Tag zur Eingabe wechseln
      const y = Number(cell.dataset.y);
      const m = Number(cell.dataset.m);
      const d = Number(cell.dataset.d);
      currentInputDate = new Date(y, m, d);
      showDayInput();
      updateDayInputView();
    });

    /* ========================================
       STATISTIKEN & HEALTH ASSESSMENT
    ======================================== */
    function isGreen(state) {
      return state === 'sober' || state === 'superday' || state === 'wellness';
    }

    function calculateStreak() {
      let probe = new Date();
      let streak = 0;
      while (true) {
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        if (isGreen(st)) {
          streak++;
          probe.setDate(probe.getDate() - 1);
        } else {
          break;
        }
        if (streak > 1000) break;
      }
      
      const card = document.getElementById('streakCard');
      const numEl = document.getElementById('streakNumber');
      card.classList.remove('streak-bad','streak-warn','streak-good','streak-great');
      
      if (streak >= 30) card.classList.add('streak-great');
      else if (streak >= 21) card.classList.add('streak-good');
      else if (streak >= 11) card.classList.add('streak-warn');
      else if (streak >= 1) card.classList.add('streak-bad');
      
      numEl.textContent = String(streak) + (streak >= 30 ? ' üéâ' : '');
    }

    function calculateSuccessRate() {
      const y = currentViewDate.getFullYear();
      const m = currentViewDate.getMonth();
      let total = 0, max = 0;
      const last = new Date(y, m + 1, 0).getDate();
      
      for (let d = 1; d <= last; d++) {
        const key = formatDateKey(new Date(y, m, d));
        const st = getDayStatus(key);
        if (!st) continue;
        max += 1;
        
        // Gewichtung
        if (st === 'superday') total += 1.0;
        else if (st === 'wellness') total += 0.9;
        else if (st === 'sober') total += 0.75;
        else if (st === 'moderate') total += 0.4;
        else if (st === 'mixed') total += 0.25;
        else if (st === 'hangover') total += 0.0;
      }
      
      const pct = max > 0 ? Math.round((total / max) * 100) : 0;
      document.getElementById('successRate').textContent = pct + '%';
      
      const card = document.getElementById('successCard');
      card.classList.remove('rate-good','rate-warn','rate-bad');
      if (pct < 50) card.classList.add('rate-bad');
      else if (pct < 75) card.classList.add('rate-warn');
      else card.classList.add('rate-good');
    }

    function calculate100DaysChart() {
      let negative = 0, positive = 0;
      const today = new Date();
      
      for (let i = 0; i < 100; i++) {
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const st = getDayStatus(formatDateKey(probe));
        
        if (st === 'alcohol' || st === 'mixed' || st === 'moderate' || st === 'hangover') {
          negative++;
        } else if (st === 'sober' || st === 'wellness' || st === 'superday') {
          positive++;
        }
      }
      
      const denominator = neutralDaysSetting === 'ignore' ? (positive + negative) || 1 : 100;
      const negPct = Math.round((negative / denominator) * 100);
      const posPct = Math.round((positive / denominator) * 100);
      
      setTimeout(() => {
        document.getElementById('chartNegative').style.width = negPct + '%';
        document.getElementById('chartNegativeNum').textContent = negative;
        document.getElementById('chartNegativePct').textContent = negPct + '%';
        document.getElementById('chartPositive').style.width = posPct + '%';
        document.getElementById('chartPositiveNum').textContent = positive;
        document.getElementById('chartPositivePct').textContent = posPct + '%';
      }, 100);
    }

    function calculateHealthAssessment() {
      const today = new Date();
      let counts = {superday: 0, wellness: 0, sober: 0, moderate: 0, mixed: 0, alcohol: 0, hangover: 0, hangoverWithAlc: 0, empty: 0};
      const last100Days = [];
      
      for (let i = 0; i < 100; i++) {
        const probe = new Date(today);
        probe.setDate(probe.getDate() - i);
        const key = formatDateKey(probe);
        const st = getDayStatus(key);
        const entry = dayData[key];
        
        last100Days.push({st, entry});
        
        if (st && counts[st] !== undefined) {
          counts[st]++;
          
          // Differenziere Katertage
          if (st === 'hangover' && entry && entry.totalAlcohol && entry.totalAlcohol > 0) {
            counts.hangoverWithAlc++;
          }
        } else if (!st) {
          counts.empty++;
        }
      }
      
      const enteredDays = 100 - counts.empty;
      let divisor = 100, neutralWeight = 0;
      
      if (neutralDaysSetting === 'ignore') {
        divisor = enteredDays || 1;
      } else if (neutralDaysSetting === 'neutral') {
        neutralWeight = 0.5;
      } else if (neutralDaysSetting === 'negative') {
        neutralWeight = 0.3;
      } else if (neutralDaysSetting === 'very-negative') {
        neutralWeight = 0.15;
      }
      
      const afCount = counts.superday + counts.wellness + counts.sober;
      const afQuote = afCount / divisor;
      
      // Gewichtete Gesundheitsquote - KORRIGIERT
      const hangoverClean = counts.hangover - counts.hangoverWithAlc; // Katertage OHNE Alkohol
      
      const weightedScore = (
        counts.superday * 1.0 +
        counts.wellness * 0.9 +
        counts.sober * 0.75 +
        counts.moderate * 0.4 +
        counts.mixed * 0.25 +
        counts.alcohol * 0.0 +
        hangoverClean * 0.1 +        // Katertag ohne Alkohol = 10% (leidet, aber trinkt nicht)
        counts.hangoverWithAlc * 0.0 + // Katertag MIT Alkohol = 0% (doppelt problematisch!)
        counts.empty * neutralWeight
      ) / 100;
      
      // Binge-N√§he inkl. problematische Katertage
      const bingeProximity = counts.alcohol + counts.mixed + counts.hangover;
      const bingeQuote = bingeProximity / divisor;
      
      // Cluster-Erkennung
      let maxCluster = 0, currentCluster = 0;
      for (const day of last100Days) {
        if (day.st === 'alcohol' || day.st === 'mixed' || day.st === 'hangover') {
          currentCluster++;
          maxCluster = Math.max(maxCluster, currentCluster);
        } else {
          currentCluster = 0;
        }
      }
      
      let label, badgeClass, description, warning = '';
      
      // Spezial-Warnung bei Katertagen mit Alkohol
      const morningDrinkingWarning = counts.hangoverWithAlc > 0 ? 
        `<br><br>üö® <strong>KRITISCH:</strong> ${counts.hangoverWithAlc} Katertag(e) mit Weiter-Alkohol! Dies ist ein DSM-5-Kriterium f√ºr schwere Alkoholabh√§ngigkeit (morgendliches Trinken zur Linderung). Dringend professionelle Hilfe empfohlen!` : 
        '';
      
      if (bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10) || counts.hangoverWithAlc >= 3) {
        label = 'üö® Sucht-Alarm: Rote Lampen!';
        badgeClass = 'red';
        description = '<strong>Sehr hohes Risiko / Potenzielle Abh√§ngigkeit</strong> ‚Äî Binge-N√§he (‚â•40/100 ‚âà fast t√§glich) oder fast t√§glicher Konsum (AF-Quote <20%) zeigt extremes Risiko f√ºr Herz, Gehirn, Krebs und Leber. DSM-5-Warnzeichen f√ºr schwere AUD (6+ Kriterien): starkes Verlangen (Craving), Entzug, Kontrollverlust, Toleranz, Weitermachen trotz Sch√§den, Vernachl√§ssigung anderer Aktivit√§ten.' + morningDrinkingWarning;
        warning = 'üÜò Professionelle Hilfe SOFORT empfohlen: SAMHSA-Hotline, lokale Suchtberatung, medizinisches Gespr√§ch. Dies ist keine Diagnose, aber ein klares Signal! Ab AUDIT ‚â• 8 Punkten ist professionelle Abkl√§rung essentiell (ICD-10/DSM-5).';
      } else if ((bingeProximity >= 20 && bingeProximity < 40) || (afQuote < 0.30 && afQuote >= 0.20) || (bingeQuote >= 0.20 && enteredDays >= 10) || counts.hangoverWithAlc >= 1) {
        label = 'üé≤ Risiko-Roulette';
        badgeClass = 'red';
        description = '<strong>Hohes Risiko</strong> ‚Äî Du spielst Russian Roulette mit deiner Gesundheit. Binge-N√§he (20-39/100 ‚âà mehrmals w√∂chentlich) oder niedrige AF-Quote (20-29%) zeigen ein kritisches Muster. Hohes Risiko f√ºr Krebs, Leberzirrhose, Herz-Kreislauf-Erkrankungen und Unf√§lle. Sport kann diese Risiken NICHT kompensieren (WHO).' + morningDrinkingWarning;
        warning = 'üö® Moderate bis schwere AUD wahrscheinlich (4-5 DSM-5-Kriterien wie Toleranz, soziale Probleme, Kontrollverlust). Medizinisches Gespr√§ch und professionelle Beratung DRINGEND empfohlen!';
      } else if (afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)) {
        label = 'üö® Kipppunkt-Kandidat';
        badgeClass = 'weekend';
        description = '<strong>Erh√∂htes Risiko ‚Äì Kritische Schwelle erreicht</strong> ‚Äî Deine AF-Quote (<40%) oder Binge-N√§he (13-19/100 ‚âà w√∂chentlich) liegt im WHO-Risikolevel "moderat bis hoch". Du befindest dich an einem Kipppunkt: H√§ufige Rauschsituationen sind nachweisliche Treiber f√ºr Leber-, Krebs- und Herzprobleme.';
        warning = '‚ö†Ô∏è Dringend empfohlen: AUDIT-Screening durchf√ºhren! Sport neutralisiert Alkoholrisiken NICHT (WHO/DHS). Potenziell mildes AUD bei 2-3 DSM-5-Kriterien (z.B. Kontrollverlust, mehr trinken als geplant).';
      } else if (afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12) {
        label = 'üßò Balance-Buddha';
        badgeClass = 'balance';
        description = '<strong>Moderates Risiko</strong> ‚Äî Du meditierst mit einem Glas Wasser ‚Äì zen, aber nicht fanatisch! AF-Quote 40-69% ist solide. Pr√ºfe kritisch: Bleiben "moderate" Tage wirklich moderat (‚â§2 Einheiten/Woche nach DGE)? Binge-Events (‚â§12/100 ‚âà h√∂chstens viertel- bis monatlich) sind √ºberschaubar.';
        warning = 'Tipp: Mehr Supertage/Wellness-Tage einstreuen ‚Äì Sport + Abstinenz = doppelter Gesundheitsboost!';
      } else {
        label = 'ü¶∏ Leber-Superheld';
        badgeClass = 'zen';
        description = '<strong>Niedriges Gesamtrisiko</strong> ‚Äî Du bist der Batman der Bars ‚Äì unsichtbar f√ºr Alkohol! Deine alkoholfreien Tage (‚â•70%) mit sportlichen/erholsamen Puffern zeigen ein vorbildliches Muster. Binge-Events sind selten (‚â§4/100 Tage ‚âà seltener als monatlich). Deine Leber schickt dir Dankeskarten! üíö';
        warning = '‚ö†Ô∏è Trotzdem kein "Freifahrtschein" ‚Äì WHO empfiehlt weiterhin Wachsamkeit.';
      }
      
      // Sonder-Warnungen
      let extraWarnings = '';
      if (maxCluster >= 3) {
        extraWarnings += `<br>üî• <strong>Cluster-St√ºrmer erkannt:</strong> ${maxCluster} Hochrisiko-Tage am St√ºck bedeuten deutlichen Risiko-Spike!`;
      }
      if (counts.mixed >= 15) {
        extraWarnings += `<br>üíä <strong>Schadensbegrenzungs-Illusionist:</strong> Sport kaschiert Alkoholrisiken, senkt sie aber NICHT substanziell (WHO). ${counts.mixed} "Schadensbegrenzung"-Tage zeigen ein problematisches Muster.`;
      }
      
      const afDisplay = neutralDaysSetting === 'ignore' ? 
        `${Math.round(afQuote * 100)}% (${afCount}/${enteredDays})` : 
        `${Math.round(afQuote * 100)}%`;
      
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore * 100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? 
        `${bingeProximity} (${Math.round(bingeQuote * 100)}%)` : 
        bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster > 0 ? maxCluster + ' Tage' : 'Keiner';
      
      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label;
      badge.className = 'assessment-badge ' + badgeClass;
      
      const basisInfo = neutralDaysSetting === 'ignore' ? 
        `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">üìä Basierend auf <strong>${enteredDays} von 100 Tagen</strong></div>` :
        `<div style="text-align:center; font-size:12px; color:var(--muted); margin-bottom:12px;">üìä Basierend auf <strong>100 Tagen</strong> (${enteredDays} eingetragen)</div>`;
      
      document.getElementById('assessmentDescription').innerHTML = basisInfo + description;
      
      const warningEl = document.getElementById('assessmentWarning');
      if (warning || extraWarnings) {
        warningEl.innerHTML = (warning || '') + extraWarnings;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }
      
      buildDetailedAnalysis();
    }

    function buildDetailedAnalysis() {
      const today = new Date();
      
      // === DATENSAMMLUNG ===
      let last180Days = [];
      let gramsData = [];
      let daysCount = 0;
      let hangoverWithAlc = 0;
      
      for (let i = 0; i < 180; i++) {
        const dt = new Date(today);
        dt.setDate(dt.getDate() - i);
        const key = formatDateKey(dt);
        const entry = dayData[key];
        const status = getDayStatus(key);
        
        let grams = 0;
        if (entry && entry.totalAlcohol) {
          grams = entry.totalAlcohol;
          
          // Z√§hle Katertage mit Alkohol
          if (status === 'hangover' && grams > 0) {
            hangoverWithAlc++;
          }
        } else if (status) {
          // Fallback-Werte
          const fallback = {superday: 0, wellness: 0, sober: 0, moderate: 20, mixed: 40, alcohol: 50, hangover: 60};
          grams = fallback[status] || 0;
        }
        
        last180Days.push({key, status, grams, entry, date: new Date(dt)});
        if (grams > 0 || status) daysCount++;
        gramsData.push(grams);
      }
      
      const last100 = last180Days.slice(0, 100);
      const last30 = last180Days.slice(0, 30);
      
      // === 1. MENGEN-ANALYSE ===
      const gramsTotal = gramsData.reduce((sum, g) => sum + g, 0);
      const avgPerDay = daysCount > 0 ? (gramsTotal / daysCount).toFixed(1) : 0;
      const weeks = 180 / 7.0;
      const avgPerWeek = (gramsTotal / weeks).toFixed(1);
      const avgDrinksPerWeek = (avgPerWeek / DRINK_UNIT).toFixed(1);
      
      // DGE/WHO Schwellenwerte
      let dgeRisk = 'niedrig';
      if (avgPerDay > 40) dgeRisk = 'sehr hoch (‚ö†Ô∏è >40g/Tag)';
      else if (avgPerDay > 24) dgeRisk = 'hoch (‚ö†Ô∏è >24g/Tag M√§nner-Limit)';
      else if (avgPerDay > 12) dgeRisk = 'moderat (‚ö†Ô∏è >12g/Tag Frauen-Limit)';
      
      // === 2. BINGE-ANALYSE ===
      let bingeDays = 0;
      let maxBac = 0;
      let bacPeaks = [];
      
      last100.forEach(day => {
        if (day.grams >= 60) {
          bingeDays++;
          const bac = estimateBAC(day.grams);
          bacPeaks.push({date: day.date, bac: parseFloat(bac), grams: day.grams});
          if (parseFloat(bac) > maxBac) maxBac = parseFloat(bac);
        }
      });
      
      bacPeaks.sort((a, b) => b.bac - a.bac);
      const top3Peaks = bacPeaks.slice(0, 3);
      
      // === 3. CLUSTER-ANALYSE ===
      let maxCluster = 0, curCluster = 0;
      let clusterEvents = [];
      
      last100.forEach((day, idx) => {
        if (day.grams >= 20) {
          curCluster++;
        } else {
          if (curCluster >= 3) {
            clusterEvents.push({length: curCluster, endIdx: idx - 1});
          }
          maxCluster = Math.max(maxCluster, curCluster);
          curCluster = 0;
        }
      });
      if (curCluster >= 3) clusterEvents.push({length: curCluster, endIdx: 0});
      maxCluster = Math.max(maxCluster, curCluster);
      
      // === 4. WEEKEND BINGE PATTERN ===
      let weekendTotal = 0, weekendHigh = 0;
      const weekdayIdx = d => (d.getDay() + 6) % 7; // Mo=0...So=6
      
      last100.forEach(day => {
        const dow = weekdayIdx(day.date);
        if (dow === 4 || dow === 5) { // Fr, Sa
          if (day.grams > 0 || day.status) {
            weekendTotal++;
            if (day.grams >= 40) weekendHigh++;
          }
        }
      });
      
      const weekendBinger = weekendTotal > 0 && (weekendHigh / weekendTotal) >= 0.4;
      
      // === 5. VOLATILIT√ÑT (14-Tage-Schwankungen) ===
      const last14Grams = gramsData.slice(0, 14).filter(g => g > 0);
      let volatility = 0;
      if (last14Grams.length > 1) {
        const mean = last14Grams.reduce((sum, g) => sum + g, 0) / last14Grams.length;
        const variance = last14Grams.reduce((sum, g) => sum + Math.pow(g - mean, 2), 0) / last14Grams.length;
        volatility = Math.sqrt(variance);
      }
      
      let volRisk = 'stabil';
      if (volatility > 30) volRisk = 'sehr volatil ‚ö†Ô∏è';
      else if (volatility > 20) volRisk = 'volatil';
      else if (volatility > 10) volRisk = 'moderat schwankend';
      
      // === 6. TOLERANCE CREEP ===
      const first90 = last180Days.slice(90, 180);
      const recent90 = last180Days.slice(0, 90);
      
      const medianGrams = arr => {
        const sorted = arr.filter(d => d.grams > 0).map(d => d.grams).sort((a,b) => a-b);
        if (sorted.length === 0) return 0;
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 === 0 ? (sorted[mid-1] + sorted[mid]) / 2 : sorted[mid];
      };
      
      const oldMedian = medianGrams(first90);
      const newMedian = medianGrams(recent90);
      const creep = newMedian - oldMedian;
      
      let creepStatus = 'keine Toleranzentwicklung';
      if (creep > 15) creepStatus = '‚ö†Ô∏è starke Toleranzentwicklung (+' + creep.toFixed(0) + 'g)';
      else if (creep > 5) creepStatus = '‚ö†Ô∏è Toleranzentwicklung (+' + creep.toFixed(0) + 'g)';
      else if (creep < -5) creepStatus = '‚úÖ Reduzierung (-' + Math.abs(creep).toFixed(0) + 'g)';
      
      // === 7. MARKOV-CHAIN 7-TAGE-PROGNOSE ===
      const states = ['superday', 'wellness', 'sober', 'moderate', 'mixed', 'alcohol', 'hangover'];
      const idx = {};
      states.forEach((s, i) => idx[s] = i);
      
      // Transition Matrix mit Recency-Gewichtung
      const M = Array(7).fill(0).map(() => Array(7).fill(1)); // Laplace smoothing
      
      let prev = null;
      for (let i = 179; i >= 1; i--) {
        const st = last180Days[i].status;
        if (!st) continue;
        
        const weight = (i <= 30) ? 2 : 1; // Recency-Gewichtung
        
        if (prev && idx[prev] !== undefined && idx[st] !== undefined) {
          M[idx[prev]][idx[st]] += weight;
        }
        prev = st;
      }
      
      // Normalisieren
      M.forEach(row => {
        const sum = row.reduce((s, v) => s + v, 0);
        for (let i = 0; i < row.length; i++) {
          row[i] /= sum;
        }
      });
      
      // 7-Tage-Forecast
      const currentState = last180Days[0].status || 'sober';
      let forecast = [];
      let state = currentState;
      
      for (let day = 1; day <= 7; day++) {
        const probs = M[idx[state]];
        // W√§hle wahrscheinlichsten n√§chsten Zustand
        let maxProb = 0, nextState = state;
        probs.forEach((p, i) => {
          if (p > maxProb) {
            maxProb = p;
            nextState = states[i];
          }
        });
        
        forecast.push({day, state: nextState, prob: (maxProb * 100).toFixed(0)});
        state = nextState;
      }
      
      // === 8. RECOVERY RATE ===
      let recoveryTimes = [];
      let lastBinge = null;
      
      last180Days.reverse().forEach((day, idx) => {
        if (day.grams >= 60) {
          if (lastBinge !== null) {
            recoveryTimes.push(idx - lastBinge);
          }
          lastBinge = idx;
        }
      });
      
      const avgRecovery = recoveryTimes.length > 0 ? 
        (recoveryTimes.reduce((s, t) => s + t, 0) / recoveryTimes.length).toFixed(1) : 
        'N/A';
      
      // === 9. COMMENT RISK ANALYSIS ===
      const triggerWords = ['party', 'feier', 'stress', 'schlecht', 'schei√üe', 'traurig', '√§rger', 'wut', 'problem', 'streit'];
      let triggerCount = 0;
      
      last30.forEach(day => {
        if (day.entry && day.entry.comment) {
          const comment = day.entry.comment.toLowerCase();
          triggerWords.forEach(word => {
            if (comment.includes(word)) triggerCount++;
          });
        }
      });
      
      const commentRisk = triggerCount > 5 ? '‚ö†Ô∏è hoch' : triggerCount > 2 ? 'moderat' : 'niedrig';
      
      // === HTML GENERIERUNG ===
      const catNames = {
        superday: '‚≠ê',
        wellness: 'üíö',
        sober: 'üü¢',
        moderate: 'üü°',
        mixed: '‚ù§Ô∏è',
        alcohol: 'üî¥',
        hangover: 'üòµ'
      };
      
      let html = `
        <div style="line-height:2.0; font-size:14px;">
          <div style="margin-bottom:24px; padding:16px; background:#f0f9ff; border-radius:8px; border:1px solid #bae6fd;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">üìä Mengen-Analyse (180 Tage)</div>
            <div><strong>√ò Gramm/Tag:</strong> ${avgPerDay}g <span style="color:var(--muted);">(${daysCount} Tage mit Konsum)</span></div>
            <div><strong>√ò Gramm/Woche:</strong> ${avgPerWeek}g</div>
            <div><strong>√ò Drinks/Woche:</strong> ${avgDrinksPerWeek} <span style="font-size:12px;">(√† 10g)</span></div>
            <div style="margin-top:8px; padding:8px; background:white; border-radius:6px;"><strong>DGE/WHO-Risiko:</strong> ${dgeRisk}</div>
          </div>
          
          <div style="margin-bottom:24px; padding:16px; background:#fef3c7; border-radius:8px; border:1px solid #fde68a;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">‚ö†Ô∏è Binge-Analyse (100 Tage)</div>
            <div><strong>Binge-Tage (‚â•60g):</strong> ${bingeDays}/100 ${bingeDays > 10 ? '‚ö†Ô∏è' : ''}</div>
            <div><strong>Max. BAC (gesch√§tzt):</strong> ${maxBac.toFixed(2)}‚Ä∞</div>
            ${top3Peaks.length > 0 ? `
              <div style="margin-top:8px;"><strong>Top-3 Peaks:</strong></div>
              <ul style="margin:4px 0; padding-left:20px; font-size:13px;">
                ${top3Peaks.map(p => `<li>${p.date.toLocaleDateString('de-DE')}: ${p.grams}g (${p.bac.toFixed(2)}‚Ä∞)</li>`).join('')}
              </ul>
            ` : ''}
          </div>
          
          <div style="margin-bottom:24px; padding:16px; background:#fee; border-radius:8px; border:1px solid #fcc;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">üî• Cluster & Patterns</div>
            <div><strong>L√§ngster Cluster:</strong> ${maxCluster} Tage (‚â•20g am St√ºck) ${maxCluster >= 5 ? '‚ö†Ô∏è' : ''}</div>
            <div><strong>Cluster-Events (‚â•3 Tage):</strong> ${clusterEvents.length}</div>
            <div><strong>Weekend-Binge Pattern:</strong> ${weekendBinger ? '‚ö†Ô∏è Ja (Fr/Sa-Fokus)' : 'Nein'} 
              <span style="font-size:12px;">(${weekendHigh}/${weekendTotal} Wochenenden)</span></div>
            <div><strong>Volatilit√§t (14d):</strong> ${volRisk} <span style="font-size:12px;">(œÉ=${volatility.toFixed(1)}g)</span></div>
          </div>
          
          <div style="margin-bottom:24px; padding:16px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">üìà Trends & Tolerance</div>
            <div><strong>Tolerance Creep (90d vs. 90d):</strong> ${creepStatus}</div>
            <div><strong>√ò Recovery (Binge‚ÜíBinge):</strong> ${avgRecovery} Tage</div>
            <div><strong>Comment Risk (30d):</strong> ${commentRisk} <span style="font-size:12px;">(${triggerCount} Trigger-W√∂rter)</span></div>
            ${hangoverWithAlc > 0 ? `<div style="margin-top:8px; padding:8px; background:#fee2e2; border-left:3px solid #dc2626; border-radius:4px;"><strong>üö® Katertage mit Weiter-Alkohol:</strong> ${hangoverWithAlc} (DSM-5-Kriterium f√ºr schwere AUD!)</div>` : ''}
          </div>
          
          <div style="margin-bottom:16px; padding:16px; background:#ede9fe; border-radius:8px; border:1px solid #c4b5fd;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">üîÆ Markov-Prognose (7 Tage)</div>
            <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Basierend auf √úbergangs-Wahrscheinlichkeiten (letzte 180 Tage, Recency-gewichtet):</div>
            <div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; text-align:center;">
              ${forecast.map(f => `
                <div style="padding:8px; background:white; border-radius:6px; border:1px solid #e0e7ff;">
                  <div style="font-size:20px;">${catNames[f.state] || '‚ùì'}</div>
                  <div style="font-size:11px; color:var(--muted);">Tag ${f.day}</div>
                  <div style="font-size:10px; color:var(--muted);">${f.prob}%</div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top:12px; font-size:12px; color:var(--muted); font-style:italic;">
              ‚ö†Ô∏è Dies ist eine statistische Prognose, keine Vorhersage. Deine Entscheidungen k√∂nnen diesen Trend jederzeit √§ndern!
            </div>
          </div>
          
          <div style="padding:12px; background:#fef2f2; border-left:4px solid #ef4444; border-radius:6px; font-size:12px; line-height:1.6;">
            <strong>üìö Wissenschaftliche Basis:</strong><br>
            ‚Ä¢ DGE: ‚â§24g/Tag (M√§nner), ‚â§12g/Tag (Frauen)<br>
            ‚Ä¢ WHO: Binge = ‚â•60g/Session<br>
            ‚Ä¢ RKI: Riskanter Konsum = >20g/Tag regelm√§√üig<br>
            ‚Ä¢ DSM-5: AUD-Kriterien bei Kontrollverlust, Toleranz, Craving, <strong>morgendlichem Trinken</strong><br>
            ‚Ä¢ Markov-Chain: Historische √úbergangsmuster<br>
            ‚Ä¢ <strong>Katertag ohne Alkohol = 10% Gesundheit</strong> (leidet, trinkt aber nicht weiter)<br>
            ‚Ä¢ <strong>Katertag MIT Alkohol = 0% Gesundheit</strong> (doppelt problematisch, DSM-5-Kriterium!)
          </div>
          
          <div style="margin-top:16px; font-size:12px; color:var(--muted);">
            <strong>Hinweis:</strong> Wo keine detaillierten Mengen erfasst wurden, nutzt die Analyse plausible Fallbacks (moderat‚âà20g, Schadensbegrenzung‚âà40g, viel‚âà50g, Katertag‚âà60g). 
            Exakte Angaben im God-Modus verbessern die Aussagekraft massiv.
          </div>
        </div>
      `;
      
      document.getElementById('godMetricsList').innerHTML = html;
    }

    /* ========================================
       POPUPS
    ======================================== */
    function toggleChartPopup() {
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');

      if (isActive) {
        popup.classList.remove('active');
        overlay.classList.remove('active');
      } else {
        calculate100DaysChart();
        calculateHealthAssessment();
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function toggleSettingsPopup() {
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');

      if (isActive) {
        popup.classList.remove('active');
        overlay.classList.remove('active');
      } else {
        // Refresh Radio-UI
        document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if (radio) {
          radio.checked = true;
          radio.closest('.settings-option').classList.add('selected');
        }
        document.getElementById('toggleGodMode').checked = godMode;
        
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function toggleSettingsSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }

    function saveSettings() {
      const selected = document.querySelector('input[name="neutralDays"]:checked');
      if (selected) neutralDaysSetting = selected.value;
      godMode = document.getElementById('toggleGodMode').checked;

      if (storageWorking) {
        try {
          localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
            neutralDays: neutralDaysSetting,
            godMode
          }));
        } catch (e) {
          console.warn('Settings konnten nicht gespeichert werden:', e);
        }
      }
      
      toggleSettingsPopup();
      updateDayInputView();
      alert('‚úÖ Einstellungen gespeichert.');
    }

    /* ========================================
       EVENT LISTENERS
    ======================================== */
    document.addEventListener('DOMContentLoaded', () => {
      testStorage();
      loadData();
      
      document.getElementById('appVersion').textContent = APP_VERSION;
      updateDayInputView();
      
      // FIX: Initial Drink beim God-Mode laden
      if (godMode && activeDrinks.length === 0) {
        addDrink();
      }
      
      // Kategorie-Auswahl mit Auto-Select
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio => {
        radio.addEventListener('change', () => {
          // Pr√ºfe ob manuell ge√§ndert (nicht Auto-Select)
          const isManual = !radio.dataset.autoSelected;
          delete radio.dataset.autoSelected; // Reset
          if (isManual) {
            updateCategoryWarnings(null);
          }
        });
      });
      
      // Submit Day
      document.getElementById('submitDay').addEventListener('click', saveDay);
      
      // FIX: God-Modus Toggle mit korrekter Logik
      document.getElementById('godToggleBtn').addEventListener('click', () => {
        godMode = !godMode;
        const section = document.getElementById('godSection');
        section.style.display = godMode ? 'block' : 'none';
        
        const btn = document.getElementById('godToggleBtn');
        btn.textContent = godMode ? 'Ausblenden' : 'Einblenden';
        
        // Initial Drink hinzuf√ºgen wenn leer
        if (godMode && activeDrinks.length === 0) {
          addDrink();
        }
      });
      
      // Add Drink
      document.getElementById('addDrinkBtn').addEventListener('click', () => {
        addDrink();
      });
      
      // Drinks Input Delegation
      document.addEventListener('change', (e) => {
        const target = e.target;
        if (target.matches('[data-drink]')) {
          const drinkId = target.dataset.drink;
          const field = target.dataset.field;
          updateDrinkFromInput(drinkId, field, target.value);
        }
      });
      
      document.addEventListener('input', (e) => {
        const target = e.target;
        if (target.matches('[data-drink][data-field="custom"]')) {
          const drinkId = target.dataset.drink;
          updateDrinkFromInput(drinkId, 'custom', target.value);
        }
      });
      
      // Checkboxen
      document.getElementById('checkSport').addEventListener('change', updateLiveCalc);
      document.getElementById('checkCrash').addEventListener('change', updateLiveCalc);
      document.getElementById('checkHangover').addEventListener('change', updateLiveCalc);
      
      document.getElementById('checkDope').addEventListener('change', (e) => {
        document.getElementById('dopeDetails').style.display = e.target.checked ? 'block' : 'none';
      });
      
      // Analysis Toggle
      document.getElementById('analysisToggle').addEventListener('click', () => {
        const box = document.getElementById('analysisBox');
        box.classList.toggle('active');
        const btn = document.getElementById('analysisToggle');
        btn.textContent = box.classList.contains('active') ? 'üîº Analyse ausblenden' : 'üîç Detaillierte Analyse anzeigen';
      });
      
      // Settings Radio
      document.querySelectorAll('input[name="neutralDays"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
          radio.closest('.settings-option').classList.add('selected');
        });
      });
    });

    /* ========================================
       GLOBAL FUNCTIONS (f√ºr onclick)
    ======================================== */
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.currentMonth = currentMonth;
    window.toggleChartPopup = toggleChartPopup;
    window.toggleSettingsPopup = toggleSettingsPopup;
    window.toggleSettingsSection = toggleSettingsSection;
    window.saveSettings = saveSettings;
    window.exportData = exportData;
    window.importData = importData;
    window.resetStorage = resetStorage;
    window.removeDrink = removeDrink;
  </script>
</body>
</html>
