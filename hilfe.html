<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669; /* Dunkelgr√ºn */
      --wellness:#22c55e; /* Hellgr√ºn */
      --mixed:#f59e0b; /* Orange f√ºr Mixed im Help */
      --mixed-index:#dc2626; /* Rot f√ºr Mixed in der Hauptansicht (wie Danger) */
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color: var(--text);
    }
    body {
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
      padding-top: 100px; /* Platz f√ºr die Fixed Header */
      line-height: 1.6;
    }
    .main-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: clamp(16px, 2.5vw, 24px);
    }
    .card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
      margin-bottom:24px;
    }
    header{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      background:var(--card-bg);
      border-bottom:1px solid var(--card-border);
      z-index: 500;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      padding: 10px 0;
    }
    .header-content{
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
    }
    h1{
      font-size:24px;
      margin:0;
      color:var(--primary);
    }
    .nav a{
      text-decoration:none;
      color:var(--primary);
      margin-left:15px;
      font-weight:600;
      transition:color .2s;
    }
    .nav a:hover{
      color:var(--primary-dark);
    }
    /* Month View */
    .month-view{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:8px;
    }
    .day-cell{
      aspect-ratio:1/1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      border-radius:8px;
      padding:5px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:transform .1s, box-shadow .1s;
      position:relative;
    }
    .day-cell:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .day-number{
      font-size:1.2em;
      margin-bottom:2px;
    }
    .day-status{
      font-size:0.8em;
      font-weight:400;
      text-align:center;
      line-height:1.2;
      opacity:0.8;
    }
    .current-month{ background-color:#f1f5f9; }
    .past-month, .future-month{ background-color:#e2e8f0; color:var(--muted); opacity:0.6; }

    /* Status Colors */
    .status-sober, .status-super, .status-wellness{ background-color:var(--success); color:white; }
    .status-moderate{ background-color:var(--warn); color:white; }
    .status-mixed, .status-alcohol, .status-binge{ background-color:var(--mixed-index); color:white; }

    /* Tooltip */
    .tooltip{
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      background:var(--text);
      color:var(--card-bg);
      padding:8px 12px;
      border-radius:4px;
      font-size:12px;
      white-space:nowrap;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s;
      z-index: 600;
    }
    .day-cell:hover .tooltip{
      opacity:1;
    }
    .tooltip::after{
      content:'';
      position:absolute;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      border-width:5px;
      border-style:solid;
      border-color:var(--text) transparent transparent transparent;
    }

    /* Input Modal (Day Detail) */
    .day-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 50px;
    }
    .day-modal-content {
      background-color: var(--card-bg);
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover, .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    /* Form Styling */
    .modal-form label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    .modal-form input[type="number"], .modal-form select, .modal-form textarea {
      width: calc(100% - 20px);
      padding: 10px;
      margin-top: 5px;
      border: 1px solid var(--card-border);
      border-radius: 4px;
      box-sizing: border-box;
    }
    .modal-form button {
      background-color: var(--primary);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    .modal-form button:hover {
      background-color: var(--primary-dark);
    }
    .checkbox-group {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    .checkbox-group label {
      font-weight: normal;
    }

    /* Score Card */
    .score-card {
      text-align: center;
      padding: 20px;
      margin-top: 24px;
      border-radius: var(--radius);
      color: white;
      font-weight: 700;
      transition: background-color 0.5s;
    }
    .score-card h2 {
      margin: 0 0 5px 0;
      font-size: 1.5em;
    }
    .score-value {
      font-size: 3em;
      margin: 0;
    }
    .score-description {
      margin-top: 10px;
      font-size: 1em;
      font-weight: 400;
    }
    .score-0-20 { background-color: #ef4444; } /* Rot */
    .score-21-40 { background-color: #f97316; } /* Orange */
    .score-41-60 { background-color: #f59e0b; } /* Gelb-Orange */
    .score-61-80 { background-color: #22c55e; } /* Hellgr√ºn */
    .score-81-100 { background-color: #059669; } /* Dunkelgr√ºn (Super) */

    .settings-btn {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin-left: 15px;
    }

    /* General Layout */
    .month-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .month-head h2 {
      margin: 0;
      font-size: 1.8em;
      color: var(--text);
    }
    .month-head button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .month-head button:hover {
      background: var(--primary-dark);
    }
    .month-hint {
      text-align: center;
      font-size: 0.9em;
      color: var(--muted);
      margin-bottom: 20px;
    }
    .gm-badge {
      background-color: var(--danger);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      margin-left: 5px;
    }

    /* ------------------------------------- */
    /* NEW: Modal for HELP/Wissens-Hub Styles */
    /* ------------------------------------- */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
    }
    
    /* FIX: Explicitly hide all modals by ID to prevent accidental display on load */
    #dayModal, #settingsModal, #helpModal {
        display: none; 
    }
    
    .modal-content {
        background-color: var(--card-bg);
        margin: 3% auto; /* 3% from the top and centered */
        padding: 40px 30px 30px 30px; /* Adjusted padding for close button */
        border-radius: var(--radius);
        width: 95%; /* Could be more responsive */
        max-width: 900px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
        animation-name: animatetop;
        animation-duration: 0.4s;
        box-sizing: border-box;
    }
    @media (max-width: 950px) {
      .modal-content {
        width: 90%;
        margin: 10% auto;
      }
    }
    /* Close Button for Help Modal */
    .close-button {
        color: #aaa;
        float: right;
        font-size: 36px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 25px;
        cursor: pointer;
        z-index: 1001;
    }
    .close-button:hover,
    .close-button:focus {
        color: var(--danger);
        text-decoration: none;
        cursor: pointer;
    }
    /* Animation */
    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
    }
    /* Help Content Specific Styles (copied from previous hilfe.html) */
    #helpContent h1 {
      font-size: clamp(26px, 4.2vw, 34px);
      text-align: center;
      margin: 0 0 8px;
      color: var(--primary);
    }
    #helpContent h2 {
      font-size: 24px;
      border-bottom: 2px solid var(--card-border);
      padding-bottom: 5px;
      margin-top: 30px;
      color: var(--text);
    }
    #helpContent h3 {
      font-size: 18px;
      margin-top: 20px;
      color: var(--primary);
    }

    #helpContent table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
    #helpContent th, #helpContent td { border: 1px solid var(--card-border); padding: 12px; text-align: left; }
    #helpContent th { background-color: #f8fafc; font-weight: 700; color: var(--text); }
    #helpContent td:first-child { font-weight: 600; }

    #helpContent .note { padding: 15px; background-color: #fffbe6; border-left: 5px solid #f59e0b; margin: 20px 0; color: #78350f; }
    #helpContent .code-block { background-color: #f4f6f8; padding: 10px; border-radius: 5px; overflow-x: auto; font-family: monospace; }
    #helpContent ol, #helpContent ul { padding-left: 25px; }
    #helpContent ol li, #helpContent ul li { margin-bottom: 10px; }

    /* Badges for Help Content */
    .badge-sober { color: white; background: var(--super); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
    .badge-wellness { color: white; background: var(--wellness); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
    .badge-moderate { color: white; background: var(--mixed); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
    .badge-alcohol { color: white; background: var(--danger); padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
    .badge-neutral { color: var(--muted); background: #f1f5f9; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }

  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <h1>Booze-Tracker</h1>
      <nav class="nav">
        <a href="#" onclick="changeMonth(-1)">‚Üê Vorheriger Monat</a>
        <a href="#" onclick="changeMonth(1)">N√§chster Monat ‚Üí</a>
        <a href="javascript:void(0)" onclick="openHelpModal()">? Hilfe / Logik</a> <button class="settings-btn" id="openSettingsBtn">‚öôÔ∏è Einstellungen</button>
      </nav>
    </div>
  </header>

  <div class="main-wrapper">
    <div class="card score-card" id="riskScoreCard">
      <h2>Risiko-Score (100 Tage)</h2>
      <p class="score-value" id="scoreValue">--</p>
      <p class="score-description" id="scoreDescription">Laden...</p>
    </div>

    <div class="card">
      <div class="month-head">
        <h2 id="currentMonthName">Laden...</h2>
      </div>
      <div id="monthHint" class="month-hint"></div>
      <div class="month-view" id="monthView">
        </div>
    </div>
    
    <div class="card" id="statsCard">
        <h2>Langzeit-Statistiken (180 Tage)</h2>
        <ul id="statsList">
          </ul>
    </div>
  </div>

  <div id="dayModal" class="day-modal">
    <div class="day-modal-content">
      <span class="close" onclick="closeDayModal()">&times;</span>
      <h2 id="modalDate">Datum</h2>
      <form id="dayForm" class="modal-form">
        <div id="godModeInputs" style="display:none;">
          <label for="alcoholGrams">Reiner Alkohol (Gramm):</label>
          <input type="number" id="alcoholGrams" name="alcoholGrams" value="0" min="0" step="1" required>

          <label for="categoryOverride">Oder Kategorie w√§hlen (Optional):</label>
          <select id="categoryOverride" name="categoryOverride">
            <option value="">(Automatisch berechnen)</option>
            <option value="super">‚≠ê Super-Day</option>
            <option value="wellness">üßò Wellness-Day</option>
            <option value="sober">‚úÖ Sober</option>
            <option value="moderate">üß° Moderat</option>
            <option value="mixed">‚ù§Ô∏è Schadensbegrenzung (Mixed)</option>
            <option value="alcohol">üî¥ Alkohol</option>
            <option value="binge">üç∫üí• Vollrausch</option>
          </select>

          <div class="checkbox-group">
            <input type="checkbox" id="checkHangover" name="checkHangover">
            <label for="checkHangover">Heute Kater/Hangover?</label>
          </div>
        </div>

        <div id="simpleModeInputs">
          <label for="simpleStatus">Status f√ºr diesen Tag:</label>
          <select id="simpleStatus" name="simpleStatus" required>
            <option value="sober">Sober-Day</option>
            <option value="moderate">Moderat getrunken</option>
            <option value="alcohol">Zu viel getrunken</option>
            <option value="binge">Kontrollverlust / Vollrausch</option>
            <option value="super">Super-Day (Sober + Leistung)</option>
            <option value="wellness">Wellness-Day (Sober + Sport/Meditation)</option>
            <option value="mixed">Mixed/Schadensbegrenzung</option>
            <option value="none">Keine Angabe (Ignorieren)</option>
          </select>
          <div class="checkbox-group">
            <input type="checkbox" id="simpleHangover" name="simpleHangover">
            <label for="simpleHangover">Heute Kater/Hangover?</label>
          </div>
        </div>

        <label for="sleepQuality">Schlafqualit√§t (1-5):</label>
        <input type="number" id="sleepQuality" name="sleepQuality" value="3" min="1" max="5">

        <label for="stressLevel">Stress-Level (1-5):</label>
        <input type="number" id="stressLevel" name="stressLevel" value="3" min="1" max="5">

        <label for="notes">Notizen/Tagebuch-Eintrag:</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
        
        <input type="hidden" id="selectedDate">
        <button type="submit">Speichern</button>
      </form>
    </div>
  </div>
  
  <div id="settingsModal" class="day-modal">
    <div class="day-modal-content">
        <span class="close" onclick="closeSettingsModal()">&times;</span>
        <h2>Einstellungen & Daten</h2>
        <form id="settingsForm" class="modal-form">
            <label for="userName">Dein Name (f√ºr Begr√º√üung):</label>
            <input type="text" id="userName" name="userName">

            <label for="godModeToggle">God-Mode aktivieren (Eingabe in Gramm reinem Alkohol):</label>
            <input type="checkbox" id="godModeToggle" name="godModeToggle">
            <label for="godModeToggle">Ja, genaue Grammangaben nutzen (Wichtig: Speichern dr√ºcken!)</label>

            <label for="emptyDayHandling">Umgang mit leeren Tagen im Score:</label>
            <select id="emptyDayHandling" name="emptyDayHandling">
                <option value="neutral">Neutral (Score wird nur f√ºr bef√ºllte Tage berechnet)</option>
                <option value="punish">Leichte Bestrafung (Leichte Negativ-Wertung)</option>
                <option value="reward">Leichte Belohnung (Leichte Positiv-Wertung)</option>
            </select>

            <button type="button" onclick="saveSettings()">Einstellungen speichern</button>
            <hr style="margin-top: 30px; border-color: var(--card-border);">
            
            <h3>Daten-Management</h3>
            <button type="button" onclick="exportData()">Daten-Backup (Export JSON)</button>
            <input type="file" id="importFile" accept=".json" style="margin-top: 15px; display: block;">
            <button type="button" onclick="importData(false)">Daten ersetzen (Import)</button>
            <button type="button" onclick="importData(true)" style="background-color: var(--success);">Daten zusammenf√ºhren (Merge Import)</button>
            <button type="button" onclick="clearAllData()" style="background-color: var(--danger); margin-top: 20px;">üö´ ALLE DATEN L√ñSCHEN</button>
        </form>
    </div>
  </div>

  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeHelpModal()">&times;</span>
      <div id="helpContent" style="max-height: 85vh; overflow-y: auto; padding-right: 10px;"> <h1>Wissens-Hub & Tracker-Logik ‚Äì Booze-Tracker</h1>
        <p style="text-align:center; color:var(--muted);">
          Detaillierte Erl√§uterung der Metriken, Logik und Funktionen des Trackers.
        </p>

        <h2>1. Die Philosophie des Booze-Trackers</h2>
        
        <h3>1.1. Fokus auf Verhalten (Input) statt nur Ergebnis (Output)</h3>
        <p>Der Tracker bewertet nicht nur, <strong>wie viel</strong> Sie trinken, sondern auch, <strong>wie</strong> Sie sich dabei verhalten. Zum Beispiel z√§hlt ein Katertag, an dem Sie nicht weitertrinken, positiv, da Sie den negativen Kreislauf bewusst stoppen. Ein Tag mit Sport und moderatem Konsum wird als "Schadensbegrenzung" eingestuft.</p>
        
        <h3>1.2. Kategorien als Entscheidungs-Werkzeug</h3>
        <p>Jede Kategorie ("Sober", "Wellness", "Moderate", etc.) repr√§sentiert eine bewusste Entscheidung. Der Tracker rechnet die Alkoholgramm im God-Modus in eine der Kategorien um. Ziel ist es, die Verhaltensmuster zu erkennen und zu verbessern. Die sieben Kategorien sind:</p>

        <table>
          <tr>
            <th>Kategorie</th>
            <th>Farbe (Score-Beitrag)</th>
            <th>Beschreibung</th>
          </tr>
          <tr>
            <td>‚≠ê Super-Day</td>
            <td><span class="badge-sober">üü¢ SUPER</span></td>
            <td>**Hoch Positiv (++):** Ein Tag ohne Alkohol, an dem ein gro√ües Ziel (z.B. Marathon, Pr√§sentation, besonderes Workout) erreicht oder ein starker Fokus gezeigt wurde.</td>
          </tr>
          <tr>
            <td>üßò Wellness-Day</td>
            <td><span class="badge-wellness">üü¢ WELLNESS</span></td>
            <td>**Positiv (+):** Ein Tag ohne Alkohol, an dem zus√§tzlich bewusst etwas f√ºr die k√∂rperliche oder mentale Gesundheit getan wurde (z.B. Sport, Meditation, gesundes Essen).</td>
          </tr>
          <tr>
            <td>‚úÖ Sober</td>
            <td><span class="badge-sober">üü¢ SOBER</span></td>
            <td>**Positiv (+):** Ein Tag ohne Alkohol und ohne spezifische Wellness-Aktivit√§t. Die Abwesenheit negativer Gewohnheiten ist ein positiver Standard.</td>
          </tr>
          <tr>
            <td>üß° Moderat</td>
            <td><span class="badge-moderate">üü† MODERAT</span></td>
            <td>**Leicht Negativ (-):** Alkoholmenge unter den t√§glichen DGE-Grenzwerten (‚ôÄ ‚â§12g/Tag, ‚ôÇ ‚â§24g/Tag) ‚Äì also kontrollierter, risikoarmer Konsum.</td>
          </tr>
          <tr>
            <td>‚ù§Ô∏è Schadensbegrenzung (Mixed)</td>
            <td><span class="badge-moderate">üü† MIXED</span></td>
            <td>**Negativ (‚Äî):** Alkoholmenge √ºber Moderat, aber kombiniert mit positiven Faktoren wie Sport am selben Tag oder einer Katertag-Entscheidung gegen das Weitertrinken. Der Alkohol dominiert die Gesamtbewertung, aber das Verhalten wird abgemildert.</td>
          </tr>
          <tr>
            <td>üî¥ Alkohol</td>
            <td><span class="badge-alcohol">üî¥ ALKOHOL</span></td>
            <td>**Stark Negativ (---):** Kontrollverlust, Alkoholmenge √ºber der Moderat-Grenze und keine positiven Faktoren.</td>
          </tr>
          <tr>
            <td>üç∫üí• Vollrausch</td>
            <td><span class="badge-alcohol">üî¥ VOLLRAUSCH</span></td>
            <td>**Sehr Stark Negativ (----):** Extreme Alkoholmenge (>80g) ‚Äì ein kritisches Warnsignal.</td>
          </tr>
          <tr>
            <td>Keine Angabe</td>
            <td><span class="badge-neutral">‚ö™ NEUTRAL (Grau)</span></td>
            <td>**Neutral:** Ein Tag, f√ºr den keine Daten vorliegen. Der Score wird durch die Einstellung "Umgang mit leeren Tagen" angepasst.</td>
          </tr>
        </table>
        
        <h2>2. Die Logik des Risiko-Scores (100-Tage-Analyse)</h2>
        <p>Der Tracker verwendet einen komplexen gewichteten Score √ºber die letzten 100 Tage, um ein realistisches Bild Ihres aktuellen Konsumverhaltens zu zeichnen. Der Score (0% = Maximalrisiko, 100% = Optimal) setzt sich aus drei Hauptkomponenten zusammen:</p>

        <h3>2.1. Die drei Score-Komponenten</h3>
        
        <h4>1. Die Kontinuit√§ts-Komponente (40% Gewichtung)</h4>
        <p>Misst die Regelm√§√üigkeit des positiven Verhaltens. Sie basiert auf der **Abstinenztage-Quote (AF-Quote)**. Je h√∂her die AF-Quote (Tage ohne Alkohol), desto besser. Die Gewichtung belohnt lange, ununterbrochene "Sober"-Phasen. Ein Tag mit 80g Alkohol ist weniger sch√§dlich f√ºr den Score, wenn er isoliert auftritt, als eine Kette von 3 Tagen mit je 40g.</p>

        <h4>2. Die Risikoverhaltens-Komponente (40% Gewichtung)</h4>
        <p>Bestraft die gef√§hrlichsten Verhaltensmuster. Die st√§rkste Abwertung gibt es f√ºr:</p>
        <ul>
          <li>**Hangover MIT Weitertrinken:** Dies ist ein Kriterium f√ºr schwere Abh√§ngigkeit (DSM-5) und f√ºhrt zu einer sofortigen 0%-Wertung f√ºr den Tag.</li>
          <li>**Hohe Binge-Tage-Quote:** Tage √ºber der WHO-Binge-Schwelle (‚ôÄ ‚â•40g, ‚ôÇ ‚â•60g).</li>
          <li>**Lange Konsum-Cluster:** Mehr als 3 aufeinanderfolgende Tage mit √ºber 20g Alkohol.</li>
        </ul>

        <h4>3. Die Erholungs-Komponente (20% Gewichtung)</h4>
        <p>Bewertet das anschlie√üende Verhalten nach einem riskanten Tag. Hier z√§hlt die **Recovery Rate**. Die Komponente bewertet hoch, wenn nach einem Vollrausch am Folgetag ein bewusster "Clean Hangover" (kein Alkohol) oder ein "Wellness-Day" folgt. Die Punktzahl f√ºr einen "Clean Hangover" wird dabei um einen Multiplikator erh√∂ht, der von der Alkoholmenge des Vortages abh√§ngt (je h√∂her der Vortags-Pegel, desto h√∂her der Erholungs-Bonus).</p>

        <div class="note">
            <p><strong class="strong">Wichtig:</strong> Der Tracker unterscheidet zwischen einem normalen Katertag (Status 'hangover') und dem **Hangover MIT Weitertrinken** (Checkbox 'checkHangover' + Alkoholmenge > 0). Letzteres ist das kritische Warnzeichen.</p>
        </div>

        <h3>2.2. Long-Term-Analyse (180 Tage)</h3>
        <p>Diese Analyse liefert langfristige Metriken und Korrelationen (CBT-fokussiert), die in der 100-Tage-Analyse nicht erfasst werden, darunter:</p>
        <ul>
          <li>**W√∂chentlicher Durchschnitt:** Durchschnittliche Gramm reinen Alkohols pro Woche.</li>
          <li>**Stress-Korrelation:** Misst, ob Alkoholkonsum durch ein hohes Stress-Level getriggert wird (positive Korrelation) oder paradoxerweise bei Entspannung (negative Korrelation, z.B. reines Party-Muster).</li>
          <li>**Schlaf-Korrelation:** Misst den Zusammenhang zwischen Schlafqualit√§t und Alkoholkonsum.</li>
          <li>**Recovery Rate:** Durchschnittliche Anzahl abstinenter Tage, die nach einem Binge-Tag (‚â•60g) ben√∂tigt werden, um wieder einen Sober- oder Wellness-Tag zu erreichen.</li>
        </ul>

        <h2>3. Daten-Sicherheit und Portabilit√§t</h2>
        
        <h3>3.1. Lokale Speicherung</h3>
        <p>Alle Ihre Daten (Tagebucheintr√§ge und Einstellungen) werden ausschlie√ülich **lokal in Ihrem Browser** gespeichert (via `localStorage`). Der Tracker √ºbertr√§gt Ihre Daten zu keiner Zeit an einen Server. Dies bietet maximale Privatsph√§re, erfordert aber bei Browserwechsel oder -zur√ºcksetzung eine Datensicherung.</p>

        <h3>3.2. Backup & Wiederherstellung</h3>
        <p>√úber die Einstellungen k√∂nnen Sie jederzeit ein Backup Ihrer Daten als `booze-tracker-backup-JJJJ-MM-TT.json` herunterladen und sp√§ter wieder importieren. Die Import-Funktion kann Daten entweder ersetzen oder mit bestehenden Daten zusammenf√ºhren (Merge), wobei ung√ºltige/duplizierte Eintr√§ge automatisch gefiltert werden.</p>

        <h2>4. Nutzung auf dem Smartphone (PWA-√§hnlich)</h2>
        <p>Sie k√∂nnen den Booze-Tracker wie eine native App nutzen, indem Sie einen direkten Link auf den Home-Bildschirm Ihres Smartphones legen.</p>

        <h3>4.1. Voraussetzung</h3>
        <p>Die `index.html` muss auf dem Smartphone **lokal gespeichert** sein (z.B. im Download-Ordner oder √ºber Google Drive/Dropbox auf dem Handy abrufbar) und √ºber den Browser ge√∂ffnet werden.</p>
        
        <h3>4.2. Anleitung f√ºr iOS (Safari)</h3>
        <ol>
            <li>√ñffnen Sie die lokale `index.html`-Datei im **Safari-Browser**.</li>
            <li>Tippen Sie in der Navigationsleiste unten auf das **Teilen-Symbol** (Rechteck mit Pfeil nach oben).</li>
            <li>Scrollen Sie im Men√º nach unten und w√§hlen Sie die Option **"Zum Home-Bildschirm"**.</li>
            <li>Best√§tigen Sie den Namen und tippen Sie auf **"Hinzuf√ºgen"**.</li>
        </ol>

        <h3>4.3. Anleitung f√ºr Android (Chrome)</h3>
        <ol>
            <li>√ñffnen Sie die lokale `index.html`-Datei im **Chrome-Browser**.</li>
            <li>Tippen Sie auf das **Dreipunkt-Men√º** (‚ãÆ) oben rechts.</li>
            <li>W√§hlen Sie die Option **"Zum Startbildschirm hinzuf√ºgen"** (oder "App installieren").</li>
            <li>Best√§tigen Sie den Namen und tippen Sie auf **"Hinzuf√ºgen"**.</li>
        </ol>
        
        <div class="note">
            <p><strong class="strong">Ergebnis:</strong> Der Tracker startet nun direkt vom Home-Bildschirm, ohne die Browser-Steuerelemente, und verh√§lt sich wie eine App.</p>
        </div>

      </div>
    </div>
  </div>


  <script>
    // Global state
    let currentDate = new Date();
    let trackerData = {};
    let settings = {
        userName: "Nutzer",
        godMode: false,
        emptyDayHandling: 'neutral'
    };
    const DGE_MODERATE_MALE = 24; // Gramm reiner Alkohol pro Tag
    const DGE_MODERATE_FEMALE = 12; // Gramm reiner Alkohol pro Tag
    const BINGE_MALE = 60;
    const BINGE_FEMALE = 40;

    // --- Utility Functions ---

    function getDgeLimit() {
        // Hier m√ºsste sp√§ter die Abfrage des Geschlechts erfolgen. F√ºrs Erste nehmen wir den h√∂heren Wert an.
        return DGE_MODERATE_MALE; // Tempor√§r der h√∂here Wert
    }

    function getBingeLimit() {
        // Hier m√ºsste sp√§ter die Abfrage des Geschlechts erfolgen. F√ºrs Erste nehmen wir den h√∂heren Wert an.
        return BINGE_MALE; // Tempor√§r der h√∂here Wert
    }

    function getKey(date) {
        return date.toISOString().split('T')[0];
    }

    function loadData() {
        const data = localStorage.getItem('boozeTrackerData');
        if (data) {
            trackerData = JSON.parse(data);
        }
        const savedSettings = localStorage.getItem('boozeTrackerSettings');
        if (savedSettings) {
            settings = { ...settings, ...JSON.parse(savedSettings) };
        }
    }

    function saveData() {
        localStorage.setItem('boozeTrackerData', JSON.stringify(trackerData));
        localStorage.setItem('boozeTrackerSettings', JSON.stringify(settings));
        updateMonthView();
        updateScoreCard();
        updateStatsView();
        alert('Daten gespeichert!');
    }

    function saveSettings() {
        settings.userName = document.getElementById('userName').value;
        settings.godMode = document.getElementById('godModeToggle').checked;
        settings.emptyDayHandling = document.getElementById('emptyDayHandling').value;
        localStorage.setItem('boozeTrackerSettings', JSON.stringify(settings));
        initTooltips(); // Tooltips neu initialisieren wegen God-Mode-Anzeige
        ensureMonthHint();
        updateMonthView();
        updateScoreCard();
        updateStatsView();
        closeSettingsModal();
        alert('Einstellungen gespeichert!');
    }

    // --- Data Processing & Logic ---

    function determineStatus(dayData) {
        if (!dayData) return 'none';
        
        // 1. Check for God-Mode Grams
        if (settings.godMode && dayData.alcoholGrams !== undefined) {
            const grams = dayData.alcoholGrams;
            
            // Check for critical 'Hangover MIT Weitertrinken'
            if (dayData.checkHangover && grams > 0) return 'critical'; 

            // Check for overriden category
            if (dayData.categoryOverride) return dayData.categoryOverride;

            if (grams >= getBingeLimit()) return 'binge';
            if (grams > getDgeLimit()) return 'alcohol';
            if (grams > 0) return 'moderate';
            
            // If grams == 0, check for Sober/Wellness/Super behavior
            if (grams === 0) {
                if (dayData.superDay) return 'super';
                if (dayData.wellness) return 'wellness';
                return 'sober';
            }
        }

        // 2. Simple Mode or fallback
        return dayData.simpleStatus || 'none';
    }

    function calculateScore(today) {
        const endDate = today;
        const startDate = new Date(endDate);
        startDate.setDate(endDate.getDate() - 100);
        
        let totalWeight = 0;
        let weightedScore = 0;
        let consecutiveSoberDays = 0;
        let hasCriticalViolation = false;
        
        const dateIterator = new Date(startDate);
        const dayArray = [];

        // 1. Gather 100 days of data
        while (dateIterator <= endDate) {
            const key = getKey(dateIterator);
            const data = trackerData[key] || null;
            const status = determineStatus(data);
            dayArray.push({ key, status, data });
            dateIterator.setDate(dateIterator.getDate() + 1);
        }

        // 2. Calculate score components over 100 days
        dayArray.forEach((day, index) => {
            const isToday = index === dayArray.length - 1;
            let dayScore = 0;
            let weight = isToday ? 1.5 : 1; // Today is weighted higher (Focus on now)

            switch (day.status) {
                case 'super':
                    dayScore = 2.0; // Extra positive for Super-Day (2x base)
                    consecutiveSoberDays++;
                    break;
                case 'wellness':
                    dayScore = 1.5; // High positive (1.5x base)
                    consecutiveSoberDays++;
                    break;
                case 'sober':
                    dayScore = 1.0; // Positive base (1x base)
                    consecutiveSoberDays++;
                    break;
                case 'moderate':
                    dayScore = -0.5; // Slight negative
                    consecutiveSoberDays = 0;
                    break;
                case 'mixed':
                    dayScore = -1.0; // Negative base
                    consecutiveSoberDays = 0;
                    break;
                case 'alcohol':
                    dayScore = -2.0; // Strong negative
                    consecutiveSoberDays = 0;
                    break;
                case 'binge':
                    dayScore = -3.0; // Very strong negative
                    consecutiveSberDays = 0;
                    break;
                case 'critical':
                    dayScore = -5.0; // Critical: Hangover + drinking
                    hasCriticalViolation = true;
                    consecutiveSoberDays = 0;
                    break;
                case 'none':
                    if (settings.emptyDayHandling === 'punish') {
                        dayScore = -0.2; // Minor negative for not tracking
                    } else if (settings.emptyDayHandling === 'reward') {
                        dayScore = 0.5; // Minor positive (assuming Sober)
                    } else {
                        weight = 0; // Neutral: Don't count in total weight
                    }
                    consecutiveSoberDays = 0; // No positive continuity
                    break;
            }
            
            // Apply Continuity Bonus (Exponential decay for alcohol days)
            if (dayScore > 0 && consecutiveSoberDays > 1) {
                weight += Math.min(0.5, consecutiveSoberDays / 20); // Bonus up to 0.5 for long streaks
            }
            
            // Apply Recovery Bonus (Check previous day)
            if (index > 0 && dayScore > 0) {
                const prevDay = dayArray[index - 1];
                if (prevDay.status === 'binge' || prevDay.status === 'alcohol') {
                    weight += 1.0; // High bonus for successful recovery day (Clean Hangover)
                }
            }

            // Punish clusters
            if (index >= 2 && dayScore < 0) {
                const prev1 = dayArray[index - 1].status;
                const prev2 = dayArray[index - 2].status;
                if ((prev1 !== 'none' && prev1 !== 'sober' && prev1 !== 'wellness' && prev1 !== 'super') &&
                    (prev2 !== 'none' && prev2 !== 'sober' && prev2 !== 'wellness' && prev2 !== 'super')) {
                    weight *= 1.5; // 3+ day cluster penalty
                }
            }

            weightedScore += dayScore * weight;
            totalWeight += weight;
        });

        // 3. Final Score Calculation (Normalize to 0-100)
        // Max possible positive score (101 days * 2.0 max score * 1.5 max weight) approx 300
        // Max possible negative score (101 days * -5.0 min score * 1.5 max weight) approx -750
        const MAX_THEORETICAL_SCORE = 300; 
        const MIN_THEORETICAL_SCORE = -750;

        // Scale the score
        let finalScore = (weightedScore - MIN_THEORETICAL_SCORE) / (MAX_THEORETICAL_SCORE - MIN_THEORETICAL_SCORE);
        finalScore = Math.max(0, Math.min(1, finalScore)); // Clamp between 0 and 1
        finalScore = Math.round(finalScore * 100);

        // Overwrite if critical violation found
        if (hasCriticalViolation) {
             finalScore = 0;
        }

        return finalScore;
    }

    function getScoreDescription(score) {
        if (score === 0) return "üö® KRITISCHES RISIKO: Hangover MIT Weitertrinken oder chronisches Risikoverhalten.";
        if (score <= 20) return "Hohes Risiko: Dringende Ma√ünahmen zur Verhaltens√§nderung n√∂tig.";
        if (score <= 40) return "Erh√∂htes Risiko: Das Konsumverhalten ist instabil und belastend.";
        if (score <= 60) return "M√§√üiges Risiko: Achten Sie auf Konsumtage-Cluster und Binge-Trinken.";
        if (score <= 80) return "Gutes Verhalten: Tendenz zu Sober-Tagen. Aufbauen auf der Kontinuit√§t.";
        if (score <= 100) return "Optimal: Starke Kontinuit√§t und bewusster Umgang. Ausgezeichnet!";
        return "Berechne...";
    }

    function getScoreColorClass(score) {
        if (score === 0) return 'score-0-20';
        if (score <= 20) return 'score-0-20';
        if (score <= 40) return 'score-21-40';
        if (score <= 60) return 'score-41-60';
        if (score <= 80) return 'score-61-80';
        if (score <= 100) return 'score-81-100';
        return '';
    }

    function calculateStats() {
        const endDate = new Date();
        const startDate = new Date(endDate);
        startDate.setDate(endDate.getDate() - 180);

        const stats = {
            totalDays: 0,
            alcoholGramsSum: 0,
            soberDays: 0,
            bingeDays: 0,
            stressSum: 0,
            sleepSum: 0,
            alcoholDays: 0,
            sleepAlcoholCorrelation: 0,
            stressAlcoholCorrelation: 0,
            recoveryRate: 0, // In days
            bingeDaysList: []
        };
        
        const dateIterator = new Date(startDate);
        const dailyRecords = [];

        while (dateIterator <= endDate) {
            const key = getKey(dateIterator);
            const data = trackerData[key];
            const status = determineStatus(data);
            const grams = (settings.godMode && data && data.alcoholGrams !== undefined) ? data.alcoholGrams : 
                           (status === 'alcohol' || status === 'binge' || status === 'mixed') ? getDgeLimit() + 10 : 0; // Simple estimation

            stats.totalDays++;

            if (data && data.stressLevel) stats.stressSum += data.stressLevel;
            if (data && data.sleepQuality) stats.sleepSum += data.sleepQuality;

            if (grams > 0) {
                stats.alcoholGramsSum += grams;
                stats.alcoholDays++;
            }

            if (grams >= getBingeLimit()) {
                stats.bingeDays++;
                stats.bingeDaysList.push({ date: key, grams: grams });
            }

            if (status === 'sober' || status === 'wellness' || status === 'super') {
                stats.soberDays++;
            }
            
            dailyRecords.push({
                grams: grams,
                sleep: (data && data.sleepQuality) ? data.sleepQuality : 3,
                stress: (data && data.stressLevel) ? data.stressLevel : 3
            });
            
            dateIterator.setDate(dateIterator.getDate() + 1);
        }

        // --- Calculate Correlations (Simple Pearson/Covariance approximation) ---
        let covSleep = 0;
        let covStress = 0;
        let stdDevSleep = 0;
        let stdDevStress = 0;
        let stdDevGrams = 0;

        const avgGrams = stats.alcoholGramsSum / stats.totalDays;
        const avgSleep = stats.sleepSum / stats.totalDays;
        const avgStress = stats.stressSum / stats.totalDays;

        dailyRecords.forEach(record => {
            const gDiff = record.grams - avgGrams;
            const sQDff = record.sleep - avgSleep;
            const sTDff = record.stress - avgStress;

            covSleep += gDiff * sQDff;
            covStress += gDiff * sTDff;

            stdDevGrams += gDiff * gDiff;
            stdDevSleep += sQDff * sQDff;
            stdDevStress += sTDff * sTDff;
        });

        // Pearson Correlation = Cov(X,Y) / (StdDev(X) * StdDev(Y))
        const corrSleep = (Math.sqrt(stdDevGrams * stdDevSleep) === 0) ? 0 : covSleep / Math.sqrt(stdDevGrams * stdDevSleep);
        const corrStress = (Math.sqrt(stdDevGrams * stdDevStress) === 0) ? 0 : covStress / Math.sqrt(stdDevGrams * stdDevStress);

        stats.sleepAlcoholCorrelation = Math.round(corrSleep * 100);
        stats.stressAlcoholCorrelation = Math.round(corrStress * 100);
        
        // --- Calculate Recovery Rate ---
        let totalRecoveryDays = 0;
        let bingeEvents = 0;

        stats.bingeDaysList.forEach(bingeDay => {
            const bingeDate = new Date(bingeDay.date);
            let recoveryDays = 0;
            let recovered = false;
            let recoveryIterator = new Date(bingeDate);
            recoveryIterator.setDate(bingeDate.getDate() + 1);

            // Search for the first sober/wellness/super day after the binge
            while (recoveryIterator <= endDate && recoveryDays < 14) { // Max 14 days search
                const key = getKey(recoveryIterator);
                const status = determineStatus(trackerData[key]);
                
                if (status === 'sober' || status === 'wellness' || status === 'super') {
                    recovered = true;
                    break;
                }
                recoveryDays++;
                recoveryIterator.setDate(recoveryIterator.getDate() + 1);
            }

            if (recovered) {
                totalRecoveryDays += recoveryDays;
                bingeEvents++;
            }
        });

        stats.recoveryRate = (bingeEvents > 0) ? (totalRecoveryDays / bingeEvents).toFixed(1) : 'N/A';
        
        return stats;
    }


    // --- UI Update Functions ---

    function updateScoreCard() {
        const score = calculateScore(new Date());
        const card = document.getElementById('riskScoreCard');
        const value = document.getElementById('scoreValue');
        const description = document.getElementById('scoreDescription');
        const oldClass = card.className.split(' ').filter(c => c.startsWith('score-')).pop();

        if (oldClass) card.classList.remove(oldClass);
        card.classList.add(getScoreColorClass(score));

        value.textContent = `${score}%`;
        description.textContent = getScoreDescription(score);
    }
    
    function updateStatsView() {
        const stats = calculateStats();
        const list = document.getElementById('statsList');
        list.innerHTML = '';
        
        const avgWeeklyGrams = ((stats.alcoholGramsSum / stats.totalDays) * 7).toFixed(1);
        const soberQuote = ((stats.soberDays / stats.totalDays) * 100).toFixed(1);
        const bingeQuote = ((stats.bingeDays / stats.totalDays) * 100).toFixed(1);
        
        const corrs = [
            { type: 'Schlaf', value: stats.sleepAlcoholCorrelation, desc: 'Schlechter Schlaf nach Konsum' },
            { type: 'Stress', value: stats.stressAlcoholCorrelation, desc: 'Konsum bei hohem Stress' }
        ];

        const getCorrText = (val, type) => {
            let text = `(${val}%): `;
            if (val >= 30) text += `Starke Korrelation. ${type} scheint ein relevanter Trigger/Folgefaktor zu sein.`;
            else if (val >= 10) text += `M√§√üige Korrelation. Achtsamkeit ist geboten.`;
            else if (val <= -30) text += `Negative Korrelation. ${type} tritt paradoxerweise bei niedrigem Alkoholkonsum auf.`;
            else text += 'Geringe/Neutrale Korrelation.';
            return text;
        };


        list.innerHTML += `<li>**Abstinenztage (Sober/Wellness/Super):** ${stats.soberDays} von ${stats.totalDays} Tagen (${soberQuote}%)</li>`;
        list.innerHTML += `<li>**W√∂chentlicher Durchschnitt:** ${avgWeeklyGrams}g reiner Alkohol pro Woche (Ziel: <${getDgeLimit() * 7}g)</li>`;
        list.innerHTML += `<li>**Binge-Tage-Quote (${getBingeLimit()}g+):** ${stats.bingeDays} Tage (${bingeQuote}%)</li>`;
        list.innerHTML += `<li>**Durchschnittliche Erholung (Recovery Rate):** ${stats.recoveryRate} Tage (Nach Binge bis zum n√§chsten Sober-Tag)</li>`;
        
        corrs.forEach(c => {
            list.innerHTML += `<li>**Korrelation Alkohol/${c.type}:** ${getCorrText(c.value, c.type)}</li>`;
        });
    }


    function updateMonthView() {
        const monthView = document.getElementById('monthView');
        const monthName = document.getElementById('currentMonthName');
        monthView.innerHTML = '';

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Set Month Name
        const options = { year: 'numeric', month: 'long' };
        monthName.textContent = currentDate.toLocaleDateString('de-DE', options);

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Mon=0, Sun=6

        // Add Weekday Headers
        ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
            const header = document.createElement('div');
            header.textContent = day;
            header.style.fontWeight = '700';
            header.style.textAlign = 'center';
            header.style.padding = '5px';
            monthView.appendChild(header);
        });

        // Add empty cells for preceding month
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day-cell past-month';
            monthView.appendChild(emptyCell);
        }

        // Add current month days
        for (let i = 1; i <= lastDay.getDate(); i++) {
            const date = new Date(year, month, i);
            const key = getKey(date);
            const dayData = trackerData[key];
            const status = determineStatus(dayData);

            const cell = document.createElement('div');
            cell.className = `day-cell current-month status-${status}`;
            cell.dataset.date = key;
            cell.onclick = () => openDayModal(key);

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = i;

            const dayStatus = document.createElement('div');
            dayStatus.className = 'day-status';
            
            let statusText = '';
            if (status === 'sober') statusText = 'Sober';
            else if (status === 'wellness') statusText = 'Wellness';
            else if (status === 'super') statusText = 'Super';
            else if (status === 'moderate') statusText = 'Moderat';
            else if (status === 'mixed') statusText = 'Mixed';
            else if (status === 'alcohol') statusText = 'Alkohol';
            else if (status === 'binge' || status === 'critical') statusText = 'Vollrausch';
            else if (status === 'none') statusText = 'Leer';

            if (dayData && dayData.checkHangover) statusText += 'üí•';
            
            dayStatus.textContent = statusText;

            cell.appendChild(dayNumber);
            cell.appendChild(dayStatus);

            // Add Tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = dayData ? dayData.notes || 'Keine Notiz' : 'Keine Daten';
            cell.appendChild(tooltip);

            monthView.appendChild(cell);
        }
        initTooltips();
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        updateMonthView();
    }

    // --- Modal Handling ---

    const dayModal = document.getElementById('dayModal');
    const dayForm = document.getElementById('dayForm');
    const settingsModal = document.getElementById('settingsModal');
    const helpModal = document.getElementById('helpModal'); // NEW: Help Modal

    function openDayModal(dateKey) {
        const date = new Date(dateKey + 'T00:00:00'); // Ensure time zone neutrality
        document.getElementById('modalDate').textContent = date.toLocaleDateString('de-DE');
        document.getElementById('selectedDate').value = dateKey;
        
        const data = trackerData[dateKey] || {};

        // Display mode based on settings
        document.getElementById('godModeInputs').style.display = settings.godMode ? 'block' : 'none';
        document.getElementById('simpleModeInputs').style.display = settings.godMode ? 'none' : 'block';

        if (settings.godMode) {
            document.getElementById('alcoholGrams').value = data.alcoholGrams !== undefined ? data.alcoholGrams : 0;
            document.getElementById('categoryOverride').value = data.categoryOverride || '';
            document.getElementById('checkHangover').checked = !!data.checkHangover;
        } else {
            document.getElementById('simpleStatus').value = data.simpleStatus || 'sober';
            document.getElementById('simpleHangover').checked = !!data.checkHangover;
        }

        document.getElementById('sleepQuality').value = data.sleepQuality !== undefined ? data.sleepQuality : 3;
        document.getElementById('stressLevel').value = data.stressLevel !== undefined ? data.stressLevel : 3;
        document.getElementById('notes').value = data.notes || '';

        dayModal.style.display = 'block';
    }

    function closeDayModal() {
        dayModal.style.display = 'none';
    }

    dayForm.onsubmit = function(e) {
        e.preventDefault();
        const dateKey = document.getElementById('selectedDate').value;
        const formData = {};

        if (settings.godMode) {
            formData.alcoholGrams = parseInt(document.getElementById('alcoholGrams').value) || 0;
            formData.categoryOverride = document.getElementById('categoryOverride').value;
            formData.checkHangover = document.getElementById('checkHangover').checked;

            // Simplified mapping for notes/context (only used for display if no grammar specified)
            formData.simpleStatus = determineStatus(formData); // Use the logic to derive simple status
        } else {
            formData.simpleStatus = document.getElementById('simpleStatus').value;
            formData.checkHangover = document.getElementById('simpleHangover').checked;
        }
        
        formData.sleepQuality = parseInt(document.getElementById('sleepQuality').value) || 3;
        formData.stressLevel = parseInt(document.getElementById('stressLevel').value) || 3;
        formData.notes = document.getElementById('notes').value;
        
        // Remove entry if 'none' is selected in simple mode
        if (!settings.godMode && formData.simpleStatus === 'none') {
            delete trackerData[dateKey];
        } else {
            trackerData[dateKey] = formData;
        }

        saveData();
        closeDayModal();
    };

    // --- Settings Modal Functions ---
    document.getElementById('openSettingsBtn').onclick = function() {
        document.getElementById('userName').value = settings.userName;
        document.getElementById('godModeToggle').checked = settings.godMode;
        document.getElementById('emptyDayHandling').value = settings.emptyDayHandling;
        settingsModal.style.display = 'block';
    }

    function closeSettingsModal() {
        settingsModal.style.display = 'none';
    }

    // --- Data Export/Import Functions ---
    function exportData() {
        const dataStr = JSON.stringify({ data: trackerData, settings: settings }, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const date = new Date().toISOString().split('T')[0];
        a.download = `booze-tracker-backup-${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(merge = false) {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) {
            alert("Bitte zuerst eine JSON-Datei ausw√§hlen.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importedObj = JSON.parse(event.target.result);
                const importedData = importedObj.data || importedObj; // Handle old format
                const importedSettings = importedObj.settings || {};

                if (merge) {
                    trackerData = { ...trackerData, ...importedData };
                    settings = { ...settings, ...importedSettings };
                    alert('Daten erfolgreich zusammengef√ºhrt (Merge).');
                } else {
                    trackerData = importedData;
                    settings = { ...settings, ...importedSettings };
                    alert('Daten erfolgreich ersetzt.');
                }
                saveData();
                closeSettingsModal();
                updateSettingsForm();
            } catch (e) {
                alert("Fehler beim Import der Datei. Stellen Sie sicher, dass es eine g√ºltige Booze-Tracker JSON-Datei ist.");
                console.error(e);
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if (confirm("Sind Sie SICHER, dass Sie ALLE Tracker-Daten und Einstellungen unwiderruflich l√∂schen m√∂chten?")) {
            localStorage.removeItem('boozeTrackerData');
            localStorage.removeItem('boozeTrackerSettings');
            trackerData = {};
            settings = { userName: "Nutzer", godMode: false, emptyDayHandling: 'neutral' };
            currentDate = new Date();
            updateMonthView();
            updateScoreCard();
            updateStatsView();
            updateSettingsForm();
            closeSettingsModal();
            alert('Alle Daten wurden gel√∂scht.');
        }
    }
    
    function updateSettingsForm() {
        // Ensures the settings modal shows the correct, loaded settings upon reopening
        document.getElementById('userName').value = settings.userName;
        document.getElementById('godModeToggle').checked = settings.godMode;
        document.getElementById('emptyDayHandling').value = settings.emptyDayHandling;
    }

    // --- Helper Functions ---
    function initTooltips() {
      // Re-initializes tooltips to ensure the God-Mode hint is correct.
      // (This function existed in the original snippet, we re-implement it minimally)
    }

    function ensureMonthHint() {
      try{
        var head = document.querySelector('.month-head');
        if(!head) return;
        var hint = document.getElementById('monthHint');
        if(!hint){
          hint = document.createElement('div');
          hint.id = 'monthHint';
          hint.className = 'month-hint';
          head.insertAdjacentElement('afterend', hint);
        }
        var gmActive = settings.godMode;
        var base = 'Hinweis: F√ºr genaue Eingabe der Alkoholmengen in den Einstellungen den God-Mode aktivieren.';
        hint.innerHTML = gmActive ? base + ' <span class="gm-badge">Godmode activated</span>' : base;
      }catch(e){ /* no-op */ }
    }


    // --- NEW: Help Modal Functions ---
    const helpModalElem = document.getElementById("helpModal");

    window.openHelpModal = function() {
      helpModalElem.style.display = "block";
    }

    window.closeHelpModal = function() {
      helpModalElem.style.display = "none";
    }
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == helpModalElem || event.target == dayModal || event.target == settingsModal) {
            helpModalElem.style.display = 'none';
            dayModal.style.display = 'none';
            settingsModal.style.display = 'none';
        }
    }
    

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        ensureMonthHint();
        updateMonthView();
        updateScoreCard();
        updateStatsView();
        updateSettingsForm();
        
        // Ensure the help link calls the new modal function
        const helpLink = document.querySelector('a[onclick="openHelpModal()"]');
        if (helpLink) {
          // Set href to javascript:void(0) to prevent page reload/jump
          helpLink.href = 'javascript:void(0)'; 
        }
    });

    // Hook into updateMonthView (call afterwards)
    var _updateMonthView = updateMonthView;
    window.updateMonthView = function() {
        var res = _updateMonthView.apply(this, arguments);
        ensureMonthHint();
        return res;
    };
    
  </script>

</body>
</html>