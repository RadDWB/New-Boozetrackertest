<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 18px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }

    /* Eingabe */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 10px 0 18px;
    }

    /* Kommentarfeld Styling */
    .comment-section{
      margin-bottom: 20px;
    }
    
    .comment-label{
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    
    textarea{
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    textarea:focus{
      outline: none;
      border-color: var(--primary);
    }
    
    textarea::placeholder{
      color: #94a3b8;
    }

    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 16px;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }

    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
      position:relative;
    }
    .choice-option.superday::before{ content:"‚≠ê"; position:absolute; right:12px; top:10px; opacity:.9; }

    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* Data Management Buttons */
    .data-management{
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .data-management .btn{
      flex: 1;
      min-width: 140px;
      height: 42px;
      font-size: 14px;
    }

    /* Monats√ºbersicht */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    /* Erfolgsquote Ampel */
    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    /* Streak Ampel */
    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Balkendiagramm f√ºr 100 Tage */
    .chart-section{
      margin: 18px 0;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }
    .chart-title{
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
    }
    .chart-bars{
      display: flex;
      flex-direction: column;
      gap: 32px;
      margin-bottom: 10px;
    }
    .chart-bar-container{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-bar-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chart-bar-label{
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .chart-bar-label small{
      display: block;
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
      margin-top: 2px;
    }
    .chart-bar-percent{
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }
    .chart-bar-wrapper{
      height: 32px;
      background: #e5e7eb;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
    }
    .chart-bar{
      height: 100%;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 16px;
      position: relative;
    }
    .chart-bar.negative{ 
      background: linear-gradient(90deg, #fca5a5, #ef4444, #dc2626);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    .chart-bar.positive{ 
      background: linear-gradient(90deg, #86efac, #10b981, #059669);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Animation */
    @keyframes slideIn {
      from { width: 0; }
      to { width: var(--bar-width); }
    }

    /* Calendar */
    .calendar-nav{ display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .calendar-nav h2{ margin:0; font-size: clamp(20px, 4vw, 28px); color:var(--text); }
    .month-nav{ display:flex; gap:8px; }
    .nav-btn{
      width: 40px; height: 40px; border-radius: 10px; border:0;
      background:var(--primary); color:#fff; font-size:18px;
      cursor:pointer; transition:.15s ease;
      display:flex; align-items:center; justify-content:center;
    }
    .nav-btn:hover{ background:var(--primary-dark); transform: translateY(-1px); }

    .calendar{
      display:grid; grid-template-columns:repeat(7,1fr);
      gap:6px; margin-bottom:16px;
    }
    @media (max-width:640px){ .calendar{ gap:3px; } }

    .calendar-header, .calendar-day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center;
      font-weight:600; border-radius:10px;
    }
    .calendar-header{ background:#f1f5f9; color:var(--muted); font-size: clamp(11px, 1.8vw, 13px); }
    .calendar-day{
      background:#fff; border:1.5px solid #e5e7eb; cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      position:relative;
      font-size: clamp(12px, 2.2vw, 15px);
    }
    .calendar-day:hover:not(.empty){ transform:scale(1.08); box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .calendar-day.empty{ background:transparent; border:0; cursor:default; }
    .calendar-day.sober{ background:#d1fae5; border-color:#86efac; color:#065f46; }
    .calendar-day.wellness{ background:#bbf7d0; border-color:#4ade80; color:#14532d; }
    .calendar-day.moderate{ background:#fed7aa; border-color:#fdba74; color:#7c2d12; }
    .calendar-day.mixed{ background:#fecaca; border-color:#f87171; color:#991b1b; }
    .calendar-day.alcohol{ background:#fecaca; border-color:#f87171; color:#991b1b; }
    .calendar-day.superday{
      background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
      border-color:#34d399;
      color:#065f46;
      font-weight:900;
      box-shadow:0 0 0 1px #10b981 inset;
    }
    .calendar-day.superday::before{ content:"‚≠ê"; position:absolute; top:2px; right:3px; font-size:10px; opacity:.85; }
    .calendar-day.today{ box-shadow: 0 0 0 2.5px var(--primary) inset; font-weight: 900; }
    .calendar-day.has-comment::after{
      content: "üí¨";
      position: absolute;
      bottom: 2px;
      right: 3px;
      font-size: 10px;
      opacity: 0.7;
    }

    /* Modal overlay */
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.5); display:none;
      z-index:998;
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay.active{ display:block; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Edit popup */
    .edit-popup{
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      background:#fff;
      border-radius: 20px;
      padding:28px;
      max-width:480px;
      width:calc(100% - 32px);
      box-shadow:0 20px 50px rgba(0,0,0,.3);
      display:none;
      z-index:999;
      animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .edit-popup.active{ display:block; }

    @keyframes popIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .popup-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .popup-date{
      font-size:22px;
      font-weight:800;
      color:var(--primary);
      margin: 0;
    }

    /* Close button */
    .close-btn{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid #e5e7eb;
      background: #fff;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .close-btn:hover{
      background: #f1f5f9;
      color: var(--text);
      border-color: var(--primary);
    }

    .popup-actions{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
      margin-bottom: 16px;
    }
    @media (max-width:480px){ .popup-actions{ grid-template-columns:1fr; } }

    .popup-btn{
      padding: 12px 16px;
      border-radius: 12px;
      border:0;
      font-weight:600;
      cursor:pointer;
      transition:.15s ease;
      font-size: 14px;
    }
    .popup-btn:hover{ transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .popup-btn.sober{ background:#d1fae5; color:#065f46; }
    .popup-btn.wellness{ background:#bbf7d0; color:#14532d; }
    .popup-btn.moderate{ background:#fed7aa; color:#7c2d12; }
    .popup-btn.mixed{ background:#fecaca; color:#991b1b; }
    .popup-btn.alcohol{ background:#fecaca; color:#991b1b; }
    .popup-btn.superday{ background:linear-gradient(135deg, #a7f3d0, #6ee7b7); color:#065f46; position:relative; }
    .popup-btn.superday::before{ content:"‚≠ê"; position:absolute; right:8px; top:6px; opacity:.8; }
    .popup-btn.delete{
      background:#ef4444; color:#fff;
      grid-column: span 2;
      margin-top: 4px;
    }

    /* Chart popup */
    .chart-popup{
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      max-width: 680px;
      width: calc(100% - 32px);
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,.3);
      display: none;
      z-index: 999;
    }
    .chart-popup.active{ display: block; }

    .popup-close{
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f3f4f6;
      border: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: background .2s ease;
    }
    .popup-close:hover{ background: #e5e7eb; }

    /* Settings */
    .settings-section{
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #e5e7eb;
    }
    .settings-title{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }
    .settings-info{
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .settings-options{
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .settings-option{
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .settings-option:hover{
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    .settings-option.selected{
      background: #ede9fe;
      border-color: var(--primary);
    }
    .settings-option input[type="radio"]{
      margin: 0;
      transform: scale(1.2);
      accent-color: var(--primary);
    }
    .settings-label{
      flex: 1;
    }
    .settings-label-main{
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    .settings-label-sub{
      font-size: 13px;
      color: var(--muted);
    }

    /* Health Assessment */
    .health-section{
      margin: 24px 0;
      padding: 20px;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #bae6fd;
      border-radius: 16px;
    }
    .health-title{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
      text-align: center;
    }
    .health-metrics{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .health-metric{
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e0e7ff;
    }
    .metric-value{
      font-size: 24px;
      font-weight: 900;
      margin: 4px 0;
    }
    .metric-label{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .health-status{
      padding: 16px;
      background: white;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 8px;
    }
    .status-badge{
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .status-excellent{ background: #d1fae5; color: #065f46; }
    .status-good{ background: #fef3c7; color: #78350f; }
    .status-concern{ background: #fee2e2; color: #991b1b; }
    .health-message{
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
    }

    /* AUDIT-C Section */
    .audit-section{
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #e5e7eb;
    }
    .audit-title{
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .audit-subtitle{
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .audit-question{
      margin-bottom: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .audit-question-text{
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }
    .audit-options{
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .audit-option{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .audit-option:hover{
      background: #f1f5f9;
      border-color: var(--primary);
    }
    .audit-option input[type="radio"]{
      margin: 0;
      transform: scale(1.2);
      accent-color: var(--primary);
    }
    .audit-option label{
      flex: 1;
      cursor: pointer;
      font-size: 14px;
    }
    
    .audit-gender{
      margin-bottom: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .audit-gender label{
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .audit-gender select{
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }
    
    .audit-submit{
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .audit-submit:hover{
      background: var(--primary-dark);
    }
    
    .audit-result{
      display: none;
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
    }
    .audit-result.low{
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #86efac;
    }
    .audit-result.medium{
      background: #fef3c7;
      color: #78350f;
      border: 1px solid #fbbf24;
    }
    .audit-result.high{
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #f87171;
    }

    /* Settings Popup */
    .settings-popup{
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      max-width: 500px;
      width: calc(100% - 32px);
      box-shadow: 0 20px 50px rgba(0,0,0,.3);
      display: none;
      z-index: 999;
    }
    .settings-popup.active{ display: block; }
    
    .settings-popup-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .settings-popup-title{
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }
    
    .settings-actions{
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .settings-actions .btn{
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Eingabe-View -->
    <div id="dayInputView" class="view active">
      <h1>üç∑ Booze-Tracker</h1>
      <div class="current-date" id="currentDate">‚Äî</div>
      
      <!-- Kommentarfeld VOR der Auswahl -->
      <div class="comment-section">
        <label class="comment-label" for="dayCommentInput">Notiz f√ºr heute (optional):</label>
        <textarea 
          id="dayCommentInput" 
          placeholder="z.B. Geburtstag gefeiert, war m√ºde, Sport gemacht..."
          maxlength="500"
        ></textarea>
      </div>
      
      <div class="choice-container">
        <label class="choice-option sober"><input type="radio" name="dayChoice" value="sober" /> üå± AF (n√ºchtern)</label>
        <label class="choice-option wellness"><input type="radio" name="dayChoice" value="wellness" /> üí™ Wellness-Tag</label>
        <label class="choice-option moderate"><input type="radio" name="dayChoice" value="moderate" /> üç∫ Moderat (1-2)</label>
        <label class="choice-option mixed"><input type="radio" name="dayChoice" value="mixed" /> üçπ Gemischt (3-4)</label>
        <label class="choice-option alcohol"><input type="radio" name="dayChoice" value="alcohol" /> üçª Zu viel (5+)</label>
        <label class="choice-option superday"><input type="radio" name="dayChoice" value="superday" /> Super-Tag</label>
      </div>
      <div class="submit-row">
        <button class="btn" id="submitDay" disabled>Tag speichern</button>
        <button class="btn secondary" onclick="showMonthView()">üìä Monats√ºbersicht</button>
      </div>
      <div class="storage-info" id="storageInfo">‚ö†Ô∏è Achtung: Lokaler Speicher funktioniert nicht!</div>
      
      <!-- Data Management Buttons -->
      <div class="data-management">
        <button class="btn secondary" onclick="exportData()">üì§ Daten exportieren</button>
        <button class="btn secondary" onclick="importData()">üì• Daten importieren</button>
        <button class="btn danger" onclick="resetStorage()">üóëÔ∏è Alle Daten l√∂schen</button>
      </div>
    </div>

    <!-- Monats-View -->
    <div id="monthView" class="view">
      <h1>üìä Monats√ºbersicht</h1>
      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktuelle Serie</div>
          <div class="stat-number" id="currentStreak">‚Äî</div>
        </div>
        <div class="stat-card" id="rateCard">
          <div class="stat-label">AF-Quote (30 Tage)</div>
          <div class="stat-number" id="successRate">‚Äî</div>
        </div>
      </div>
      <div class="calendar-nav">
        <h2 id="currentMonthYear">‚Äî</h2>
        <div class="month-nav">
          <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
          <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
        </div>
      </div>
      <div class="calendar" id="calendar"></div>
      <button class="btn" onclick="toggleChartPopup()">üìà Gesundheits-Dashboard (100 Tage)</button>
      <button class="btn secondary" onclick="toggleSettingsPopup()" style="margin-top: 12px;">‚öôÔ∏è Einstellungen</button>
      <button class="btn secondary" onclick="showDayInput()" style="margin-top: 12px;">üìù Zur√ºck zur Eingabe</button>
      
      <!-- Data Management Buttons auch hier -->
      <div class="data-management">
        <button class="btn secondary" onclick="exportData()">üì§ Daten exportieren</button>
        <button class="btn secondary" onclick="importData()">üì• Daten importieren</button>
        <button class="btn danger" onclick="resetStorage()">üóëÔ∏è Alle Daten l√∂schen</button>
      </div>
    </div>
  </div>

  <!-- Bearbeitungs-Popup -->
  <div class="modal-overlay" id="editOverlay"></div>
  <div class="edit-popup" id="editPopup" aria-hidden="true">
    <div class="popup-header">
      <h3 class="popup-date" id="editDate">‚Äî</h3>
      <button class="close-btn" onclick="closeEditPopup()">√ó</button>
    </div>
    
    <!-- Kommentarfeld auch hier VOR den Aktionen -->
    <div class="comment-section">
      <label class="comment-label" for="editCommentInput">Notiz bearbeiten:</label>
      <textarea 
        id="editCommentInput" 
        placeholder="Notiz hinzuf√ºgen..."
        maxlength="500"
      ></textarea>
      <button class="btn secondary" onclick="saveEditComment()" style="margin-top: 8px;">üíæ Notiz speichern</button>
    </div>
    
    <div class="popup-actions">
      <button class="popup-btn sober" onclick="updateDay('sober')">üå± AF</button>
      <button class="popup-btn wellness" onclick="updateDay('wellness')">üí™ Wellness</button>
      <button class="popup-btn moderate" onclick="updateDay('moderate')">üç∫ Moderat</button>
      <button class="popup-btn mixed" onclick="updateDay('mixed')">üçπ Gemischt</button>
      <button class="popup-btn alcohol" onclick="updateDay('alcohol')">üçª Zu viel</button>
      <button class="popup-btn superday" onclick="updateDay('superday')">‚≠ê Super-Tag</button>
      <button class="popup-btn delete" onclick="updateDay('delete')">üóëÔ∏è Tag l√∂schen</button>
    </div>
  </div>

  <!-- Chart Popup -->
  <div class="modal-overlay" id="chartOverlay"></div>
  <div class="chart-popup" id="chartPopup" aria-hidden="true">
    <button class="popup-close" onclick="toggleChartPopup()">√ó</button>
    <h2 style="margin-bottom: 24px; text-align: center;">üìà 100-Tage-Analyse</h2>
    
    <div class="chart-section">
      <div class="chart-bars" id="chartBars"></div>
    </div>
    
    <div class="health-section">
      <div class="health-title">üè• Gesundheitsbewertung (100 Tage)</div>
      <div id="healthAssessment"></div>
    </div>
    
    <div class="audit-section">
      <div class="audit-title">AUDIT-C Schnelltest</div>
      <div class="audit-subtitle">Wissenschaftlicher WHO-Screening-Test zur Einsch√§tzung des Alkoholkonsumrisikos</div>
      
      <div class="audit-gender">
        <label for="auditGender">Geschlecht (f√ºr angepasste Grenzwerte):</label>
        <select id="auditGender">
          <option value="male">M√§nnlich</option>
          <option value="female">Weiblich</option>
        </select>
      </div>
      
      <div class="audit-question">
        <div class="audit-question-text">1. Wie oft trinkst du Alkohol?</div>
        <div class="audit-options">
          <div class="audit-option">
            <input type="radio" name="auditQ1" value="0" id="q1_0">
            <label for="q1_0">Nie</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ1" value="1" id="q1_1">
            <label for="q1_1">1x pro Monat oder seltener</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ1" value="2" id="q1_2">
            <label for="q1_2">2-4x pro Monat</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ1" value="3" id="q1_3">
            <label for="q1_3">2-3x pro Woche</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ1" value="4" id="q1_4">
            <label for="q1_4">4x oder √∂fter pro Woche</label>
          </div>
        </div>
      </div>
      
      <div class="audit-question">
        <div class="audit-question-text">2. Wenn du trinkst, wie viele Drinks nimmst du normalerweise? (1 Drink = 1 Bier/Wein/Shot)</div>
        <div class="audit-options">
          <div class="audit-option">
            <input type="radio" name="auditQ2" value="0" id="q2_0">
            <label for="q2_0">1-2 Drinks</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ2" value="1" id="q2_1">
            <label for="q2_1">3-4 Drinks</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ2" value="2" id="q2_2">
            <label for="q2_2">5-6 Drinks</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ2" value="3" id="q2_3">
            <label for="q2_3">7-9 Drinks</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ2" value="4" id="q2_4">
            <label for="q2_4">10 oder mehr Drinks</label>
          </div>
        </div>
      </div>
      
      <div class="audit-question">
        <div class="audit-question-text">3. Wie oft trinkst du 6 oder mehr Drinks bei einer Gelegenheit?</div>
        <div class="audit-options">
          <div class="audit-option">
            <input type="radio" name="auditQ3" value="0" id="q3_0">
            <label for="q3_0">Nie</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ3" value="1" id="q3_1">
            <label for="q3_1">Seltener als monatlich</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ3" value="2" id="q3_2">
            <label for="q3_2">Monatlich</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ3" value="3" id="q3_3">
            <label for="q3_3">W√∂chentlich</label>
          </div>
          <div class="audit-option">
            <input type="radio" name="auditQ3" value="4" id="q3_4">
            <label for="q3_4">T√§glich oder fast t√§glich</label>
          </div>
        </div>
      </div>
      
      <button class="audit-submit" onclick="calculateAuditScore()">Test auswerten</button>
      <div class="audit-result" id="auditResult"></div>
    </div>
    
    <div class="settings-section">
      <div class="settings-title">‚öôÔ∏è Berechnungseinstellungen</div>
      <div class="settings-info">
        Wie sollen Tage ohne Eintrag (graue Tage) in der Statistik gez√§hlt werden?
      </div>
      <div class="settings-options">
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="negative">
          <div class="settings-label">
            <div class="settings-label-main">Als Trinktag werten</div>
            <div class="settings-label-sub">Graue Tage = Alkoholtage (strenger)</div>
          </div>
        </label>
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="ignore" checked>
          <div class="settings-label">
            <div class="settings-label-main">Ignorieren</div>
            <div class="settings-label-sub">Nur eingetragene Tage z√§hlen (Standard)</div>
          </div>
        </label>
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="positive">
          <div class="settings-label">
            <div class="settings-label-main">Als AF-Tag werten</div>
            <div class="settings-label-sub">Graue Tage = n√ºchterne Tage (optimistisch)</div>
          </div>
        </label>
      </div>
      <button class="btn" onclick="saveSettings()">üíæ Einstellung speichern</button>
    </div>
  </div>

  <!-- Settings Popup -->
  <div class="modal-overlay" id="settingsOverlay"></div>
  <div class="settings-popup" id="settingsPopup" aria-hidden="true">
    <div class="settings-popup-header">
      <h3 class="settings-popup-title">‚öôÔ∏è Einstellungen</h3>
      <button class="close-btn" onclick="toggleSettingsPopup()">√ó</button>
    </div>
    
    <div class="settings-section" style="margin-top: 0; padding-top: 0; border-top: none;">
      <div class="settings-info">
        Wie sollen Tage ohne Eintrag (graue Tage) in der Statistik gez√§hlt werden?
      </div>
      <div class="settings-options">
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="negative">
          <div class="settings-label">
            <div class="settings-label-main">Als Trinktag werten</div>
            <div class="settings-label-sub">Graue Tage = Alkoholtage (strenger)</div>
          </div>
        </label>
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="ignore" checked>
          <div class="settings-label">
            <div class="settings-label-main">Ignorieren</div>
            <div class="settings-label-sub">Nur eingetragene Tage z√§hlen (Standard)</div>
          </div>
        </label>
        <label class="settings-option">
          <input type="radio" name="neutralDays" value="positive">
          <div class="settings-label">
            <div class="settings-label-main">Als AF-Tag werten</div>
            <div class="settings-label-sub">Graue Tage = n√ºchterne Tage (optimistisch)</div>
          </div>
        </label>
      </div>
    </div>
    
    <div class="settings-actions">
      <button class="btn secondary" onclick="toggleSettingsPopup()">Abbrechen</button>
      <button class="btn" onclick="saveSettings()">üíæ Speichern</button>
    </div>
  </div>

  <script>
    // Data
    let dayData = {};
    let currentInputDate = new Date();
    let currentViewDate = new Date();
    let storageWorking = false;
    let editingDate = null;
    let neutralDaysSetting = 'ignore';

    // Storage test
    function testStorage(){
      try{
        const test = '__test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        storageWorking = true;
        document.getElementById('storageInfo').style.display = 'none';
      }catch(e){
        storageWorking = false;
        console.warn('LocalStorage nicht verf√ºgbar:', e);
      }
    }

    // Load/Save
    function loadData(){
      if(!storageWorking) return;
      try{
        const data = localStorage.getItem('alcoholTrackerData');
        if(data) dayData = JSON.parse(data);
        const savedDate = localStorage.getItem('alcoholTrackerCurrentDate');
        if(savedDate) currentInputDate = new Date(savedDate);
        
        // Load settings
        const settings = localStorage.getItem('alcoholTrackerSettings');
        if(settings){
          const parsed = JSON.parse(settings);
          neutralDaysSetting = parsed.neutralDays || 'ignore';
        }
      }catch(e){ console.warn('Daten konnten nicht geladen werden:', e); }
    }

    function saveData(){
      if(!storageWorking) return false;
      try{
        localStorage.setItem('alcoholTrackerData', JSON.stringify(dayData));
        localStorage.setItem('alcoholTrackerCurrentDate', currentInputDate.toISOString());
        return true;
      }catch(e){
        console.error('Speichern fehlgeschlagen:', e);
        alert('‚ùå Fehler beim Speichern! Der Speicher k√∂nnte voll sein.');
        return false;
      }
    }

    // Export/Import Functions
    function exportData(){
      const exportObject = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: dayData,
        settings: {
          neutralDays: neutralDaysSetting
        }
      };
      
      const dataStr = JSON.stringify(exportObject, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `booze-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Feedback
      alert('‚úÖ Daten erfolgreich exportiert!');
    }
    
    function importData(){
      // Warnung
      if(!confirm('‚ö†Ô∏è Beim Import werden existierende Daten √ºberschrieben. Vorher ein Backup machen?\n\nOK = Fortfahren\nAbbrechen = Zur√ºck')){
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.readAsText(file);
        reader.onload = readerEvent => {
          try {
            const imported = JSON.parse(readerEvent.target.result);
            
            // Validierung
            if(!imported.data){
              throw new Error('Ung√ºltiges Dateiformat');
            }
            
            // Daten √ºbernehmen
            dayData = imported.data;
            
            // Settings √ºbernehmen falls vorhanden
            if(imported.settings && imported.settings.neutralDays){
              neutralDaysSetting = imported.settings.neutralDays;
            }
            
            // Speichern
            saveData();
            if(storageWorking){
              localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
                neutralDays: neutralDaysSetting
              }));
            }
            
            alert('‚úÖ Daten erfolgreich importiert!');
            location.reload();
          } catch(err){
            console.error('Import-Fehler:', err);
            alert('‚ùå Fehler beim Import: ' + err.message);
          }
        }
      };
      input.click();
    }

    // Utility functions
    function formatDateKey(d){ 
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
    }
    
    function parseDate(s){ 
      const [y,m,d] = s.split('-'); 
      return new Date(+y, +m-1, +d); 
    }
    
    // Neue Helper-Funktionen f√ºr Status und Kommentare
    function getDayStatus(key){
      const data = dayData[key];
      if(!data) return null;
      if(typeof data === 'string') return data; // Alte Datenstruktur
      return data.status; // Neue Datenstruktur
    }
    
    function getDayComment(key){
      const data = dayData[key];
      if(!data) return '';
      if(typeof data === 'string') return ''; // Alte Datenstruktur hat keine Kommentare
      return data.comment || ''; // Neue Datenstruktur
    }

    // Views
    function showDayInput(){
      document.getElementById('dayInputView').classList.add('active');
      document.getElementById('monthView').classList.remove('active');
      updateDayInputView();
    }

    function showMonthView(){
      document.getElementById('dayInputView').classList.remove('active');
      document.getElementById('monthView').classList.add('active');
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }

    function updateDayInputView(){
      // Pr√ºfe ob f√ºr heute schon ein Eintrag existiert
      const today = new Date();
      const todayKey = formatDateKey(today);
      const existingEntry = getDayStatus(todayKey);
      
      if(existingEntry){
        // Zeige heutigen Tag mit vorhandenem Eintrag
        currentInputDate = today;
        document.getElementById('currentDate').textContent = currentInputDate.toLocaleDateString('de-DE', 
          { weekday:'long', day:'numeric', month:'long' });
        
        // Setze Radio-Button
        const radio = document.querySelector(`input[name="dayChoice"][value="${existingEntry}"]`);
        if(radio) radio.checked = true;
        
        // Setze Kommentar
        document.getElementById('dayCommentInput').value = getDayComment(todayKey);
        
        // Button-Text anpassen
        document.getElementById('submitDay').textContent = 'Tag aktualisieren';
        document.getElementById('submitDay').disabled = false;
      } else {
        // Normale Anzeige f√ºr neuen Tag
        document.getElementById('currentDate').textContent = currentInputDate.toLocaleDateString('de-DE', 
          { weekday:'long', day:'numeric', month:'long' });
        document.getElementById('submitDay').textContent = 'Tag speichern';
      }
    }

    function updateMonthView(){
      const y = currentViewDate.getFullYear();
      const m = currentViewDate.getMonth();
      const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      document.getElementById('currentMonthYear').textContent = `${monthNames[m]} ${y}`;

      const firstDay = new Date(y, m, 1).getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const cal = document.getElementById('calendar');
      cal.innerHTML = '';

      ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d => {
        const h = document.createElement('div');
        h.className = 'calendar-header';
        h.textContent = d;
        cal.appendChild(h);
      });

      const startOffset = firstDay === 0 ? 6 : firstDay - 1;
      for(let i = 0; i < startOffset; i++){
        const e = document.createElement('div');
        e.className = 'calendar-day empty';
        cal.appendChild(e);
      }

      const today = new Date();
      for(let d = 1; d <= daysInMonth; d++){
        const cell = document.createElement('div');
        const dateObj = new Date(y, m, d);
        const key = formatDateKey(dateObj);
        const status = getDayStatus(key);
        const comment = getDayComment(key);
        
        cell.className = 'calendar-day';
        if(status) cell.classList.add(status);
        if(comment) cell.classList.add('has-comment');
        if(dateObj.toDateString() === today.toDateString()) cell.classList.add('today');
        
        cell.textContent = d;
        cell.onclick = () => openEditPopup(dateObj);
        cal.appendChild(cell);
      }
    }

    // Edit popup
    function openEditPopup(date){
      editingDate = date;
      const key = formatDateKey(date);
      const status = getDayStatus(key);
      const comment = getDayComment(key);
      
      document.getElementById('editDate').textContent = date.toLocaleDateString('de-DE', 
        { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      document.getElementById('editCommentInput').value = comment;
      
      document.getElementById('editPopup').classList.add('active');
      document.getElementById('editOverlay').classList.add('active');
      document.getElementById('editPopup').setAttribute('aria-hidden', 'false');
      
      // Overlay-Klick zum Schlie√üen
      document.getElementById('editOverlay').onclick = closeEditPopup;
    }

    function closeEditPopup(){
      editingDate = null;
      document.getElementById('editPopup').classList.remove('active');
      document.getElementById('editOverlay').classList.remove('active');
      document.getElementById('editPopup').setAttribute('aria-hidden', 'true');
    }

    // Streak calculation
    function calculateStreak(){
      const today = new Date();
      let streak = 0;
      const positiveTypes = neutralDaysSetting === 'positive' 
        ? ['sober', 'wellness', 'superday', null]
        : ['sober', 'wellness', 'superday'];

      for(let i = 0; i < 365; i++){
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDateKey(d);
        const status = getDayStatus(key);
        
        if(neutralDaysSetting === 'ignore' && status === null) continue;
        if(positiveTypes.includes(status)){
          streak++;
        } else {
          break;
        }
      }

      document.getElementById('currentStreak').textContent = `${streak} Tage`;
      
      const card = document.getElementById('streakCard');
      card.className = 'stat-card';
      if(streak === 0) card.classList.add('streak-bad');
      else if(streak < 7) card.classList.add('streak-warn');
      else if(streak < 30) card.classList.add('streak-good');
      else card.classList.add('streak-great');
    }

    // Success rate calculation
    function calculateSuccessRate(){
      const today = new Date();
      let totalDays = 0;
      let positiveDays = 0;
      const positiveTypes = ['sober', 'wellness', 'superday'];

      for(let i = 0; i < 30; i++){
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDateKey(d);
        const status = getDayStatus(key);
        
        if(neutralDaysSetting === 'ignore' && status === null) continue;
        
        totalDays++;
        if(status === null){
          if(neutralDaysSetting === 'positive') positiveDays++;
        } else if(positiveTypes.includes(status)){
          positiveDays++;
        }
      }

      const rate = totalDays > 0 ? Math.round((positiveDays / totalDays) * 100) : 0;
      document.getElementById('successRate').textContent = `${rate}%`;

      const card = document.getElementById('rateCard');
      card.className = 'stat-card';
      if(rate >= 80) card.classList.add('rate-good');
      else if(rate >= 60) card.classList.add('rate-warn');
      else card.classList.add('rate-bad');
    }

    // 100 Days Chart
    function calculate100DaysChart(){
      const today = new Date();
      const periods = [
        { label: 'Letzte 30 Tage', sublabel: 'Aktueller Monat', days: 30, offset: 0 },
        { label: 'Tage 31-60', sublabel: 'Vorheriger Monat', days: 30, offset: 30 },
        { label: 'Tage 61-100', sublabel: 'Vor 2-3 Monaten', days: 40, offset: 60 }
      ];
      
      const positiveTypes = ['sober', 'wellness', 'superday'];
      const container = document.getElementById('chartBars');
      container.innerHTML = '';
      
      periods.forEach(period => {
        let positiveDays = 0;
        let totalDays = 0;
        
        for(let i = period.offset; i < period.offset + period.days; i++){
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const key = formatDateKey(d);
          const status = getDayStatus(key);
          
          if(neutralDaysSetting === 'ignore' && status === null) continue;
          
          totalDays++;
          if(status === null){
            if(neutralDaysSetting === 'positive') positiveDays++;
          } else if(positiveTypes.includes(status)){
            positiveDays++;
          }
        }
        
        const percentage = totalDays > 0 ? Math.round((positiveDays / totalDays) * 100) : 0;
        const isPositive = percentage >= 50;
        
        const barContainer = document.createElement('div');
        barContainer.className = 'chart-bar-container';
        barContainer.innerHTML = `
          <div class="chart-bar-header">
            <div class="chart-bar-label">
              ${period.label}
              <small>${period.sublabel}</small>
            </div>
            <div class="chart-bar-percent">${percentage}%</div>
          </div>
          <div class="chart-bar-wrapper">
            <div class="chart-bar ${isPositive ? 'positive' : 'negative'}" 
                 style="width: ${percentage}%; --bar-width: ${percentage}%;">
            </div>
          </div>
        `;
        container.appendChild(barContainer);
      });
    }

    // Health Assessment
    function calculateHealthAssessment(){
      const today = new Date();
      let totalDays = 0;
      let afDays = 0;
      let heavyDays = 0;
      let bingeEpisodes = 0;
      let consecutiveAF = 0;
      let maxConsecutiveAF = 0;
      
      const positiveTypes = ['sober', 'wellness', 'superday'];
      const heavyTypes = ['alcohol'];
      const bingeTypes = ['alcohol', 'mixed'];
      
      for(let i = 0; i < 100; i++){
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDateKey(d);
        const status = getDayStatus(key);
        
        if(neutralDaysSetting === 'ignore' && status === null) continue;
        
        totalDays++;
        
        if(status === null){
          if(neutralDaysSetting === 'positive'){
            afDays++;
            consecutiveAF++;
          } else {
            consecutiveAF = 0;
          }
        } else if(positiveTypes.includes(status)){
          afDays++;
          consecutiveAF++;
        } else {
          consecutiveAF = 0;
          if(heavyTypes.includes(status)) heavyDays++;
          if(bingeTypes.includes(status)) bingeEpisodes++;
        }
        
        maxConsecutiveAF = Math.max(maxConsecutiveAF, consecutiveAF);
      }
      
      const afRate = totalDays > 0 ? Math.round((afDays / totalDays) * 100) : 0;
      const bingeRate = totalDays > 0 ? Math.round((bingeEpisodes / totalDays) * 100) : 0;
      
      let statusClass, statusText, message;
      
      if(afRate >= 80 && bingeRate < 5){
        statusClass = 'status-excellent';
        statusText = 'Exzellent';
        message = 'Hervorragende Gewohnheiten! Dein Konsummuster zeigt minimale Gesundheitsrisiken. Die WHO best√§tigt: Diese Rate reduziert das Risiko f√ºr Lebererkrankungen, Krebs und Herz-Kreislauf-Probleme erheblich.';
      } else if(afRate >= 60 && bingeRate < 15){
        statusClass = 'status-good';
        statusText = 'Gut';
        message = 'Solide Fortschritte! Du bist auf einem guten Weg. Versuche, die AF-Rate weiter zu steigern und Binge-Episoden zu reduzieren f√ºr optimale Gesundheit.';
      } else {
        statusClass = 'status-concern';
        statusText = 'Verbesserungspotenzial';
        message = 'Dein Konsummuster k√∂nnte gesundheitliche Risiken bergen. Die WHO empfiehlt: Mehr alkoholfreie Tage und Vermeidung von Rauschtrinken. Jeder AF-Tag z√§hlt!';
      }
      
      const assessmentDiv = document.getElementById('healthAssessment');
      assessmentDiv.innerHTML = `
        <div class="health-metrics">
          <div class="health-metric">
            <div class="metric-label">AF-Quote</div>
            <div class="metric-value">${afRate}%</div>
          </div>
          <div class="health-metric">
            <div class="metric-label">L√§ngste Serie</div>
            <div class="metric-value">${maxConsecutiveAF} Tage</div>
          </div>
          <div class="health-metric">
            <div class="metric-label">Schwere Tage</div>
            <div class="metric-value">${heavyDays}</div>
          </div>
          <div class="health-metric">
            <div class="metric-label">Binge-Rate</div>
            <div class="metric-value">${bingeRate}%</div>
          </div>
        </div>
        <div class="health-status">
          <div class="status-badge ${statusClass}">${statusText}</div>
          <div class="health-message">${message}</div>
        </div>
      `;
    }

    // AUDIT-C Score
    function calculateAuditScore(){
      const q1 = parseInt(document.querySelector('input[name="auditQ1"]:checked')?.value);
      const q2 = parseInt(document.querySelector('input[name="auditQ2"]:checked')?.value);
      const q3 = parseInt(document.querySelector('input[name="auditQ3"]:checked')?.value);

      if(isNaN(q1) || isNaN(q2) || isNaN(q3)){
        alert('Bitte beantworte alle 3 Fragen!');
        return;
      }

      const score = q1 + q2 + q3;
      const gender = document.getElementById('auditGender').value;
      
      let risk, riskClass, riskText;
      
      if(score === 0){
        risk = 'Niedriges Risiko';
        riskClass = 'low';
        riskText = 'Abstinenz oder sehr geringer Konsum. Kein Hinweis auf problematischen Alkoholkonsum. Weiter so! üíö';
      } else if((gender === 'female' && score < 3) || (gender === 'male' && score < 4)){
        risk = 'Geringes Risiko';
        riskClass = 'low';
        riskText = 'Dein Konsum liegt im unteren Bereich. Achte weiterhin auf Ma√ühalten und vermeide Rauschsituationen.';
      } else if(score < 5){
        risk = 'Riskanter Konsum';
        riskClass = 'medium';
        riskText = 'Dein Konsum ist potenziell sch√§dlich f√ºr deine Gesundheit. Erw√§ge eine Reduzierung und sprich ggf. mit einem Arzt oder einer Beratungsstelle. WHO-Empfehlung: Reduziere Frequenz und Menge!';
      } else {
        risk = 'Hohes Risiko';
        riskClass = 'high';
        riskText = 'Hohes Risiko f√ºr Alkohol Use Disorder (AUD). Professionelle Beratung wird dringend empfohlen! Kontaktiere: SAMHSA-Hotline (USA: 1-800-662-4357), DHS-Suchtberatung oder deine*n Hausarzt*√§rztin.';
      }

      const resultDiv = document.getElementById('auditResult');
      resultDiv.className = 'audit-result ' + riskClass;
      resultDiv.innerHTML = `
        <strong>AUDIT-C Score: ${score} von 12</strong>
        <strong style="font-size: 14px; margin-top: 8px; display: block;">${risk}</strong>
        ${riskText}
        <br><br>
        <small><strong>Wichtig:</strong> Dies ist ein Screening-Tool, keine Diagnose. Bei Score ‚â•${gender === 'female' ? '3' : '4'} empfiehlt die WHO eine professionelle Abkl√§rung. Mehr Info: <a href="https://www.who.int/tools/audit" target="_blank" style="color: inherit; text-decoration: underline;">WHO AUDIT</a></small>
      `;
      resultDiv.style.display = 'block';

      // Scroll zum Ergebnis
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /* Chart Popup */
    function toggleChartPopup(){
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');
      
      if(isActive){
        popup.classList.remove('active');
        overlay.classList.remove('active');
        popup.setAttribute('aria-hidden','true');
      } else {
        calculate100DaysChart();
        calculateHealthAssessment();
        
        // Setze die richtige Settings-Option
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if(radio){
          radio.checked = true;
          radio.closest('.settings-option').classList.add('selected');
        }
        
        popup.classList.add('active');
        overlay.classList.add('active');
        popup.setAttribute('aria-hidden','false');
        
        // Overlay-Klick zum Schlie√üen
        overlay.onclick = toggleChartPopup;
      }
    }

    /* Settings Popup */
    function toggleSettingsPopup(){
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');
      
      if(isActive){
        popup.classList.remove('active');
        overlay.classList.remove('active');
        popup.setAttribute('aria-hidden','true');
      } else {
        // Lade aktuelle Einstellung
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if(radio) radio.checked = true;
        updateSettingsUI();
        
        popup.classList.add('active');
        overlay.classList.add('active');
        popup.setAttribute('aria-hidden','false');
        
        // Overlay-Klick zum Schlie√üen
        overlay.onclick = toggleSettingsPopup;
      }
    }

    function updateSettingsUI(){
      // Update selected class
      document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
      const selectedOption = document.querySelector(`input[name="neutralDays"]:checked`);
      if(selectedOption){
        selectedOption.closest('.settings-option').classList.add('selected');
      }
    }

    function saveSettings(){
      const selected = document.querySelector('input[name="neutralDays"]:checked');
      if(selected){
        neutralDaysSetting = selected.value;
        
        // Speichern
        if(storageWorking){
          try{
            localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
              neutralDays: neutralDaysSetting
            }));
          }catch(e){
            console.warn('Settings konnten nicht gespeichert werden:', e);
          }
        }
        
        // Popup schlie√üen
        toggleSettingsPopup();
        
        // Info anzeigen
        alert('‚úÖ Einstellungen gespeichert! Die Statistik wird beim n√§chsten √ñffnen mit den neuen Einstellungen berechnet.');
      }
    }

    function updateDay(action){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      
      if(action==='delete'){
        delete dayData[key];
      } else {
        // Bewahre existierenden Kommentar beim Status-Wechsel
        const existingComment = getDayComment(key);
        dayData[key] = {
          status: action,
          comment: existingComment
        };
      }

      saveData();
      closeEditPopup();
      updateMonthView();
      calculateStreak();
      calculateSuccessRate();
    }
    
    /* Speichere Kommentar */
    function saveEditComment(){
      if(!editingDate) return;
      const key = formatDateKey(editingDate);
      const comment = document.getElementById('editCommentInput').value.trim();
      const existingStatus = getDayStatus(key);
      
      if(existingStatus){
        // Update nur den Kommentar, Status bleibt gleich
        dayData[key] = {
          status: existingStatus,
          comment: comment
        };
        saveData();
        updateMonthView();
        
        // Feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Gespeichert!';
        setTimeout(() => btn.textContent = originalText, 1200);
      }
    }

    function previousMonth(){ currentViewDate.setMonth(currentViewDate.getMonth()-1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }
    function nextMonth(){     currentViewDate.setMonth(currentViewDate.getMonth()+1); updateMonthView(); calculateStreak(); calculateSuccessRate(); }

    /* Save day */
    function saveDay(){
      const selected = document.querySelector('input[name="dayChoice"]:checked');
      if(!selected) return;
      const key = formatDateKey(currentInputDate);
      const comment = document.getElementById('dayCommentInput').value.trim();
      
      // Speichere sowohl Status als auch Kommentar
      dayData[key] = {
        status: selected.value,
        comment: comment
      };

      const btn = document.getElementById('submitDay');
      const ok = saveData();
      const label = btn.textContent;
      btn.textContent = ok ? '‚úÖ Gespeichert!' : '‚ùå Fehler!';
      setTimeout(()=>btn.textContent = label, 1200);

      calculateStreak();

      currentInputDate.setDate(currentInputDate.getDate()+1);
      updateDayInputView();

      document.querySelectorAll('input[name="dayChoice"]').forEach(r=>r.checked=false);
      document.getElementById('dayCommentInput').value = '';
      btn.disabled = true;
    }

    /* Reset */
    function resetStorage(){
      const ok = confirm('‚ö†Ô∏è Wirklich ALLE lokalen Daten (Tage + Einstellungen) l√∂schen und neu starten?');
      if(!ok) return;
      try{
        localStorage.removeItem('alcoholTrackerData');
        localStorage.removeItem('alcoholTrackerCurrentDate');
        localStorage.removeItem('alcoholTrackerSettings');
      }catch(e){ console.warn('LocalStorage-Bereinigung fehlgeschlagen:', e); }
      location.reload();
    }

    // Expose
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.openEditPopup = openEditPopup;
    window.closeEditPopup = closeEditPopup;
    window.updateDay = updateDay;
    window.resetStorage = resetStorage;
    window.toggleChartPopup = toggleChartPopup;
    window.toggleSettingsPopup = toggleSettingsPopup;
    window.saveSettings = saveSettings;
    window.saveEditComment = saveEditComment;
    window.exportData = exportData;
    window.importData = importData;
    window.calculateAuditScore = calculateAuditScore;

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      testStorage();
      loadData();
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{ document.getElementById('submitDay').disabled = false; });
      });
      document.getElementById('submitDay').addEventListener('click', saveDay);
      updateDayInputView();
    });
  </script>
</body>
</html>
