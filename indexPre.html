<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ralles wunderbarer Booze-Tracker</title>
  <style>
    :root{
      --bg-grad-start:#6ea8ff;
      --bg-grad-end:#8ee5ff;
      --card-bg:#ffffff;
      --card-border:#e6eaf1;
      --text:#1f2937;
      --muted:#64748b;
      --primary:#4f46e5;
      --primary-dark:#4338ca;
      --success:#10b981;
      --success-dark:#047857;
      --warn:#f59e0b;
      --danger:#ef4444;
      --super:#059669;
      --wellness:#22c55e;
      --mixed:#dc2626;
      --radius:16px;
      --shadow:0 12px 30px rgba(31,41,55,.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end)) fixed;
    }

    .container{
      max-width: 820px;
      margin: 32px auto;
      padding: clamp(16px, 2.5vw, 24px);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size: clamp(26px, 4.2vw, 34px);
    }
    .app-version{
      position: fixed;
      top: 4px;
      right: 4px;
      color: var(--muted);
      font-size: 8px;
      z-index: 9999;
    }

    /* === EINGABE === */
    .current-date{
      font-size: clamp(26px, 5vw, 36px);
      font-weight: 800;
      color: var(--primary);
      text-align:center;
      margin: 6px 0 18px;
    }

    /* Kategorie-Auswahl */
    .choice-container{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 18px 0 8px;
    }
    @media (max-width:640px){ .choice-container{ grid-template-columns: 1fr 1fr; } }

    .choice-option{
      display:flex; align-items:center; gap:12px;
      padding: 14px 16px;
      border:2px solid #edf2f7;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-size: 15px;
      position:relative;
    }
    .choice-option:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .choice-option input[type="radio"]{ transform: scale(1.3); margin:0 2px 0 0; accent-color: var(--primary); }
    .choice-option.selected{ border-color: var(--primary); background: #f0f4ff; }
    
    .choice-option.sober{ border-color: #c0f1df; background: #f4fffa; }
    .choice-option.wellness{ border-color: #b3f5cc; background: #f0fdf5; }
    .choice-option.moderate{ border-color: #ffe5b5; background: #fff9ec; }
    .choice-option.mixed{ border-color: #fecaca; background: #fef2f2; }
    .choice-option.alcohol{ border-color: #ffcaca; background: #fff2f2; }
    .choice-option.superday{
      border-color: #b7f3d2;
      background: linear-gradient(135deg, #f3fff9, #ecfff8);
    }
    .choice-option.hangover{ border-color: #7f1d1d; background: #fef2f2; }
    
    .choice-label{ flex:1; }
    .choice-desc{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .choice-warning{
      display:none;
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:4px;
      padding:6px 8px;
      background:#fff7ed;
      border:1px solid #fb923c;
      border-radius:8px;
      font-size:11px;
      color:#9a3412;
      z-index:10;
    }
    .choice-option.warning-active .choice-warning{ display:block; }

    /* God-Modus Detail-Eingabe */
    .god-section{
      margin-top: 16px;
      padding:16px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      display:none;
    }
    .god-section.active{ display:block; }
    
    .god-header{
      font-weight:800;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    /* GetrÃ¤nke-Liste */
    .drinks-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:12px;
    }
    
    .drink-item{
      background:white;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
      position:relative;
    }
    
    .drink-remove{
      position:absolute;
      top:8px;
      right:8px;
      background:#fee;
      border:1px solid #fcc;
      border-radius:50%;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:14px;
      color:#dc2626;
    }
    .drink-remove:hover{ background:#fcc; }
    
    .drink-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    @media (max-width:560px){ .drink-row{ grid-template-columns: 1fr; } }
    
    .drink-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    
    .drink-label{
      font-size:12px;
      font-weight:600;
      color:var(--text);
    }
    
    .drink-select, .drink-input{
      padding:8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
      background:white;
      font-family:inherit;
    }
    
    .drink-summary{
      font-size:12px;
      color:var(--muted);
      padding-top:8px;
      border-top:1px solid #e5e7eb;
    }
    
    .btn-add-drink{
      width:100%;
      padding:10px;
      background:#f0f4ff;
      border:1px dashed var(--primary);
      border-radius:8px;
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
      font-size:14px;
    }
    .btn-add-drink:hover{ background:#e0e7ff; }
    
    /* Checkboxen-Grid */
    .checkboxes-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin:12px 0;
    }
    @media (max-width:560px){ .checkboxes-grid{ grid-template-columns:1fr; } }
    
    .checkbox-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      background:white;
      border:1px solid #e5e7eb;
      border-radius:8px;
    }
    .checkbox-item input[type="checkbox"]{
      transform:scale(1.2);
      accent-color:var(--primary);
    }
    .checkbox-item label{
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    
    /* Live-Berechnung */
    .live-calc{
      margin-top:12px;
      padding:12px;
      background:white;
      border:1px solid #e5e7eb;
      border-radius:10px;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
      text-align:center;
    }
    @media (max-width:640px){ .live-calc{ grid-template-columns:repeat(2, 1fr); } }
    .live-calc-item{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .live-calc-value{
      font-size:20px;
      font-weight:800;
      color:var(--text);
    }
    .live-calc-label{
      font-size:10px;
      color:var(--muted);
    }
    .live-calc-suggest{
      grid-column:1/-1;
      padding:8px;
      background:#f0f9ff;
      border-radius:6px;
      font-size:12px;
      color:#0c4a6e;
    }
    
    /* Buttons */
    .btn{
      height: 48px;
      padding: 0 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 8px 18px rgba(79,70,229,.25);
      font-size: 16px;
    }
    .btn:hover{ background: var(--primary-dark); transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; box-shadow:none; cursor:not-allowed; }

    .btn.secondary{ background:#64748b; box-shadow: 0 8px 18px rgba(100,116,139,.2); }
    .btn.secondary:hover{ background:#475569; }

    .btn.danger{ background:#ef4444; box-shadow: 0 8px 18px rgba(239,68,68,.2); }
    .btn.danger:hover{ background:#dc2626; }

    .submit-row{ margin-top: 12px; display:flex; gap:12px; }
    .storage-info{ margin-top: 10px; text-align:center; color:var(--muted); font-size:14px; }

    /* === MONATSÃœBERSICHT === */
    .stats-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom: 12px;
    }
    .stat-card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius: 14px;
      padding:16px;
      text-align:center;
      transition: background .2s ease, border-color .2s ease;
    }
    .stat-card .stat-number{ font-size: clamp(28px, 4.8vw, 40px); font-weight:900; margin: 6px 0 2px; }
    .stat-card .stat-label{ color:var(--muted); font-size: 13px; }

    .rate-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .rate-warn{ background:#fffbeb; border-color:#fde68a; }
    .rate-bad { background:#fef2f2; border-color:#fecaca; }

    .streak-bad { background:#fef2f2; border-color:#fecaca; }
    .streak-warn{ background:#fffbeb; border-color:#fde68a; }
    .streak-good{ background:#ecfdf5; border-color:#a7f3d0; }
    .streak-great{ background:#d1fae5; border-color:#34d399; }

    /* Kalender */
    .legend{ display:flex; flex-wrap:wrap; gap:10px 14px; margin:10px 0 14px; color:var(--muted); font-size:13px; }
    .legend span{ display:flex; align-items:center; gap:6px; }

    .cal{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:10px; position:relative; }
    .weekday{ text-align:center; font-weight:700; font-size:12px; color:#475569; padding:6px 0; background:#f1f5f9; border-radius:8px; border:1px solid #e7eef6; }

    .day{
      aspect-ratio:1;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      border:1px solid #e7eef6;
      background:#fff;
      font-weight:700;
      cursor:pointer;
      transition:.1s ease;
      position:relative;
      z-index:1;
      user-select:none;
    }
    .day:hover{ transform: scale(1.03); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    
    .day.sober{ background:#10b981; color:#fff; }
    .day.wellness{ background:#22c55e; color:#fff; }
    .day.wellness::after{ content:"ğŸ’š"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.moderate{ background:#f59e0b; color:#fff; }
    .day.mixed{ background:#dc2626; color:#fff; }
    .day.mixed::after{ content:"â¤ï¸"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.alcohol{ background:#ef4444; color:#fff; }
    .day.superday{ background:#059669; color:#fff; }
    .day.superday::after{ content:"â­"; position:absolute; top:2px; right:4px; font-size:10px; }
    .day.hangover{ background:#7f1d1d; color:#fff; }
    .day.hangover::after{ content:"ğŸºğŸ’¥"; position:absolute; top:2px; right:4px; font-size:10px; }

    .day.today{ outline: 3px solid var(--primary); outline-offset:-3px; }

    /* Kommentar-Tooltip */
    .day-comment-tooltip{
      display:none;
      position:absolute;
      bottom:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      min-width:200px;
      max-width:280px;
      padding:10px 12px;
      background:#1f2937;
      color:white;
      border-radius:8px;
      font-size:11px;
      line-height:1.5;
      z-index:1000;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      text-align:left;
      font-weight:400;
      pointer-events:none;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .day-comment-tooltip::after{
      content:'';
      position:absolute;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      border:6px solid transparent;
      border-top-color:#1f2937;
    }
    .day.has-comment{ position:relative; }
    .day.has-comment::before{ content:'ğŸ’¬'; position:absolute; top:2px; left:2px; font-size:10px; opacity:.8; }
    .day.has-comment:hover .day-comment-tooltip{ display:block; }
    
    /* Mobile: Tap um Tooltip zu zeigen */
    @media (max-width:640px){
      .day.has-comment.tooltip-active .day-comment-tooltip{ display:block; }
    }

    /* Chart-Popup */
    .chart-popup-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      z-index:1001;
    }
    .chart-popup-overlay.active{ display:block; }
    
    .chart-popup{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px;
      width:min(720px,92vw);
      max-height:85vh;
      overflow-y:auto;
      display:none;
      z-index:1002;
    }
    .chart-popup.active{ display:block; }

    .chart-section{ margin:18px 0; }
    .chart-title{ font-weight:700; font-size:18px; margin-bottom:24px; text-align:center; color:var(--text); }
    .chart-bars{ display:flex; flex-direction:column; gap:32px; margin-bottom:10px; }
    .chart-bar-container{ display:flex; flex-direction:column; gap:12px; }
    .chart-bar-header{ display:flex; align-items:center; justify-content:space-between; }
    .chart-bar-label{ font-size:14px; font-weight:600; color:var(--text); }
    .chart-bar-label small{ display:block; font-size:12px; font-weight:400; color:var(--muted); margin-top:2px; }
    .chart-bar-value{ display:flex; align-items:baseline; gap:8px; }
    .chart-bar-number{ font-size:32px; font-weight:900; color:var(--text); }
    .chart-bar-percent{ font-size:16px; font-weight:600; color:var(--muted); }
    .chart-bar-wrapper{ height:48px; background:#f1f5f9; border-radius:12px; position:relative; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05); }
    .chart-bar{ height:100%; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); width:0%; border-radius:12px; display:flex; align-items:center; justify-content:flex-end; padding-right:16px; font-weight:700; color:white; font-size:16px; position:relative; }
    .chart-bar::after{ content:''; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0)); border-radius:12px; }
    .chart-bar.negative{ background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .chart-bar.positive{ background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    /* Health Assessment */
    .health-assessment{
      margin-top: 32px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 14px;
      border: 2px solid #e5e7eb;
    }
    .assessment-title{ font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--text); }
    .assessment-badge{
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      border-radius: 12px;
      font-size: 22px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .assessment-badge:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .assessment-badge:active{
      transform: translateY(0);
    }
    .assessment-badge.zen{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border: 2px solid #34d399; }
    .assessment-badge.balance{ background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #fbbf24; }
    .assessment-badge.weekend{ background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; border: 2px solid #fb923c; }
    .assessment-badge.red{ background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border: 2px solid #ef4444; }

    .assessment-metrics{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    @media (max-width:560px){ .assessment-metrics{ grid-template-columns:1fr; } }
    .metric-item{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; }
    .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
    .metric-value{ font-size:20px; font-weight:800; color:var(--text); }
    .assessment-description{ padding:12px; background:white; border-radius:10px; border:1px solid #e5e7eb; font-size:13px; line-height:1.6; color:var(--text); }
    .assessment-warning{ margin-top:12px; padding:10px; background:#fff7ed; border-left:4px solid #fb923c; border-radius:6px; font-size:12px; color:#9a3412; }

    /* Detailanalyse Toggle */
    .analysis-advanced{ margin-top: 14px; }
    .analysis-toggle{
      appearance:none;
      background:#f1f5f9;
      border:1px solid #e5e7eb;
      color:#111827;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      width:100%;
    }
    .analysis-toggle:hover{ background:#e2e8f0; }
    .analysis-box{
      display:none;
      margin-top:12px;
      padding:14px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
    }
    .analysis-box.active{ display:block; }

    /* Settings */
    .settings-popup-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:none;
      z-index:1001;
    }
    .settings-popup-overlay.active{ display:block; }
    
    .settings-popup{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      box-shadow:0 20px 40px rgba(31,41,55,.25);
      padding:24px;
      width:min(560px,92vw);
      max-height:85vh;
      overflow-y:auto;
      display:none;
      z-index:1002;
    }
    .settings-popup.active{ display:block; }
    
    .settings-title{ font-size:22px; font-weight:800; margin-bottom:8px; color:var(--text); text-align:center; }
    .settings-subtitle{ font-size:14px; color:var(--muted); margin-bottom:24px; text-align:center; }
    
    .settings-section{
      margin-bottom:20px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:hidden;
    }
    .settings-section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      background:#f9fafb;
      cursor:pointer;
      user-select:none;
    }
    .settings-section-header:hover{ background:#f3f4f6; }
    .settings-section-title{ font-size:16px; font-weight:700; color:var(--text); }
    .settings-section-toggle{
      font-size:18px;
      color:var(--muted);
      transition:transform .2s ease;
    }
    .settings-section.collapsed .settings-section-toggle{ transform:rotate(-90deg); }
    .settings-section-content{
      padding:16px;
      background:white;
      display:block;
    }
    .settings-section.collapsed .settings-section-content{ display:none; }
    
    .settings-description{ font-size:13px; color:var(--muted); margin-bottom:12px; line-height:1.6; }
    .settings-options{ display:flex; flex-direction:column; gap:10px; }
    .settings-option{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:12px;
      border:2px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      transition:all .2s ease;
    }
    .settings-option:hover{ border-color:var(--primary); background:#f8faff; }
    .settings-option.selected{ border-color:var(--primary); background:linear-gradient(135deg,#eef2ff,#f8faff); box-shadow:0 4px 12px rgba(79,70,229,0.15); }
    .settings-option input[type="radio"]{ margin-top:2px; transform:scale(1.3); accent-color:var(--primary); }
    .settings-option-content{ flex:1; }
    .settings-option-title{ font-weight:700; font-size:14px; color:var(--text); margin-bottom:4px; }
    .settings-option-desc{ font-size:12px; color:var(--muted); line-height:1.5; }

    /* Buttons fÃ¼r Settings/Stats */
    .btn-stats-toggle, .btn-settings{
      appearance:none;
      background:linear-gradient(135deg,#eef2ff,#e0e7ff);
      border:1.5px solid #c7d2fe;
      color:#1e3a8a;
      padding:10px 18px;
      border-radius:999px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease;
      box-shadow:0 6px 14px rgba(79,70,229,.18);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-stats-toggle:hover, .btn-settings:hover{
      background:linear-gradient(135deg,#e0e7ff,#c7d2fe);
      border-color:#a5b4fc;
      transform:translateY(-1px);
      box-shadow:0 10px 20px rgba(79,70,229,.25);
    }

    .month-head{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px 0 6px; }
    .month-title{ font-weight:800; font-size:20px; }
    .month-top-nav{ display:flex; gap:10px; justify-content:center; margin:8px 0 14px; }
    .month-top-nav .btn{ width:auto; min-width:140px; }

    footer{ margin-top: 18px; text-align:center; color:#475569; font-size: 13px; }

    /* Support */
    .support{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      text-align:center;
    }
    .support p{ margin:0 0 6px; }
    .support-buttons{ margin-top:0; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; }
    .support-buttons .btn-holder{ height:48px; display:flex; align-items:center; justify-content:center; }
    
    #kofi-holder, #kofi-holder iframe{ margin:0 !important; }
    #kofi-holder iframe{ height:48px !important; min-height:48px !important; }
    @media (max-width: 420px){
      #kofi-holder iframe{ height:44px !important; }
    }

	/* Icon-Button in der Monats-Navigation */
    .month-top-nav .btn.btn-icon{
    min-width:48px;   /* Touch-Ziel >= 44px, also safe */
    width:auto;
    padding:0 12px;   /* etwas schmaler */
    }
    @media (max-width:640px){
    /* Variante: auf Mobile nur das Icon zeigen */
    .month-top-nav .btn.btn-icon .label{ display:none; }
    }

    /* === TOOLTIP SYSTEM === */
    .tooltip-trigger{
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: help;
    }
    .tooltip-icon{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      transition: all 0.2s ease;
    }
    .tooltip-icon:hover{
      background: rgba(59, 130, 246, 0.2);
      transform: scale(1.1);
    }
    .tooltip-content{
      position: absolute;
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.5;
      max-width: 280px;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-5px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .tooltip-content.show{
      opacity: 1;
      transform: translateY(0);
    }
    .tooltip-content::before{
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #1f2937;
    }
  </style>

<style>
/* === Mobile equalize adjustments (surgical, no other changes) === */
@media (max-width:640px){
  /* Keep 2 columns from previous change; ensure cards feel even */
  .choice-option{
    /* more uniform visual height without truncating essential content */
    min-height: 128px;
    height: 100%;
    align-items: flex-start; /* prevent vertical wobble between rows */
  }
  .choice-desc{
    /* clamp excessive lines to reduce uneven card heights */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}
</style>


<style>
/* --- Heute-Button schmal (surgical override) --- */
.month-top-nav .btn.today-btn{
  min-width:48px;
  width:auto;
  padding:0 12px;
}
@media (max-width:640px){
  .month-top-nav .btn.today-btn .label{ display:none; }
}
</style>


<style>
/* === Kategorie-Layout zurÃ¼ck zu EINER Spalte (schlank) === */
.choice-container{ grid-template-columns: 1fr !important; }
@media (max-width:640px){
  .choice-container{ grid-template-columns: 1fr !important; }
}
/* Karten wieder schlank machen */
.choice-option{
  min-height: unset !important;
  height: auto !important;
}

/* Monat-Hinweis unter der Ãœberschrift */
.month-hint{
  margin-top: 4px;
  font-size: 12px;
  line-height: 1.2;
  color: var(--muted);
  text-align: center;
  font-weight: 400;
}
.month-hint .gm-badge{
  color: #e11d48; /* rot */
  font-weight: 700;
  margin-left: 8px;
  font-size: 11px;
}
</style>

<!-- Neue Styles fÃ¼r Phase 1 Features -->
<style>
/* Stress-Regler */
.stress-container {
  margin-top: 16px;
  padding: 12px;
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
}
.stress-options {
  display: flex;
  justify-content: space-between;
  gap: 8px;
}
.stress-option {
  flex: 1;
  padding: 8px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
}
.stress-option input[type="radio"] {
  display: none;
}
.stress-option.selected {
  background: #f0f4ff;
  border-color: var(--primary);
  box-shadow: 0 2px 4px rgba(79,70,229,0.1);
}
.stress-label {
  font-size: 12px;
  font-weight: 600;
}
.stress-desc {
  font-size: 10px;
  color: var(--muted);
}

/* Predictive Nudging Alert */
.nudge-alert {
  display: none;
  margin-top: 16px;
  padding: 12px;
  background: #fef3c7;
  border-left: 4px solid #fbbf24;
  border-radius: 6px;
  font-size: 13px;
  color: #92400e;
  line-height: 1.5;
}
.nudge-alert.active {
  display: block;
}
.nudge-suggestions {
  margin-top: 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.nudge-btn {
  padding: 6px 12px;
  background: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: 999px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.nudge-btn:hover {
  background: #fef3c7;
}

/* Leber-Score Sektion */
.leber-score-section {
  margin-top: 24px;
  padding: 16px;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 12px;
}
.leber-title {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 12px;
  text-align: center;
}
.leber-value {
  font-size: 28px;
  font-weight: 900;
  text-align: center;
  margin-bottom: 8px;
}
.leber-desc {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
  line-height: 1.5;
}
.leber-warning {
  margin-top: 8px;
  padding: 8px;
  background: #d1fae5;
  border-radius: 6px;
  font-size: 12px;
  text-align: center;
}
</style>

</head>
<body>
  <div class="container">
    <!-- === TAG-EINGABE VIEW === -->
    <div id="dayInputView" class="view active">
      <h1>ğŸ· Ralles wunderbarer BoozeTracker</h1>
      <div class="app-version" id="appVersion"></div>

      <div class="current-date" id="currentDateDisplay"></div>

      <!-- Kategorie-Auswahl mit Beschreibungen -->
      <div class="choice-container" role="group" aria-label="Tagesauswahl">
        <label class="choice-option superday" data-value="superday">
          <input type="radio" name="dayChoice" value="superday" />
          <div class="choice-label">
            <div>â­ Supertag</div>
            <div class="choice-desc">Kein Alkohol + Sport</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option wellness" data-value="wellness">
          <input type="radio" name="dayChoice" value="wellness" />
          <div class="choice-label">
            <div>ğŸ’š Wellness</div>
            <div class="choice-desc">Kein Alkohol + Gesundheit (Sauna, Yoga)</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option sober" data-value="sober">
          <input type="radio" name="dayChoice" value="sober" />
          <div class="choice-label">
            <div>ğŸŸ¢ Alkoholfrei</div>
            <div class="choice-desc">Kein Alkohol getrunken</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option moderate" data-value="moderate">
          <input type="radio" name="dayChoice" value="moderate" />
          <div class="choice-label">
            <div>ğŸŸ¡ Moderat</div>
            <div class="choice-desc" id="moderateDesc">1-2 Drinks</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>

        <label class="choice-option mixed" data-value="mixed">
          <input type="radio" name="dayChoice" value="mixed" />
          <div class="choice-label">
            <div>â¤ï¸ Schadensbegrenzung</div>
            <div class="choice-desc">Selbstbetrug = Sport + feiern</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>

        <label class="choice-option alcohol" data-value="alcohol">
          <input type="radio" name="dayChoice" value="alcohol" />
          <div class="choice-label">
            <div>ğŸ”´ Alkohol</div>
            <div class="choice-desc">Viel Alkohol getrunken (41-80g)</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
        
        <label class="choice-option hangover" data-value="hangover">
          <input type="radio" name="dayChoice" value="hangover" />
          <div class="choice-label">
            <div>ğŸºğŸ’¥ Vollrausch</div>
            <div class="choice-desc">Sehr viel Alkohol getrunken (>80g)</div>
          </div>
          <div class="choice-warning">âš ï¸ Auto-Vorschlag passt nicht zur Eingabe!</div>
        </label>
      </div>

      <!-- Kommentar -->
      <div style="margin-top: 16px;">
        <label for="dayCommentInput" style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          ğŸ’¬ Kommentar (optional):
        </label>
        <textarea 
          id="dayCommentInput" 
          placeholder="Notizen zum Tag (z.B. Anlass, GefÃ¼hle, Situation)..."
          style="width:100%; min-height:80px; resize:vertical; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:13px; font-family:inherit;"
        ></textarea>
      </div>

      <!-- Neu: Stress-Regler -->
      <div class="stress-container">
        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text);">
          ğŸ˜Œ Stresslevel heute:
          <span class="tooltip-icon" data-tooltip="Dein Stresslevel hilft bei der Analyse von Triggermustern. WÃ¤hle ehrlich aus.">?</span>
        </label>
        <div class="stress-options">
          <label class="stress-option" data-value="-2">
            <input type="radio" name="stressLevel" value="-2" />
            <div class="stress-label">-2</div>
            <div class="stress-desc">Supergechilled</div>
          </label>
          <label class="stress-option" data-value="-1">
            <input type="radio" name="stressLevel" value="-1" />
            <div class="stress-label">-1</div>
            <div class="stress-desc">Relaxed</div>
          </label>
          <label class="stress-option" data-value="0">
            <input type="radio" name="stressLevel" value="0" />
            <div class="stress-label">0</div>
            <div class="stress-desc">Normaler Wahnsinn, okay</div>
          </label>
          <label class="stress-option" data-value="1">
            <input type="radio" name="stressLevel" value="1" />
            <div class="stress-label">1</div>
            <div class="stress-desc">Leicht genervt</div>
          </label>
          <label class="stress-option" data-value="2">
            <input type="radio" name="stressLevel" value="2" />
            <div class="stress-label">2</div>
            <div class="stress-desc">Ich dreh durch</div>
          </label>
        </div>
      </div>

      <!-- Neu: Predictive Nudging Alert -->
      <div id="nudgeAlert" class="nudge-alert">
        <strong>ğŸš¨ Risiko-Alert fÃ¼r heute:</strong> <span id="nudgeRiskPct"></span>% Chance fÃ¼r einen Hochrisiko-Tag (basierend auf deinen Mustern).
        <br>Was ist dein Plan B?
        <div class="nudge-suggestions">
          <button class="nudge-btn" onclick="nudgeAction('sport')">Sport machen</button>
          <button class="nudge-btn" onclick="nudgeAction('friends')">Freunde anrufen</button>
          <button class="nudge-btn" onclick="nudgeAction('relax')">Entspannen (z.B. Yoga)</button>
          <button class="nudge-btn" onclick="nudgeAction('dismiss')">Ignorieren</button>
        </div>
      </div>

      <!-- God-Modus Bereich -->
      <div id="godSection" class="god-section">
        <div class="god-header">
          <span>ğŸ§  Detaillierte Eingabe</span>
          <button id="godToggleBtn" class="btn secondary" style="width:auto; height:32px; padding:0 12px; font-size:12px;">Ausblenden</button>
        </div>

        <!-- GetrÃ¤nke-Liste -->
        <div class="drinks-list" id="drinksList">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>

        <button class="btn-add-drink" id="addDrinkBtn">+ Weiteres GetrÃ¤nk hinzufÃ¼gen</button>

        <!-- Checkboxen -->
        <div class="checkboxes-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="checkSport">
            <label for="checkSport">ğŸƒâ€â™‚ï¸ Sport gemacht</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkCompensation">
            <label for="checkCompensation">
              ğŸ˜“ Kompensationstrinken (Stress etc.)
              <span class="tooltip-icon" data-tooltip="Trinken zur StressbewÃ¤ltigung oder nach Sport als 'Belohnung'. Zeigt emotionale AbhÃ¤ngigkeit - ein kritisches Warnzeichen fÃ¼r problematisches Trinkverhalten.">?</span>
            </label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkDope">
            <label for="checkDope">ğŸŒ¿ Marijuana konsumiert</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkCrash">
            <label for="checkCrash">ğŸ’¥ Totalabsturz</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkHangover">
            <label for="checkHangover">
              ğŸ¤¢ Katertag
              <span class="tooltip-icon" data-tooltip="WICHTIG: Ob du heute WEITERTRINKEN wirst, ist entscheidend fÃ¼r die Analyse! Katertag OHNE Weitertrinken = positives Verhalten (Kreislauf gestoppt). Katertag MIT Weitertrinken = 0% Score + DSM-5-Kriterium fÃ¼r schwere AbhÃ¤ngigkeit.">?</span>
            </label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="checkHangoverLight">
            <label for="checkHangoverLight">
              ğŸ˜Œ Kater Light
              <span class="tooltip-icon" data-tooltip="Wenig getrunken, trotzdem Kopfweh - fÃ¼r sensible Personen oder nach langer Abstinenz. Zeigt niedrige Toleranz (positiv!), aber trotzdem kÃ¶rperliche Reaktion.">?</span>
            </label>
          </div>
        </div>

        <!-- Dope Details (nur wenn aktiviert) -->
        <div id="dopeDetails" style="display:none; margin-top:12px; padding:12px; background:white; border:1px solid #e5e7eb; border-radius:8px;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="drink-field">
              <label class="drink-label">Menge (g)</label>
              <input type="number" id="dopeGrams" class="drink-input" min="0" step="0.1" placeholder="z.B. 0.5">
            </div>
            <div class="drink-field">
              <label class="drink-label">HÃ¤ufigkeit</label>
              <select id="dopeFreq" class="drink-select">
                <option value="einmalig">einmalig</option>
                <option value="mehrmals">mehrmals am Tag</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Live-Berechnung -->
        <div class="live-calc">
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveGrams">0</div>
            <div class="live-calc-label">Gramm Alkohol</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveDrinks">0.0</div>
            <div class="live-calc-label">Drinks (DE: 10g)</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveDrinksUK">0.0</div>
            <div class="live-calc-label">Units (UK: 8g)</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveDrinksUSA">0.0</div>
            <div class="live-calc-label">Drinks (USA: 14g)</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveBAC">0.0â€°</div>
            <div class="live-calc-label">Ã˜ Promille (geschÃ¤tzt)</div>
          </div>
          <div class="live-calc-item">
            <div class="live-calc-value" id="liveDGE">â€”</div>
            <div class="live-calc-label" id="liveDGELabel">
              DGE-Limit
              <span class="tooltip-icon" data-tooltip="Deutsche Gesellschaft fÃ¼r ErnÃ¤hrung: Risikoarmes Limit ist â™€ 12g/Tag, â™‚ 24g/Tag. Zeigt prozentual, wie viel du vom Tageslimit bereits erreicht hast. >100% = Ã¼ber dem Limit.">?</span>
            </div>
          </div>
          <div class="live-calc-suggest" id="liveSuggest">
            ğŸ’¡ Vorschlag
            <span class="tooltip-icon" data-tooltip="Automatische Empfehlung fÃ¼r Tageskategorie basierend auf deiner Eingabe (Gramm, Sport, Checkboxen). Hilft bei der Einordnung: Ist das noch 'Moderat' oder schon 'Alkohol'? Orientiert sich an DGE-Limits und deinen AktivitÃ¤ten.">?</span>:
            <strong id="suggestedCat">â€”</strong>
          </div>
        </div>
      </div>

      <div class="submit-row">
        <button id="submitDay" class="btn">Tag speichern</button>
      </div>

      <div class="submit-row" style="margin-top:8px">
        <button id="deleteDay" class="btn danger">Tag lÃ¶schen</button>
      </div>

      <div class="storage-info" id="storageInfo">
        ğŸ· Gespeicherte Tage: <span id="savedDaysCount">0</span> Â·
        <span id="storageStatus">Ladeâ€¦</span>
      </div>

      <div class="submit-row" style="margin-top:12px">
        <button class="btn secondary" onclick="showMonthView()">ğŸ“Š MonatsÃ¼bersicht</button>
      </div>
    </div>

    <!-- === MONATSÃœBERSICHT VIEW === -->
    <div id="monthView" class="view">
      <h1>ğŸ“Š Ralles wunderbarer Booze-Tracker previewgrok</h1>
      <div class="app-version" id="appVersion2"></div>

      <div class="month-head">
        <div class="month-title" id="monthHeader">â€”</div>
      </div>

      <div class="month-top-nav">
        <button class="btn secondary" onclick="previousMonth()">â† Vorheriger</button>
        <button class="btn today-btn" onclick="currentMonth()" aria-label="Heute" title="Heute">
         <span class="icon">ğŸ“…</span><span class="label">Heute</span>
        </button>

        <button class="btn" onclick="nextMonth()">NÃ¤chster â†’</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card" id="streakCard">
          <div class="stat-label">Aktueller Streak</div>
          <div class="stat-number" id="streakNumber">0</div>
          <div class="stat-label">alkoholfreie Tage</div>
        </div>
        <div class="stat-card" id="successCard">
          <div class="stat-label">Ã˜ Gesundheitsscore</div>
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">diesen Monat</div>
        </div>
      </div>

      <div class="legend">
        <span>â­ Supertag</span>
        <span>ğŸ’š Wellness</span>
        <span>ğŸŸ¢ Alkoholfrei</span>
        <span>ğŸŸ¡ Moderat (ğŸ‘Ÿ = mit Sport)</span>
        <span>â¤ï¸ Schadensbegrenzung (Sport+Alk)</span>
        <span>ğŸ”´ Alkohol</span>
        <span>ğŸºğŸ’¥ Vollrausch</span>
      </div>

      <div id="monthGrid" class="cal" aria-label="Kalender"></div>

      <div style="text-align: center; margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn-stats-toggle" onclick="toggleChartPopup()">ğŸ“Š Langzeit-Statistik</button>
        <button class="btn-settings" onclick="toggleSettingsPopup()">âš™ï¸ Einstellungen</button>
      </div>

      <section class="support">
        <p><strong>Findest diese kleine Anwendung nÃ¼tzlich?</strong> Dann spendier mir doch einen Kaffee:</p>
        <div class="support-buttons">
          <!-- Ko-fi Button -->
          <div id="kofi-holder" class="btn-holder">
            <div id="kofi-widget" aria-label="Ko-fi UnterstÃ¼tzungsbutton"></div>
          </div>

          <!-- Buy Me a Coffee Button -->
          <div class="btn-holder">
            <a href="https://www.buymeacoffee.com/rduwenbecky"><img src="https://img.buymeacoffee.com/button-api/?text=Spendier mir Â´n Kaffee! &emoji=â˜•&slug=rduwenbecky&button_colour=5F7FFF&font_colour=ffffff&font_family=Lato&outline_colour=000000&coffee_colour=FFDD00" /></a>
          </div>
        </div>

        <!-- Ko-fi Widget-Script -->
        <script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
        <script type="text/javascript">
          kofiwidget2.init('Spendier mir nÂ´ Kaffee Ko-fi', '#72a4f2', 'R5R319DK8N');
          kofiwidget2.draw();
        </script>
      </section>
    </div>

    <!-- === CHART POPUP === -->
    <div class="chart-popup-overlay" id="chartOverlay" onclick="toggleChartPopup()"></div>
    <div id="chartPopup" class="chart-popup">
      <div class="chart-section">
        <div class="chart-title">ğŸ“Š 100-Tage-Analyse</div>
        <div id="chartDaysInfo" style="text-align:center; margin-bottom:12px; font-size:14px; color:var(--muted);"></div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                ğŸ”´ Unter 50%
                <small>Alkohol, "Schadensbegrenzung", Moderat, Vollrausch/Katertag</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartNegativeNum">0</span>
                <span class="chart-bar-percent" id="chartNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chartNegative"></div>
            </div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                ğŸŸ¢ Ãœber 50%
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chartPositiveNum">0</span>
                <span class="chart-bar-percent" id="chartPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chartPositive"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 6-Monats-Langzeitanalyse -->
      <button id="toggleSixMonthBtn" class="btn secondary" style="width:100%; margin-top:24px; margin-bottom:16px; background-color: #d97706; box-shadow: 0 8px 18px rgba(217, 119, 6, .2);">
        6-Monats-Analyse anzeigen
      </button>

      <div id="sixMonthAnalysisSection" class="chart-section" style="margin-top:0; background:#fef9f3; border:1px solid #fbbf24; display:none;">  
        <div class="chart-title">ğŸ“ˆ 6-Monats-Langzeitanalyse (180 Tage)</div>
        <div style="font-size:13px; color:var(--muted); margin-bottom:12px; text-align:center;">
          Langfristige Muster und Entwicklungen
        </div>
        <div class="chart-bars">
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                ğŸ”´ Risikotage
                <small>Alkohol, Schadensbegrenzung, Moderat, Katertag mit Alkohol</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chart6mNegativeNum">0</span>
                <span class="chart-bar-percent" id="chart6mNegativePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar negative" id="chart6mNegative"></div>
            </div>
          </div>
          <div class="chart-bar-container">
            <div class="chart-bar-header">
              <div class="chart-bar-label">
                ğŸŸ¢ Gesunde Tage
                <small>Supertag, Wellness, Alkoholfrei</small>
              </div>
              <div class="chart-bar-value">
                <span class="chart-bar-number" id="chart6mPositiveNum">0</span>
                <span class="chart-bar-percent" id="chart6mPositivePct">0%</span>
              </div>
            </div>
            <div class="chart-bar-wrapper">
              <div class="chart-bar positive" id="chart6mPositive"></div>
            </div>
          </div>
        </div>
        
        <!-- 6-Monats-Metriken -->
        <div class="assessment-metrics" style="margin-top:16px;">
          <div class="metric-item">
            <div class="metric-label">
              Trend (letztes Quartal)
              <span class="tooltip-icon" data-tooltip="Vergleicht die letzten 90 Tage mit den 90 Tagen davor. ğŸ“ˆ=Verbesserung (mehr positive Tage), ğŸ“‰=Verschlechterung (mehr Risikotage), â¡ï¸=Stabil">?</span>
            </div>
            <div class="metric-value" id="metric6mTrend">-</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Ã˜ Risikotage/Monat
              <span class="tooltip-icon" data-tooltip="Durchschnittliche Anzahl von Risikotagen (Alkohol, Mixed, Moderat, Katertag mit Alkohol) pro Monat Ã¼ber 6 Monate. Niedriger ist besser.">?</span>
            </div>
            <div class="metric-value" id="metric6mAvgRisk">0</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Kompensationstrinken
              <span class="tooltip-icon" data-tooltip="Trinken nach Sport/Wellness-AktivitÃ¤ten (Checkbox 'Kompensation'). Zeigt problematisches Muster: Sport wird als 'Erlaubnis' zum Trinken missbraucht.">?</span>
            </div>
            <div class="metric-value" id="metric6mCompensation">0</div>
          </div>
        </div>
        
        <div style="margin-top:12px; padding:12px; background:white; border-radius:8px; font-size:12px; color:var(--muted);">
          <strong>ğŸ’¡ Langzeit-EinschÃ¤tzung:</strong>
          <div id="longTermAssessment" style="margin-top:6px;"></div>
        </div>
      </div>

      <!-- Health Assessment -->
      <div class="health-assessment">
        <div class="assessment-title">ğŸ¯ Deine GesundheitseinschÃ¤tzung</div>
        <div class="assessment-badge" id="assessmentBadge"></div>

        <!-- Beschreibung mit AuslÃ¶ser (direkt nach Plakette) -->
        <div class="assessment-description" id="assessmentDescription"></div>
        <div id="assessmentWarning" class="assessment-warning" style="display:none;"></div>

        <!-- Basierend auf Info -->
        <div id="assessmentBasis" style="text-align:center; font-size:12px; color:var(--muted); margin:16px 0 24px 0; padding:8px; background:#f9fafb; border-radius:6px;"></div>

        <div class="assessment-metrics">
          <div class="metric-item">
            <div class="metric-label">
              AF-Quote (alkoholfrei)
              <span class="tooltip-icon" data-tooltip="Alkoholfreie-Tage-Quote: Anteil von Superday/Wellness/Sober-Tagen der letzten 100 Tage. Je hÃ¶her, desto besser!">?</span>
            </div>
            <div class="metric-value" id="metricAF">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Gewichtete Gesundheit
              <span class="tooltip-icon" data-tooltip="Gesundheitsquote mit Gewichtung: Superday=100%, Wellness=90%, NÃ¼chtern=75%, Moderat=40%, Mixed=25%, Alkohol=0%. Katertage werden adaptiv bewertet je nach Vortag.">?</span>
            </div>
            <div class="metric-value" id="metricHealth">0%</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">
              Binge-NÃ¤he (Hochrisiko)
              <span class="tooltip-icon" data-tooltip="Anzahl problematischer Tage ...(truncated 62400 characters)...t bingeQuote = bingeProximity / divisor;
      
      // Cluster-Erkennung
      let maxCluster = 0, currentCluster = 0;
      for (const day of last100Days) {
        if (day.st === 'alcohol' || day.st === 'mixed' || day.st === 'hangover') {
          currentCluster++;
          maxCluster = Math.max(maxCluster, currentCluster);
        } else {
          currentCluster = 0;
        }
      }
      
      let label, badgeClass, description, warning = '';
      
      // Spezial-Warnung bei Katertagen mit Alkohol
      const morningDrinkingWarning = counts.hangoverWithAlc > 0 ?
        `<br><br>ğŸš¨ <strong>KRITISCH:</strong> ${counts.hangoverWithAlc} Katertag(e) mit Weiter-Alkohol! Dies ist ein DSM-5-Kriterium fÃ¼r schwere AlkoholabhÃ¤ngigkeit (morgendliches Trinken zur Linderung). Dringend professionelle Hilfe empfohlen!` :
        '';

      // Helper-Funktion: Tooltip nach erstem Wort des ersten Triggers einfÃ¼gen
      function formatReasonsWithTooltip(reasons) {
        if (reasons.length === 0) return '';

        const tooltipHTML = '<span class="tooltip-icon" data-tooltip="Diese Metriken haben die Risiko-Einstufung ausgelÃ¶st. Binge-NÃ¤he=absolute Anzahl, Hochrisiko-Anteil=relativer Prozentsatz aller erfassten Tage.">?</span>';

        const firstReason = reasons[0];
        const spaceIndex = firstReason.indexOf(' ');

        if (spaceIndex > 0) {
          // FÃ¼ge Tooltip nach erstem Wort ein
          const firstWord = firstReason.substring(0, spaceIndex);
          const restOfFirst = firstReason.substring(spaceIndex);
          let formatted = firstWord + ' ' + tooltipHTML + restOfFirst;

          // FÃ¼ge restliche Reasons hinzu
          if (reasons.length > 1) {
            formatted += ' Â· ' + reasons.slice(1).join(' Â· ');
          }
          return formatted;
        } else {
          // Fallback: Tooltip am Ende wenn kein Leerzeichen
          return reasons.join(' Â· ') + ' ' + tooltipHTML;
        }
      }

      if (bingeProximity >= 40 || afQuote < 0.20 || (bingeQuote >= 0.40 && enteredDays >= 10) || counts.hangoverWithAlc >= 3) {
        label = 'ğŸš¨ Sucht-Alarm: Rote Lampen!';
        badgeClass = 'red';

        // Sammle explizite AuslÃ¶ser
        const reasons = [];
        if (bingeProximity >= 40) reasons.push(`Binge-NÃ¤he ${bingeProximity}/100 (â‰¥40)`);
        if (afQuote < 0.20) reasons.push(`AF-Quote ${Math.round(afQuote*100)}% (<20%)`);
        if (bingeQuote >= 0.40 && enteredDays >= 10) reasons.push(`Hochrisiko-Anteil ${Math.round(bingeQuote*100)}% (â‰¥40%)`);
        if (counts.hangoverWithAlc >= 3) reasons.push(`${counts.hangoverWithAlc} Katertage mit Alkohol`);
        if (maxCluster >= 5) reasons.push(`Cluster ${maxCluster} Tage in Folge`);

        description = '<strong>Sehr hohes Risiko / Potenzielle AbhÃ¤ngigkeit</strong> â€” Extremes Risiko fÃ¼r Herz, Gehirn, Krebs und Leber. DSM-5-Warnzeichen fÃ¼r schwere AUD (6+ Kriterien): starkes Verlangen (Craving), Entzug, Kontrollverlust, Toleranz, Weitermachen trotz SchÃ¤den, VernachlÃ¤ssigung anderer AktivitÃ¤ten.<br><br><strong>AuslÃ¶ser:</strong> ' + formatReasonsWithTooltip(reasons) + morningDrinkingWarning;
        warning = 'ğŸ†˜ Professionelle Hilfe SOFORT empfohlen: SAMHSA-Hotline, lokale Suchtberatung, medizinisches GesprÃ¤ch. Dies ist keine Diagnose, aber ein klares Signal! Ab AUDIT â‰¥ 8 Punkten ist professionelle AbklÃ¤rung essentiell (ICD-10/DSM-5).';
      } else if ((bingeProximity >= 20 && bingeProximity < 40) || (afQuote < 0.30 && afQuote >= 0.20) || (bingeQuote >= 0.20 && enteredDays >= 10) || counts.hangoverWithAlc >= 1) {
        label = 'ğŸ² Risiko-Roulette';
        badgeClass = 'red';

        // Sammle explizite AuslÃ¶ser
        const reasons = [];
        if (bingeProximity >= 20 && bingeProximity < 40) reasons.push(`Binge-NÃ¤he ${bingeProximity}/100 (20-39)`);
        if (afQuote < 0.30 && afQuote >= 0.20) reasons.push(`AF-Quote ${Math.round(afQuote*100)}% (20-29%)`);
        if (bingeQuote >= 0.20 && enteredDays >= 10) reasons.push(`Hochrisiko-Anteil ${Math.round(bingeQuote*100)}% (â‰¥20%)`);
        if (counts.hangoverWithAlc >= 1) reasons.push(`${counts.hangoverWithAlc} Katertag(e) mit Alkohol`);
        if (maxCluster >= 4) reasons.push(`Cluster ${maxCluster} Tage in Folge`);

        description = '<strong>Hohes Risiko</strong> â€” Du spielst Russian Roulette mit deiner Gesundheit. Hohes Risiko fÃ¼r Krebs, Leberzirrhose, Herz-Kreislauf-Erkrankungen und UnfÃ¤lle. Sport kann diese Risiken NICHT kompensieren (WHO).<br><br><strong>AuslÃ¶ser:</strong> ' + formatReasonsWithTooltip(reasons) + morningDrinkingWarning;
        warning = 'ğŸš¨ Moderate bis schwere AUD wahrscheinlich (4-5 DSM-5-Kriterien wie Toleranz, soziale Probleme, Kontrollverlust). Medizinisches GesprÃ¤ch und professionelle Beratung DRINGEND empfohlen!';
      } else if (afQuote <= 0.39 || (bingeProximity >= 13 && bingeProximity <= 19) || (bingeQuote >= 0.13 && enteredDays >= 10)) {
        label = 'ğŸš¨ Kipppunkt-Kandidat';
        badgeClass = 'weekend';

        // Sammle explizite AuslÃ¶ser
        const reasons = [];
        if (afQuote <= 0.39) reasons.push(`AF-Quote ${Math.round(afQuote*100)}% (<40%)`);
        if (bingeProximity >= 13 && bingeProximity <= 19) reasons.push(`Binge-NÃ¤he ${bingeProximity}/100 (â‰¥13)`);
        if (bingeQuote >= 0.13 && enteredDays >= 10) reasons.push(`Hochrisiko-Anteil ${Math.round(bingeQuote*100)}% (â‰¥13%)`);
        if (maxCluster >= 3) reasons.push(`Cluster ${maxCluster} Tage in Folge`);

        description = '<strong>ErhÃ¶htes Risiko â€“ Kritische Schwelle erreicht</strong> â€” Du befindest dich an einem Kipppunkt: HÃ¤ufige Rauschsituationen sind nachweisliche Treiber fÃ¼r Leber-, Krebs- und Herzprobleme.<br><br><strong>AuslÃ¶ser:</strong> ' + formatReasonsWithTooltip(reasons);
        warning = 'âš ï¸ Dringend empfohlen: AUDIT-Screening durchfÃ¼hren! Sport neutralisiert Alkoholrisiken NICHT (WHO/DHS). Potenziell mildes AUD bei 2-3 DSM-5-Kriterien (z.B. Kontrollverlust, mehr trinken als geplant).';
      } else if (afQuote >= 0.40 && afQuote < 0.70 && bingeProximity <= 12) {
        label = 'ğŸ§˜ Balance-Buddha';
        badgeClass = 'balance';
        description = '<strong>Moderates Risiko</strong> â€” Du meditierst mit einem Glas Wasser â€“ zen, aber nicht fanatisch! AF-Quote 40-69% ist solide. PrÃ¼fe kritisch: Bleiben "moderate" Tage wirklich moderat (â‰¤2 Einheiten/Woche nach DGE)? Binge-Events (â‰¤12/100 â‰ˆ hÃ¶chstens viertel- bis monatlich) sind Ã¼berschaubar.';
        warning = 'Tipp: Mehr Supertage/Wellness-Tage einstreuen â€“ Sport + Abstinenz = doppelter Gesundheitsboost!';
      } else {
        label = 'ğŸ¦¸ Leber-Superheld';
        badgeClass = 'zen';
        description = '<strong>Niedriges Gesamtrisiko</strong> â€” Du bist der Batman der Bars â€“ unsichtbar fÃ¼r Alkohol! Deine alkoholfreien Tage (â‰¥70%) mit sportlichen/erholsamen Puffern zeigen ein vorbildliches Muster. Binge-Events sind selten (â‰¤4/100 Tage â‰ˆ seltener als monatlich). Deine Leber schickt dir Dankeskarten! ğŸ’š';
        warning = 'âš ï¸ Trotzdem kein "Freifahrtschein" â€“ WHO empfiehlt weiterhin Wachsamkeit.';
      }
      
      // Sonder-Warnungen
      let extraWarnings = '';
      if (maxCluster >= 3) {
        extraWarnings += `<br>ğŸ”¥ <strong>Cluster-StÃ¼rmer erkannt:</strong> ${maxCluster} Hochrisiko-Tage am StÃ¼ck bedeuten deutlichen Risiko-Spike!`;
      }
      if (counts.mixed >= 15) {
        extraWarnings += `<br>ğŸ’Š <strong>Schadensbegrenzungs-Illusionist:</strong> Sport kaschiert Alkoholrisiken, senkt sie aber NICHT substanziell (WHO). ${counts.mixed} "Schadensbegrenzung"-Tage zeigen ein problematisches Muster.`;
      }
      
      const afDisplay = neutralDaysSetting === 'ignore' ? 
        `${Math.round(afQuote * 100)}% (${afCount}/${enteredDays})` : 
        `${Math.round(afQuote * 100)}%`;
      
      document.getElementById('metricAF').textContent = afDisplay;
      document.getElementById('metricHealth').textContent = Math.round(weightedScore * 100) + '%';
      document.getElementById('metricBinge').textContent = neutralDaysSetting === 'ignore' ? 
        `${bingeProximity} (${Math.round(bingeQuote * 100)}%)` : 
        bingeProximity;
      document.getElementById('metricCluster').textContent = maxCluster > 0 ? maxCluster + ' Tage' : 'Keiner';
      
      const badge = document.getElementById('assessmentBadge');
      badge.textContent = label;
      badge.className = 'assessment-badge ' + badgeClass;

      // Plakette klickbar machen - scrollt zur Beschreibung und hebt sie hervor
      badge.onclick = () => {
        const descEl = document.getElementById('assessmentDescription');
        descEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        descEl.style.transition = 'all 0.3s ease';
        descEl.style.transform = 'scale(1.02)';
        descEl.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
        setTimeout(() => {
          descEl.style.transform = 'scale(1)';
          descEl.style.boxShadow = '';
        }, 600);
      };

      const basisInfo = neutralDaysSetting === 'ignore' ?
        `ğŸ“Š Basierend auf <strong>${enteredDays} von 100 Tagen</strong>` :
        `ğŸ“Š Basierend auf <strong>100 Tagen</strong> (${enteredDays} eingetragen)`;

      document.getElementById('assessmentBasis').innerHTML = basisInfo;
      document.getElementById('assessmentDescription').innerHTML = description;
      
      const warningEl = document.getElementById('assessmentWarning');
      if (warning || extraWarnings) {
        warningEl.innerHTML = (warning || '') + extraWarnings;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }
      
      buildDetailedAnalysis();
    }

    function buildDetailedAnalysis() {
      const today = new Date();
      
      // === DATENSAMMLUNG ===
      let last180Days = [];
      let gramsData = [];
      let daysCount = 0;
      let hangoverWithAlc = 0;
      let compensationCount = 0; // NEU: Kompensationstrinken zÃ¤hlen
      
      for (let i = 0; i < 180; i++) {
        const dt = new Date(today);
        dt.setDate(dt.getDate() - i);
        const key = formatDateKey(dt);
        const entry = dayData[key];
        const status = getDayStatus(key);
        
        let grams = 0;
        let hasActualConsumption = false; // Track ob echter Alkoholkonsum

        if (entry && entry.totalAlcohol) {
          grams = entry.totalAlcohol;
          hasActualConsumption = true;

          // ZÃ¤hle Katertage mit Alkohol: PrÃ¼fe CHECKBOX hangover, nicht Status!
          if (entry.hangover && grams > 0) {
            hangoverWithAlc++;
          }

          // ZÃ¤hle Kompensationstrinken (NEU)
          if (entry.compensation && grams > 0) {
            compensationCount++;
          }
        } else if (status) {
          // Fallback-Werte fÃ¼r Berechnung
          const fallback = {superday: 0, wellness: 0, sober: 0, moderate: 20, mixed: 40, alcohol: 50, hangover: 60};
          grams = fallback[status] || 0;
          // Nur als Konsum zÃ¤hlen wenn Status ein Alkohol-Tag ist
          hasActualConsumption = (status === 'moderate' || status === 'mixed' || status === 'alcohol' || status === 'hangover');
        }

        last180Days.push({key, status, grams, entry, date: new Date(dt)});
        if (hasActualConsumption) daysCount++; // Nur echte Konsum-Tage zÃ¤hlen
        gramsData.push(grams);
      }
      
      const last100 = last180Days.slice(0, 100);
      const last30 = last180Days.slice(0, 30);
      
      // === 1. MENGEN-ANALYSE ===
      const gramsTotal = gramsData.reduce((sum, g) => sum + g, 0);
      const avgPerDay = daysCount > 0 ? (gramsTotal / daysCount).toFixed(1) : 0;
      const weeks = 180 / 7.0;
      const avgPerWeek = (gramsTotal / weeks).toFixed(1);
      const avgDrinksPerWeek = (avgPerWeek / DRINK_UNIT).toFixed(1);
      
      // DGE/WHO Schwellenwerte - geschlechtsspezifisch
      const dgeDailyLimit = (userGender === 'female') ? 12 : 24;
      const dgeVeryHigh = 40; // allgemeiner "sehr hoch"-Marker

      let dgeRisk = `niedrig (â‰¤${dgeDailyLimit}g/Tag ${userGender==='female' ? 'â™€' : 'â™‚'}-Limit)`;
      if (avgPerDay > dgeDailyLimit) {
        dgeRisk = `hoch (âš ï¸ >${dgeDailyLimit}g/Tag ${userGender==='female' ? 'â™€' : 'â™‚'}-Limit)`;
      }
      if (avgPerDay > dgeVeryHigh) {
        dgeRisk = `sehr hoch (âš ï¸ >${dgeVeryHigh}g/Tag)`;
      }
      // Bonus: zeige bei MÃ¤nnern die Zwischenlage an
      if (userGender === 'male' && avgPerDay > 12 && avgPerDay <= 24) {
        dgeRisk = 'moderat (Ã¼ber â™€-Limit, unter â™‚-Limit)';
      }
      
      // === 2. BINGE-ANALYSE ===
      const bingeThreshold = (userGender === 'female') ? 40 : 60; // Frauen 40g, MÃ¤nner 60g
      let bingeDays = 0;
      let maxBac = 0;
      let bacPeaks = [];

      last100.forEach(day => {
        if (day.grams >= bingeThreshold) {
          bingeDays++;
          const bac = estimateBAC(day.grams);
          bacPeaks.push({date: day.date, bac: parseFloat(bac), grams: day.grams});
          if (parseFloat(bac) > maxBac) maxBac = parseFloat(bac);
        }
      });
      
      bacPeaks.sort((a, b) => b.bac - a.bac);
      const top3Peaks = bacPeaks.slice(0, 3);
      
      // === 3. CLUSTER-ANALYSE ===
      let maxCluster = 0, curCluster = 0;
      let clusterEvents = [];
      
      last100.forEach((day, idx) => {
        if (day.grams >= 20) {
          curCluster++;
        } else {
          if (curCluster >= 3) {
            clusterEvents.push({length: curCluster, endIdx: idx - 1});
          }
          maxCluster = Math.max(maxCluster, curCluster);
          curCluster = 0;
        }
      });
      if (curCluster >= 3) clusterEvents.push({length: curCluster, endIdx: 0});
      maxCluster = Math.max(maxCluster, curCluster);
      
      // === 4. WEEKEND BINGE PATTERN ===
      let weekendTotal = 0, weekendHigh = 0;
      const weekdayIdx = d => (d.getDay() + 6) % 7; // Mo=0...So=6
      
      last100.forEach(day => {
        const dow = weekdayIdx(day.date);
        if (dow === 4 || dow === 5) { // Fr, Sa
          if (day.grams > 0 || day.status) {
            weekendTotal++;
            if (day.grams >= 40) weekendHigh++;
          }
        }
      });
      
      const weekendBinger = weekendTotal > 0 && (weekendHigh / weekendTotal) >= 0.4;
      
      // === 5. VOLATILITÃ„T (14-Tage-Schwankungen) ===
      const last14Grams = gramsData.slice(0, 14).filter(g => g > 0);
      let volatility = 0;
      if (last14Grams.length > 1) {
        const mean = last14Grams.reduce((sum, g) => sum + g, 0) / last14Grams.length;
        const variance = last14Grams.reduce((sum, g) => sum + Math.pow(g - mean, 2), 0) / last14Grams.length;
        volatility = Math.sqrt(variance);
      }
      
      let volRisk = 'stabil';
      if (volatility > 30) volRisk = 'sehr volatil âš ï¸';
      else if (volatility > 20) volRisk = 'volatil';
      else if (volatility > 10) volRisk = 'moderat schwankend';
      
      // Neu: CVaR statt VolatilitÃ¤t (Conditional Value-at-Risk)
      let cvar = 0;
      if (last14Grams.length > 0) {
        const sortedGrams = last14Grams.sort((a, b) => b - a);
        const worstPercent = Math.ceil(sortedGrams.length * 0.05); // 5%
        const worstDays = sortedGrams.slice(0, worstPercent);
        cvar = worstDays.reduce((sum, g) => sum + g, 0) / worstDays.length;
      }
      let cvarRisk = cvar > 60 ? 'sehr hoch âš ï¸' : cvar > 40 ? 'hoch' : 'niedrig';
      
      // === 6. TOLERANCE CREEP ===
      const first90 = last180Days.slice(90, 180);
      const recent90 = last180Days.slice(0, 90);
      
      const medianGrams = arr => {
        const sorted = arr.filter(d => d.grams > 0).map(d => d.grams).sort((a,b) => a-b);
        if (sorted.length === 0) return 0;
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 === 0 ? (sorted[mid-1] + sorted[mid]) / 2 : sorted[mid];
      };
      
      const oldMedian = medianGrams(first90);
      const newMedian = medianGrams(recent90);
      const creep = newMedian - oldMedian;
      
      let creepStatus = 'keine Toleranzentwicklung';
      if (creep > 15) creepStatus = 'âš ï¸ starke Toleranzentwicklung (+' + creep.toFixed(0) + 'g)';
      else if (creep > 5) creepStatus = 'âš ï¸ Toleranzentwicklung (+' + creep.toFixed(0) + 'g)';
      else if (creep < -5) creepStatus = 'âœ… Reduzierung (-' + Math.abs(creep).toFixed(0) + 'g)';
      
      // === 7. MARKOV-CHAIN 7-TAGE-PROGNOSE (VERBESSERT) ===
      const states = ['superday', 'wellness', 'sober', 'moderate', 'mixed', 'alcohol', 'hangover'];
      const idx = {};
      states.forEach((s, i) => idx[s] = i);

      // Transition Matrix mit exponentieller Recency-Gewichtung
      const M = Array(7).fill(0).map(() => Array(7).fill(0.1)); // Minimales Laplace Smoothing

      let prev = null;
      for (let i = 179; i >= 1; i--) {
        const st = last180Days[i].status;
        if (!st) continue;
        
        // Exponentielle Gewichtung: je jÃ¼nger, desto mehr Gewicht
        // Letzte 7 Tage: ~10x, letzte 30: ~2.5x, Ã¤lter: 1x
        const daysAgo = i;
        const weight = Math.exp(-daysAgo / 60); // Decay-Faktor
        
        if (prev && idx[prev] !== undefined && idx[st] !== undefined) {
          M[idx[prev]][idx[st]] += weight;
        }
        prev = st;
      }

      // Normalisieren zu Wahrscheinlichkeiten
      M.forEach(row => {
        const sum = row.reduce((s, v) => s + v, 0);
        if (sum > 0) {
          for (let i = 0; i < row.length; i++) {
            row[i] /= sum;
          }
        } else {
          // Fallback: gleichmÃ¤ÃŸige Verteilung
          for (let i = 0; i < row.length; i++) {
            row[i] = 1 / states.length;
          }
        }
      });

      // Monte-Carlo Simulation: 1000 DurchlÃ¤ufe
      const currentState = last180Days[0].status || 'sober';
      const simulations = 1000;
      const dayPredictions = Array(7).fill(0).map(() => ({}));

      // Initialisiere ZÃ¤hler
      states.forEach(s => {
        for (let d = 0; d < 7; d++) {
          dayPredictions[d][s] = 0;
        }
      });

      // Stochastische Simulationen
      for (let sim = 0; sim < simulations; sim++) {
        let state = currentState;
        
        for (let day = 0; day < 7; day++) {
          const probs = M[idx[state]];
          
          // Stochastische Auswahl: WÃ¼rfeln basierend auf Wahrscheinlichkeiten
          const random = Math.random();
          let cumulative = 0;
          let nextState = state;
          
          for (let i = 0; i < states.length; i++) {
            cumulative += probs[i];
            if (random <= cumulative) {
              nextState = states[i];
              break;
            }
          }
          
          // ZÃ¤hle Vorhersage
          dayPredictions[day][nextState]++;
          state = nextState;
        }
      }

      // Berechne Durchschnitt und Konfidenzintervalle
      let forecast = [];
      for (let day = 0; day < 7; day++) {
        // Sortiere ZustÃ¤nde nach HÃ¤ufigkeit
        const sorted = Object.entries(dayPredictions[day])
          .sort((a, b) => b[1] - a[1]);
        
        const mostLikely = sorted[0][0];
        const probability = (sorted[0][1] / simulations * 100).toFixed(0);
        
        // Top-3 Wahrscheinlichkeiten fÃ¼r Konfidenzintervall
        const top3 = sorted.slice(0, 3).map(([state, count]) => ({
          state,
          prob: (count / simulations * 100).toFixed(0)
        }));
        
        forecast.push({
          day: day + 1,
          state: mostLikely,
          prob: probability,
          alternatives: top3
        });
      }

      // Speichere forecast global fÃ¼r Popup
      markovForecast = forecast;

      // === 8. RECOVERY RATE ===
      let recoveryTimes = [];
      let lastBinge = null;
      
      last180Days.reverse().forEach((day, idx) => {
        if (day.grams >= 60) {
          if (lastBinge !== null) {
            recoveryTimes.push(idx - lastBinge);
          }
          lastBinge = idx;
        }
      });
      
      const avgRecovery = recoveryTimes.length > 0 ? 
        (recoveryTimes.reduce((s, t) => s + t, 0) / recoveryTimes.length).toFixed(1) : 
        'N/A';
      
      // === 9. COMMENT RISK ANALYSIS ===
      const triggerWords = [
        // Emotionale Belastung
        'stress', 'traurig', 'wut', 'Ã¤rger', 'depressiv', 'einsam', 'verzweifelt', 'Ã¼berfordert', 'nervÃ¶s', 'erschÃ¶pft',

        // Soziale Kontexte
        'party', 'feier', 'geburtstag', 'wochenende', 'urlaub', 'kneipe', 'bar', 'club', 'festival', 'runde', 'trinken', 'anstoÃŸen',

        // Konflikte & Probleme
        'streit', 'problem', 'scheiÃŸe', 'schlecht', 'stressig', 'diskussion', 'trennung', 'verlust', 'kÃ¼ndigung', 'stressphase',

        // Selbstabwertung & Flucht
        'versagt', 'nicht geschafft', 'egal', 'scheiÃŸ drauf', 'flucht', 'abschalten', 'betÃ¤uben', 'vergessen', 'nichts fÃ¼hlen',

        // Gewohnheiten & Muster
        'bier', 'wein', 'schnaps', 'whisky', 'cocktail', 'trinklust', 'durst', 'gewohnheit', 'ritual', 'belohnung',

        // KÃ¶rperliche Hinweise
        'kopfschmerzen', 'kater', 'Ã¼belkeit', 'zittern', 'schwindel', 'nicht geschlafen', 'mÃ¼de', 'ausgelaugt'
      ];
      let triggerCount = 0;
      
      last30.forEach(day => {
        if (day.entry && day.entry.comment) {
          const comment = day.entry.comment.toLowerCase();
          triggerWords.forEach(word => {
            if (comment.includes(word)) triggerCount++;
          });
        }
      });
      
      const commentRisk = triggerCount > 5 ? 'âš ï¸ hoch' : triggerCount > 2 ? 'moderat' : 'niedrig';
      
      // === Neu: Leber-Belastungs-Score ===
      let leberScore = 0;
      const lambda = 0.05; // Decay-Rate fÃ¼r ~14-Tage Halbwert (ln(2)/14 â‰ˆ 0.05)
      gramsData.forEach((g, i) => {
        leberScore += g * Math.exp(-lambda * i);
      });
      leberScore = Math.round(leberScore);
      let leberRisk = leberScore > 5000 ? 'sehr hoch âš ï¸' : leberScore > 3000 ? 'hoch' : 'niedrig';
      let leberRecommendation = leberScore > 3000 ? 'Dringend: Min. 14 Tage alkoholfrei fÃ¼r Regeneration!' : 'Gut: Halte es so, um langfristige SchÃ¤den zu vermeiden.';
      
      // === HTML GENERIERUNG ===
      const catNames = {
        superday: 'â­',
        wellness: 'ğŸ’š',
        sober: 'ğŸŸ¢',
        moderate: 'ğŸŸ¡',
        mixed: 'â¤ï¸',
        alcohol: 'ğŸ”´',
        hangover: 'ğŸºğŸ’¥'
      };
      
      let html = `
        <div style="line-height:2.0; font-size:14px;">
          <div style="margin-bottom:24px; padding:16px; background:#f0f9ff; border-radius:8px; border:1px solid #bae6fd;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">ğŸ“Š Mengen-Analyse (180 Tage)</div>
            <div><strong>Ã˜ Gramm/Tag:</strong> ${avgPerDay}g <span style="color:var(--muted);">(${daysCount} Tage mit Konsum)</span></div>
            <div><strong>Ã˜ Gramm/Woche:</strong> ${avgPerWeek}g</div>
            <div><strong>Ã˜ Drinks/Woche:</strong> ${avgDrinksPerWeek} <span style="font-size:12px;">(Ã  10g)</span></div>
            <div style="margin-top:8px; padding:8px; background:white; border-radius:6px;">
              <strong>DGE/WHO-Risiko:</strong> ${dgeRisk}
              <span class="tooltip-icon" data-tooltip="Deutsche Gesellschaft fÃ¼r ErnÃ¤hrung / Weltgesundheitsorganisation. Risikoarmes Limit: â™€ 12g/Tag, â™‚ 24g/Tag. Ab 40g/Tag sehr hohes Risiko fÃ¼r alle Geschlechter.">?</span>
            </div>
          </div>

          <div style="margin-bottom:24px; padding:16px; background:#fef3c7; border-radius:8px; border:1px solid #fde68a;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">âš ï¸ Binge-Analyse (100 Tage)</div>
            <div>
              <strong>Binge-Tage (â‰¥${bingeThreshold}g):</strong> ${bingeDays}/100 ${bingeDays > 10 ? 'âš ï¸' : ''}
              <span class="tooltip-icon" data-tooltip="Binge-Schwelle: â™€ â‰¥40g, â™‚ â‰¥60g pro Tag. Ab 10 Binge-Tagen in 100 Tagen erhÃ¶htes Gesundheitsrisiko.">?</span>
            </div>
            <div>
              <strong>Max. BAC (geschÃ¤tzt):</strong> ${maxBac.toFixed(2)}â€°
              <span class="tooltip-icon" data-tooltip="BAC = Blood Alcohol Concentration (Blutalkoholkonzentration in Promille). 0,5â€°=FahruntÃ¼chtig, 1,0â€°=Deutlich betrunken, 2,0â€°=Stark betrunken, 3,0â€°+=LebensgefÃ¤hrlich">?</span>
            </div>
            ${top3Peaks.length > 0 ? `
              <div style="margin-top:8px;"><strong>Top-3 Peaks:</strong></div>
              <ul style="margin:4px 0; padding-left:20px; font-size:13px;">
                ${top3Peaks.map(p => `<li>${p.date.toLocaleDateString('de-DE')}: ${p.grams}g (${p.bac.toFixed(2)}â€°)</li>`).join('')}
              </ul>
            ` : ''}
          </div>
          
          <div style="margin-bottom:24px; padding:16px; background:#fee; border-radius:8px; border:1px solid #fcc;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">ğŸ”¥ Cluster & Patterns</div>
            <div><strong>LÃ¤ngster Cluster:</strong> ${maxCluster} Tage (â‰¥20g am StÃ¼ck) ${maxCluster >= 5 ? 'âš ï¸' : ''}</div>
            <div><strong>Cluster-Events (â‰¥3 Tage):</strong> ${clusterEvents.length}</div>
            <div><strong>Weekend-Binge Pattern:</strong> ${weekendBinger ? 'âš ï¸ Ja (Fr/Sa-Fokus)' : 'Nein'} 
              <span style="font-size:12px;">(${weekendHigh}/${weekendTotal} Wochenenden)</span></div>
            <div><strong>CVaR (Extremrisiko 5%):</strong> ${cvar.toFixed(1)}g Ã˜ (${cvarRisk}) 
              <span class="tooltip-icon" data-tooltip="Conditional Value-at-Risk: Durchschnitt der schlimmsten 5% Tage. Robuster Indikator fÃ¼r Binge-Schwere als VolatilitÃ¤t.">?</span></div>
          </div>
          
          <div style="margin-bottom:24px; padding:16px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="font-weight:800; margin-bottom:12px; font-size:16px;">ğŸ“ˆ Trends & Tolerance</div>
            <div>
              <strong>Tolerance Creep (90d vs. 90d):</strong> ${creepStatus}
              <span class="tooltip-icon" data-tooltip="Toleranzentwicklung: Vergleicht den Median-Alkoholkonsum der letzten 90 Tage mit den 90 Tagen davor. Anstieg deutet auf GewÃ¶hnung hin (brauche mehr fÃ¼r gleichen Effekt).">?</span>
            </div>
            <div>
              <strong>Ã˜ Recovery (Bingeâ†’Binge):</strong> ${avgRecovery} Tage
              <span class="tooltip-icon" data-tooltip="Durchschnittliche Tage zwischen zwei Binge-Events (â‰¥${userGender==='female' ? 40 : 60}g). KÃ¼rzere Recovery-Zeit = hÃ¶heres Risiko. 'N/A' bedeutet keine oder nur 1 Binge-Episode erfasst.">?</span>
            </div>
            <div>
              <strong>Comment Risk (30d):</strong> ${commentRisk} <span style="font-size:12px;">(${triggerCount} Trigger Trigger-WÃ¶rter)</span>
              <span class="tooltip-icon" data-tooltip="Analyse deiner Tages-Kommentare auf Risiko-WÃ¶rter (Stress, Frust, Angst, Druck, MÃ¼de, etc.). Viele Trigger = emotionale TrinkgrÃ¼nde. Niedrig=gut, Moderat=Achtung, Hoch=Warnung.">?</span>
            </div>
            <div><strong>Kompensationstrinken (180d):</strong> ${compensationCount} ${compensationCount > 0 ? '<span style="color:#f59e0b;">âš ï¸</span>' : 'âœ…'}</div>
            ${compensationCount > 15 ? `<div style="margin-top:8px; padding:8px; background:#fef3c7; border-left:3px solid #f59e0b; border-radius:4px;"><strong>âš ï¸ Emotionale AbhÃ¤ngigkeit:</strong> ${compensationCount} Kompensations-Trinktage deuten auf StressbewÃ¤ltigung durch Alkohol hin - ein klares Warnzeichen!</div>` : ''}
            ${hangoverWithAlc > 0 ? `<div style="margin-top:8px; padding:8px; background:#fee2e2; border-left:3px solid #dc2626; border-radius:4px;"><strong>ğŸš¨ Katertage mit Weiter-Alkohol:</strong> ${hangoverWithAlc} (DSM-5-Kriterium fÃ¼r schwere AUD!)</div>` : ''}
          </div>

          <!-- Neu: Leber-Belastungs-Score Sektion -->
          <div class="leber-score-section">
            <div class="leber-title">ğŸ«€ Leber-Belastungs-Score (kumulativ 180d)</div>
            <div class="leber-value">${leberScore}</div>
            <div class="leber-desc">Gewichtete toxische Dosis mit exponentiellem Decay (simuliert Leber-Regeneration).</div>
            <div class="leber-warning">${leberRisk}: ${leberRecommendation}</div>
          </div>

          <!-- Markov-Prognose Button -->
          <div style="margin-bottom:16px; text-align:center;">
            <button onclick="toggleMarkovPopup()" style="padding:16px 32px; background:linear-gradient(135deg, #ede9fe, #faf5ff); border:2px solid #c4b5fd; border-radius:12px; font-size:16px; font-weight:700; color:#6b21a8; cursor:pointer; box-shadow:0 4px 12px rgba(196,181,253,0.2); transition:all 0.2s ease;">
              ğŸ”® Markov-Prognose anzeigen (7 Tage)
            </button>
          </div>
          
          <div style="padding:12px; background:#fef2f2; border-left:4px solid #ef4444; border-radius:6px; font-size:12px; line-height:1.6;">
            <strong>ğŸ“š Wissenschaftliche Basis:</strong><br>
            â€¢ DGE: â‰¤24g/Tag (MÃ¤nner), â‰¤12g/Tag (Frauen)<br>
            â€¢ WHO: Binge = â‰¥60g/Session<br>
            â€¢ RKI: Riskanter Konsum = >20g/Tag regelmÃ¤ÃŸig<br>
            â€¢ DSM-5: AUD-Kriterien bei Kontrollverlust, Toleranz, Craving, <strong>morgendlichem Trinken</strong><br>
            â€¢ Markov-Chain: Historische Ãœbergangsmuster<br>
            â€¢ <strong>Katertag ohne Alkohol = 40% Gesundheit</strong> (leidet, trinkt aber nicht weiter)<br>
            â€¢ <strong>Katertag MIT Alkohol = 0% Gesundheit</strong> (doppelt problematisch, DSM-5-Kriterium!)<br>
            â€¢ CVaR: Conditional Value-at-Risk fÃ¼r Extremrisiken<br>
            â€¢ Leber-Score: Exponentieller Decay basierend auf metabolischer Halbwertszeit (~14 Tage)
          </div>
          
          <div style="margin-top:16px; font-size:12px; color:var(--muted);">
            <strong>Hinweis:</strong> Wo keine detaillierten Mengen erfasst wurden, nutzt die Analyse plausible Fallbacks (moderatâ‰ˆ20g, Schadensbegrenzungâ‰ˆ40g, vielâ‰ˆ50g, Katertagâ‰ˆ60g). 
            Exakte Angaben im God-Modus verbessern die Aussagekraft massiv.
          </div>
        </div>
      `;
      
      document.getElementById('godMetricsList').innerHTML = html;
    }

    /* ========================================
       POPUPS
    ======================================== */
    function toggleChartPopup() {
      const popup = document.getElementById('chartPopup');
      const overlay = document.getElementById('chartOverlay');
      const isActive = popup.classList.contains('active');

      if (isActive) {
        popup.classList.remove('active');
        overlay.classList.remove('active');
      } else {
        calculate100DaysChart();
        calculate6MonthsChart();
        calculateHealthAssessment();
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function toggleMarkovPopup() {
      const popup = document.getElementById('markovPopup');
      const overlay = document.getElementById('markovOverlay');
      const isActive = popup.classList.contains('active');

      if (isActive) {
        popup.classList.remove('active');
        overlay.classList.remove('active');
      } else {
        // Markov-Content generieren
        const catNames = {
          superday: 'â­',
          wellness: 'ğŸ’š',
          sober: 'ğŸŸ¢',
          moderate: 'ğŸŸ¡',
          mixed: 'â¤ï¸',
          alcohol: 'ğŸ”´',
          hangover: 'ğŸºğŸ’¥'
        };

        const markovHTML = `
          <div style="font-size:12px; color:#7c3aed; margin-bottom:12px; text-align:center; background:white; padding:8px; border-radius:6px;">
            <strong>Monte-Carlo Simulation</strong> (1000 DurchlÃ¤ufe) Â· Exponentielle Recency-Gewichtung Â· Stochastische Auswahl
            <span class="tooltip-icon" data-tooltip="Monte-Carlo: 1000 zufÃ¤llige Simulationen deiner nÃ¤chsten 7 Tage basierend auf deinen Verhaltensmustern. Recency: Neuere Tage wiegen stÃ¤rker. Stochastisch: Zufallsbasiert, aber realistisch.">?</span>
          </div>
          <div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; text-align:center;">
            ${markovForecast.map(f => {
              let bgGradient = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
              let borderColor = '#d1d5db';
              const prob = parseInt(f.prob);

              if (prob >= 70) {
                bgGradient = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                borderColor = '#34d399';
              } else if (prob >= 50) {
                bgGradient = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                borderColor = '#fbbf24';
              } else if (prob >= 30) {
                bgGradient = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                borderColor = '#f87171';
              }

              return `
                <div style="padding:12px 8px; background:${bgGradient}; border-radius:10px; border:2px solid ${borderColor}; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                  <div style="font-size:28px; margin-bottom:4px;">${catNames[f.state] || 'â“'}</div>
                  <div style="font-size:11px; font-weight:700; color:#374151; margin-bottom:2px;">Tag ${f.day}</div>
                  <div style="font-size:14px; font-weight:800; color:#1f2937;">${f.prob}%</div>
                  ${f.alternatives.length > 1 ? `
                    <div style="font-size:9px; color:#6b7280; margin-top:6px; padding-top:6px; border-top:1px solid rgba(0,0,0,0.1);">
                      ${f.alternatives.slice(1, 3).map(alt => `${catNames[alt.state]} ${alt.prob}%`).join(' Â· ')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top:16px; padding:12px; background:white; border-radius:8px; border-left:4px solid #a855f7;">
            <div style="font-size:12px; color:#6b7280; line-height:1.6;">
              <strong style="color:#7c3aed;">ğŸ“Š Interpretation:</strong><br>
              â€¢ <strong>â‰¥70%</strong>: Sehr wahrscheinlich (grÃ¼n)<br>
              â€¢ <strong>50-69%</strong>: Wahrscheinlich (gelb)<br>
              â€¢ <strong>30-49%</strong>: MÃ¶glich (orange)<br>
              â€¢ <strong><30%</strong>: Unsicher (grau)<br>
              <em style="display:block; margin-top:8px; color:#9ca3af;">âš ï¸ Statistische Prognose basierend auf historischen Mustern. Deine Entscheidungen kÃ¶nnen den Trend jederzeit Ã¤ndern!</em>
            </div>
          </div>
        `;

        document.getElementById('markovContent').innerHTML = markovHTML;
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function toggleSettingsPopup() {
      const popup = document.getElementById('settingsPopup');
      const overlay = document.getElementById('settingsOverlay');
      const isActive = popup.classList.contains('active');

      if (isActive) {
        popup.classList.remove('active');
        overlay.classList.remove('active');
      } else {
        // Refresh Radio-UI
        document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
        const radio = document.querySelector(`input[name="neutralDays"][value="${neutralDaysSetting}"]`);
        if (radio) {
          radio.checked = true;
          radio.closest('.settings-option').classList.add('selected');
        }
        document.getElementById('toggleGodMode').checked = godMode;

        // Gender-Radio korrekt vorselektieren
        const gInput = document.querySelector(`input[name="gender"][value="${userGender}"]`);
        if (gInput) {
          gInput.checked = true;
          document.querySelectorAll('#settingsGender .settings-option')
            .forEach(opt => opt.classList.remove('selected'));
          gInput.closest('.settings-option')?.classList.add('selected');
        }

        // Gewicht anzeigen
        const weightInput = document.getElementById('userWeightInput');
        weightInput.value = userWeight || '';
        
        // Neu: Nudging-Toggle
        document.getElementById('toggleNudging').checked = nudgingEnabled || false;
        
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }

    function toggleSettingsSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }

    function saveSettings() {
      const selectedNeutral = document.querySelector('input[name="neutralDays"]:checked');
      if (selectedNeutral) neutralDaysSetting = selectedNeutral.value;
      
      const selectedGender = document.querySelector('input[name="gender"]:checked');
      if (selectedGender) {
        userGender = selectedGender.value;
        updateCategoryDescriptions(); // Beschreibungen aktualisieren
      }

      // Gewicht auslesen (optional)
      const weightInput = document.getElementById('userWeightInput');
      const weightValue = parseInt(weightInput.value);
      userWeight = (weightValue >= 40 && weightValue <= 200) ? weightValue : null;
      
      neutralDaysWeight = parseInt(document.getElementById('neutralWeightSlider').value) || 30;
      godMode = document.getElementById('toggleGodMode').checked;

      // Neu: Nudging speichern
      nudgingEnabled = document.getElementById('toggleNudging').checked;

      if (storageWorking) {
        try {
          localStorage.setItem('alcoholTrackerSettings', JSON.stringify({
            neutralDays: neutralDaysSetting,
            neutralDaysWeight,
            godMode,
            gender: userGender,
            weight: userWeight,
            nudgingEnabled
          }));
        } catch (e) {
          console.warn('Settings konnten nicht gespeichert werden:', e);
        }
      }
      
      toggleSettingsPopup();
      updateDayInputView();
      alert('âœ… Einstellungen gespeichert.');
    }

    /* ========================================
       EVENT LISTENERS
    ======================================== */
    document.addEventListener('DOMContentLoaded', () => {
      testStorage();
      loadData();
      
      document.getElementById('appVersion').textContent = APP_VERSION;
      updateDayInputView();
      
      // FIX: Initial Drink beim God-Mode laden
      /* auto-add suppressed: user must click + GetrÃ¤nk */
      
      // Kategorie-Auswahl mit Auto-Select
      document.querySelectorAll('input[name="dayChoice"]').forEach(radio => {
        radio.addEventListener('change', () => {
          categoryManual = true;
        // PrÃ¼fe ob manuell geÃ¤ndert (nicht Auto-Select)
          const isManual = !radio.dataset.autoSelected;
          delete radio.dataset.autoSelected; // Reset
          if (isManual) {
            updateCategoryWarnings(null);
            
            // AUTO-SAVE: Wenn nicht im God-Modus, speichere sofort
            if (!godMode) {
              setTimeout(() => {
                saveDay();
              }, 300); // Kurze VerzÃ¶gerung fÃ¼r bessere UX
            }
          }
        });
      });
      
      // Submit Day
      document.getElementById('submitDay').addEventListener('click', saveDay);
    // Delete current day
    try {
      document.getElementById('deleteDay').addEventListener('click', () => {
        const key = formatDateKey(currentInputDate);
        if (!key) return;
        if (!storageWorking) return;
        delete dayData[key];
        saveData();
        updateMonthView();
        showMonthView();
      });
    } catch(e) {}

      
      // FIX: God-Modus Toggle mit korrekter Logik
      document.getElementById('godToggleBtn').addEventListener('click', () => {
        godMode = !godMode;
        const section = document.getElementById('godSection');
        section.style.display = godMode ? 'block' : 'none';
        
        const btn = document.getElementById('godToggleBtn');
        btn.textContent = godMode ? 'Ausblenden' : 'Einblenden';
        
        // Initial Drink hinzufÃ¼gen wenn leer
        /* auto-add suppressed: user must click + GetrÃ¤nk */
      });
      
      // Add Drink
      document.getElementById('addDrinkBtn').addEventListener('click', () => {
        addDrink();
      });
      
      // Drinks Input Delegation
      document.addEventListener('change', (e) => {
        const target = e.target;
        if (target.matches('[data-drink]')) {
          const drinkId = target.dataset.drink;
          const field = target.dataset.field;
          updateDrinkFromInput(drinkId, field, target.value);
        }
      });
      
      document.addEventListener('input', (e) => {
        const target = e.target;
        if (target.matches('[data-drink][data-field="custom"]')) {
          const drinkId = target.dataset.drink;
          updateDrinkFromInput(drinkId, 'custom', target.value);
        }
      });
      
      // Checkboxen
      document.getElementById('checkSport').addEventListener('change', updateLiveCalc);
      document.getElementById('checkCompensation').addEventListener('change', updateLiveCalc);
      document.getElementById('checkCrash').addEventListener('change', updateLiveCalc);
      document.getElementById('checkHangover').addEventListener('change', updateLiveCalc);
      document.getElementById('checkHangoverLight').addEventListener('change', updateLiveCalc);
      
      document.getElementById('checkDope').addEventListener('change', (e) => {
        document.getElementById('dopeDetails').style.display = e.target.checked ? 'block' : 'none';
      });
      
      // Neu: Stress-Optionen Listener
      document.querySelectorAll('input[name="stressLevel"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('.stress-option').forEach(opt => opt.classList.remove('selected'));
          radio.closest('.stress-option').classList.add('selected');
          updateLiveCalc(); // Optional: Stress in Calc einbeziehen
        });
      });
      
      // Analysis Toggle
      document.getElementById('analysisToggle').addEventListener('click', () => {
        const box = document.getElementById('analysisBox');
        box.classList.toggle('active');
        const btn = document.getElementById('analysisToggle');
        btn.textContent = box.classList.contains('active') ? 'ğŸ”¼ Analyse ausblenden' : 'ğŸ” Detaillierte Analyse anzeigen';
      });
      
	  // === NEUER CODE START ===
      // Event Listener fÃ¼r den 6-Monats-Toggle-Button
      document.getElementById('toggleSixMonthBtn').addEventListener('click', () => {
        const section = document.getElementById('sixMonthAnalysisSection');
        const btn = document.getElementById('toggleSixMonthBtn');
        
        if (!section || !btn) return; // Sicherheitsabfrage

        if (section.style.display === 'none') {
          section.style.display = 'block'; // Sektion anzeigen
          btn.textContent = 'ğŸ“‰ 6-Monats-Analyse ausblenden';
        } else {
          section.style.display = 'none'; // Sektion verstecken
          btn.textContent = 'ğŸ“ˆ 6-Monats-Analyse anzeigen';
        }
      });
      // === NEUER CODE ENDE ===
	  
      // Settings Radio
      document.querySelectorAll('input[name="neutralDays"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('.settings-option').forEach(opt => opt.classList.remove('selected'));
          radio.closest('.settings-option').classList.add('selected');
        });
      });
    });

    /* ========================================
       GLOBAL FUNCTIONS (fÃ¼r onclick)
    ======================================== */
    window.showMonthView = showMonthView;
    window.showDayInput = showDayInput;
    window.previousMonth = previousMonth;
    window.nextMonth = nextMonth;
    window.currentMonth = currentMonth;
    window.toggleChartPopup = toggleChartPopup;
    window.toggleSettingsPopup = toggleSettingsPopup;
    window.toggleSettingsSection = toggleSettingsSection;
    window.saveSettings = saveSettings;
    window.exportData = exportData;
    window.importData = importData;
    window.resetStorage = resetStorage;
    window.removeDrink = removeDrink;

    /* ========================================
       TOOLTIP SYSTEM
    ======================================== */
    function initTooltips() {
      // Erstelle Tooltip-Container falls nicht vorhanden
      if (!document.getElementById('tooltipContainer')) {
        const container = document.createElement('div');
        container.id = 'tooltipContainer';
        document.body.appendChild(container);
      }

      // Event Delegation fÃ¼r alle Tooltip-Icons
      document.addEventListener('mouseover', (e) => {
        const trigger = e.target.closest('.tooltip-icon');
        if (!trigger) return;

        const text = trigger.dataset.tooltip;
        if (!text) return;

        // Erstelle Tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip-content';
        tooltip.textContent = text;
        tooltip.id = 'activeTooltip';
        document.getElementById('tooltipContainer').appendChild(tooltip);

        // Positioniere Tooltip
        const rect = trigger.getBoundingClientRect();
        tooltip.style.position = 'fixed';
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.top - 10) + 'px';
        tooltip.style.transform = 'translate(-50%, -100%)';

        // Zeige Tooltip
        setTimeout(() => tooltip.classList.add('show'), 10);
      });

      document.addEventListener('mouseout', (e) => {
        const trigger = e.target.closest('.tooltip-icon');
        if (!trigger) return;

        // Entferne Tooltip
        const tooltip = document.getElementById('activeTooltip');
        if (tooltip) {
          tooltip.classList.remove('show');
          setTimeout(() => tooltip.remove(), 200);
        }
      });
    }

    // Initialisiere Tooltips beim Laden
    document.addEventListener('DOMContentLoaded', initTooltips);

    /* Neu: Nudge-Aktionen (Beispiel-Handler) */
    window.nudgeAction = function(action) {
      // Hier kÃ¶nnte man z.B. Checkboxen setzen oder Notizen hinzufÃ¼gen
      alert(`Plan B aktiviert: ${action}! Guter Schritt!`);
      document.getElementById('nudgeAlert').style.display = 'none';
    };

    /* Neu: Predictive Nudging Logik (in updateDayInputView oder Ã¤hnlich aufrufen) */
    function checkForNudge() {
      if (!nudgingEnabled) return;
      // Berechne Risiko aus Markov (z.B. forecast[0].prob fÃ¼r heute)
      const todayRisk = markovForecast && markovForecast[0] ? parseInt(markovForecast[0].prob) : 0;
      if (todayRisk >= 40) {
        document.getElementById('nudgeRiskPct').textContent = todayRisk;
        document.getElementById('nudgeAlert').classList.add('active');
      } else {
        document.getElementById('nudgeAlert').classList.remove('active');
      }
    }

    // Rufe in updateDayInputView auf
    const originalUpdateDayInputView = updateDayInputView;
    updateDayInputView = function() {
      originalUpdateDayInputView.apply(this, arguments);
      checkForNudge();
      // Stress laden, wenn Tag geladen
      if (currentDayEntry && currentDayEntry.stressLevel !== undefined) {
        const radio = document.querySelector(`input[name="stressLevel"][value="${currentDayEntry.stressLevel}"]`);
        if (radio) {
          radio.checked = true;
          radio.closest('.stress-option').classList.add('selected');
        }
      }
    };

    // Erweitere saveDay um Stress
    const originalSaveDay = saveDay;
    saveDay = function() {
      const stressRadio = document.querySelector('input[name="stressLevel"]:checked');
      if (stressRadio) {
        currentDayEntry.stressLevel = parseInt(stressRadio.value);
      }
      originalSaveDay.apply(this, arguments);
    };

  </script>

<script>
(function(){
  function ensureMonthHint(){
    try{
      var head = document.querySelector('.month-head');
      if(!head) return;
      var hint = document.getElementById('monthHint');
      if(!hint){
        hint = document.createElement('div');
        hint.id = 'monthHint';
        hint.className = 'month-hint';
        head.insertAdjacentElement('afterend', hint);
      }
      var gmActive = (typeof godMode !== 'undefined' && !!godMode);
      var base = 'Hinweis: FÃ¼r genaue Eingabe der Alkoholmengen in den Einstellungen den God-Mode aktivieren.';
      hint.innerHTML = gmActive ? base + ' <span class="gm-badge">Godmode activated</span>' : base;
    }catch(e){ /* no-op */ }
  }

  // Hook into updateMonthView (call afterwards)
  if(typeof updateMonthView === 'function'){
    var _updateMonthView = updateMonthView;
    window.updateMonthView = function(){
      var res = _updateMonthView.apply(this, arguments);
      ensureMonthHint();
      return res;
    };
  } else {
    // Fallback: try once on DOM ready
    document.addEventListener('DOMContentLoaded', ensureMonthHint);
  }

  // Update when settings saved or checkbox toggled
  document.addEventListener('DOMContentLoaded', function(){
    var tgm = document.getElementById('toggleGodMode');
    if(tgm){
      tgm.addEventListener('change', ensureMonthHint);
    }
  });
})();
</script>

<!-- Neu: Markov Popup (bereits vorhanden, aber fÃ¼r VollstÃ¤ndigkeit) -->
<div class="chart-popup-overlay" id="markovOverlay" onclick="toggleMarkovPopup()"></div>
<div id="markovPopup" class="chart-popup">
  <div id="markovContent"></div>
</div>

<!-- Neu: Nudging Toggle in Settings (erweiterte Settings Sektion) -->
<div id="settingsNudging" class="settings-section">
  <div class="settings-section-header" onclick="toggleSettingsSection('settingsNudging')">
    <span class="settings-section-title">Predictive Nudging</span>
    <span class="settings-section-toggle">â–¼</span>
  </div>
  <div class="settings-section-content">
    <div class="settings-description">Aktiviere proaktive Tipps basierend auf deiner Prognose. Hilft bei der Selbstwirksamkeit (evidenzbasiert aus CBT-Studien).</div>
    <div class="checkbox-item">
      <input type="checkbox" id="toggleNudging">
      <label for="toggleNudging">Nudging aktivieren</label>
    </div>
  </div>
</div>

</body>
</html>